#textdomain wesnoth-Grnk

[scenario]
    id=12_Alliance
    name=_"Alliance"
    next_scenario=12s_Pursuit

    # Using a Part 1 map here:
    map_data="{~add-ons/Grnk/part2/maps/12_Alliance.map}"

    {DEFAULT_SCHEDULE}
    {TURNS 13 15 18}
    victory_when_enemies_defeated=no

    [side]
        side=1
        controller=human
        id=Vanak

        x,y=1,1

        team_name=Vanak
        user_team_name=_"Vanak"

        {GOLD 300 250 200}
    [/side]

    # Teehf River Fort
    [side]
        side=2
        controller=ai
        id=Langzight
        name=_"Langzight"
        type=Lieutenant

        x,y=19,17

        team_name=humans
        user_team_name=_"Shmaltupp"

        persistent=yes

        recruit=Heavy Infantryman,Bowman,Spearman

        {GOLD 197 -247 287}
    [/side]

    [side]
        side=3
        controller=null
        no_leader=yes
        hidden=yes

        team_name=master
        user_team_name=_"Master's Minions"

        {GOLD 150 -200 250}
    [/side]

    [side]
        side=4
        controller=null
        no_leader=yes
        hidden=yes
    [/side]

    [side]
        side=5
        controller=null

        team_name=saurians
        user_team_name=_"Saurians"
        recruit=Saurian Augur,Saurian Skirmisher

        [ai]
            aggression=1.0
            caution=0.0
            leader_aggression=1.0
            leader_caution=0.0
            village_value=0.0
            scout_village_targeting=0.0
        [/ai]

        {GOLD 261 261 361}
    [/side]
    # Saurians can recruit 1 Level 2 unit per turn
    {ONE_RECRUIT_PER_TURN 5 (Saurian Oracle,Saurian Soothsayer,Saurian Ambusher)}

    [event]
        name=prestart

        # Set up the extra units, villages Side 3 (Koorzhar)
        {CAPTURE_VILLAGES 2 33 35 5}
        {CAPTURE_VILLAGES 2 33 43 3}

        {SET_LABEL 16 30 _"Knick Point"}
        {SET_LABEL 19 17 _"Teehf River Fort"}
        {SET_LABEL 27 18 _"Lake Teehf"}

        {UNIT 2 Spearman 38 38 (id,facing=soldier1,se)}

        # Recreate all the extra keeps from Part 1
        # Yes, this could be combined into fewer [terrain] tags, this is
        # simply copy/pasted from Part 1, just with the keeps removed
        [terrain]
            x=1,2,2,1,1
            y=42,42,43,44,43
            terrain=Ce
        [/terrain]
        [terrain]
            x=20,21,22,21
            y=4,5,4,4
            terrain=Ce
        [/terrain]
        [terrain]
            x=2,2,1,1
            y=15,16,17,16
            terrain=Ce
        [/terrain]
        [terrain]
            x=33,34,34,35
            y=10,9,10,10
            terrain=Ce
        [/terrain]

        [terrain]
            x=33,34,34,35
            y=10,9,10,10
            terrain=Ce
        [/terrain]

        # Also remove the keep from existing castles in Part 1
        [terrain]
            x=2,11
            y=4,46
            terrain=Ce
        [/terrain]

        [store_unit]
            [filter]
                id=Vanak
            [/filter]

            variable=S.stored_Vanak
            kill=yes
        [/store_unit]

        {UNIT 1 Galleon 37 48 (id,facing=cruise_ship,n)}
        {SCROLL_TO 37 48}

        [objectives]
            side=1
            summary=_"Objectives for Vanak and Grnk"
            [objective]
                description=_"Seize the chest by defeating all Teehf River Fort units"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Vanak"
                condition=lose
            [/objective]
            [objective]
                description=_"Grnk attacks one of Koorzhar's units"
                condition=lose
            [/objective]
            [objective]
                description=_"Turns run out"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
            [note]
                description=_"Throughout this scenario, Grnk gets 1 gold per turn per experience level, to be paid in full at the end of the scenario."
            [/note]
        [/objectives]
    [/event]

    [event]
        name=start

        [kill]
            id=cruise_ship
        [/kill]

        [move_unit_fake]
            type=Galleon
            side=1
            x=37,37,36,36,38,38,39,39
            y=48,47,46,44,43,42,42,40
        [/move_unit_fake]

        {UNIT 1 Galleon 39 40 (id,facing=cruise_ship,n)}

        {MESSAGE soldier1 "" "" _"Halt!  Who goes there?"}

        [move_unit_fake]
            type=Bowman
            side=2
            x=38,39
            y=38,38
        [/move_unit_fake]
        {UNIT 2 Bowman 39 38 (id,facing=soldier2,s)}

        {VARIABLE S.quank_portrait "portraits/dwarves/transparent/ulfserker.png"}
        {MESSAGE narrator "$S.quank_portrait" _"Quank" _"..."}
        {MESSAGE narrator "$stored_Grnk_S11.profile" _"Grnk" _"<i>Sigh.</i>

It can never be easy, can it?  Come on, Vanak."}

        [move_unit_fake]
            type=$stored_Grnk_S11.type
            side=1
            x=39,38
            y=40,39
        [/move_unit_fake]

        [unstore_unit]
            variable=stored_Grnk_S11
            x,y=38,39
        [/unstore_unit]
        {CLEAR_VARIABLE stored_Grnk_S11}

        [modify_unit]
            [filter]
                id=Grnk
            [/filter]

            facing=nw
        [/modify_unit]

        [move_unit_fake]
            type=$S.stored_Vanak.type
            side=1
            x=39,38
            y=40,40
        [/move_unit_fake]

        [unstore_unit]
            variable=S.stored_Vanak
            x,y=38,40
        [/unstore_unit]
        {CLEAR_VARIABLE S.stored_Vanak}

        [modify_unit]
            [filter]
                id=Vanak
            [/filter]

            facing=nw
        [/modify_unit]

#        {MOVE_UNIT (id=soldier1) 30 48}
        [kill]
            id=soldier1
        [/kill]

#        {MOVE_UNIT (id=soldier2) 18 18}

        {SCROLL_TO 39 40}
        [move_unit_fake]
            type=Dwarvish Berserker
            side=1
            x=39,37
            y=40,40
        [/move_unit_fake]

        [unit]
            type=Dwarvish Berserker
            id=Quank
            name=_"Quank"
            side=1
            x,y=37,40

            gender=male
            unrenamable=yes
            overlays=misc/hero-icon.png

            [modifications]
                {TRAIT_QUICK}
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]

        {CLEAR_VARIABLE S.quank_portrait.type}

        {MESSAGE Quank "" "" _"Captain, move my cruise ship to safety.  I cannot risk losing such a valuable asset in this little quarrel."}

        {MOVE_UNIT_TO_EDGE_AND_OFF_MAP cruise_ship 37 48 s}

#        {MOVE_UNIT (id=Grnk) 22 32}

        [modify_unit]
            [filter]
                id=Vanak
            [/filter]

            x,y=23,32
            facing=sw
        [/modify_unit]

        [modify_unit]
            [filter]
                id=Quank
            [/filter]

#            x,y=23,33
x,y=18,19
            facing=sw
        [/modify_unit]

        [redraw]
        [/redraw]
    [/event]

    [event]
        name=moveto

        [filter]
            id=Quank
#            x=18,18,19,19,20
#            y=16,17.17,18,17
        [/filter]

        {MESSAGE Langzight "" "" _"Quank!  I cannot believe that you are collaborating with that traitor goblin."}

        [store_unit]
            [filter]
                id=Langzight
            [/filter]

            variable=S.stored_Langzight
            kill=yes
        [/store_unit]

        [move_unit_fake]
            type=$S.stored_Langzight.type
            side=2
            x=$S.stored_Langzight.x,19
            y=$S.stored_Langzight.y,17
        [/move_unit_fake]

        [store_unit]
            [filter]
                id=Quank
            [/filter]

            variable=S.stored_Quank
            kill=yes
        [/store_unit]

        [move_unit_fake]
            type=$S.stored_Quank.type
            side=1
            x=$S.stored_Quank.x,19
            y=$S.stored_Quank.y,17
        [/move_unit_fake]

        {REMOVE_LABEL 16 30}
        {REMOVE_LABEL 19 17}
        {REMOVE_LABEL 27 18}

        [modify_side]
            side=1
            shroud=yes
        [/modify_side]
        [redraw]
        [/redraw]

        # Also store away the Side 2 units still on the map
        [store_unit]
            [filter]
                side=2
                [not]
                    id=Langzight
                [/not]
            [/filter]

            variable=S.stored_soldiers
            kill=yes
            mode=append
        [/store_unit]

        [dialog_message]
            message=_"Some time later"
        [/dialog_message]

        [store_unit]
            [filter]
                side=1
                x=1-99
            [/filter]

            variable=S.stored_units
            kill=yes
        [/store_unit]

        {FOREACH S.stored_units S.i}
            [unstore_unit]
                variable=S.stored_units[$S.i]
                x,y=13,20
                find_vacant=yes
            [/unstore_unit]
        {NEXT S.i}
        {CLEAR_VARIABLE S.stored_units}

        {SCROLL_TO 19 17}

        [unit]
            type=General
            id=Koorzhar
            name=_"Koorzhar"
            side=3
            x,y=20,33
            canrecruit=yes

            gender=male
            unrenamable=yes
        [/unit]

        {SET_LABEL 16 30 _"Knick Point"}
        {SET_LABEL 19 17 _"Teehf River Fort"}
        {SET_LABEL 27 18 _"Lake Teehf"}

        [modify_side]
            side=1
            shroud=no
        [/modify_side]
        [redraw]
        [/redraw]

        [move_unit_fake]
            type=$S.stored_Quank.type
            side=1
            x=19,18
            y=17,18
        [/move_unit_fake]

        [unstore_unit]
            variable=S.stored_Quank
            x,y=18,18
        [/unstore_unit]
        {CLEAR_VARIABLE S.stored_Quank}

        [modify_unit]
            [filter]
                id=Quank
            [/filter]

            facing=sw
        [/modify_unit]

        [move_unit_fake]
            type=$S.stored_Langzight.type
            side=1
            x=19,$S.stored_Langzight.x
            y=17,$S.stored_Langzight.y
        [/move_unit_fake]

        [unstore_unit]
            variable=S.stored_Langzight
        [/unstore_unit]
        {CLEAR_VARIABLE S.stored_Langzight}

        {MESSAGE Grnk "" "" _"Vanak, release the prisoners."}

        {FOREACH S.stored_soldiers S.i}
            [unstore_unit]
                variable=S.stored_soldiers[$S.i]
                x,y=16,18
                find_vacant=yes
            [/unstore_unit]

            {VARIABLE S.have_uninjured_soldier no}
            [if]
                [variable]
                    name=S.stored_soldiers[$S.i].hitpoints
                    equals=$S.stored_soldiers[$S.i].max_hitpoints
                [/variable]

                [then]
                    {VARIABLE S.have_uninjured_soldier yes}
                [/then]
            [/if]
        {NEXT S.i}
        {CLEAR_VARIABLE S.stored_soldiers}

        {MOVE_UNIT (id=Koorzhar) 14 29}
        {UNIT 3 Longbowman 13 29 (id=guard1)}
        {UNIT 3 (Royal Guard) 15 29 (id=guard2)}
        {UNIT 3 Pikeman 13 30 (id=guard3)}
        {UNIT 3 (Master Bowman) 15 30 (id=guard4)}

        {MESSAGE Koorzhar "" "" _"Lieutenant Langzight!  What the hell do you think you are doing?!"}

        {FIREBALL_IN 14 30 $stored_Karcyn_S7.image n}

        {VARIABLE stored_Karcyn_S7.facing n}
        {VARIABLE stored_Karcyn_S7.side 3}
        [unstore_unit]
            variable=stored_Karcyn_S7
            x,y=14,30
        [/unstore_unit]

        {MESSAGE Karcyn "" "" _"Put an end to this travesty, Koorzhar!"}

        [move_unit_fake]
            type=Peasant
            side=1
            x=13,14,14
            y=24,24,26
        [/move_unit_fake]

        {UNIT 4 Peasant 14 26 (id,facing=peasant1,se)}
        {SCATTER_UNITS 20 "Peasant" 0 (x,y,terrain=9-17,22-26,G*) (side=4)}

        {MESSAGE peasant1 "" "" _"We will help you."}

        [modify_unit]
            [filter]
                id=guard1,guard2,guard3,guard4
            [/filter]

            side=2
        [/modify_unit]

        {MESSAGE guard2 "" "" _"<span color='#808080'><small>[Mumbling under his breath]  It's about time...</small></span>

Yes, Lieutenant.  Please come back to Shmaltupp with us, General."}

        [kill]
            id=guard1,guard2,guard3,guard4,Koorzhar
        [/kill]

        {MESSAGE Karcyn "" "" _"<i>[Sigh]</i>

I will just have to do it myself then."}

        {FIREBALL_OUT Karcyn}

        {SCROLL_TO 1 43}

        {FIREBALL_IN 1 43 $stored_Karcyn_S7.image n}

        [unstore_unit]
            variable=stored_Karcyn_S7
            x,y=1,43
        [/unstore_unit]

        {CLEAR_VARIABLE stored_Karcyn_S7}

        [terrain]
            x,y=1,43
            terrain=Ke
        [/terrain]

        {MESSAGE Karcyn "" "" _"Skeleton minions, rise and destroy them all!"}
        {GENERIC_UNIT 3 (Bone Shooter) 1 42}
        {GENERIC_UNIT 3 (Deathblade) 2 42}
        {GENERIC_UNIT 3 (Revenant) 2 43}
        {GENERIC_UNIT 3 (Draug) 1 44}

        {MESSAGE Grnk "" "" _"<i>[Sigh]</i>"}
        {MESSAGE Langzight "" "" _"<i>[Sigh]</i>"}
        {MESSAGE Quank "" "" _"<i>[Sigh]</i>"}
        {MESSAGE Vanak "" "" _"Vanak like smash skeleton."}

        {MESSAGE Grnk "" "" _"Lieutenant Langzight, will you help us fight the undead now?"}

        [if]
            [variable]
                name=S.have_uninjured_soldier
                equals=yes
            [/variable]

            [then]
                {MESSAGE Langzight "" "" _"Most of my men are too beaten up to fight right now.  Those that are uninjured will help you right now, the rest will join the fight as soon as they are healed."}
            [/then]

            [else]
                {MESSAGE Langzight "" "" _"I would, but my men are too beaten up to fight right now.  They will join the fight as soon as they are healed."}
            [/else]
        [/if]

        [modify_side]
            side=2
            controller=human
            team_name=Vanak
        [/modify_side]

        # Need to store the soldiers again, as their positions have changed
        [store_unit]
            [filter]
                side=2
                [not]
                    id=Langzight
                [/not]
            [/filter]

            variable=S.stored_soldiers
        [/store_unit]

        {FOREACH S.stored_soldiers S.i}
            [if]
                [variable]
                    name=S.stored_soldiers[$S.i].hitpoints
                    not_equals=$S.stored_soldiers[$S.i].max_hitpoints
                [/variable]

                [then]
                    [store_unit]
                        [filter]
                            id=$S.stored_soldiers[$S.i].id
                        [/filter]

                        variable=S.injured_soldiers
                        kill=yes
                        mode=append
                    [/store_unit]

                    [kill]
                        id=$S.stored_soldiers[$S.i].id
                    [/kill]

                    [move_unit_fake]
                        type=$S.stored_soldiers[$S.i].type
                        side=2
                        x=$S.stored_soldiers[$S.i].x,18
                        y=$S.stored_soldiers[$S.i].y,17
                    [/move_unit_fake]
                [/then]
            [/if]
        {NEXT S.i}
        {CLEAR_VARIABLE S.stored_soldiers}

        {MESSAGE peasant1 "" ""  _"We will help you though."}
        {MESSAGE Grnk "" "" _"No, please.  Too many of your brothers have died already.  Go somewhere where you can work for your cause without being slaughtered."}
        {MESSAGE peasant1 "" ""  _"If you say so.  But I believe that the day is close when we will join you in the fight."}

        [kill]
            type=Peasant
        [/kill]

        {MOVE_UNIT (id=Vanak) 1 16}
        [terrain]
            x,y=1,16
            terrain=Ke
        [/terrain]

        {MESSAGE Grnk "" "" _"This seems oddly familiar.  All that's missing are some saurians."}

        {NEW_LEADER_APPEARS 5 (Saurian Soothsayer) 39 11 saurian_leader ()}

        {SCROLL_TO 39 11}
        {MESSAGE saurian_leader "" "" _"Zzaurianzss?  Did zzomebody zzay zzaurianzss?"}

        {MOVE_UNIT id=saurian_leader 35 10}
        [terrain]
            x,y=35,10
            terrain=Ke
        [/terrain]
        {REDRAW 1}

        {MESSAGE Grnk "" "" _"Just great!  How about some lurkers next.  No, wait, I didn't say that!"}

        {SCROLL_TO 1 16}

        [objectives]
            side=1
            summary=_"Objectives for Vanak and Grnk"
            [objective]
                description=_"Get a strike in on that groveling slimy little bastard, Karcyn"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Vanak"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Quank"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Langzight"
                condition=lose
            [/objective]
            [objective]
                description=_"Turns run out"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]

        [objectives]
            side=2
            summary=_"Objectives for Langzight"
            [objective]
                description=_"Help Vanak and Grnk get a strike in on that groveling slimy little bastard, Karcyn"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Vanak"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Quank"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Langzight"
                condition=lose
            [/objective]
            [objective]
                description=_"Turns run out"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
            [note]
                description=_"Langzight's injured men heal 10 hitpoints per turn.  They will join the fight one by one when they are fully healed."
            [/note]
        [/objectives]
    [/event]

    # Orcs take humans prisoner
    [event]
        name=last breath
        first_time_only=no

        [filter]
            side=2
            [not]
                id=Langzight
            [/not]
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [modify_unit]
            [filter]
                id=$unit.id
            [/filter]

            hitpoints=1
        [/modify_unit]

        [store_unit]
            [filter]
                id=$unit.id
            [/filter]

            variable=S.stored_soldiers
            kill=yes
            mode=append
        [/store_unit]

        [if]
            [variable]
                name=S.stored_soldiers.length
                equals=1
            [/variable]

            [then]
                {MESSAGE Grnk "" "" _"Vanak, remember that we may not kill the humans.  Take them prisoners."}
                {MESSAGE Vanak "" "" _"Vanak no like, but little goblin smart.  $second_unit.name, no kill human or Vanak kill you."}
            [/then]
        [/if]
    [/event]

    # Heal injured soldiers
    [event]
        name=side 2 turn
        first_time_only=no

        {VARIABLE S.i "$($S.injured_soldiers.length-1)"}
        [while]
            [variable]
                name=S.i
                greater_than_equal_to=0
            [/variable]

            [do]
                {VARIABLE_OP S.injured_soldiers[$S.i].hitpoints add 10}
                {MESSAGE narrator "" "" "$S.injured_soldiers[$S.i].id $S.injured_soldiers[$S.i].hitpoints $S.injured_soldiers[$S.i].max_hitpoints"}

                [if]
                    [variable]
                        name=S.injured_soldiers[$S.i].hitpoints
                        greater_than_equal_to=$S.injured_soldiers[$S.i].max_hitpoints
                    [/variable]

                    [then]
                        {MESSAGE narrator "" "" "$S.injured_soldiers[$S.i].id healed"}

                        [unstore_unit]
                            variable=S.injured_soldiers[$S.i]

                            x,y=18,17
                            find_vacant=yes
                        [/unstore_unit]

                        {FULL_HEAL_AND_CURE (id=$S.injured_soldiers[$S.i].id)}

                        {CLEAR_VARIABLE S.injured_soldiers[$S.i]}
                    [/then]
                [/if]

                {VARIABLE_OP S.i add -1}
            [/do]
        [/while]
        {CLEAR_VARIABLE S.i}
    [/event]

    [event]
        name=die

        [filter]
            id=Langzight
        [/filter]

        {MESSAGE Quank "" "" _"Not good.  We need Langzight."}

        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    # Karcyn never moves or attacks at all
    [event]
        name=side 3 turn refresh
        first_time_only=no

        {MODIFY_UNIT id=Karcyn moves 0}
        {MODIFY_UNIT id=Karcyn attacks_left 0}
    [/event]

    # Scenario ends when Karcyn is hit the first time
    [event]
        name=attacker hits
        [filter_second]
            id=Karcyn
        [/filter_second]

        {MESSAGE_RIGHT Karcyn _"Oh, no, you won't."}

        [store_unit]
            [filter]
                id=Karcyn
            [/filter]

            variable=stored_Karcyn_S12
        [/store_unit]

        {FIREBALL_OUT Karcyn}

        {MESSAGE Grnk "" "" _"I knew it!"}

        # Store Grnk and all other units on map separately, just for convenience
        # for the next story-only scenario
        [store_unit]
            [filter]
                id=Grnk
            [/filter]

            variable=stored_Grnk_S12
        [/store_unit]

        # This also includes Grnk again
        [store_unit]
            [filter]
                x=1-999
            [/filter]

            variable=stored_all_units_S12
        [/store_unit]

        # Next scenario needs to start at same time of day
        [store_time_of_day]
        [/store_time_of_day]

        # House cleaning
        {CLEAR_VARIABLE S}

        [endlevel]
            result=victory
            bonus=no
            carryover_add=no
            carryover_percentage=0
            carryover_report=no
            linger_mode=yes
        [/endlevel]
    [/event]
[/scenario]
