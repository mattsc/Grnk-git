#textdomain wesnoth-Grnk

[scenario]
    id=02_Blockade
    name=_"Blockade"
    next_scenario=03_Betrayal

    map_data="{~add-ons/Grnk_Part2/maps/Wyssauba.map}"

    {DEFAULT_SCHEDULE_FIRST_WATCH}
    {TURNS 30 2 24}
    victory_when_enemies_defeated=no

#ifndef SKIP_DIALOG
    {GRNK2_STORY_02}
#endif

    [side]
        side=1
        controller=human
        id=Teussauba
        name=_"Teussauba"
        gender=male
        unrenamable=yes
        type=White Mage

        team_name=mages
        user_team_name=_"Hynderwlt Mages"

        recruit=Mage

        {GOLD 200 200 200}
    [/side]

    [side]
        side=2
        controller=ai
        type=Lieutenant
        id=guard_leader
        canrecruit=yes

        team_name=humans
        user_team_name=_"Shmaltupp Army"

        recruit=Spearman,Bowman
        {GOLD 75 100 125}

        [ai]
            version=10710
            [engine]
                name="lua"
                code= <<
                    local ai = ...
                    return wesnoth.require("~add-ons/Grnk_Part2/lua/Grnk_defend-pass_engine.lua").init(ai)
                >>
            [/engine]

            [stage]
                id=main_loop
                name=testing_ai_default::candidate_action_evaluation_loop
                {AI_CA_RECRUITMENT}
                [candidate_action]
                    engine=lua
                    name=pass_move
                    evaluation="return (...):move_eval()"
                    execution="(...):move_exec()"
                [/candidate_action]
                [candidate_action]
                    engine=lua
                    name=pass_move
                    evaluation="return (...):attack_eval()"
                    execution="(...):attack_exec()"
                [/candidate_action]
            [/stage]
        [/ai]
    [/side]

    [side]
        side=3
        controller=null
        hidden=yes
        no_leader=yes

        team_name=undead
        user_team_name=_"The Master"

        gold=0
    [/side]

    [side]
        side=4
        controller=null
        hidden=yes
        no_leader=yes

        team_name=humans
        user_team_name=_"Koorzhar's Special Forces"

        gold=0
    [/side]

    [event]
        name=prestart

        # This cannot be put into the side definition because of a bug in Wesnoth
        [modify_side]
            side=2
            [ai]
                recruitment_pattern=fighter,fighter,archer
            [/ai]
        [/modify_side]

        # Set up the units at Wyssauba's house
        [unit]
            side=1
            id=Wyssauba
            name=_"Wyssauba"
            type=Mage of Light
            x,y=16,10

            gender=male
            unrenamable=yes
            canrecruit=yes
        [/unit]

        # Get Grnk out there
        {FOREACH stored_teussauba_troops S.i}
            {IF_VAR stored_teussauba_troops[$S.i].id equals Grnk (
                [then]
                    [unstore_unit]
                        variable=stored_teussauba_troops[$S.i]
                        x,y=17,12
                    [/unstore_unit]
                [/then]
            )}
        {NEXT S.i}

        {PLACE_IMAGE "items/anvil.png" 1 16}
        {PLACE_IMAGE "items/armor.png" 14 4}
        {PLACE_IMAGE "items/armor.png" 15 5}
        {PLACE_IMAGE "items/armor.png" 16 5}
        {PLACE_IMAGE "items/armor.png" 17 6}
        {PLACE_IMAGE "items/armor.png" 18 6}
        {PLACE_IMAGE "items/armor-golden.png" 16 14}
        {PLACE_IMAGE "items/chest.png" 7 6}
        {PLACE_IMAGE "scenery/rock-cairn.png" 4 14}
    [/event]

    [event]
        name=start

        {SCROLL_TO 14 16}

#ifndef SKIP_DIALOG
        {MESSAGE Wyssauba "" "" _"Patience, Grnk.  There is nothing wrong with a little comfort.  Believe it or not, you are making progress every day, but you cannot rush these things.  Now be a nice little goblin and get me another bottle of '75 Special Reserve from the village, will you?  And a loaf of Bocc's harvest rye."}
        {MESSAGE Grnk "" "" _"<i>[Grumbles]</i>

"+{WHISPER _"At least he could make me carry a pack full of rocks with that.  Or balance the bread on my nose while I walk home."}}
        {MESSAGE Wyssauba "" "" _"Knock yourself out, if you like that sort if thing."}

        {UNIT 1 Peasant 26 7 id=peasant}
        [unit]
            side=1
            id=Grossauba
            name=_"Grossauba"
            type=Great Mage
            x,y=26,6

            gender=male
            unrenamable=yes
        [/unit]
        {SCROLL_TO 26 6}
        {MOVE_UNIT id=peasant 19 11}
        {MOVE_UNIT id=Grossauba 17 10}

        {MESSAGE peasant "" "" _"Great wizards of Hinterworld, ..."}
        {MESSAGE Wyssauba "" "" _"It's Hynderwlt."}
        {MESSAGE peasant "" "" _"Yes, of course, master, I ..."}
        {BOOMING_VOICE_EFFECT Wyssauba _"Do not call me Master!" 16 10}
        {MESSAGE Grossauba "" "" _"Now, now, Wyssauba, take it easy on the poor little fellow.  Can't you see that he's scared out of his mind.  He looks like he has seen a ghost.  Now, what brings you here, son?"}
        {MESSAGE peasant "" "" _"It was two nights ago, just past midnight and I was out behind my hut because I ... I ...  Well, it doesn't matter what I was doing.  Anyway, suddenly there was this noise and this skeleton head appeared next to me."}
        {MESSAGE Wyssauba "" "" _"A skeleton?  Are you sure of this?  How come you are alive to talk about this if there was a skeleton at your house??"}
        {MESSAGE peasant "" "" _"I ... I don't know.  I ...  It was very dark and I was so scared I literally wet my pants."}
        {MESSAGE Wyssauba "" "" _"Now there is something I did <i>not</i> need to know.  How did it look?  How did it's voice sound?  Did it ..."}
        {MESSAGE Grossauba "" "" _"Give the poor man a break, Wyssauba.  Now, son, why did you come to us to tell us about this?"}
        {MESSAGE peasant "" "" _"The skeleton told me to tell you that the undead are planning an attack on Phorhoot Outpost.  In 2 days, right at sunset."}
        {MESSAGE Grossauba "" "" _"Thank you, son, you have been very helpful.  Go to my house, it's that big one over there, and tell the servants that Grossauba sent you.  They will give you some food for yourself and your family.  Then go home and forget that any of this ever happened."}
        {MESSAGE peasant "" "" _"Thank you, mast... my lord.  Thank you very much!  I will never forget your kindness.  No, wait, you told me to forget things, so I will make sure that I <i>do</i> forget.  Except your kind..."}
        {MESSAGE Wyssauba "" "" _"Just go!"}

        {MOVE_UNIT id=peasant 26 7}
        [kill]
            id=peasant
        [/kill]

        {MESSAGE Wyssauba "" ""  _"What the hell is going on here?  Do you believe this story?"}
        {MESSAGE Grossauba "" ""  _"I don't know, but I don't see any harm in sending a party there to check it out."}
        {MESSAGE Wyssauba "" ""  _"It could be a trap.  Why would a skeleton warn us about an attack by the Master?  We should be careful and wait this one out, see what happens."}
        {MESSAGE Grossauba "" ""  _"And risk the undead taking over Phorhoot and starting to spread fear and terror again?  That moron Koorzhar does not take our warnings seriously, but that's too high a price to pay for teaching him a lesson."}
        {MESSAGE Wyssauba "" ""  _"True.  Well, Grnk, I guess we have a job for you."}
        {MESSAGE Grnk "" "" _"Finally!"}

        [dialog_message]
            message=_"... which brings us back to the present"
        [/dialog_message]
#endif

        # Now we switch back to the battle-field
        [store_unit]
            [filter]
                id=Wyssauba
            [/filter]
            variable=stored_Wyssauba
            kill=yes
        [/store_unit]
        [store_unit]
            [filter]
                id=Grossauba
            [/filter]
            variable=stored_Grossauba
            kill=yes
        [/store_unit]
        [kill]
            id=Grnk
            x=1-999 # keep the one on the recall list
        [/kill]
        [replace_map]
            map="{~add-ons/Grnk_Part2/maps/01_Intervention_Phorhoot.map}"
            expand=yes
        [/replace_map]

        {SET_LABEL 36 30 _"Phorhoot Station"}
        {REMOVE_IMAGE 1-999 1-999}
        {PLACE_IMAGE "staff-broken.png" 27 8}
        {PLACE_IMAGE "staff-broken.png~FL()" 31 13}

        {FOREACH stored_teussauba_troops S.i}
            [unstore_unit]
                variable=stored_teussauba_troops[$S.i]
            [/unstore_unit]
        {NEXT S.i}
        {CLEAR_VARIABLE stored_teussauba_troops}

        # Phorhoot commander
        {UNIT 2 Sergeant 36 32 (id,canrecruit=sergeant,yes)}

#ifndef SKIP_DIALOG
        {MESSAGE Grnk "" "" _"Let's talk to the Phorhoot Station commander now."}
        {MOVE_UNIT id=Grnk 31 33}
        {MOVE_UNIT id=Teussauba 31 32}

        {MESSAGE Grnk "" "" _"Hello there!  We ..."}
        {MESSAGE sergeant "" "" _"Halt!  Who goes there?"}
        {MESSAGE Grnk "" "" _"We ..."}
        {MESSAGE sergeant "" "" _"Oh, you're that traitor goblin who lives with the mad wizards in Hinterworld.  General Koorzhar told us all about you."}
        {MESSAGE Grnk "" "" _"It's Hynderwlt.  And we ..."}
        {MESSAGE sergeant "" "" _"Men, to the weapons!  These traitors are planning an attack."}

        {UNIT 2 (Master Bowman) 35 32 (animate=yes)}
        {UNIT 2 Pikeman 36 31 (animate=yes)}
        {UNIT 2 Swordsman 37 32 (animate=yes)}
        {UNIT 2 Spearman 34 29 (animate=yes)}
        {UNIT 2 Bowman 35 29 (animate=yes)}
        {UNIT 2 Peasant 38 30 (animate=yes)}

        {MESSAGE Grnk "" "" _"Sigh.  It can't ever be easy, can it?"}
        {MESSAGE Teussauba "" "" _"We better get out of here, Grnk.  Grossauba made it very clear that we are to stay away from any confrontation with Shmaltupp."}

        [dialog_message]
            message=_"Meanwhile in the Underworld"
        [/dialog_message]
#endif

        # Now switch to the Master's lair
        [kill]
            x=1-999 # keep the ones on the recall list
        [/kill]
        [replace_map]
            map="{~add-ons/Grnk_Part2/maps/Master.map}"
            shrink=yes
        [/replace_map]

        {UNIT 3 (Ancient Lich) 25 4 (id,name,canrecruit=The Master,The Master,yes)}
        {UNIT 3 (Necrophage) 26 5 (id,name=Sklaf,Sklaf)}

        {UNIT 3 (Deathblade) 16 7 ()}
        {UNIT 3 (Bone Shooter) 16 9 ()}
        {UNIT 3 (Draug) 26 7 ()}
        {UNIT 3 (Banebow) 32 4 ()}
        {UNIT 3 (Draug) 30 16 ()}

#ifndef SKIP_DIALOG
        {SCROLL_TO 18 10}
        {MESSAGE (The Master) "" "" _"We have a mole in our ranks, Sklaf!  There is no other way those Hynderwlt maggots could have known about our move against Phorhoot.  I must find the traitor or my Grand Plan will be thwarted yet again."}
        {MESSAGE Sklaf "" "" _"Indeed, Master.  Here is your brandy."}
#endif

        # And finally, to the pass defense itself
        [kill]
            x=1-999 # keep the ones on the recall list
        [/kill]
        [replace_map]
            map="{~add-ons/Grnk_Part2/maps/02_Blockade.map}"
            expand=yes
            shrink=yes
        [/replace_map]
        {REMOVE_IMAGE 1-999 1-999}

        {UNIT 2 Spearman 11 10 (id=guard1)}
        {UNIT 2 (White Mage) 23 6 (id,name=Ubtrunin,Ubtrunin)}
        {UNIT 2 Bowman 21 7 ()}
        {UNIT 2 Bowman 22 6 ()}
        {UNIT 2 Spearman 22 7 ()}

        [recall]
            id=guard_leader
            x,y=23,7
        [/recall]
        [recall]
            id=Teussauba
            x,y=6,18
        [/recall]
        [recall]
            id=Grnk
            x,y=5,19
        [/recall]

        [capture_village]
            y=1-17
            side=2
        [/capture_village]

        {PLACE_IMAGE "scenery/signpost.png" 13 1}
        {SET_LABEL 13 1 _"Move Grnk Here"}

#ifndef SKIP_DIALOG
        {MESSAGE guard1 "" "" _"Halt!  Who goes there?"}
        {MESSAGE_RIGHT Teussauba _"We're mages from Hynderwlt on our way back home.  Remember us passing through a few days ago.  We saved ..."}
        {MESSAGE guard1 "" "" _"You bet I remember you.  And we have heard about your failed attack on Phorhoot.  General Koorzhar sent us new orders by carrier falcon.  I quote ""Under no circumstances may those traitors from Hin...  Hynter ..."""}
        {MESSAGE_RIGHT Teussauba _"Hynderwlt."}
        {MESSAGE guard1 "" "" _"Yes, thank you.  ""... get across Angstal Pass, in particular that goblin Gr..  Gree..  Gri..  Whatever.  He must pay for his treason during the battle at Laztie River and ..."""}
        {MESSAGE_RIGHT Grnk _"<u>My</u> treason???"}
        {MESSAGE guard1 "" "" _"""... <i>and</i> must be detained until my special forces squad arrives to take him back to Shmaltupp.  Signed: Ambrosius L. L. Koorzhar, General."""}
        {MESSAGE_RIGHT Grnk _"Listen, we don't want to fight you, we just ..."}
        {MESSAGE guard1 "" "" _"We don't want to fight you either, but we'll be damned if we let you get across the pass.  So why don't you wait right where you are until the general's men arrive."}
        {MESSAGE_RIGHT Teussauba _"<i>[Sigh!]</i>

Grossauba won't like this at all, but we have no choice.  There is no other way with Koorzhar's troops closing in behind us."}

        {MESSAGE narrator "wesnoth-icon.png" _"Important Notes"  _"The AI behavior has been modified in several scenarios of this campaign.  Be aware that AI controlled sides, both allies and enemies, may not always behave as you are used to.

Also, check out Grnk's unit description, if you have not done so yet."}
#endif

        [objectives]
            side=1
            summary=_"Objectives for Teussauba and Grnk"
            [objective]
                description=_"Cross Angstal Pass before Koorzhar's troops arrive and move Grnk to the signpost in the north"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Teussauba"
                condition=lose
            [/objective]
            [note]
                description=_"Koorzhar's special forces will show up when turns run out.  Grnk better be very close to the signpost by then."
            [/note]
            [gold_carryover]
                bonus=no
                carryover_percentage=0
            [/gold_carryover]
        [/objectives]
    [/event]

    # If there's still gold left at the beginning of the turn, keep the guard leader there
    [event]
        name=side 2 turn refresh
        first_time_only=no

        [store_gold]
            side=2
            variable=tmp_gold
        [/store_gold]

        {IF_VAR tmp_gold greater_than_equal_to 14 (
            [then]
                {MODIFY_UNIT id=guard_leader moves 0}
            [/then]
        )}
        {CLEAR_VARIABLE tmp_gold}
    [/event]

    # If last recruitment has been done, leader can leave
    [event]
        name=recruit
        first_time_only=no
        [filter]
            side=2
        [/filter]

        [store_gold]
            side=2
            variable=tmp_gold
        [/store_gold]
        # Unit cost not yet been taken off at this point
        {VARIABLE_OP tmp_gold sub $unit.cost}

        {IF_VAR tmp_gold less_than 14 (
            [then]
                #{MESSAGE guard_leader "" "" _"Keep going, chaps, I'm coming."}
                {MODIFY_UNIT id=guard_leader moves 6}
            [/then]
        )}
        {CLEAR_VARIABLE tmp_gold}
    [/event]

    # Message about soldiers not coming across pass
    [event]
        name=turn 3

        {GET_RANDOM_UNIT_ID (
            side=1
            [not]
                id=Grnk,Teussauba
            [/not]
        )}
        {MESSAGE $random_unit_id "" "" _"What the hell is going on here?  Why are they not charging at us?"}
        {CLEAR_VARIABLE random_unit_id}
        {MESSAGE Grnk "" "" _"Apparently they have a lot more discipline than the drunkards we usually encounter.  Do you think you can convince that white wizard over there to help us?  Or not to help them, at least?"}
        {MESSAGE Teussauba "" "" _"Not a chance.  That's Ubtrunin.  He was kicked out of the order a long time ago and he didn't take that lightly."}
    [/event]

    # Message about it being tedious
    [event]
        name=turn 7

        {MESSAGE Teussauba "" "" _"Umpf.  This is even more tedious than I expected."}
    [/event]

    # Message when first mage dies
    [event]
        name=last_breath
        [filter]
            side=1
            [not]
                id=Grnk,Teussauba
            [/not]
        [/filter]

        {MESSAGE Teussauba "" "" _"No, $unit.name.  I've known you all my life."}
        {MESSAGE $unit.id "" "" _"Don't worry about me, Teussauba.  All of us will gladly give our lives if that will assure your success.  Only you and Grnk need to make it back to Hynderwlt."}
    [/event]

    # When leader dies: message, then keep fighting
    [event]
        name=last_breath
        [filter]
            id=guard_leader
        [/filter]

        [if]
            [have_unit]
                side=2
            [/have_unit]
            [then]
                {MESSAGE guard_leader "" "" _"I may have fallen, but we will defend the pass to the last man!"}
            [/then]
        [/if]
    [/event]

    # Spearmen only advance to Javelineers
    [event]
        name=recruit
        first_time_only=no
        [filter]
            side=2
            type=Spearman
        [/filter]

        {MODIFY_UNIT id=$unit.id advances_to Javelineer}
    [/event]

    # The victory event, Grnk gets to the signpost
    [event]
        name=moveto
        [filter]
            id=Grnk
            x,y=13,1
        [/filter]

        {MESSAGE Grnk "" "" _"Phew!  That was harder than I had thought."}

        # House cleaning
        {CLEAR_VARIABLE S}

        [endlevel]
            result=victory
            bonus=no
            carryover_add=no
            carryover_percentage=0
            carryover_report=no
            linger_mode=no
        [/endlevel]
    [/event]

    # If Grnk does not make it in time, we have Koorzhar's troops show up
    [event]
        name=time over

        [modify_turns]
            value=-1
        [/modify_turns]
        [modify_side]
            side=4
            controller=ai
            hidden=no
        [/modify_side]

        {UNIT 4 "Lieutenant" 4 24 (id,canrecruit=lieutenant,yes)}
        {UNIT 4 "Longbowman" 4 24 ()}
        {UNIT 4 "Javelineer" 4 24 ()}
        {UNIT 4 "Pikeman" 4 24 ()}
        {UNIT 4 "Pikeman" 4 24 ()}
        {UNIT 4 "Horseman" 4 24 ()}
        {UNIT 4 "Lancer" 4 24 ()}

        {MESSAGE_RIGHT lieutenant _"There they are!  Let's get them, men!"}

        {UNIT 4 "Grand Knight" 29 4 id=knight}
        {UNIT 4 "Paladin" 29 4 ()}
        {UNIT 4 "Knight" 29 4 ()}
        {UNIT 4 "Knight" 29 4 ()}
        {UNIT 4 "Lancer" 29 4 ()}

        {MESSAGE knight "" "" _"Charge!"}
    [/event]

    ######################
    # Finally, the standard events for all or most scenarios
    {GRNK_DEATH}
    {TEUSSAUBA_DEATH}
[/scenario]
