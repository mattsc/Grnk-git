#textdomain wesnoth-Grnk

[scenario]
    id=03_Beasts
    name=_"Beasts"
    next_scenario=04_Cart

    map_data="{~add-ons/Grnk/part2/maps/03_Beasts.map}"

    {DEFAULT_SCHEDULE}
    turns=-1
    victory_when_enemies_defeated=no

    [side]
        side=1
        controller=human
        id=Grnk

        x,y=46,26

        team_name=Grnk
        user_team_name=_"Grnk"

        gold=100
        income=-2
        village_gold=0
    [/side]

    [side]
        side=2
        controller=ai
        no_leader=yes

        team_name=forest
        user_team_name=_"Forest Creatures"

        gold=0
        income=-2
    [/side]

    [side]
        side=3
        controller=ai
        no_leader=yes

        team_name=bears
        user_team_name=_"Bears"

        gold=0
        income=-2
    [/side]

    [side]
        side=4
        controller=ai
        no_leader=yes

        team_name=spiders
        user_team_name=_"Spiders"

        gold=0
        income=-2
    [/side]

    [side]
        side=5
        controller=ai
        no_leader=yes

        team_name=wolves
        user_team_name=_"Wolves"

        gold=0
        income=-2
    [/side]

    [side]
        side=6
        controller=ai
        no_leader=yes

        team_name=sheep,forest
        user_team_name=_"Sheep"

        gold=0
        income=-2
    [/side]

#define GOTO_MAI SIDE
    [micro_ai]
        side={SIDE}
        ai_type=goto
        action=add

        [filter]
            [filter_wml]
                [variables]
                    spooked=yes
                [/variables]
            [/filter_wml]
        [/filter]

        [filter_location]
            x=1,1,57,57
            y=1,33,1,33
        [/filter_location]
        avoid_enemies=2
        ca_score=400000
    [/micro_ai]
#enddef

    [event]
        name=prestart

        # Give Grnk the attacks of the spearman with the animations of the
        # impaler, for this scenario only
        # Also make sure he never defends himself with the magical spear
        [object]
            duration=scenario
            silent=yes
            [filter]
                id=Grnk
            [/filter]

            [effect]
                apply_to=attack
                name=magical spear
                defense_weight=-1
            [/effect]

            [effect]
                apply_to=new_attack
                name=spear
                description=_"spear"
                type=pierce
                range=melee
                damage=6
                number=3
                icon=attacks/spear-orcish.png
            [/effect]
            [effect]
                apply_to=new_attack
                name=spear
                description=_"spear"
                type=pierce
                range=ranged
                damage=3
                number=1
                icon=attacks/javelin-orcish.png
            [/effect]

            [effect]
                apply_to=new_animation
                [attack_anim]
                    [filter_attack]
                        name=spear
                        range=ranged
                    [/filter_attack]
                    missile_start_time=-150
                    [missile_frame]
                        duration=150
                        image="projectiles/spear-n.png"
                        image_diagonal="projectiles/spear-ne.png"
                    [/missile_frame]
                    start_time=-250
                    [frame]
                        image="units/goblins/impaler-attack-se-1.png:100"
                        sound={SOUND_LIST:THROW}
                    [/frame]
                    [frame]
                        image="units/goblins/impaler-attack-ranged-s.png:100"
                    [/frame]
                    {SOUND:HIT spear.ogg -100}
                    [frame]
                        image="units/goblins/impaler-death-1.png:50"
                    [/frame]
                [/attack_anim]
                [attack_anim]
                    [filter_attack]
                        name=spear
                        range=melee
                    [/filter_attack]
                    direction=ne,nw
                    start_time=-200
                    [frame]
                        image=units/goblins/impaler.png:75
                    [/frame]
                    [frame]
                        image=units/goblins/impaler-attack-ne.png:250
                    [/frame]
                    {SOUND:HIT_AND_MISS spear.ogg spear-miss.ogg -75}
                    [frame]
                        image=units/goblins/impaler.png:75
                    [/frame]
                [/attack_anim]
                [attack_anim]
                    [filter_attack]
                        name=spear
                        range=melee
                    [/filter_attack]
                    direction=n
                    start_time=-200
                    [frame]
                        image=units/goblins/impaler.png:75
                    [/frame]
                    [frame]
                        image=units/goblins/impaler-attack-n.png:250
                    [/frame]
                    {SOUND:HIT_AND_MISS spear.ogg spear-miss.ogg -75}
                    [frame]
                        image=units/goblins/impaler.png:75
                    [/frame]
                [/attack_anim]
                [attack_anim]
                    [filter_attack]
                        name=spear
                        range=melee
                    [/filter_attack]
                    direction=s
                    start_time=-200
                    [frame]
                        image=units/goblins/impaler.png:75
                    [/frame]
                    [frame]
                        image=units/goblins/impaler-attack-[se-1,s,se-1].png:[50,150,50]
                    [/frame]
                    {SOUND:HIT_AND_MISS spear.ogg spear-miss.ogg -75}
                    [frame]
                        image=units/goblins/impaler.png:75
                    [/frame]
                [/attack_anim]
                [attack_anim]
                    [filter_attack]
                        name=spear
                        range=melee
                    [/filter_attack]
                    direction=se,sw
                    start_time=-200
                    [frame]
                        image=units/goblins/impaler.png:75
                    [/frame]
                    [frame]
                        image=units/goblins/impaler-attack-se-[1,2,1].png:[50,150,50]
                    [/frame]
                    {SOUND:HIT_AND_MISS spear.ogg spear-miss.ogg -75}
                    [frame]
                        image=units/goblins/impaler.png:75
                    [/frame]
                [/attack_anim]
            [/effect]
        [/object]

        [micro_ai]
            side=2
            ai_type=forest_animals
            action=add

            deer_type=Deer
            rabbit_type=Rabbit
            tusker_type=Tusker
            tusklet_type=Tusklet
            [filter_location]
                terrain=*^F*
            [/filter_location]
        [/micro_ai]

        # Set up the big_animals micro AI for the Bears
        [micro_ai]
            side=3
            ai_type=big_animals
            action=add

            [filter]
                type=Bear
            [/filter]
            [avoid_unit]
                type=Yeti,Giant Spider,Tarantula,Bear,Dog
            [/avoid_unit]
            [filter_location]
                x,y=1-40,1-18
            [/filter_location]
        [/micro_ai]

        # Set up the big_animals micro AI for side 4 (the spiders)
        [micro_ai]
            side=4
            ai_type=big_animals
            action=add

            [filter]
                type=Giant Spider,Tarantula
            [/filter]
            [avoid_unit]
                type=Yeti,Giant Spider,Tarantula,Bear,Dog
            [/avoid_unit]
            [filter_location]
                terrain=H*
            [/filter_location]
        [/micro_ai]

        # Set up the wolves micro AI
        [micro_ai]
            side=5
            ai_type=wolves
            action=add

            [filter]
                type=Wolf
            [/filter]
            [filter_second]
                type=Deer
            [/filter_second]
            avoid_type=Yeti,Giant Spider,Tarantula,Bear,Dog
        [/micro_ai]

        # Set up the sheep micro AI
        [micro_ai]
            side=6
            ai_type=herding
            action=add

            [filter]
                type=Dog
            [/filter]
            [filter_second]
                type=Sheep,Ram
            [/filter_second]
            herd_x,herd_y=32,28
            [filter_location]
                terrain=Rb
            [/filter_location]
        [/micro_ai]

        {GOTO_MAI 2}
        {GOTO_MAI 3}
        {GOTO_MAI 4}
        {GOTO_MAI 5}
        {GOTO_MAI 6}

        [objectives]
            side=1
            summary=_"Objectives for Grnk and Faad"
            [objective]
                description=_"Convert as many animals as possible to Grnk's side"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Faad"
                condition=lose
            [/objective]
            [note]
                description=_"Any animal killed by a unit on Grnk's side will join Grnk with full hitpoints restored."
            [/note]
            [note]
                description=_"The scenario is over either when time runs out of when Grnk moves to the signpost in the east."
            [/note]
            [note]
                description=_"Gold plays no role in this scenario.  There is no upkeep, income or carry-over gold."
            [/note]
        [/objectives]

        # The right-click menu items
        [set_menu_item]
            id=m01_forest
            description=_"Deer, Tuskers, Tusklets and Rabbits"
            image=animals/stag.png~CROP(28,6,24,24)
            [command]
                {MESSAGE Faad "" "" _"Deer wander randomly on forest tiles, except when enemies get in their (the deer's) range, in which case they flee to the farthest point it can reach.

Tuskers exhibit the same behavior as deer, except when an enemy is next to one of the tusklets.  This enemy then experiencew the full wrath of an irate boar.

Tusklets blindly follow the closest adult tusker, except when there is no tusker left, in which case they behave the same as deer.

Rabbits wander randomly for the most part as well.  In addition, they disappear into their holes (if any are within reach) when enemies are close.  They reappear out of the holes at the beginning of the turn, if that is safe."}
            [/command]
        [/set_menu_item]
        [set_menu_item]
            id=m02_sheep
            description=_"Sheep and Sheep Dogs"
            image=animals/dog.png~CROP(33,28,24,24)
            [command]
                {MESSAGE Faad "" "" _"The most important duty of sheep dog is to keep its sheep safe.  This involves keeping them inside the area outlined by the path the dogs have worn into the meadow, positioning themselves in between the sheep and approaching enemies (if those enemies are within 8 hexes of a sheep), and attacking those enemies that get too close (within 4 hexes of a sheep).

Sheep wander aimlessly except when a sheep dog is next to them, in which case they run away from the dog.  The dogs exploit this by positioning themselves on the outside of the sheep, if possible.  The sheep, dogs and forest creatures (deer, tuskers, rabbits) have learned that they are no threat to each other and leave each other alone, demonstrating the enormous self control of a well trained sheep dog.

There is <span color='#A00000'>one important exception</span> to the controlled behavior of the dogs: if a unit on Grnk's side directly attacks a dog, the dogs forget all their training and go after units on Grnk's side with utmost ferociousness.  If you are going to take on those dogs, you better make sure you have enough units to handle them all.  They are extremely vicious."}
            [/command]
        [/set_menu_item]
        [set_menu_item]
            id=m03_wolves
            description=_"Wolves"
            image=units/monsters/wolf.png~CROP(40,29,24,24)
            [command]
                {MESSAGE Faad "" "" _"Wolves hunt in a pack of up to three.  They actively go after the closest deer (as long as the latter stays in the forest) and try to corner it, but are easily distracted by other prey coming into attack range.  The wolves try to avoid getting into the range of bears, spiders and dogs, except when they are going in for an attack on a weaker animal.  When no deer is left, the wolves wander randomly."}
            [/command]
        [/set_menu_item]
        [set_menu_item]
            id=m04_big
            description=_"Bears and Spiders"
            image=animals/bear.png~CROP(34,24,24,24)
            [command]
                {MESSAGE Faad "" "" _"Bears and spiders mostly just wander in their respective parts of the map.  They stay out of each other's way (and out of the way of the dogs), but do attack each other if cornered.  They do attack the other, weaker animals, as well as Grnk and Faad, if those are within range."}
            [/command]
        [/set_menu_item]

#undef GOTO_MAI

        # Grnk's scout
        [unit]
            side=1
            id=Faad
            name=_"Faad"
            type=Footpad
            x,y=45,27

            gender=male
            unrenamable=yes
            overlays=misc/hero-icon.png

            [modifications]
                {TRAIT_QUICK}
                {TRAIT_LOYAL}
            [/modifications]
        [/unit]

        {PLACE_IMAGE "scenery/signpost.png" 56 21}
        {SET_LABEL 56 21 _"Move Grnk Here"}

        # Initialize counter for the units that were converted
        {VARIABLE S.units_converted_counter 0}

        # Put 3 does, 1 stag, and 5 rabbits out there (might vary a little depending on RNG)
        {SCATTER_UNITS 3 "Deer" 1 (x,y,terrain=6-99,12-99,G*^F*) (side,random_traits,gender=2,no,female)}
        {SCATTER_UNITS 1 "Deer" 1 (x,y,terrain=6-99,12-99,G*^F*) (side,random_traits,gender=2,no,male)}
        {SCATTER_UNITS 5 "Rabbit" 1 (x,y,terrain=15-39,15-25,"Gg,Gs") (side,random_traits=2,no)}

        # Then all the other units
        {NOTRAIT_UNIT 2 "Tusker" 6 20}
        {NOTRAIT_UNIT 2 "Tusker" 7 21}
        {NOTRAIT_UNIT 2 "Tusklet" 7 20}
        {NOTRAIT_UNIT 2 "Tusklet" 8 21}

        # Do this separately, so that there will definitely be tw0
        {SCATTER_UNITS 1 "Bear" 1 (x,y,terrain=1-10,1-6,G*) (side,random_traits=3,no)}
        {SCATTER_UNITS 1 "Bear" 1 (x,y,terrain=16-25,1-6,G*) (side,random_traits=3,no)}

        {SCATTER_UNITS 1 "Giant Spider" 1 (x,y=51-57,1-8) (side,random_traits=4,no)}
        {SCATTER_UNITS 1 "Tarantula" 1 (x,y=36-50,1-9) (side,random_traits=4,no)}

        {NOTRAIT_UNIT 5 "Wolf" 3 32}
        {NOTRAIT_UNIT 5 "Wolf" 2 32}
        {NOTRAIT_UNIT 5 "Wolf" 5 32}
        [+unit]
        [status]
        entangled=yes
        [/status]
        [/unit]

        {SCATTER_UNITS 3 "Dog" 1 (x,y=24-40,24-33) (side,random_traits=6,no)}
        {SCATTER_UNITS 2 "Ram" 1 (x,y=24-40,24-33) (side,random_traits=6,no)}
        {SCATTER_UNITS 4 "Sheep" 1 (x,y=24-40,24-33) (side,random_traits=6,no)}

        # Need to make sure these won't be on the border !!!!
        # Other dimension are carefully chosen to give good distribution on map
        # and not inside th sheep herding area
        {SCATTER_IMAGE (
            terrain=Gg,Gs
            x,y=19-39,17-32
            [not]
                x,y=26-38,25-32
            [/not]
        ) 3 misc/burrow.png}
        {SCATTER_IMAGE (
            terrain=Gg,Gs
            x,y=19-39,17-32
            [not]
                x,y=26-38,25-32
            [/not]
        ) 3 "misc/burrow.png~FL()"}
        {SCATTER_IMAGE (
            terrain=Gg,Gs
            x,y=40-57,17-29
        ) 2 misc/burrow.png}
        {SCATTER_IMAGE (
            terrain=Gg,Gs
            x,y=40-57,17-29
        ) 2 "misc/burrow.png~FL()"}

        # Bring back the map
        {SCROLL_TO 46 28}
    [/event]

    # Start
    [event]
        name=start

        {MESSAGE Faad "" "" _"Wait!  Wait!"}
        {MESSAGE Faad "" "" _"Wait!"}
        {MESSAGE Faad "" "" _"Let me see if I got this right.  You are trying to tame a bunch of animals so that you can attack a group of giant mountain trolls and convince them to pull one of Quank's ox carts out of a swamp?!?"}
        {MESSAGE Grnk "" "" _"I wouldn't put it quite like that but, essentially, yes."}
        {MESSAGE Faad "" "" _"This is typical Quank!  He never cares how dangerous any of his crazy schemes is for anybody else, as long as he makes a profit.  That's how he got the cart stuck in the swamp and attacked by trolls in the first place.  It's a miracle that nobody was killed!"}
        {MESSAGE Faad "" "" _"Fine, I will help you with the animals and I'll show you where the cart is, but then I am out of there.  And I want half of my 100 gold pieces right now!"}
        {MESSAGE narrator "wesnoth-icon.png" _"More Information about the Animals"  _"Faad is an experienced trapper, woodsman and, recently, tourist guide for Quank, with a lot of experience how the wild animals behave in these parts.  There are several right-click menu options available through which he will give you detailed information on what to expect from them."}

        {SOUND gold.ogg}

        [gold]
            side=1
            amount=-50
        [/gold]
    [/event]

    [event]
        name=preload
        first_time_only=no
        [lua]
            code=<<
                local _ = wesnoth.textdomain "wesnoth-Grnk"
                local old_unit_status = wesnoth.theme_items.unit_status
                function wesnoth.theme_items.unit_status()
                    local u = wesnoth.get_displayed_unit()
                    if not u then return {} end
                    local s = old_unit_status()
                    if u.status.entangled then
                        table.insert(s, { "element", {
                            image = "entangled.png",
                            tooltip = _"entangled: This unit is entangled. It cannot move but it can still attack."
                        } })
                    end
                    return s
                end
            >>
        [/lua]
    [/event]


    [event]
        name=attack end
        first_time_only=no

        [filter_attack]
            name=magical spear
        [/filter_attack]

        [unit_overlay]
            id=$second_unit.id
            image=misc/blank-hex.png~BLIT(misc/skull.png,35,0)
        [/unit_overlay]

        [modify_unit]
            [filter]
                id=$second_unit.id
            [/filter]
            [variables]
                spooked=yes
            [/variables]
        [/modify_unit]
    [/event]

    # After first Tusker attack on wolves, wolves do not attack those any more
    [event]
        name=attack end
        [filter]
            side=2
            type=Tusker
        [/filter]
        [filter_second]
            side=5
            type=Wolf
        [/filter_second]

        {SOUND wolf-die.wav}
        {MESSAGE $second_unit.id "" "" _"Yowl!

(Translation: Those tuskers are mean!  We better stay away from them and their young."}

        {MODIFY_AI_ADD_ASPECT 5 attacks (
            [facet]
                name=testing_ai_default::aspect_attacks
                id=dont_attack
                invalidate_on_gamestate_change=yes
                [filter_enemy]
                    [not]
                        type=Giant Spider,Tarantula,Bear,Dog,Tusker,Tusklet
                    [/not]
                [/filter_enemy]
            [/facet]
        )}
    [/event]

    # If a dog was attacked by a unit on Grnk's side (and there are dogs left)
    # set a variable that will cause the dog CAs to blindly attack units on
    # Grnk's side from then on
    [event]
        name=attack end
        [filter]
            side=1
        [/filter]
        [filter_second]
            side=6
            type=Dog
        [/filter_second]

        [if]
            [have_unit]
                side=6
                type=Dog
            [/have_unit]
            [then]
                {SOUND  wolf-growl-1.ogg}
                {MESSAGE $second_unit.id "" "" _"Grrrrrrwwwllll !!!"}
                {MESSAGE Faad "" "" _"We better be careful now."}
                {VARIABLE S.dogs_attacked yes}
            [/then]
        [/if]
    [/event]

    # Any animal that is killed by a unit on Grnk's side joins Grnk
    [event]
        name=last breath
        first_time_only=no
        [filter]
            side=2,3,4,5,6,7,8
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [if]
            [variable]
                name=S.units_converted_counter
                less_than=2
            [/variable]

            [then]
                [store_unit]
                    [filter]
                        id=Grnk
                    [/filter]
                    variable=S.tmp_Grnk
                [/store_unit]

                [if]
                    [variable]
                        name=S.units_converted_counter
                        equals=0
                    [/variable]

                    [then]
                        {MESSAGE Grnk "" "" _"Here we go ..."}
                    [/then]

                    [else]
                        {MESSAGE Grnk "" "" _"And number two ..."}
                    [/else]
                [/if]

                {LEADING_HALO_PRUNES Grnk}
                {VARIABLE_OP S.units_converted_counter add 1}
                {CLEAR_VARIABLE S.tmp_Grnk}
            [/then]
        [/if]

        {LEADING_HALO_PRUNES $unit.id}

        [modify_unit]
            [filter]
                id=$unit.id
            [/filter]

            side=1
            moves=0
            attacks_left=0
            hitpoints="$($unit.max_hitpoints/2)"
            overlays=misc/loyal-icon.png
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/modify_unit]

        # If this was a tusker, and there are tusklets next to them, those convert also
        [store_unit]
            [filter]
                side=2
                type=Tusklet
                [filter_adjacent]
                    id=$unit.id
                    type=Tusker
                [/filter_adjacent]
            [/filter]
            variable=S.adjacent_tusklets
        [/store_unit]

        {FOREACH S.adjacent_tusklets S.i}
            {MESSAGE $S.adjacent_tusklets[$S.i].id "" "" _"Oink!"}
            [modify_unit]
                [filter]
                    id=$S.adjacent_tusklets[$S.i].id
                [/filter]

                side=1
                moves=0
                attacks_left=0
                overlays=misc/loyal-icon.png
                [modifications]
                    {TRAIT_LOYAL}
                [/modifications]
            [/modify_unit]
        {NEXT S.i}

        [if]
            {VARIABLE_CONDITIONAL S.tusklet_message not_equals yes}
            {VARIABLE_CONDITIONAL S.adjacent_tusklets.length greater_than 0}
            [then]
                {MESSAGE Grnk "" "" _"Nice!  Looks like we're getting adjacent tusklets for free."}
                {VARIABLE S.tusklet_message yes}
            [/then]
        [/if]
        {CLEAR_VARIABLE S.adjacent_tusklets}
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            [filter_wml]
                [variables]
                    spooked=yes
                [/variables]
            [/filter_wml]
            x=1,1,57,57
            y=1,33,1,33
        [/filter]

        [kill]
            id=$unit.id
        [/kill]
    [/event]

    # Victory either when time is up, or when Grnk gets to the signpost
    [event]
        name=moveto
        [filter]
            id=Grnk
            x,y=56,21
        [/filter]

        [fire_event]
            name=end_scenario
        [/fire_event]
    [/event]

    [event]
        name=time over

        {MESSAGE Grnk "" "" _"This is all we have time for."}

        [fire_event]
            name=end_scenario
        [/fire_event]
    [/event]

    [event]
        name=end_scenario

        {MESSAGE Grnk "" "" _"Bring on them trolls now!"}

        # House cleaning
        {CLEAR_VARIABLE S}

        [endlevel]
            result=victory
            bonus=no
            carryover_add=no
            carryover_percentage=0
            carryover_report=no
            linger_mode=no
        [/endlevel]
    [/event]


    # When scout dies, this means defeat
    [event]
        name=last breath

        [filter]
            id=Faad
        [/filter]

        {MESSAGE Faad "" "" _"I should have known better than to follow a bloody mad gob..."}

        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    # Remove the menu items at end of scenario
    [event]
        name=victory

        [set_menu_item]
            id=m01_forest
            [show_if]
                [not]
                [/not]
            [/show_if]
        [/set_menu_item]

        [set_menu_item]
            id=m02_sheep
            [show_if]
                [not]
                [/not]
            [/show_if]
        [/set_menu_item]

        [set_menu_item]
            id=m03_wolves
            [show_if]
                [not]
                [/not]
            [/show_if]
        [/set_menu_item]

        [set_menu_item]
            id=m04_big
            [show_if]
                [not]
                [/not]
            [/show_if]
        [/set_menu_item]
    [/event]

    # Finally, the standard events for all or most scenarios
    {GRNK_DEATH}
[/scenario]
