#textdomain wesnoth-Grnk

[scenario]
    id=14_Submission
    name=_"Submission"
    next_scenario=null

    # Using a Part 1 map here:
    map_data="{~add-ons/Grnk/part2/maps/14_Submission.map}"

    {DEFAULT_SCHEDULE}
    {TURNS 13 15 18}
    victory_when_enemies_defeated=no

    # Sides for Part a of the scenario
    [side]
        side=1
        controller=ai
        id=Mal An
        name=Mal An
        gender=male
        unrenamable=yes
        type=Water Lich

        x,y=19,5

        team_name=undead
        user_team_name=_"The Master's Minions"
        recruit=Skeleton,Skeleton Archer

        {GOLD 175 200 225}

        [ai]
            {MODIFY_AI_ADD_CANDIDATE_ACTION 2 main_loop (
                [candidate_action]
                    engine=lua
                    name=mal_an
                    id=mal_an
                    max_score=90000
                    location="~add-ons/Grnk/lua/ca_mal_an.lua"
                [/candidate_action]
            )}
        [/ai]

        [ai]
            [avoid]
                x=1-12,1-14,1-16,1-18,1-20, 1-24
                y=   7,   8,   9,  10,  11,12-24
            [/avoid]
        [/ai]
    [/side]

    [side]
        side=2
        controller=human
        id=the goblins
        type=Peasant # Placeholder unit

        x,y=8,20

        recruit=Goblin Spearman,Orcish Grunt

        team_name=Grnk
        user_team_name=_"Grnk's Goblins"

        {GOLD 300 250 200}
    [/side]

    # Sides for Part b of the scenario
    [side]
        side=3
        controller=human
        id=Vanak
        hidden=yes

        x,y=5,20

        team_name=Vanak
        user_team_name=_"Vanak"

        {GOLD 300 250 200}
    [/side]

    [side]
        side=4
        controller=null
        no_leader=yes
        hidden=yes

        team_name=undead
        user_team_name=_"More Swamp Squatters"
        recruit=Saurian Skirmisher,Saurian Augur

        # Strongly target wood carrying orcs
        [ai]
            [goal]
                [criteria]
                    side=3

                    [filter_wml]
                        overlays={WOOD_OVERLAY}
                    [/filter_wml]
                [/criteria]

                value=100
            [/goal]
        [/ai]

        {GOLD 175 -200 225}
    [/side]

    # Sides for Part c of the scenario
    [side]
        side=5
        controller=null
        no_leader=yes
        hidden=yes

        team_name=Grnk
        user_team_name=_"Peasants"

        gold=0
        income=-2
        village_gold=0
    [/side]

    [side]
        side=6
        controller=null
        no_leader=yes
        hidden=yes

        team_name=undead
        user_team_name=_"Northern Dark Mages"

        gold=0

        # This is because the Goto MAI is supposed to affect the leader also, but has low score
        [ai]
            {MODIFY_AI_DELETE_CANDIDATE_ACTION 6 main_loop move_leader_to_keep}
        [/ai]
    [/side]

    [side]
        side=7
        controller=ai
        no_leader=yes
        hidden=yes

        team_name=bats
    [/side]

    [side]
        side=8
        controller=null
        no_leader=yes
        hidden=yes

        team_name=Grnk
    [/side]

    [event]
        name=prestart

        # Remove placeholder side leader
        [kill]
            side=2
            x=1-999
        [/kill]

        [recall]
            id=Grnk
            x,y=8,20
        [/recall]

        [modify_unit]
            [filter]
                id=Grnk
            [/filter]

            facing=nw
        [/modify_unit]

        # Disable Vanak's side for the time being
        [store_unit]
            [filter]
                id=Vanak
            [/filter]

            variable=S.stored_Vanak
            kill=yes
        [/store_unit]

        [modify_side]
            side=3
            controller=null
        [/modify_side]

        # Location of Mal An's keep in Part a
        [set_variables]
            name=S.keep_Mal_An
            [value]
                x=21
                y=6
            [/value]
        [/set_variables]

        [objectives]
            side=2
            summary=_"Objectives for Grnk"
            [objective]
                description=_"Subdue Mal An by killing him"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]
    [/event]

    [event]
        name=start

#        {MESSAGE Grnk "" "" _"Here lichy, lichy, lichy."}

        {SCROLL_TO 19 8}
        {MOVE_UNIT (id=Mal An) 21 6}

        {MESSAGE (Mal An) "" "" _"Who dares disturb ...  Oh, it's you!  Yes, we were told that you would come"}

        {SCROLL_TO 8 20}

        [modify_unit]
            [filter]
                id=Grnk
            [/filter]

            facing=ne
        [/modify_unit]

#        {MESSAGE_RIGHT Grnk _"You were?"}

#        [recall]
#            id=Grashnak
#            x,y=8,19
#        [/recall]
#        [recall]
#            id=Gort
#            x,y=9,20
#        [/recall]

        {SUREFIRE Grashnak}
        {SUREFIRE Gort}

#        {MESSAGE_RIGHT (Mal An) _"Rise, skeleton minions.  And remember, the Master wants Grnk alive!"}
    [/event]

    ######## Events for Part a of the scenario ########

    {STORE_MOVES}

    # Make all units recruited/recalled by Mal An brittle
    [event]
        name=recruit,recall
        first_time_only=no

        [filter]
            side=1
        [/filter]

        {BRITTLE $unit.id}
    [/event]

    # Give all goblins recruited/recalled by Grnk surefire
    [event]
        name=recruit,recall
        first_time_only=no

        [filter]
            side=2
            race=goblin
        [/filter]

        {SUREFIRE $unit.id}
    [/event]

    # Set the water terrain for recruiting, but only during Mal An's turn
    [event]
        name=side 1 turn refresh
        first_time_only=no

        [if]
            [have_unit]
                id=Mal An
            [/have_unit]

            [then]
                [terrain]
                    x,y=$S.keep_Mal_An.x,$S.keep_Mal_An.y
                    radius=1

                    terrain=Ww^Cw
                [/terrain]
                [terrain]
                    x,y=$S.keep_Mal_An.x,$S.keep_Mal_An.y

                    terrain=Ww^Kw
                [/terrain]
            [/then]
        [/if]
    [/event]

    [event]
        name=side 1 turn end
        first_time_only=no

        [if]
            [have_unit]
                id=Mal An
            [/have_unit]

            [then]
                [terrain]
                    x,y=$S.keep_Mal_An.x,$S.keep_Mal_An.y
                    radius=1

                    terrain=Ww
                [/terrain]
            [/then]
        [/if]
    [/event]

    [event]
        name=side 2 turn 2

        {MESSAGE_RIGHT Grnk _"Is that all you got?"}
        {MESSAGE (Mal An) "" "" _"Hah, look who's talking with his army of mighty goblins."}
        {MESSAGE_RIGHT Grnk _"Yeah, well, I've got a little surprise for you.  Or two, rather."}
        {MESSAGE narrator "wesnoth-icon.png" _"Grnk's Two Surprises for Mal An" _"Grnk's magical prowess is still improving.  His sole presence next to them now calms his fellow goblins down sufficiently they they always have a high chance of making a hit.  Conversely, he somehow manages to disturb the magical powers holding together adjacent skeletons, making any type of weapon as effective against them as an arcane attack."}
    [/event]

    [event]
        name=side 2 turn 3

        {MESSAGE_RIGHT Grnk _"Something's very fishy here."}

        [role]
            race=goblin
            [not]
                id=Grashnak,Grnk
            [/not]
            role=random_goblin
        [/role]

        [message]
            role=random_goblin
            message=_"Big lake.  Lot fish."
        [/message]

        {MESSAGE_RIGHT Grnk _"Indeed.  But not quite what I meant.
<i> </i>
If the Master knew that I was coming, how come he left Mal An with only a handful of comparatively weak skeletons?  Sure, Mal An would be arrogant enough to believe that a bunch of little goblins are easy to take care of.  But the Master knows better by now.  There is something else going on here and I have no idea what it is."}
    [/event]

    # Mal An sends units off for Parts b and c
    # This happening in Part d is very unlikely in the first place, but also made
    # impossible by making hexes (21,5) and (22,5) impassable on the Part d map.
    [event]
        name=side 1 turn refresh
        first_time_only=no

        [store_unit]
            [filter]
                side=1
                x,y=22,5
                formula = '$this_unit.moves >= 2'
            [/filter]

            variable=tmp_unit_14b
        [/store_unit]

        [if]
            [variable]
                name=tmp_unit_14b.length
                greater_than=0
            [/variable]

            [then]
                # Skeletons don't have names or random traits -> need to save type only
                [set_variables]
                    name=stored_skeletons.S14b
                    mode=append

                    [value]
                        turn_number=$turn_number
                        type=$tmp_unit_14b.type
                    [/value]
                [/set_variables]

                {MOVE_UNIT_TO_EDGE_AND_OFF_MAP $tmp_unit_14b.id 24 6 se}

                {CLEAR_VARIABLE tmp_unit_14b}
            [/then]
        [/if]

        [store_unit]
            [filter]
                side=1
                x,y=21,5
                formula = '$this_unit.moves >= 3'
            [/filter]

            variable=tmp_unit_14c
        [/store_unit]

        [if]
            [variable]
                name=tmp_unit_14c.length
                greater_than=0
            [/variable]

            [then]
                # Skeletons don't have names or random traits -> need to save type only
                [set_variables]
                    name=stored_skeletons.S14c
                    mode=append

                    [value]
                        turn_number=$turn_number
                        type=$tmp_unit_14c.type
                    [/value]
                [/set_variables]

                {MOVE_UNIT_TO_EDGE_AND_OFF_MAP $tmp_unit_14c.id 24 3 ne}

                {CLEAR_VARIABLE tmp_unit_14c}
            [/then]
        [/if]
    [/event]

    # Dark mages cut scene
    [event]
        name=side 1 turn 33

        [modify_side]
            side=2
            shroud=yes
        [/modify_side]

        [redraw]
        [/redraw]

        [store_unit]
            [filter]
                x=1-999
            [/filter]

            variable=tmp_units
            kill=yes
        [/store_unit]

        [dialog_message]
            message=_"Just then, in a place not at all far, far away ..."
        [/dialog_message]

        [replace_map]
            map="{~add-ons/Grnk/part2/maps/14c_Submission.map}"
            expand=yes
            shrink=yes
        [/replace_map]

        [remove_shroud]
            x,y=18,1
            radius=7
        [/remove_shroud]

        {DARK_MAGES}

        [place_shroud]
            x,y=10-30,0-10
        [/place_shroud]

        {MASTERS_LAIR 1 2}

        {MESSAGE (The Master) "" "" _"Is the entire world filled with idiots?!  What do those amateurs think they are doing??  Mal An is not supposed to win this battle."}
        {MESSAGE Sklaf "" "" _"Your wrath will be terrible?"}
        {MESSAGE (The Master) "" "" _"Naturally."}
        {MESSAGE (The Master) "" "" _"We cannot let those morons give away the true nature of my Plan though, so we will have to do this by other means.
<i>[Sigh]</i>
But then, what's another sacrifice for the sake of the Grand Plan?"}
        {MESSAGE Sklaf "" "" _"You truly are evil, Master.  Here's your brandy."}

        [kill]
            side=1,6
        [/kill]

        [modify_side]
            side=2
            shroud=yes
        [/modify_side]

        [redraw]
        [/redraw]

        [replace_map]
            map="{~add-ons/Grnk/part2/maps/14_Submission.map}"
            expand=yes
            shrink=yes
        [/replace_map]

        {UNSTORE_ALL_UNITS tmp_units}

        {CLEAR_VARIABLE tmp_units}

        [modify_side]
            side=2
            shroud=no
        [/modify_side]

        [redraw]
        [/redraw]

        {MESSAGE Grnk "" "" _"Did you hear something?"}

        [role]
            race=goblin
            [not]
                id=Grashnak,Grnk
            [/not]
            role=random_goblin
        [/role]

        [message]
            role=random_goblin
            message=_"What hear?"
        [/message]
    [/event]

    ######## Transition from Part a to Part b ########

    [event]
        name=moveto

        [filter]
            id=Grnk
            x,y=8,23
        [/filter]

        {MESSAGE Grnk "" "" _"I wonder where Vanak is."}

        [modify_side]
            side=2
            shroud=yes
        [/modify_side]

        [redraw]
        [/redraw]

        [dialog_message]
            message=_"While Grnk will have to wonder for a little longer,
we can show you where Vanak is."
        [/dialog_message]

        [store_unit]
            [filter]
                x=1-999
            [/filter]

            variable=S.stored_units_a
            kill=yes
        [/store_unit]

        [store_locations]
            [not]
                owner_side=0
            [/not]

            variable=S.stored_villages_a
        [/store_locations]

        [replace_map]
            map="{~add-ons/Grnk/part2/maps/14b_Submission.map}"
            expand=yes
            shrink=yes
        [/replace_map]

        [unstore_unit]
            variable=S.stored_Vanak
            x,y=22,23
        [/unstore_unit]

        {CLEAR_VARIABLE S.stored_Vanak}

        [recall]
            id=Quank
            x,y=22,22
            show=no
        [/recall]

        {UNIT 4 (Saurian Flanker) 31 11 (id,canrecruit=saurian_leader,yes)}

        # So that Side 2 units in replays can capture villages
        {UNIT 2 (Invisible Unit) 5 11 (canrecruit=yes)}

        # Set up replaying of the stored moves
        {VARIABLE S.14b_start_turn "$($turn_number-1)"}
        {REPLAY_STORED_MOVES}

        [modify_side]
            side=2
            shroud=no
        [/modify_side]

        [redraw]
        [/redraw]

        # Do not set Side 1 controller to null
        [modify_side]
            side=1
            hidden=yes
        [/modify_side]

        [modify_side]
            side=2
            controller=null
            hidden=yes
        [/modify_side]

        [modify_side]
            side=3
            controller=human
            hidden=no
        [/modify_side]

        [modify_side]
            side=4
            controller=ai
            hidden=no
        [/modify_side]

        # Remove the avoid tag for the skeletons sent in by Mal An
        [modify_ai]
            side=1
            action=delete
            path=aspect[avoid].facet[*]
        [/modify_ai]

        # Menu item for building bridge in deep water
        [set_menu_item]
            id=m01_unload
            description=_"Unload wood here"
            image=units/float.png~CROP(11,35,48,36)~SCALE(24,18)

            [filter_location]
                terrain=Wo

                [filter_adjacent_location]
                    [filter]
                        [filter_wml]
                            overlays={WOOD_OVERLAY}
                        [/filter_wml]
                    [/filter]
                [/filter_adjacent_location]

                [not]
                    [filter]
                    [/filter]
                [/not]
            [/filter_location]

            [command]
                # Find the unit that can unload
                [store_unit]
                    [filter]
                        [filter_wml]
                            overlays={WOOD_OVERLAY}
                        [/filter_wml]

                        [filter_location]
                            [filter_adjacent_location]
                                x,y=$x1,$y1
                            [/filter_adjacent_location]
                        [/filter_location]
                    [/filter]

                    variable=S.tmp_grunt
                [/store_unit]

                # Give it normal appearance and attacks back
                [remove_unit_overlay]
                    id=$S.tmp_grunt.id
                    image={WOOD_OVERLAY}
                [/remove_unit_overlay]

                [object]
                    duration=scenario
                    silent=yes
                    [filter]
                        id=$S.tmp_grunt.id
                    [/filter]

                    [effect]
                        apply_to=attack
                        attack_weight=1
                       defense_weight=1
                    [/effect]
                [/object]

                # Now check out whether this was the first unload on this hex or second.
                # This is done by looking whether there is an image set for the hex already.
                [store_items]
                    x,y=$x1,$y1
                    variable=S.loc_with_image
                [/store_items]

                [if]
                    [variable]
                        name=S.loc_with_image.length
                        equals=0
                    [/variable]

                    # If not, we place the image
                    [then]
                        [item]
                            x,y=$x1,$y1
                            image=units/float.png~CROP(1,18,72,54)
                        [/item]
                    [/then]

                    # If yes, we change the terrain to bridge
                    [else]
                        [remove_item]
                            x,y=$x1,$y1
                        [/remove_item]

                        [terrain]
                            x,y=$x1,$y1
                            terrain=Wo^Bw|r
                        [/terrain]

                        # Check whether a path to the northern shore has been established
                        [find_path]
                            [traveler]
                                id=Vanak
                            [/traveler]

                            [destination]
                                x,y=13,1
                            [/destination]

                            variable=S.tmp_path
                            allow_multiple_turns=yes
                            check_zoc=no
                        [/find_path]

                        [if]
                            [variable]
                                name=S.tmp_path.hexes
                                not_equals=0
                            [/variable]

                            [then]
                                {MESSAGE Quank "" "" _"Not the prettiest or most stable bridge I've ever seen, but it'll do."}

                                # Set variable so that village events do not fire any more
                                {VARIABLE S.bridge_built yes}

                                # All orcs still carrying wood drop their loads and can fight again
                                [store_unit]
                                    [filter]
                                        [filter_wml]
                                           overlays={WOOD_OVERLAY}
                                        [/filter_wml]
                                    [/filter]

                                    variable=S.wood_grunts
                                [/store_unit]

                                {FOREACH S.wood_grunts S.i}
                                    {MESSAGE $S.wood_grunts[$S.i].id "" "" _"$S.wood_grunts[$S.i].name drop wood."}

                                    [remove_unit_overlay]
                                        id=$S.wood_grunts[$S.i].id
                                        image={WOOD_OVERLAY}
                                    [/remove_unit_overlay]

                                    [object]
                                        duration=scenario
                                        silent=yes
                                        [filter]
                                            id=$S.wood_grunts[$S.i].id
                                        [/filter]

                                        [effect]
                                            apply_to=attack
                                            attack_weight=1
                                           defense_weight=1
                                        [/effect]
                                    [/object]
                                {NEXT S.i}

                                {CLEAR_VARIABLE S.wood_grunts,wood_taken}
                            [/then]
                        [/if]
                    [/else]
                [/if]

                {CLEAR_VARIABLE S.tmp_grunt,S.tmp_path,S.loc_with_image}
            [/command]
        [/set_menu_item]

        [objectives]
            side=3
            summary=_"Objectives for Vanak and Quank"
            [objective]
                description=_"Build a bridge and move Vanak and Quank to the northern shore"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Vanak"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Quank"
                condition=lose
            [/objective]
            [objective]
                description=_"Turns run out"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
            [note]
                description=_"Only Vanak and grunts (or their advancements) are strong enough to carry the wood."
            [/note]
            [note]
                description=_"Orcs carrying wood cannot attack or defend themselves."
            [/note]
            [note]
                description=_"To gather wood, move a unit onto the broken huts in the southwest (3 loads of wood per hut)."
            [/note]
            [note]
                description=_"Unload wood by moving the orc next to unoccupied deep water and right-clicking on the water hex."
            [/note]
            [note]
                description=_"It takes two loads of wood per hex to build a bridge."
            [/note]
        [/objectives]

        # Control is still with Side 2 at this time
        [end_turn]
        [/end_turn]
    [/event]

    ######## Events for Part b of the scenario ########

    # Bring in the skeletons Mal An sent out (it takes them 2 turns to get there)
    [event]
        name=side 1 turn end
        first_time_only=no

        [if]
            [have_unit]
                 id=Vanak
            [/have_unit]

            [not]
                [have_unit]
                     id=Grnk,peasant_leader
                [/have_unit]
            [/not]

            [variable]
                name=stored_skeletons.S14b.length
                greater_than=0
            [/variable]

            [variable]
                name=stored_skeletons.S14b[0].turn_number
                equals="$($turn_number-2-$S.14b_start_turn)"
            [/variable]

            [then]
                {SCROLL_TO 12 1}
                {MOVE_UNIT_ONTO_MAP 1 "$stored_skeletons.S14b[0].type" 12 1 s ()}
                {CLEAR_VARIABLE stored_skeletons.S14b[0]}
            [/then]
        [/if]
    [/event]

    # Grab wood from villages (grunt line or Vanak only)
    # Note that there may not be other hexes with the Rd^Vhr terrain on the map f
    # or this to work correctly
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=3
            [and]
                type=Orcish Grunt,Orcish Warrior,Orcish Warlord

                [or]
                    id=Vanak
                [/or]
            [/and]
            [filter_location]
                terrain=Rd^Vhr
            [/filter_location]
        [/filter]

        [if]
            [variable]
                name=S.bridge_built
                not_equals=yes
            [/variable]

            [then]
                [if]
                    [variable]
                        name=unit.overlays
                        equals=""
                    [/variable]

                    [then]
                        [unit_overlay]
                            id=$unit.id
                            image={WOOD_OVERLAY}
                        [/unit_overlay]

                        [object]
                            duration=scenario
                            silent=yes
                            [filter]
                                id=$unit.id
                            [/filter]

                            [effect]
                                apply_to=attack
                                attack_weight=0
                                defense_weight=0
                            [/effect]
                        [/object]

                        # Each village only yields 3 loads of wood
                        [if]
                            [variable]
                                name=wood_taken.i"$($x1*100+$y1)"
                                equals=""
                            [/variable]

                            [then]
                                {VARIABLE wood_taken.i"$($x1*100+$y1)" 1}
                            [/then]

                            [else]
                                {VARIABLE_OP wood_taken.i"$($x1*100+$y1)" add 1}
                            [/else]
                        [/if]

                        [if]
                            [variable]
                                name=wood_taken.i"$($x1*100+$y1)"
                                equals=3
                            [/variable]

                            [then]
                                {CLEAR_VARIABLE wood_taken.i"$($x1*100+$y1)"}
                                {BURN_VILLAGE $x1 $y1}
                            [/then]
                        [/if]

                        {MESSAGE_RIGHT $unit.id _"$unit.name get wood."}
                    [/then]

                    [else]
                        {MESSAGE_RIGHT $unit.id _"$unit.name no can carry more."}
                    [/else]
                [/if]
            [/then]
        [/if]
    [/event]

    # Other orcs cannot pick up the wood
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=3
            [not]
                type=Orcish Grunt,Orcish Warrior,Orcish Warlord

                [or]
                    id=Vanak
                [/or]
            [/not]
            [filter_location]
                terrain=Rd^Vhr
            [/filter_location]
        [/filter]

        [if]
            [variable]
                name=S.bridge_built
                not_equals=yes
            [/variable]

            [then]
                {MESSAGE narrator "wesnoth-icon.png" "" _"Only Vanak and orcs of the grunt line (grunts, warriors or warlards) are strong enough to pick up the wood needed for building the bridge."}
            [/then]
        [/if]
    [/event]

    ######## Transition from Part b to Part c ########

    [event]
        name=moveto

        [filter]
            id=Quank
        [/filter]

        [modify_side]
            side=3
            shroud=yes
        [/modify_side]

        [redraw]
        [/redraw]

        [dialog_message]
            message=_"At which point we switch scenes again ..."
        [/dialog_message]

        # First, need to get rid of the invisible Side 2 leader
        [kill]
            type=Invisible Unit
        [/kill]

        [store_unit]
            [filter]
                x=1-999
            [/filter]

            variable=S.stored_units_b
            kill=yes
        [/store_unit]

        [store_locations]
            [not]
                owner_side=0
            [/not]

            variable=S.stored_villages_b
        [/store_locations]

        [store_locations]
            terrain=Wo^B*

            variable=S.stored_bridges_b
        [/store_locations]

        [store_items]
            variable=S.stored_items_b
        [/store_items]

        [remove_item]
            x,y=1-99,1-99
        [/remove_item]

        [replace_map]
            map="{~add-ons/Grnk/part2/maps/14c_Submission.map}"
            expand=yes
            shrink=yes
        [/replace_map]

        [item]
            x,y=19,20
            image=misc/wood-end-se-broken.png
        [/item]
        [item]
            x,y=20,20
            image=misc/wood-rotting-se-nw-broken.png
        [/item]
        [item]
            x,y=21,21
            image=misc/wood-end-nw-broken.png
        [/item]

        [modify_side]
            side=3,4
            controller=null
            hidden=yes
        [/modify_side]

        [modify_side]
            side=5
            controller=human
            hidden=no
        [/modify_side]

        [modify_side]
            side=6
            controller=ai
            hidden=no
        [/modify_side]

        [unstore_unit]
            variable=stored_peasant_S12
            x,y=25,15
        [/unstore_unit]

        {VARIABLE S.peasant_leader_name $stored_peasant_S12.name}
        {CLEAR_VARIABLE stored_peasant_S12}

        [modify_unit]
            [filter]
                id=peasant_leader
            [/filter]

            side=5
        [/modify_unit]

        {GENERIC_UNIT 8 Boat 6 22}
        {GENERIC_UNIT 8 Boat 10 22}
        {GENERIC_UNIT 8 Boat 20 23}

        [modify_side]
            side=3
            shroud=no
        [/modify_side]

        [redraw]
        [/redraw]

        [micro_ai]
            side=6
            ai_type=goto
            action=add

            [filter_location]
                x,y=1,17-21
            [/filter_location]

            ca_score=50000
            ignore_enemy_at_goal=yes
        [/micro_ai]

        {VARIABLE S.14c_start_turn "$($turn_number-1)"}

        [objectives]
            side=5
            summary=_"Objectives for the Peasants"
            [objective]
                description=_"Prevent the dark mages from getting to Grnk until the end of turns"
                condition=win
            [/objective]
            [objective]
                description=_"Death of $S.peasant_leader_name"
                condition=lose
            [/objective]
            [objective]
                description=_"One of the dark mages makes it to the western edge of the map"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
            [note]
                description=_"Since there are no extra weapons to be found in this scenario, any peasant leveling up will simply become a (slightly) stronger peasant."
            [/note]
            [note]
                description=_"Moving a peasant onto an unowned village will result in more peasants joining you r cause."
            [/note]
            [note]
                description=_"The same is happens when moving a boat next to an unowned village."
            [/note]
        [/objectives]

        # Control is still with Side 3 at this time
        [end_turn]
        [/end_turn]

#        {DARK_MAGES}

        # Defeat if one of the dark mages makes it to the western edge of the map
        [event]
            name=moveto

            [filter]
                side=6
                x=1
            [/filter]

            # But only during Part c
            [if]
                [not]
                    [have_unit]
                        id=Grnk
                    [/have_unit]
                [/not]

                [then]
                    {MESSAGE_RIGHT $unit.id _"Now let's get rid of that damned goblin!"}

                    [endlevel]
                        result=defeat
                    [/endlevel]
                [/then]
            [/if]
        [/event]
    [/event]

    # Bring in the skeletons Mal An sent out (it takes them 1 turn to get there)
    [event]
        name=side 1 turn end
        first_time_only=no

        [if]
            [have_unit]
                 id=peasant_leader
            [/have_unit]

            [not]
                [have_unit]
                     id=Grnk,Vanak
                [/have_unit]
            [/not]

            [variable]
                name=stored_skeletons.S14c.length
                greater_than=0
            [/variable]

            [variable]
                name=stored_skeletons.S14c[0].turn_number
                equals="$($turn_number-1-$S.14c_start_turn)"
            [/variable]

            [then]
                {SCROLL_TO 1 19}
                {MOVE_UNIT_ONTO_MAP 1 "$stored_skeletons.S14c[0].type" 1 19 ne ()}
                {CLEAR_VARIABLE stored_skeletons.S14c[0]}
            [/then]
        [/if]
    [/event]

    # Peasants capturing villages results in other peasants appearing
    # and adjacent boats converting to their side
    [event]
        name=first_new_peasant

        [role]
            type=Peasant no level
            [not]
                id=peasant_leader
            [/not]
            role=new_peasant
        [/role]

        {MESSAGE peasant_leader "" "" _"Brothers, help us stop those evil mages and thus save Grnk and the world."}
        [message]
            role=new_peasant
            message=_"Why isn't Shmalltupp sending the army if it is so important?  watch out for those bats.  when's the last time you've seen a soldier come through here? too wet, too dry, crappy soil, no fish."
        [/message]
    [/event]

    [event]
        name=new_peasants
        first_time_only=no

        {RANDOM "1..2"}

        [while]
            [variable]
                name=random
                greater_than=0
            [/variable]

            [do]
                {FIND_CLOSEST_HEX $S.x1 $S.y1 (
                    [not]
                        terrain=W*,S*
                    [/not]
                    [not]
                        [filter]
                        [/filter]
                    [/not]
                )}

                [move_unit_fake]
                    type=Peasant
                    side=2
                    x=$S.x1,$hex_x
                    y=$S.y1,$hex_y
                [/move_unit_fake]

                {UNIT 5 (Peasant no level) $hex_x $hex_y (moves=0)}

                {VARIABLE_OP random add -1}
            [/do]
        [/while]

        {CLEAR_VARIABLE hex_x,hex_y,random}

        # If there is a Boat adjacent to the village, convert it to peasants' side
        [modify_unit]
            [filter]
                side=7
                type=Boat

                [filter_location]
                    [filter_adjacent_location]
                        x,y=$S.x1,$S.y1
                    [/filter_adjacent_location]
                [/filter_location]
            [/filter]

            side=5
            moves=0
        [/modify_unit]
    [/event]

    [event]
        name=capture
        first_time_only=no

        [filter]
            side=5
        [/filter]

        {VARIABLE S.x1 $x1}
        {VARIABLE S.y1 $y1}

        [fire_event]
            name=new_peasants
        [/fire_event]

        {CLEAR_VARIABLE S.x1,S.y1}

        [fire_event]
            name=first_new_peasant
        [/fire_event]
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=5
            type=Boat

            [filter_location]
                [filter_adjacent_location]
                    terrain=*^V*
                    owner_side=0
                [/filter_adjacent_location]
            [/filter_location]
        [/filter]

        [store_locations]
            terrain=*^V*

            [filter_adjacent_location]
                x,y=$x1,$y1
            [/filter_adjacent_location]

            variable=tmp_locs
        [/store_locations]

        {VARIABLE S.x1 $tmp_locs[0].x}
        {VARIABLE S.y1 $tmp_locs[0].y}

        [capture_village]
            x,y=$S.x1,$S.y1

            side=5
        [/capture_village]

        [fire_event]
            name=new_peasants
        [/fire_event]

        {CLEAR_VARIABLE tmp_locs,S.x1,S.y1}
    [/event]

    # Side 6 units destroy all villages they move onto
    [event]
        name=first_village_burn

        {MESSAGE adept_leader "" "" _"Burn that peasant scum alive!  We will demonstrate to the master that we are serious about joining him."}
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=6

            [filter_location]
                terrain=*^V*
            [/filter_location]
        [/filter]

        [fire_event]
            name=first_village_burn
        [/fire_event]

        {FIREBALL $x1 $y1 () fire.wav ()}
        {BURN_VILLAGE $x1 $y1}
    [/event]

    # The bats (this can be active at all times, since it depends on the right terrain being on the map)
    [event]
        name=side 7 turn
        first_time_only=no

        [store_time_of_day]
        [/store_time_of_day]

        [switch]
            variable=time_of_day.id

            # Bats appear at dusk
            [case]
                value=dusk

                #{DEBUG_MSG "bringing out bats"}

                [store_locations]
                    terrain=Qxu

                    [not]
                        [filter]
                        [/filter]
                    [/not]

                    variable=tmp_locs
                [/store_locations]

                {FOREACH tmp_locs i_loc}
                    {SCROLL_TO $tmp_locs[$i_loc].x $tmp_locs[$i_loc].y}

                    [unit]
                        side=7
                        type=Vampire Bat

                        x,y=$tmp_locs[$i_loc].x,$tmp_locs[$i_loc].y
                        animate=yes

                        [variables]
                            org_x=$tmp_locs[$i_loc].x
                            org_y=$tmp_locs[$i_loc].y
                        [/variables]
                    [/unit]
                {NEXT i_loc}
            [/case]

            # They start moving back at second watch
            [case]
                value=second_watch

                #{DEBUG_MSG "moving bats back in"}

                [store_unit]
                    [filter]
                        side=7
                    [/filter]

                    variable=tmp_bats
                [/store_unit]

                {FOREACH tmp_bats i_bat}
                    [modify_unit]
                        [filter]
                            id=$tmp_bats[$i_bat].id
                        [/filter]

                        goto_x=$tmp_bats[$i_bat].variables.org_x
                        goto_y=$tmp_bats[$i_bat].variables.org_y
                    [/modify_unit]
                {NEXT i_bat}
            [/case]
        [/switch]

        {CLEAR_VARIABLE time_of_day}
    [/event]

    # A bat moving back onto cave terrain disappears
    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=7

            [filter_location]
                terrain=Qxu
            [/filter_location]
        [/filter]

        [kill]
            id=$unit.id
            animate=yes
        [/kill]
    [/event]

    # If a bat attacks a dark mage
    [event]
        name=attack end

        [filter]
            side=7
        [/filter]

        [filter_second]
            side=6
        [/filter_second]

        {MESSAGE $second_unit.id "" "" _"Stupid rodent!"}

        {WHITE_MISSILE $unit.x $unit.y () dragonstick.ogg (
            [kill]
                id=$unit.id
                animate=yes
            [/kill]
        )}

        [role]
            side=6

            [not]
                id=$second_unit.id,adept_leader
            [/not]

            role=random_mage
        [/role]

        [message]
            role=random_mage
            message=_"Bat's aren't ..."
        [/message]

        {MESSAGE $second_unit.id "" "" _"Shut up!"}

        [modify_side]
            side=7

            [ai]
                [avoid]
                    [filter]
                        side=6
                    [/filter]

                    radius=2
                [/avoid]
            [/ai]
        [/modify_side]
    [/event]

    ######## Transition from Part c to Part d ########

    [event]
        name=moveto

        [filter]
            id=peasant_leader
            x,y=25,18
        [/filter]

        [modify_side]
            side=5
            shroud=yes
        [/modify_side]

        [redraw]
        [/redraw]

        [dialog_message]
            message=_"Which brings us back to ..."
        [/dialog_message]

        [store_unit]
            [filter]
                x=1-999
            [/filter]

            variable=S.stored_units_c
            kill=yes
        [/store_unit]

        [store_locations]
            [not]
                owner_side=0
            [/not]

            variable=S.stored_villages_c
        [/store_locations]

        [store_items]
            variable=S.stored_items_c
        [/store_items]

        [remove_item]
            x,y=1-99,1-99
        [/remove_item]

        [replace_map]
            map="{~add-ons/Grnk/part2/maps/14d_Submission.map}"
            expand=yes
            shrink=yes
        [/replace_map]

        {RESET_MAP c 28 0}
        {RESET_MAP b 18 27}
        {RESET_MAP a 0 15}

        [modify_side]
            side=2,3
            controller=human
            hidden=no
        [/modify_side]

        [modify_side]
            side=1,4
            controller=ai
            hidden=no
        [/modify_side]

        [modify_side]
            side=5
            shroud=no
        [/modify_side]

        [redraw]
        [/redraw]

        # Location of Mal An's keep in Part d
        [set_variables]
            name=S.keep_Mal_An
            [value]
                x=21
                y=21
            [/value]
        [/set_variables]

        # And reset the avoid tag for the new map
        [modify_side]
            side=1

            [ai]
                [avoid]
                    x=1-12,1-14,1-16,1-18,1-20, 1-24
                    y=  22,  23,  24,  25,  26,27-39
                [/avoid]
            [/ai]
        [/modify_side]

        # The dark mages now head for Grnk
        [micro_ai]
            side=6
            ai_type=goto
            action=change

            [filter_location]
                [filter]
                    id=Grnk
                [/filter]
            [/filter_location]

            ca_score=50000
            ignore_enemy_at_goal=yes
        [/micro_ai]

        [objectives]
            side=2,3,5
            summary=_"Objectives for everybody"
            [objective]
                description=_"Finish off Mal An and get rid of all dark mages"
                condition=win
            [/objective]
            [objective]
                [show_if]
                    [variable]
                        name=S.bridge_built
                        not_equals=yes
                    [/variable]
                [/show_if]
                description=_"Vanak's orcs must also finish the bridge"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Vanak"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Quank"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of $S.peasant_leader_name"
                condition=lose
            [/objective]
            [objective]
                description=_"Turns run out"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]

        # Control is still with Side 5 at this time
        [end_turn]
        [/end_turn]
        [end_turn]
        [/end_turn]

        {MESSAGE Grnk "" "" _"I wonder where Vanak is."}
        {MESSAGE Vanak "" "" _"Vanak come help little goblin."}
    [/event]
[/scenario]
