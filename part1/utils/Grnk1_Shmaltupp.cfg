#textdomain wesnoth-Grnk

#define BLACK_SCREEN_SHMALTUPP
    # Blacks out the screen, when entering buildings
    [modify_side]
        side=1
        shroud=yes
    [/modify_side]
    {REMOVE_SHMALTUPP_LABELS}
    [redraw] # Cannot use 'side=1' in here !!!
    [/redraw]
#enddef

#define RESET_SCREEN_SHMALTUPP
    # Brings the screen back
    [modify_side]
        side=1
        shroud=no
    [/modify_side]
    {SHMALTUPP_LABELS}
    {REDRAW 1}
#enddef

#define SHMALTUPP_VILLAGE_DATA X Y IMAGE
    # Insert the next data point into the 'villages' array
    [value]
        x,y,image={X},{Y},{IMAGE}
    [/value]
#enddef

#define SHMALTUPP_VILLAGES
    # Set up the villages array - tedious but simple ...
    # and put the images onto the map
    [set_variables]
        name=S2.villages
        mode=replace

        {SHMALTUPP_VILLAGE_DATA  7 14 terrain/village/human-city3.png}
        {SHMALTUPP_VILLAGE_DATA  7 13 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA  7 12 terrain/village/human-city4.png}
        {SHMALTUPP_VILLAGE_DATA  7 11 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA  7 10 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA  8  9 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA  9  9 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 10 8 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 11 8 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 12 7 terrain/village/human-city2.png}

        {SHMALTUPP_VILLAGE_DATA  9 14 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA  9 13 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA  9 12 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA  9 11 terrain/village/human-city4.png}

        {SHMALTUPP_VILLAGE_DATA 15 14 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 15 15 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 14 14 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 14 15 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 13 14 terrain/village/human-city4.png}
        {SHMALTUPP_VILLAGE_DATA 13 15 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 12 14 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 12 13 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 12 12 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 12 11 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 12 10 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 12  9 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 11 14 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 11 12 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 11 11 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 13 10 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 13  9 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 14  9 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 15 10 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 16 10 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 17 11 terrain/village/human-city.png}

        {SHMALTUPP_VILLAGE_DATA 14  6 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 15  6 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 16  5 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 17  5 terrain/village/human-city3.png}

        {SHMALTUPP_VILLAGE_DATA 16  8 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 15  8 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 16  7 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 17  7 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 18  6 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 19  7 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 19  6 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 20  6 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 20  5 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 21  6 terrain/village/human-city.png}

        {SHMALTUPP_VILLAGE_DATA 18  9 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 19  9 terrain/village/human-city4.png}
        {SHMALTUPP_VILLAGE_DATA 20  8 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 21  8 terrain/village/human-city2.png}

        {SHMALTUPP_VILLAGE_DATA 23  5 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 23  6 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 24  5 terrain/village/human-city2.png}

        {SHMALTUPP_VILLAGE_DATA 19 15 terrain/village/human-city3.png}
        {SHMALTUPP_VILLAGE_DATA 20 15 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 20 14 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 21 15 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 21 14 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 21 13 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 21 12 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 21 11 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 21 10 terrain/village/human-city3.png}
        {SHMALTUPP_VILLAGE_DATA 22 14 terrain/village/human-city-ruin4.png}
        {SHMALTUPP_VILLAGE_DATA 22 13 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 22 12 terrain/village/human-city-ruin.png}
        {SHMALTUPP_VILLAGE_DATA 22 11 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 22 10 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 23 14 terrain/village/human-city-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA 23 13 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 23 12 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 23 11 terrain/village/human-city.png}

        {SHMALTUPP_VILLAGE_DATA  7 17 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA  7 18 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA  8 16 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA  8 17 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA  8 18 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA  8 19 terrain/village/human-city-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA  8 20 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA  9 16 terrain/village/human-city3.png}
        {SHMALTUPP_VILLAGE_DATA  9 17 terrain/village/human-city-ruin.png}
        {SHMALTUPP_VILLAGE_DATA  9 18 terrain/village/human-city-ruin.png}
        {SHMALTUPP_VILLAGE_DATA  9 19 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA  9 21 terrain/village/human-city-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA 10 16 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 10 17 terrain/village/human-city-ruin3.png}
        {SHMALTUPP_VILLAGE_DATA 10 18 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 10 19 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 11 16 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 11 17 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 11 18 terrain/village/human-city4.png}
        {SHMALTUPP_VILLAGE_DATA 12 16 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 12 17 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 13 17 terrain/village/human-city2.png}

        {SHMALTUPP_VILLAGE_DATA 14 18 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 15 18 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 16 17 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 17 17 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 18 18 terrain/village/human-city-ruin.png}
        {SHMALTUPP_VILLAGE_DATA 16 20 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 17 21 terrain/village/human-city-ruin4.png}
        {SHMALTUPP_VILLAGE_DATA 19 21 terrain/village/human-city-ruin.png}
        {SHMALTUPP_VILLAGE_DATA 19 22 terrain/village/human-city-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA 20 21 terrain/village/human-city-ruin.png}

        {SHMALTUPP_VILLAGE_DATA 23  9 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 24  8 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 24  9 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 25  8 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 25  9 terrain/village/human-city-ruin.png}
        {SHMALTUPP_VILLAGE_DATA 25 10 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 26  7 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 26  8 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 27  7 terrain/village/human-city-ruin3.png}

        {SHMALTUPP_VILLAGE_DATA 22 16 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 23 17 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 23 16 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 24 17 terrain/village/human-city-ruin.png}
        {SHMALTUPP_VILLAGE_DATA 24 16 terrain/village/human-city4.png}
        {SHMALTUPP_VILLAGE_DATA 25 15 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 25 14 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 25 12 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 26 16 terrain/village/human-city-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA 26 14 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 26 13 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 26 12 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 26 11 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 27 16 terrain/village/human-city-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA 27 14 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 27 13 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 27 12 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 27 11 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 27 10 terrain/village/human-city-ruin.png}
        {SHMALTUPP_VILLAGE_DATA 28 15 terrain/village/human-city-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA 28 14 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 28 12 terrain/village/human-city-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA 28 11 terrain/village/human-city-ruin.png}
        {SHMALTUPP_VILLAGE_DATA 28 10 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 28  9 terrain/village/human-city-ruin.png}
        {SHMALTUPP_VILLAGE_DATA 29 14 terrain/village/human-city2.png}
        {SHMALTUPP_VILLAGE_DATA 29 13 terrain/village/human-city-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA 29 12 terrain/village/human-city-ruin4.png}
        {SHMALTUPP_VILLAGE_DATA 29 10 terrain/village/human-city.png}
        {SHMALTUPP_VILLAGE_DATA 29  9 terrain/village/human-city-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA 30 13 terrain/village/human-city-ruin.png}
        {SHMALTUPP_VILLAGE_DATA 30 12 terrain/village/human-city-ruin.png}

        {SHMALTUPP_VILLAGE_DATA  9 20 terrain/village/human-cottage-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA 10 20 terrain/village/human.png}
        {SHMALTUPP_VILLAGE_DATA 10 21 terrain/village/human-cottage-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA 11 21 terrain/village/human3.png}
        {SHMALTUPP_VILLAGE_DATA 11 19 terrain/village/human.png}

        {SHMALTUPP_VILLAGE_DATA 12 22 terrain/village/human-cottage-ruin.png}
        {SHMALTUPP_VILLAGE_DATA 13 23 terrain/village/human2.png}
        {SHMALTUPP_VILLAGE_DATA 13 22 terrain/village/human3.png}
        {SHMALTUPP_VILLAGE_DATA 13 21 terrain/village/human.png}
        {SHMALTUPP_VILLAGE_DATA 13 20 terrain/village/human.png}
        {SHMALTUPP_VILLAGE_DATA 14 22 terrain/village/human.png}
        {SHMALTUPP_VILLAGE_DATA 14 21 terrain/village/human3.png}
        {SHMALTUPP_VILLAGE_DATA 14 20 terrain/village/human.png}
        {SHMALTUPP_VILLAGE_DATA 14 19 terrain/village/human3.png}
        {SHMALTUPP_VILLAGE_DATA 15 23 terrain/village/human-cottage-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA 15 22 terrain/village/human2.png}
        {SHMALTUPP_VILLAGE_DATA 15 21 terrain/village/human3.png}
        {SHMALTUPP_VILLAGE_DATA 15 20 terrain/village/human.png}
        {SHMALTUPP_VILLAGE_DATA 15 19 terrain/village/human-cottage-ruin3.png}
        {SHMALTUPP_VILLAGE_DATA 16 21 terrain/village/human2.png}
        {SHMALTUPP_VILLAGE_DATA 16 19 terrain/village/human2.png}
        {SHMALTUPP_VILLAGE_DATA 16 18 terrain/village/human-cottage-ruin.png}
        {SHMALTUPP_VILLAGE_DATA 17 22 terrain/village/human.png}
        {SHMALTUPP_VILLAGE_DATA 17 20 terrain/village/human.png}
        {SHMALTUPP_VILLAGE_DATA 17 19 terrain/village/human-cottage-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA 17 18 terrain/village/human-cottage-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA 18 22 terrain/village/human.png}
        {SHMALTUPP_VILLAGE_DATA 18 21 terrain/village/human-cottage-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA 18 20 terrain/village/human-cottage-ruin3.png}
        {SHMALTUPP_VILLAGE_DATA 18 19 terrain/village/human2.png}
        {SHMALTUPP_VILLAGE_DATA 18 17 terrain/village/human-cottage-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA 19 20 terrain/village/human-cottage-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA 19 18 terrain/village/human-cottage-ruin.png}
        {SHMALTUPP_VILLAGE_DATA 20 20 terrain/village/human-cottage-ruin3.png}
        {SHMALTUPP_VILLAGE_DATA 20 19 terrain/village/human2.png}
        {SHMALTUPP_VILLAGE_DATA 20 18 terrain/village/human-cottage-ruin2.png}
        {SHMALTUPP_VILLAGE_DATA 21 20 terrain/village/human2.png}
        {SHMALTUPP_VILLAGE_DATA 21 19 terrain/village/human-cottage-ruin.png}
        {SHMALTUPP_VILLAGE_DATA 22 19 terrain/village/human.png}
        {SHMALTUPP_VILLAGE_DATA 23 22 terrain/village/human3.png}
        {SHMALTUPP_VILLAGE_DATA 23 21 terrain/village/human2.png}
        {SHMALTUPP_VILLAGE_DATA 23 20 terrain/village/human.png}
        {SHMALTUPP_VILLAGE_DATA 25 21 terrain/village/human-cottage-ruin2.png}

        {SHMALTUPP_VILLAGE_DATA 25 18 terrain/village/human.png}
        {SHMALTUPP_VILLAGE_DATA 25 17 terrain/village/human2.png}
        {SHMALTUPP_VILLAGE_DATA 25 16 terrain/village/human.png}
        {SHMALTUPP_VILLAGE_DATA 26 18 terrain/village/human2.png}
        {SHMALTUPP_VILLAGE_DATA 26 17 terrain/village/human.png}
        {SHMALTUPP_VILLAGE_DATA 27 19 terrain/village/human-cottage-ruin3.png}
        {SHMALTUPP_VILLAGE_DATA 27 18 terrain/village/human-cottage-ruin3.png}
        {SHMALTUPP_VILLAGE_DATA 27  8 terrain/village/human-cottage-ruin3.png}
        {SHMALTUPP_VILLAGE_DATA 28 16 terrain/village/human-cottage-ruin.png}
        {SHMALTUPP_VILLAGE_DATA 28 13 terrain/village/human-cottage-ruin2.png}

        {SHMALTUPP_VILLAGE_DATA 17 23 terrain/village/camp.png}
        {SHMALTUPP_VILLAGE_DATA 20 22 terrain/village/camp.png}
        {SHMALTUPP_VILLAGE_DATA 21 22 terrain/village/camp.png}
        {SHMALTUPP_VILLAGE_DATA 22 21 terrain/village/camp.png}
        {SHMALTUPP_VILLAGE_DATA 24 21 terrain/village/camp.png}
        {SHMALTUPP_VILLAGE_DATA 24 20 terrain/village/camp.png}
        {SHMALTUPP_VILLAGE_DATA 29 11 terrain/village/camp.png}

        {SHMALTUPP_VILLAGE_DATA 30 11 terrain/village/hut.png}
        {SHMALTUPP_VILLAGE_DATA 29 15 terrain/village/hut.png}
        {SHMALTUPP_VILLAGE_DATA 19 19 terrain/village/hut2.png}
        {SHMALTUPP_VILLAGE_DATA 21 21 terrain/village/hut.png}
        {SHMALTUPP_VILLAGE_DATA 22 22 terrain/village/hut.png}
        {SHMALTUPP_VILLAGE_DATA 19 23 terrain/village/hut2.png}
        {SHMALTUPP_VILLAGE_DATA 16 22 terrain/village/hut.png}
    [/set_variables]

    # Place villages on map
    {FOREACH S2.villages S2.i}
        {PLACE_IMAGE $S2.villages[$S2.i].image $S2.villages[$S2.i].x $S2.villages[$S2.i].y}
    {NEXT S2.i}
#enddef

#define PLACE_VILLAGERS_SHMALTUPP TIMES SIDE
    # Places {TIMES} number of units of side {SIDE} on the map (on villages)
    # and give them a destination to go to (to another village)
    {REPEAT {TIMES} (
        # Original location
        {RANDOM "0..$($S2.villages.length-1)"}
        {VARIABLE S2.random_i $random}
        # Goal location
        {RANDOM "0..$($S2.villages.length-1)"}
        {VARIABLE S2.random_f $random}
        # Unit type (Peasant is by far the most likely)
        {RANDOM "Peasant,Peasant,Peasant,Peasant,Peasant,Peasant,Peasant,Peasant,Peasant,Peasant,Peasant,Peasant,Peasant,Peasant,Peasant,Peasant,Peasant,Peasant,Peasant,Peasant,Peasant,Fencer,Fencer,Fencer,Fencer,Fencer,Duelist,Mage,Bowman,Bowman,Ruffian,Ruffian,Footpad,Thug,Outlaw,Bandit,Thief,Thief,Thief,Thief,Rogue,Woodsman,Woodsman,Woodsman,Poacher,Trapper,Dwarvish Fighter,Dwarvish Scout,Elvish Fighter,Goblin Spearman"}

        # Place the unit, and set goto_x and goto_y variables
        {UNIT {SIDE} $random $S2.villages[$S2.random_i].x $S2.villages[$S2.random_i].y (goto_x,goto_y,upkeep=$S2.villages[$S2.random_f].x,$S2.villages[$S2.random_f].y,0)}

        {CLEAR_VARIABLE S2.random_i,S2.random_f,random}
    )}
#enddef

#define SHMALTUPP_LABELS
    # Place all the labels
    {SET_LABEL 9 5 _"Human Army Camp"}
    {SET_LABEL 14 11 _"Onetree Park"}
    {SET_LABEL 18 9 _"STC Hospital"}
    {SET_LABEL 19 19 _"Quank's U1st Med"}
    {SET_LABEL 21 15 _"Deep Pint"}
    {SET_LABEL 21 12 _"Olders' General"}
    {SET_LABEL 27 11 _"Kram's Pub"}
#enddef

#define REMOVE_SHMALTUPP_LABELS
    # Remove all the labels
    {REMOVE_LABEL 9 5}
    {REMOVE_LABEL 14 11}
    {REMOVE_LABEL 18 9}
    {REMOVE_LABEL 19 19}
    {REMOVE_LABEL 21 15}
    {REMOVE_LABEL 21 12}
    {REMOVE_LABEL 27 11}
#enddef

#define CITY_GUARD
    # Meant to be used as a suffix to a unit-generating macro call.
    [+unit]
        ai_special=guardian
        animate=no
        role=city guard
    [/unit]
#enddef

#define SETUP_SHMALTUPP_MAP
    # Prestart event that puts all the villages and units on the map
    [event]
        name=prestart

        # Put all the village images onto the map
        # These are only images, not real villages
        {SHMALTUPP_VILLAGES}

        {SHMALTUPP_LABELS}

        # City guards
        {LOYAL_UNIT 2 (Swordsman) 16 3}{CITY_GUARD}
        {LOYAL_UNIT 2 (Pikeman) 19 4}{CITY_GUARD}
        {LOYAL_UNIT 2 (Pikeman) 10 3}{CITY_GUARD}
        {LOYAL_UNIT 2 (Swordsman) 5 6}{CITY_GUARD}
        {LOYAL_UNIT 2 (Pikeman) 5 9}{CITY_GUARD}
        {LOYAL_UNIT 2 (Spearman) 5 14}{CITY_GUARD}
        {LOYAL_UNIT 2 (Peasant) 5 16}{CITY_GUARD}
        {LOYAL_UNIT 2 (Spearman) 26 4}{CITY_GUARD}
        {LOYAL_UNIT 2 (Peasant) 28 6}{CITY_GUARD}
        {LOYAL_UNIT 2 (Peasant) 10 22}{CITY_GUARD}
        {LOYAL_UNIT 2 (Peasant) 12 23}{CITY_GUARD}
        {LOYAL_UNIT 2 (Peasant) 26 21}{CITY_GUARD}
        {LOYAL_UNIT 2 (Peasant) 28 19}{CITY_GUARD}

        # Put some villagers on the map
        {RANDOM "6..8"}
        {VARIABLE S2.number $random} # Otherwise loop will break
        {PLACE_VILLAGERS_SHMALTUPP $S2.number 4}
        {RANDOM "6..8"}
        {VARIABLE S2.number $random} # Otherwise loop will break
        {PLACE_VILLAGERS_SHMALTUPP $S2.number 5}
        {CLEAR_VARIABLE random,S2.number}

        # Put some rats out there, too
        {RANDOM "4..8"}
        {SCATTER_RATS $random}
        {CLEAR_VARIABLE random}
    [/event]
#enddef

#define KEEP_KOORZHAR_IN_PLACE
    # Need to army leader from moving
    [event]
        name=side 2 turn refresh
        first_time_only=no
        {MODIFY_UNIT id=Koorzhar moves 0}
    [/event]
#enddef

#define KEEP_RUTBURT_IN_PLACE
    # Need to keep Bandit leader from trying to move to the closest keep
    [event]
        name=side 3 turn refresh
        first_time_only=no
        {MODIFY_UNIT id=Rutburt moves 0}
    [/event]
#enddef

#define PLACE_VILLAGERS_EACH_TURN SIDE NUMBER_RANGE
    [event]
        name=side {SIDE} turn
        first_time_only=no

        {RANDOM {NUMBER_RANGE}}
        {VARIABLE S2.number $random} # Otherwise loop will break
        {PLACE_VILLAGERS_SHMALTUPP $S2.number {SIDE}}
        {CLEAR_VARIABLE random,S2.number}
    [/event]
#enddef

#define NO_ATTACKS_LEFT SIDE NO_ATTACK_PROBABILITY
    # Villager and rat units should, for the most part, not attack
    # NO_ATTACK_PROBABILITY: probability that a single unit will not attack each turn
    # Also make them allied with Grnk, so that they _never_ attack him
    [event]
        name=side {SIDE} turn refresh
        first_time_only=no

        # Make them allied with Grnk's side
        [modify_side]
            side={SIDE}
            team_name=Grnk
        [/modify_side]

        # Now take attacks away for most units
        {GET_ALL_UNITS (side={SIDE})}
        {FOREACH filtered_units S2.i}
            {RANDOM 0..99}
            {IF_VAR random less_than {NO_ATTACK_PROBABILITY} (
                [then] # No attack this turn
                    {MODIFY_UNIT id=$filtered_units[$S2.i].id attacks_left 0}
                [/then]
                [else] # Free to attack this turn
                    {MODIFY_UNIT id=$filtered_units[$S2.i].id goto_x 0}
                    {MODIFY_UNIT id=$filtered_units[$S2.i].id goto_y 0}
                [/else]
            )}
        {NEXT S2.i}
        {CLEAR_VARIABLE filtered_units,random}
    [/event]
#enddef

#define HIDE_VILLAGER_AT_GOAL
    # Take side 4 & 5 units off if when reaches its destination
    # Because of a bug(?) in Wesnoth, this needs to be done by hiding them first
    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=4,5
        [/filter]
        [filter_condition]
            {VARIABLE_CONDITIONAL x1 equals $unit.goto_x}
            {VARIABLE_CONDITIONAL y1 equals $unit.goto_y}
        [/filter_condition]
        #{DEBUG "$unit.id $unit.goto_x $unit.goto_y $x1 $y1"}

        # Should be able to do this with a [kill] right here, but there's some bug in
        # Wesnoth that interrupts the moves for other units when that is done
        # Error #2007 (E_NOT_REACHED_DESTINATION)
        # So instead, hide the unit(s), then kill it at the end of turn
        [hide_unit]
            x,y=$x1,$y1
        [/hide_unit]
    [/event]
#enddef

#define KILL_UNITS_END_SIDE_TURN SIDE
    # Side 4 & 5 units need to be killed at end of side turn (if goto_x=-999)
    # Units with goto_x=0 (who were allowed to fight) get a new goal
    # Also need to reset side team_name
    [event]
        name=side {SIDE} turn end
        first_time_only=no
        [kill]
            side={SIDE}
            [filter_wml]
                goto_x=-999
            [/filter_wml]
        [/kill]
        # Also unhide all units just in case something gets missed
        [unhide_unit]
            side={SIDE}
        [/unhide_unit]

        # Units with goto_x=0 get a new goal
        {GET_ALL_UNITS (
            side={SIDE}
            [and]
            [filter_wml]
                goto_x=0
            [/filter_wml]
            [/and]
        )}
        {FOREACH filtered_units S2.i}
            {RANDOM "0..$($S2.villages.length-1)"}
            {MODIFY_UNIT id=$filtered_units[$S2.i].id goto_x $S2.villages[$random].x}
            {MODIFY_UNIT id=$filtered_units[$S2.i].id goto_y $S2.villages[$random].y}
        {NEXT S2.i}
        {CLEAR_VARIABLE filtered_units,random}

        # Also need to reset side team_name
        [modify_side]
            side={SIDE}
            team_name=villagers{SIDE},rats
            user_team_name="Villagers"
        [/modify_side]
    [/event]
#enddef

#### Rats ########################################

#define SCATTER_RATS NUMBER
    # scatters NUMBER giant rats in the right part of the map, but not on top or
    # adjacent to an existing unit

    {SCATTER_UNITS {NUMBER} "Giant Rat" 0 (
        x=28-34
        [not]
            [filter]
            [/filter]
        [/not]
        [not]
            [filter_adjacent_location]
                [filter]
                [/filter]
            [/filter_adjacent_location]
        [/not]
    ) (
        side=6
        random_traits=yes
    )}

    # It is possible that this process places rats on the recall list,
    # if they are on top of each other or something -> kill those
    [kill]
        side=6
        [not]  # somehow 'x=recall' does not work here
            x=1-99
        [/not]
    [/kill]
#enddef

#define NEW_RAT RAT_PROBABILITY
    # At beginning of turn, there is a {RAT_PROBABILITY} chance of 1-5 new rats
    # If there are fewer than 6 there already
    [event]
        name=side 6 turn
        first_time_only=no

        {COUNT_UNITS (side=6)}
        {IF_VAR unit_count less_than 6 (
            [then]
                {RANDOM "0..99"}
            [/then]
            [else]
                {VARIABLE random 100}
            [/else]
        )}
        {CLEAR_VARIABLE unit_count}
        {IF_VAR random less_than {RAT_PROBABILITY} (
            [then]
                {RANDOM "1..5"}
                {SCATTER_RATS $random}
                #{DEBUG _"New rat"}
            [/then]
        )}
        {CLEAR_VARIABLE random}
    [/event]
#enddef

#define RATS_RANDOM_WANDER
    # Rats move erratically
    # Reset goal at the beginning of each turn
    [event]
        name=side 6 turn refresh
        first_time_only=no

        {GET_ALL_UNITS (side=6)}
        {FOREACH filtered_units S2.i}
            {RANDOM "28..34"}
            {MODIFY_UNIT id=$filtered_units[$S2.i].id goto_x $random}
            {RANDOM "1..25"}
            {MODIFY_UNIT id=$filtered_units[$S2.i].id goto_y $random}
            #{DEBUG "$S2.i id=$filtered_units[$S2.i].id $filtered_units[$S2.i].x $filtered_units[$S2.i].y $random"}
        {NEXT S2.i}
        {CLEAR_VARIABLE filtered_units,random}
    [/event]
#enddef

#define REMOVE_RAT REMOVE_PROBABILITY
    # At end of turn, each rat has a REMOVE_PROBABILITY chance of disappearing
    # Also kill any rat that has 4 or fewer hitpoints (so that Grnk cannot rely on ranged weapon)
    #
    # Previously: At end of turn, there is a {REMOVE_PROBABILITY} chance of rat disappearing,
    # if there are at least 2 left
    #
    # Also need to reset side to not be allied with Grnk
    [event]
        name=side 6 turn end
        first_time_only=no

        {GET_ALL_UNITS (side=6)}
        {FOREACH filtered_units S2.i}
            {RANDOM 0..99}
            [if]
                {VARIABLE_CONDITIONAL random less_than {REMOVE_PROBABILITY}}
                [or]
                    {VARIABLE_CONDITIONAL filtered_units[$S2.i].hitpoints less_than 5}
                [/or]
                [then] # No attack this turn
                    [kill]
                        id=$filtered_units[$S2.i].id
                    [/kill]
                [/then]
            [/if]
        {NEXT S2.i}
        {CLEAR_VARIABLE filtered_units,random}

        # This is how it was done before
        #{COUNT_UNITS (side=6)}
        #{IF_VAR unit_count greater_than 1 (
        #    [then]
        #        {RANDOM "0..99"}
        #    [/then]
        #    [else]
        #        {VARIABLE random 100}
        #    [/else]
        #)}
        #{CLEAR_VARIABLE unit_count}
        #{IF_VAR random less_than {REMOVE_PROBABILITY} (
        #    [then]
        #        {GET_RANDOM_UNIT_ID (side=6)}
        #        #{DEBUG _"Remove rat: $random_unit_id"}
        #        [kill]
        #            id=$random_unit_id
        #        [/kill]
        #        {CLEAR_VARIABLE random_unit_id}
        #    [/then]
        #)}

        # Also need to reset side team_name
        [modify_side]
            side=6
            team_name=rats
            user_team_name="Rats"
        [/modify_side]
    [/event]
#enddef

#### Misc ########################################

#define SPEECH_ABOUT_HEALING SPEAKER
    {IF_VAR Shmaltupp.talked_about_healing not_equals yes (
        [then]   # First time Rutburt or Koorzhar tell Grnk to get healed
            {MESSAGE {SPEAKER} "" "" _"Great! But there's one more thing. We cannot afford to take somebody with us who is not in perfect health. You need to get yourself all healed first."}
            {MESSAGE {SPEAKER} "" "" _"There are two medical establishments in town. Shmaltupp City Hospital is a bit pricey, but very reliable. Then there's Quank's U1st Med. Quank's an interesting character, but in spite of his appearance, he generally knows what he's doing. He's much cheaper than STCH, but he isn't particularly careful. Occasionally a patient gets poisoned. And don't expect any refunds if that happens!"}

            {VARIABLE Shmaltupp.talked_about_healing yes}
        [/then]
        [else]   # Second time and after
            {MESSAGE {SPEAKER} "" "" _"Great! Get yourself all healed and we can take off right away."}
        [/else]
    )}
#enddef

#define HEALING_OPTION SECOND_SPEAKER IMAGE GOLD_PER_HP POISON_PROBABILITY
    # The message option for getting healed at STCH or Quank's
    [show_if]
        {VARIABLE_CONDITIONAL unit.hitpoints less_than $unit.max_hitpoints}
    [/show_if]
    message=_"I would like to be healed."
    [command]
        {VARIABLE S2.heal_amount 0}
        {VARIABLE S2.str "How many hitpoints would you like restored?"}
        {VARIABLE S2.max_heal "$($unit.max_hitpoints-$unit.hitpoints)"}

        # Input loop - eliminating invalid inputs
        [while]
            {VARIABLE_CONDITIONAL S2.heal_amount less_than 1}
            [or]
                {VARIABLE_CONDITIONAL S2.heal_amount greater_than $S2.max_heal}
            [/or]
            [do]
                [message]
                    speaker=narrator
                    caption={SECOND_SPEAKER}
                    image={IMAGE}
                    message=$S2.str
                    [text_input]
                        label=_"Number of hitpoints to be restored [1-$S2.max_heal]:"
                        variable=S2.heal_amount
                    [/text_input]
                [/message]
                {VARIABLE S2.str _"That input [$S2.heal_amount] does not make sense"}
            [/do]
        [/while]

        # Cost of healing
        {VARIABLE S2.heal_cost "$($S2.heal_amount*{GOLD_PER_HP})"}
        {VARIABLE_OP S2.heal_cost round ceil}
        {MESSAGE narrator {IMAGE} {SECOND_SPEAKER} _"Absolutely. That will be $S2.heal_cost gold."}
        {IF_VAR Grnks_gold greater_than_equal_to $S2.heal_cost (
            [then]
                {SOUND gold.ogg}
                {MESSAGE Grnk "" "" _"Here it is."}
                {CHANGE_BOTH_GOLDS 1 -$S2.heal_cost}
                {SOUND heal.wav}
                {MODIFY_UNIT id=Grnk hitpoints "$($unit.hitpoints+$S2.heal_amount)"}
            [/then]
            [else]
                {MESSAGE Grnk "" "" _"I do not have that much gold. I'll have to pass for now."}
            [/else]
        )}

        # If this is at Quank's, there's a chance of getting poisoned
        # Set POISON_PROBABILITY=0 for STC to avoid this
        #   -- don't show dialog if already poisoned
        {RANDOM 0..99}
        [if]
            {VARIABLE_CONDITIONAL unit.status.poisoned not_equals yes}
            {VARIABLE_CONDITIONAL random less_than {POISON_PROBABILITY}}
            [then]
                {DELAY 500}
                {SOUND poison.ogg}
                {MESSAGE Grnk "" "" _"What just happened? I feel very weak."}
                {MESSAGE narrator {IMAGE} {SECOND_SPEAKER} _"What do you mean? Everything looks fine to me. In any case, we have a strict no-refund policy. I must be leaving now. Good-bye."}
                {MODIFY_UNIT id=Grnk status.poisoned yes}
                {VARIABLE S2.poisoned_by_Quank yes}
            [/then]
        [/if]

        {CLEAR_VARIABLE S2.str,S2.heal_amount,S2.max_heal,S2.heal_cost,S2.second_speaker,random}
#enddef

#define LEAVE_ON_WOLF_HUNT
    # Needed twice at Quanks, therefore made it a macro
    {VARIABLE Shmaltupp.cart_rented yes}
    {VARIABLE S2.cart_rented_right_now yes}

    {MESSAGE narrator "$S2.quank_portrait" "Quank" _"Very good. Go outside then, the driver is already waiting for you. The two of you should be a good fit, he is almost as insane as you."}

    # Store hitpoints and poison status
    {STORE_UNIT_VAR id=Grnk hitpoints Grnk_hitpoints_for_hunt}
    {STORE_UNIT_VAR id=Grnk status.poisoned Grnk_poisoned_for_hunt}
    #{DEBUG "Status for S6: $Grnk_hitpoints_for_hunt $Grnk_poisoned_for_hunt"}

    # Remove the cage receipt from the inventory
    {REMOVE_INVENTORY_ITEM cage}

    [endlevel]
        result=victory
        next_scenario=06_Hunting
        carryover_report=no
        bonus=no
        carryover_add=yes
        carryover_percentage=100
        linger_mode=no
    [/endlevel]
#enddef

#define ASSASSIN_OPTIONS
    [message]
        speaker=Grnk
        [option]
            [show_if]
                {VARIABLE_CONDITIONAL Grnks_gold less_than $Money.healing_potion_cost}
            [/show_if]
            message=_"I don't have enough money for either potion."
        [/option]
        [option]
            [show_if]
                {VARIABLE_CONDITIONAL Grnks_gold greater_than_equal_to $Money.healing_potion_cost}
                {VARIABLE_CONDITIONAL Shmaltupp.healing_potion not_equals yes}
            [/show_if]
            message=_"I take the healing potion for $Money.healing_potion_cost gold."
            [command]
                {SOUND gold.ogg}
                {MESSAGE Assassin "" "" _"Here you are."}
                {CHANGE_BOTH_GOLDS 1 -$Money.healing_potion_cost}
                {VARIABLE Shmaltupp.healing_potion yes}
                {ADD_INVENTORY_ITEM "healing potion, light blue" "healing_potion"}
                {SET_MENU_HEALING}
            [/command]
        [/option]
        [option]
            [show_if]
                {VARIABLE_CONDITIONAL Grnks_gold greater_than_equal_to $Money.poison_cost}
                {VARIABLE_CONDITIONAL Shmaltupp.assassin_poison not_equals yes}
            [/show_if]
            message=_"I take the poison for $Money.poison_cost gold."
            [command]
                {SOUND gold.ogg}
                {MESSAGE Assassin "" "" _"Here you are. And may I suggest that you are extremely careful with it. It is not to be used lightly. That would be very unprofessional."}
                {CHANGE_BOTH_GOLDS 1 -$Money.poison_cost}
                {VARIABLE Shmaltupp.assassin_poison yes}
                {ADD_INVENTORY_ITEM "assassin poison, very nasty color" "assassin_poison"}
                {POISON_ATTACK (id=Grnk)}
            [/command]
        [/option]
        [option]
            [show_if]
                {VARIABLE_CONDITIONAL Grnks_gold greater_than_equal_to "$($Money.poison_cost+$Money.healing_potion_cost)"}
                {VARIABLE_CONDITIONAL Shmaltupp.healing_potion not_equals yes}
                {VARIABLE_CONDITIONAL Shmaltupp.assassin_poison not_equals yes}
            [/show_if]
            message=_"I take both for $($Money.poison_cost+$Money.healing_potion_cost) gold."
            [command]
                {SOUND gold.ogg}
                {MESSAGE Assassin "" "" _"Here you are. And may I suggest that you are extremely careful with the poison. It is not to be used lightly, that would be very unprofessional."}
                {CHANGE_BOTH_GOLDS 1 -"$($Money.poison_cost+$Money.healing_potion_cost)"}
                {VARIABLE Shmaltupp.healing_potion yes}
                {ADD_INVENTORY_ITEM "healing potion, light blue" "healing_potion"}
                {SET_MENU_HEALING}
                {VARIABLE Shmaltupp.assassin_poison yes}
                {ADD_INVENTORY_ITEM "assassin poison, very nasty color" "assassin_poison"}
                {POISON_ATTACK (id=Grnk)}
            [/command]
        [/option]
        [option]
            [show_if]
                {VARIABLE_CONDITIONAL Grnks_gold greater_than_equal_to $Money.healing_potion_cost}
            [/show_if]
            message=_"I'm not interested in anything from you."
        [/option]
    [/message]

    [if]
        {VARIABLE_CONDITIONAL Shmaltupp.healing_potion not_equals yes}
        [or]
            {VARIABLE_CONDITIONAL Shmaltupp.assassin_poison not_equals yes}
        [/or]
        [then]
            {IF_VAR Shmaltupp.met_at_22_22 not_equals yes (
                [then]
                    {MESSAGE Assassin "" "" _"In case you want to do business in the future, come to the straw hut at 22,22 (very easy to remember!). I will find you there. But only at night, I do not like to be seen by certain people."}
                [/then]
                [else]
                    {MESSAGE Assassin "" "" _"You can meet me right here again, at night, if there is anything else I can do for you."}
                [/else]
            )}
            [store_unit]
                [filter]
                    id=Assassin
                [/filter]
                variable=Shmaltupp.stored_assassin
                kill=yes
            [/store_unit]
        [/then]
        [else]
            {MESSAGE Assassin "" "" _"It was a pleasure doing business with you. Rest assured that you will never hear from me again."}
            [kill]
                id=Assassin
            [/kill]
            {VARIABLE Shmaltupp.assassin_appeared gone}
            {CLEAR_VARIABLE Shmaltupp.stored_assassin,Shmaltupp.met_at_22_22}
        [/else]
    [/if]

#enddef
