#textdomain wesnoth-Grnk

[scenario]
    id=13_Wizards
    name=_"Wizards"
    next_scenario=null

    map_data="{~add-ons/Grnk/part1/maps/13_Wizards.map}"

    {TURNS 12 10 9}
    # Set schedule so that Grnk appears at the same time of day
    # at which he left the previous scenario; he appears when the
    # (initial) turns runs out.
    [event]
        name=prestart

        [store_turns]
        [/store_turns]
        {VARIABLE add_turns "$(18-$turns)"}

        {REPLACE_SCHEDULE $add_turns}

        {CLEAR_VARIABLE turns,add_turns}
    [/event]

    victory_when_enemies_defeated=no

    {GRNK_STORY_13}

    [side]
        side=1
        controller=human
        id=Grossauba
        name=_"Grossauba"
        type=Great Mage

        gender=male
        unrenamable=yes

        team_name=wizards
        user_team_name=_"Hynderwlt Mages"

        recruit=Mage,Red Mage,White Mage,Arch Mage,Silver Mage,Mage of Light

        {GOLD 711 611 511}
    [/side]

    [side]
        side=2
        controller=ai
        id=Mal An

        team_name=undead
        user_team_name=_"Undead"
        persistent=yes
        save_id=Mal An

        recruit=Skeleton,Skeleton Archer,Deathblade,Revenant,Bone Shooter

        {GOLD 833 1033 1233}

        [ai]
            aggression=1.0
            caution=0.0
            village_value=0.0
            scout_village_targeting=0.0
            villages_per_scout=0.0

            # Mal An's units will target Grnk, not Rutburt or the peasants
            [goal]
                [criteria]
                    side=1
                [/criteria]
                value=100.0
            [/goal]
            [goal]
                [criteria]
                    side=4,7
                [/criteria]
                value=1.0
            [/goal]
        [/ai]
    [/side]
    # Mal An can recruit one Level 2 undead unit per turn
    {ONE_RECRUIT_PER_TURN 2 (Deathblade,Revenant,Bone Shooter)}

    # Change scenario, this side is not needed any more;
    # keep it for now, just in case I want to revive the respective events later
    # Just change colors of other sides
    [side]
        side=3
        controller=null
        id=Vanak
        hidden=yes

        team_name=wizards
        user_team_name=_"Hynderwlt Mages"
        persistent=yes
        save_id=Vanak

        gold=0
    [/side]

    [side]
        side=4
        controller=null
        hidden=yes

        team_name=undead
        user_team_name=_"Undead"
        persistent=yes
        save_id=Rutburt
        color=3

        recruit=Thug,Poacher,Footpad,Trapper,Bandit,Outlaw

        gold=0

        [ai]
            aggression=1.0
            caution=0.0
            village_value=0.0
            scout_village_targeting=0.0
            villages_per_scout=0.0

            # Want Rutburt to go for Grnk et al., not Peasants
            [goal]
                [criteria]
                    side=1
                [/criteria]
                value=100.0
            [/goal]
            [goal]
                [criteria]
                    side=7
                [/criteria]
                value=1.0
            [/goal]
        [/ai]
    [/side]
    # Rutburt can recruit one Level 2 unit per turn
    {ONE_RECRUIT_PER_TURN 4 (Trapper,Bandit,Outlaw)}

    [side]
        side=5
        controller=null
        hidden=yes

        team_name=undead
        user_team_name=_"Undead"
        persistent=yes
        save_id=Koorzhar
        color=4

        recruit=Bowman,Spearman,Longbowman,Javelineer,Pikeman,Swordsman

        gold=0

        [ai]
            aggression=1.0
            caution=0.0
            village_value=0.0
            scout_village_targeting=0.0
            villages_per_scout=0.0
        [/ai]
    [/side]
    # Koorzhar can recruit one Level 2 unit every other turn
    # His L2 units are too strong compared to Rutburt's for doing it every turn
    {ONE_RECRUIT_EVERY_OTHER_TURN 5 (Longbowman,Javelineer,Pikeman,Swordsman)}

    [side]
        side=6
        controller=null
        hidden=yes

        team_name=undead
        user_team_name=_"Undead"
        persistent=yes
        save_id=Karcyn
        color=5

        # Karcyn can recruit orcs and undead up to L2 in this scenario
        recruit=Orcish Grunt,Orcish Archer,Orcish Assassin,Orcish Warrior,Orcish Crossbowman,Orcish Slayer,Skeleton,Skeleton Archer,Deathblade,Revenant,Bone Shooter

        gold=0

        [ai]
            aggression=1.0
            caution=0.0
            village_value=0.0
            scout_village_targeting=0.0
            villages_per_scout=0.0
        [/ai]
    [/side]
    # Karcyn can recruit one Level 2 undead unit per turn
    {ONE_RECRUIT_PER_TURN 6 (Orcish Warrior,Orcish Crossbowman,Orcish Slayer,Deathblade,Revenant,Bone Shooter)}

    # Peasants
    [side]
        side=7
        controller=null
        no_leader=yes
        hidden=yes

        team_name=wizards
        user_team_name=_"Hynderwlt Mages"
        color=6

        gold=0
        income=-2

        [ai]
            aggression=1.0
            caution=0.0

            # They are mostly after Koorzhar
            [goal]
                [criteria]
                    side=4
                [/criteria]
                value=100.
            [/goal]
        [/ai]
    [/side]

    [event]
        name=prestart

        # Mal An's units get carried over in variables
        # Need to clear the recall list
        [kill]
            side=2,3
            [not]
                id=Mal An
            [/not]
        [/kill]

        # Mal An's guardians
        {UNIT 2 "Bone Shooter" 19 31 id,ai_special=skeleton1,guardian}
        {UNIT 2 "Skeleton" 21 31 id,ai_special=skeleton2,guardian}
        {UNIT 2 "Revenant" 22 30 id,ai_special=skeleton3,guardian}
        {UNIT 2 "Skeleton" 26 28 id,ai_special=skeleton4,guardian}
        {UNIT 2 "Banebow" 31 29 id,ai_special=skeleton5,guardian}

        # The different ways to play through S8 might leave to very different
        # gold amounts and recall lists for Rutburt & Koorzhar
        # Need to level that to some extent
        # Gold:
        {SET_GOLD 4 0}
        {SET_GOLD 5 0}
        {SET_GOLD 6 0}

        # Then set them to the correct amount for the scenario
        [gold]
            side=4
            {QUANTITY amount 398 398 398}
        [/gold]
        [gold]
            side=5
            {QUANTITY amount 413 513 613}
        [/gold]
        [gold]
            side=6
            {QUANTITY amount 607 707 807}
        [/gold]

        # The Rutburt AI will happily recall all the weak units rather than recruiting strong ones
        # -> kill all L0, L1 units with less than 20 XP (except stonehand)
        [store_unit]
            [filter]
                side=4
                type=Ruffian,Thug,Poacher,Footpad
                [not]
                    id=$stored_stonehand.id
                [/not]
            [/filter]

            variable=tmp_units
        [/store_unit]

        {FOREACH tmp_units i_u}
            {IF_VAR tmp_units[$i_u].experience less_than 21 (
                [then]
                    [kill]
                        id=$tmp_units[$i_u].id
                    [/kill]
                [/then]
            )}
        {NEXT i_u}
        {CLEAR_VARIABLE tmp_units}

        # If we end S8 with Koorzhar, we killed all of Rutburt's strong units
        # -> give him some artificially (1 of each L3 unit)
        [if]
            [not]
                [have_unit]
                    side=4
                    type=Huntsman
                    search_recall_list=yes
                [/have_unit]
            [/not]

            [then]
                {GENERIC_UNIT 4 Huntsman recall recall}
            [/then]
        [/if]

        [if]
            [not]
                [have_unit]
                    side=4
                    type=Ranger
                    search_recall_list=yes
                [/have_unit]
            [/not]

            [then]
                {GENERIC_UNIT 4 Ranger recall recall}
            [/then]
        [/if]

        [if]
            [not]
                [have_unit]
                    side=4
                    type=Highwayman
                    search_recall_list=yes
                [/have_unit]
            [/not]

            [then]
                {GENERIC_UNIT 4 Highwayman recall recall}
            [/then]
        [/if]

        # Ally and enemy sides (originally, Rutburt is an enemy, later ally)
        {VARIABLE S13.ally_sides "1,3,7"}
    [/event]

    [event]
        name=start

        [dialog_message]
            message=_"Not long before that"
        [/dialog_message]

        {MESSAGE "Mal An" "" "" _"Skeleton guardians, hide in the river. If my army in the south has not captured that goblin yet, they will chase him out this way shortly. Either way, we'll be ready."}

        {MOVE_UNIT id=skeleton1 20 33}
        {MOVE_UNIT id=skeleton2 23 34}
        {MOVE_UNIT id=skeleton3 24 31}
        {MOVE_UNIT id=skeleton4 27 30}
        {MOVE_UNIT id=skeleton5 30 30}

        {MESSAGE "Mal An" "" "" _"And remember, the Master wants that goblin alive."}
        {MESSAGE Grossauba "" "" _"As annoying as Wyssauba is, he's right that this undead uprising must be stopped. Wizards of Hynderwlt, ready your staffs! We need to secure the area south of the river for Wyssauba and Grnk's arrival. If they make it this far, they'll have plenty of skeletons on their tail."}

        {HIGHLIGHT_LABEL 26 35 _"Secure this area"}

        {NARRATOR_GRAY _"Limited Number of High Level Mages" _"The Hynderwlt mages are a powerful order, but high level mages are still few and far between. They are also rather resistant to being told what to do. Thus, Grossauba can only recruit one Level-3 mage and two Level-2 mages total in this scenario."}

        [objectives]
            side=1
            summary=_"<span color='#A050A0'>Secure The Area South Of Latzie River For Wyssauba And Grnk's Arrival</span>"
            [objective]
                description=_"Keep the undead occupied and eliminate as many of them as possible"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grossauba"
                condition=lose
            [/objective]
            [note]
                description=_"Grnk et al. will arrive when turns run out. The time limit will be extended then."
            [/note]
            {IS_LAST_SCENARIO}
        [/objectives]
    [/event]

    # If Mal An has >=30 gold, he will never come out of his keep
    # This is so that it is not possible to draw him out with the Gryphons
    [event]
        name=side 2 turn refresh
        first_time_only=no

        [store_gold]
            side=2
        [/store_gold]
        {IF_VAR gold greater_than 30 (
            [then]
                {MODIFY_UNIT (id=Mal An) moves 0}
            [/then]
        )}
        {CLEAR_VARIABLE gold}
    [/event]

    # Set water terrain for Mal An to recruit, same as previously
    [event]
        name=side 2 turn refresh
        first_time_only=no

        {MODIFY_TERRAIN Ww^Kw 16 30}
        {MODIFY_TERRAIN Ww^Cw 16,16,17,17 29,31,30,31}
    [/event]

    [event]
        name=side 2 turn end
        first_time_only=no

        {MODIFY_TERRAIN Ww 16,16,16,17,17 29,30,31,30,31}
    [/event]

    # Grossauba can recruit one Level 3 mage, and 2 Level 2 mages
    [event]  # Only 1 Level 3 mage
        name=recruit

        [filter]
            side=1
            type=Arch Mage,Silver Mage,Mage of Light
        [/filter]

        [disallow_recruit]
            side=1
            type=Arch Mage,Silver Mage,Mage of Light
        [/disallow_recruit]
    [/event]

    [event]  # Only 2 Level 2 mages - first
        name=recruit

        [filter]
            side=1
            type=Red Mage,White Mage
        [/filter]

        [event]  # Only 2 Level 2 mages - second
            name=recruit

            [filter]
                side=1
                type=Red Mage,White Mage
            [/filter]

            [disallow_recruit]
                side=1
                type=Red Mage,White Mage
            [/disallow_recruit]
        [/event]
    [/event]

    # Event: Skeleton guardians can go free after they are drawn out
    # Also change their id, so that this event does not trigger every time they move afterward
    [event]
        name=moveto
        first_time_only=no

        [filter]
            id=skeleton1,skeleton2,skeleton3,skeleton4,skeleton5
        [/filter]

        # need to reset both ai_special and status together; also change the id
        [store_unit]
            [filter]
                id=$unit.id
            [/filter]

            variable=tmp_skeleton
        [/store_unit]

        {VARIABLE tmp_skeleton.id mod_$unit.id}
        {VARIABLE tmp_skeleton.ai_special ""}
        {VARIABLE tmp_skeleton.status.guardian no}
        [unstore_unit]
            variable=tmp_skeleton
        [/unstore_unit]

        {CLEAR_VARIABLE tmp_skeleton}
    [/event]

    # Event: get the gryphons out
    [event]
        name=turn 4

        {FOREACH stored_gryphons i_u}
            {VARIABLE stored_gryphons[$i_u].side 1}
            {VARIABLE stored_gryphons[$i_u].moves $stored_gryphons[$i_u].max_moves}
            {VARIABLE stored_gryphons[$i_u].x "$($stored_gryphons[$i_u].x+18)"}
            {VARIABLE stored_gryphons[$i_u].y 36}
            [unstore_unit]
                variable=stored_gryphons[$i_u]
                find_vacant=yes
            [/unstore_unit]
        {NEXT i_u}
        {CLEAR_VARIABLE stored_gryphons}

        {MESSAGE gryphon1 "" "" _"Kraahhh!!!!"}
        {MESSAGE Grossauba "" "" _"Gryphons of the High Plains, join us in our fight against the undead."}
        {MESSAGE gryphon1 "" "" _"We do not like the undead, but you are allied with that mad goblin. He does not have a good name among gryphons."}
        {MESSAGE Grossauba "" "" _"I understand. I've heard the stories, but it sounds to me that he acted out of desperation at the time. I will give you my word that I will smite anybody personally who attempts to ride a gryphon here."}
        {MESSAGE gryphon1 "" "" _"Anybody?"}
        {MESSAGE Grossauba "" "" _"Anybody."}
        {MESSAGE gryphon1 "" "" _"We have heard good things about you, Grossauba. We believe that we can trust you. We will help you. However, we will not attack that Water Lich himself."}
        {MESSAGE Grossauba "" "" _"Thank you and understood. Your help will be most valuable. Now, to get started, there are skeletons hidden in the river in front of you. We need to draw them out before Wyssauba and Grnk arrive, but I am not sure that we can make it there in time. Maybe you ..."}
        {MESSAGE gryphon1 "" "" _"Say no more."}
    [/event]

    # Gryphons never attack Mal An himself
    [event]
        name=gryphon_message_mal_an

        {MESSAGE_RIGHT $unit.id _"We told you that we would not do this!"}
        {MESSAGE Grossauba "" "" _"Right. I had forgotten. Please accept my apologies."}
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            type=Gryphon
            [filter_adjacent]
                id=Mal An
            [/filter_adjacent]
        [/filter]

        [store_unit]
            [filter]
                id=Mal An
            [/filter]

            variable=tmp_unit
        [/store_unit]

        {FAR_EMPTY_HEX $tmp_unit.x $tmp_unit.y () 2}

        {MOVE_UNIT (id=$unit.id) $hex_x $hex_y}

        [fire_event]
            name=gryphon_message_mal_an

            [primary_unit]
                id=$unit.id
            [/primary_unit]
        [/fire_event]

        {CLEAR_VARIABLE tmp_unit,hex_x,hex_y}
    [/event]

    # When time is up: Grnk et al. appear
    [event]
        name=time over

        [modify_turns]
            value=-1
        [/modify_turns]

        {REMOVE_LABEL 26 35}

        {FOREACH units_for_S13 i_u}
            {VARIABLE units_for_S13[$i_u].side 1}
            {VARIABLE units_for_S13[$i_u].moves $units_for_S13[$i_u].max_moves}
            # All of these are lead units (except the prune cart), but they cannot recruit in this scenario:
            {VARIABLE units_for_S13[$i_u].canrecruit no}

            {IF_VAR units_for_S13[$i_u].id equals prune_cart (
                [then]
                    {VARIABLE units_for_S13[$i_u].overlays ""}
                [/then]

                [else]
                    {VARIABLE units_for_S13[$i_u].overlays misc/hero-icon.png}
                [/else]
            )}

            # Also make them all loyal
            {VARIABLE units_for_S13[$i_u].upkeep loyal}
            {CLOSE_EMPTY_HEX 26 36 () 0}
            [move_unit_fake]
                type=$units_for_S13[$i_u].type
                side=1
                x=26,$hex_x
                y=36,$hex_y
            [/move_unit_fake]
            [unstore_unit]
                variable=units_for_S13[$i_u]
                x,y=$hex_x,$hex_y
                find_vacant=yes
            [/unstore_unit]
        {NEXT i_u}
        {CLEAR_VARIABLE units_for_S13,hex_x,hex_y}

        {MESSAGE Wyssauba "" "" _"Let's get rid of the cart."}
        {MESSAGE Grnk "" "" _"But we ..."}
        {MESSAGE Wyssauba "" "" _"I told you why you had to do this. It's served its purpose.
<i> </i>
Driver, get off and stand back!"}

        {STORE_UNIT_VAR id=prune_cart x cart_x}
        {STORE_UNIT_VAR id=prune_cart y cart_y}
        {CLOSE_EMPTY_HEX 26 36 () 1}
        [move_unit_fake]
            type=Thug
            side=1
            x=$cart_x,$hex_x
            y=$cart_y,$hex_y
        [/move_unit_fake]
        {UNIT 1 Thug $hex_x $hex_y id=driver}

        {MESSAGE Grnk "" "" _"Wait! Let me get some more prunes first."}
        {MESSAGE Wyssauba "" "" _"But they are just ..."}
        {MESSAGE Grnk "" "" _"I heard what you said, but I don't know how else to do my magic."}

        # Move Grnk on and off cart
        [store_unit]
            [filter]
                id=Grnk
            [/filter]

            variable=tmp_Grnk
            kill=yes
        [/store_unit]

        [move_unit_fake]
            type=$tmp_Grnk.type
            side=1
            x=$tmp_Grnk.x,$cart_x
            y=$tmp_Grnk.y,$cart_y
        [/move_unit_fake]
        {DELAY 750}
        [move_unit_fake]
            type=$tmp_Grnk.type
            side=1
            x=$cart_x,$tmp_Grnk.c
            y=$cart_y,$tmp_Grnk.y
        [/move_unit_fake]
        [unstore_unit]
            variable=tmp_Grnk
        [/unstore_unit]

        {MESSAGE Wyssauba "" "" _"May I continue now?"}
        {MESSAGE Grnk "" "" _"Be my guest."}

        # Kill the cart
        {LIGHT_BEAM prune_cart}
        {FIREBALL_KILL prune_cart}
        {CLEAR_VARIABLE cart_x,cart_y,tmp_Grnk,hex_x,hex_y}

        {MESSAGE driver "" "" _"Quank's going to be mad as hell."}
        {MESSAGE Wyssauba "" "" _"He'll get over it. I'm sure he'll figure out a way to make money from this. He's probably already founded some sort of organization that pays him in gold whenever something bad happens."}
        {MESSAGE Wyssauba "" "" _"Now, let's run. Those skeletons are right behind us. If we combine forces with my fellow Hynderwlt mages, maybe we can put an end to this undead infestation once and for all."}

        # Not needed any more, but left here in case I want to revive it later
        #        {MESSAGE Vanak "" "" _"Vanak go. Get orc."+{NOTE _"Send Vanak to the signpost in the west for reinforcements."}}
        #        {SET_LABEL 46 36 "Send Vanak here for help"}
        #        {HIGHLIGHT_IMAGE_SHORT 46 36 scenery/signpost.png ()}

        [objectives]
            side=1
            summary=_"<span color='#A050A0'>Thwart The Master's Grand Plan</span>"
            [objective]
                description=_"Defeat all enemy units"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grossauba"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Wyssauba"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Gertburt"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Vanak"
                condition=lose
            [/objective]
            {IS_LAST_SCENARIO}
        [/objectives]

        # For calculation of when the skeletons from S12 follow
        {VARIABLE S13.skeleton_start_turn "$($turn_number-1)"}

        # Also set the prunes menu again
        {PRUNES_SETUP 1 Grnk 7 19 *^X*}

        # On next Mal An turn, the guardians that have not moved yet all come out
        [event]
            name=side 2 turn

            # need to reset both ai_special and status together; also change the id
            [store_unit]
                [filter]
                    id=skeleton1,skeleton2,skeleton3,skeleton4,skeleton5
                [/filter]

                variable=tmp_skeletons
            [/store_unit]

            {FOREACH tmp_skeletons i_u}
                {VARIABLE tmp_skeletons[$i_u].id skeleton00$i_u}
                {VARIABLE tmp_skeletons[$i_u].ai_special ""}
                {VARIABLE tmp_skeletons[$i_u].status.guardian no}
                [unstore_unit]
                    variable=tmp_skeletons[$i_u]
                [/unstore_unit]
            {NEXT i_u}

            {IF_VAR tmp_skeletons.length not_equals 0 (
                [then]
                    {MESSAGE "Mal An" "" "" _"Skeleton guardians, attack!"}
                [/then]
            )}
            {CLEAR_VARIABLE tmp_skeletons}
        [/event]

        # Starting from now on, the skeletons from S12 start appearing
        # At the end of each Side 2 turn, the next closest skeletons are put onto the map
        # Skeletons that were within 5 hexes * (turn_number-skeleton_start_turn) at end of last scenario are brought out
        [event]
            name=side 2 turn end
            first_time_only=no

            #{DEBUG $stored_skeletons_for13.length}
            {FOREACH stored_skeletons_for13 i_u}
                {VARIABLE unit_x $stored_skeletons_for13[$i_u].x}
                {VARIABLE unit_y $stored_skeletons_for13[$i_u].y}
                [lua]
                    code=<<
                        local helper = wesnoth.require("lua/helper.lua")
                        wesnoth.set_variable("distance", helper.distance_between(
                            wesnoth.get_variable("unit_x"),
                            wesnoth.get_variable("unit_y"),
                            9,1))
                    >>
                [/lua]
                #{DEBUG "  - $i_u $stored_skeletons_for13[$i_u].id $unit_x $unit_y $distance"}

                {IF_VAR distance less_than_equal_to "$(($turn_number-$S13.skeleton_start_turn)*5)" (
                    [then]
                        #{DEBUG "Unstoring: $i_u $stored_skeletons_for13[$i_u].id: $distance"}
                        {SCROLL_TO 26 36}
                        {VARIABLE stored_skeletons_for13[$i_u].side 2}
                        {CLOSE_EMPTY_HEX 26 36 () 0}
                        [move_unit_fake]
                            type=$stored_skeletons_for13[$i_u].type
                            side=2
                            x=26,$hex_x
                            y=36,$hex_y
                        [/move_unit_fake]
                        [unstore_unit]
                            variable=stored_skeletons_for13[$i_u]
                            x,y=$hex_x,$hex_y
                            find_vacant=yes
                        [/unstore_unit]
                        {CLEAR_VARIABLE stored_skeletons_for13[$i_u]}
                        {VARIABLE_OP i_u sub 1}
                    [/then]
                )}
            {NEXT i_u}
            {CLEAR_VARIABLE distance,unit_x,unit_y,hex_x,hex_y}
        [/event]

        # I'll disable all of that for now, but left in for possible revival later
        # Disabled by setting x,y to impossible values
        # Nested event: Vanak leaves
        [event]
            name=moveto

            [filter]
                id=Vanak
                x,y=9946,9936
            [/filter]

            {REMOVE_LABEL 46 36}
            {REMOVE_IMAGE 46 36}
            {MESSAGE Vanak "" "" _"Vanak go. Vanak back."}
            {MESSAGE Wyssauba "" "" _"A man of few words. I like him."}

            [store_unit]
                [filter]
                    id=Vanak
                [/filter]
                variable=S13.stored_Vanak
                kill=yes
            [/store_unit]

            {VARIABLE S13.Vanak_return $turn_number}
            {VARIABLE_OP S13.Vanak_return add 4}  # He'll be back 5 turns later

            # Nested event: Vanak returns a certain number of turns after he left (set in the previous line)
            [event]
                name=side 2 turn end
                first_time_only=no

                {IF_VAR S13.Vanak_return equals $turn_number (
                    [then]
                        {VARIABLE S13.stored_Vanak.side 3}
                        {VARIABLE S13.stored_Vanak.moves 0}
                        [unstore_unit]
                            variable=S13.stored_Vanak
                            x,y=46,36
                            find_vacant=yes
                        [/unstore_unit]
                        {FULL_HEAL_AND_CURE id=$S13.stored_Vanak.id}
                        {CLEAR_VARIABLE S13.stored_Vanak,S12.Vanak_return}

                        {UNIT 3 "Orcish Warrior" 45 36 (id=orc1)}
                        {UNIT 3 "Orcish Warrior" 50 36 (id=orc2)}
                        {UNIT 3 "Orcish Crossbowman" 48 36 (id=orc3)}
                        {UNIT 3 "Orcish Slayer" 49 36 (id=orc4)}

                        {MESSAGE Vanak "" "" _"Vanak back."}

                        # If there are Grnk's units in the keep area, move them out of the way
                        {MOVE_UNIT (
                            side=1
                            x=46,47,47,48
                            y=35,35,36,35
                        ) 48 33}

                        {MOVE_UNIT id=Vanak 47 36}
                        {MODIFY_UNIT id=Vanak moves 4}

                        {MODIFY_TERRAIN Ke 47 36}
                        {MODIFY_TERRAIN Ce 46,47,48,49 35,35,35,36}
                        {REDRAW 1}

                        [modify_side]
                            side=3
                            controller=human
                        [/modify_side]

                        # There should not be anybody on the recall list, but just in case
                        [kill]
                            side=3
                            [not]
                                x=1-999
                            [/not]
                        [/kill]
                    [/then]
                )}
            [/event]
        [/event]

        # Nested event: Karcyn et al. show up two turns later
        [event]
            name=side 2 turn end

            [event]
                name=side 2 turn end

                [fire_event]
                    name=Karcyn_appears
                [/fire_event]
            [/event]
        [/event]

        # Nested event: Ghost show up three turns later
        [event]
            name=turn end

            [event]
                name=turn end

                [event]
                    name=turn end

                    {IF_VAR stored_ghosts_04.length not_equals 0 (
                        [then]
                            {FOREACH stored_ghosts_04 i_u}
                                {VARIABLE stored_ghosts_04[$i_u].side 1}
                                {VARIABLE stored_ghosts_04[$i_u].moves $stored_ghosts_04[$i_u].max_moves}
                                [unstore_unit]
                                    variable=stored_ghosts_04[$i_u]
                                    find_vacant=yes
                                    x,y=1,1
                                [/unstore_unit]
                                {FULL_HEAL_AND_CURE id=$stored_ghosts_04[$i_u].id}
                            {NEXT i_u}
                            {MESSAGE $stored_ghosts_04[0].id "" "" _"Oh no! It's that crazy goblin again."}
                            {MESSAGE Grnk "" "" _"Look who's here! Do you want me to do my voice thing on you again?"}
                            {MESSAGE $stored_ghosts_04[0].id "" "" _"Please. Don't! We will help you even without that."}
                            {MESSAGE Grnk "" "" {WHISPER _"Good, because I still don't know how I do that."}+_"

You will? You aren't siding with the undead?"}
                            {MESSAGE $stored_ghosts_04[0].id "" "" _"Not with those undead. Our world is not what it used to be since this Master of theirs arrived. He must be stopped."}
                            {MESSAGE Grossauba "" "" _"Fight with us then, noble spirits. We have the same goal."}
                        [/then]
                    )}

                    {CLEAR_VARIABLE stored_ghosts_04}
                [/event]
            [/event]
        [/event]
    [/event]

    # Karcyn appears with Koorzhar and Rutburt
    [event]
        name=Karcyn_appears

        [recall]
            id=Rutburt
            x,y=64,16
        [/recall]

        [recall]
            id=Koorzhar
            x,y=64,15
        [/recall]

        [recall]
            id=Karcyn
            x,y=64,13
        [/recall]

        # Get rid of the two skeleton guards from S7 & S8 ...
        [kill]
            side=6
            id=skeleton_guard1,skeleton_guard2
        [/kill]
        # ... and set up 2 new, stronger ones instead
        {UNIT 6 "Draug" 64 12 id,ai_special=skeleton_guard1,guardian}
        {UNIT 6 "Banebow" 64 14 id,ai_special=skeleton_guard2,guardian}

        # Bring Stonehand out, if he's not either Koorzhar or Rutburt
        # Since they have been recalled already, there's no problem
        [recall]
            id=$stored_stonehand.id
            x,y=63,15
        [/recall]
        {VARIABLE S13.stonehand_id $stored_stonehand.id}
        {CLEAR_VARIABLE stored_stonehand}
        {MESSAGE $S13.stonehand_id "" "" _"That goblin turned my hand to stone. I will make him pay for that!"}
        {MESSAGE Karcyn "" "" _"Oh no, you won't."}
        {MESSAGE $S13.stonehand_id "" "" {GASP _"grumbles"}}

        # If there are units in the keep area, move them out of the way
        # Ally units first
        {MOVE_UNIT (
            side=1,3
            x,y=54-99,7-25
        ) 53 16}
        # Enemies after; they don't need to move as far
        {MOVE_UNIT (
            side=2
            x,y=59-71,12-19
        ) 57 16}

        {MOVE_UNIT id=Koorzhar 60 15}
        {MODIFY_TERRAIN Ke 60 15}
        {MODIFY_TERRAIN Ce 59,60,61 16,16,16}
        {REDRAW 1}

        {MOVE_UNIT id=Rutburt 61 19}
        {MODIFY_TERRAIN Ke 61 19}
        {MODIFY_TERRAIN Ce 59,60,60 19,18,19}
        {REDRAW 1}

        {MOVE_UNIT id=skeleton_guard1 59 12}
        {MOVE_UNIT id=skeleton_guard2 59 14}
        {MOVE_UNIT id=Karcyn 61 13}
        {MODIFY_TERRAIN Ke 61 13}
        {MODIFY_TERRAIN Ce 59,60,60 13,12,13}
        {REDRAW 1}

        {MODIFY_UNIT id=Koorzhar moves 0}
        {MODIFY_UNIT id=Rutburt moves 0}
        {MODIFY_UNIT id=Karcyn moves 0}

        {MESSAGE Karcyn "" "" _"Remember, the Master wants that goblin alive."}
        {MESSAGE Koorzhar "" "" {GASP _"grumbles"}}
        {MESSAGE Rutburt "" "" {GASP _"grumbles"}}
        {MESSAGE Karcyn "" "" _"What did you say? I didn't quite get that."}
        {MESSAGE Rutburt "" "" _"Nothing ..."}
        {MESSAGE Koorzhar "" "" _"Nothing ..."}

        [modify_side]
            side=4
            controller=ai
            hidden=no
        [/modify_side]
        [modify_side]
            side=5
            controller=ai
            hidden=no
        [/modify_side]
        [modify_side]
            side=6
            controller=ai
            hidden=no
        [/modify_side]

        # Discussion about number of enemies at next turn
        [event]
            name=new turn

            # Now for the discussion on the other side
            {STORE_UNIT_VAR id=Gertburt x Gertburt_x}
            {STORE_UNIT_VAR id=Gertburt y Gertburt_y}
            {SCROLL_TO $Gertburt_x $Gertburt_x}

            {MESSAGE Grnk "" "" _"What do we do now? There are way too many of them. We cannot defeat that many enemies."}
            {MESSAGE Wyssauba "" "" _"You're right."}
            {MESSAGE Grnk "" "" _"What?"}
            {MESSAGE Wyssauba "" "" _"I said you're right. We cannot defeat them all."}
            {MESSAGE Grnk "" "" _"You're not supposed to say that."}
            {MESSAGE Wyssauba "" "" _"People rarely like the truth."}
            {MESSAGE Gertburt "" "" _"If I may interrupt your philosophical discourse, there might be a way."}
            {MESSAGE Wyssauba "" "" _"I'm listening."}
            {MESSAGE Gertburt "" "" _"This isn't like Rutburt. Yes, he's an opportunistic son of a bitch with delusions of being the underworld mastermind of Shmaltupp, but he only works for his own advantage. He doesn't join some undead master for whatever this Grand Plan might be. If I could only talk to him, I bet my right hand that I can convince him and his chaps to join our side."}
            {MESSAGE Grnk "" "" _"But you will never get there with that many enemies around."}
            {MESSAGE Wyssauba "" "" _"Ah! I can help with that. Here, Gertburt, let me put a spell on you."}

            {LIGHT_BEAM Gertburt}
            {CLEAR_VARIABLE Gertburt_x,Gertburt_y}
            # Gertburt is able to hide; this is different depending on Gertburt's unit type
            # because of the concealment ability of the Fugitive
            [modify_unit]
                [filter]
                    id=Gertburt
                    type=Outlaw
                [/filter]

                [abilities]
                    [hides]
                        id=always-hidden
                        name=_"hidden"
                        description=_"Hidden:

Due to Wyssauba's magic, Gertburt cannot be seen by enemies, except if they have units next to him."
                        affect_self=yes
                        [filter_self]
                        [/filter_self]
                    [/hides]
                [/abilities]
            [/modify_unit]

            [modify_unit]
                [filter]
                    id=Gertburt
                    type=Fugitive
                [/filter]

                [abilities]
                [/abilities]
                [abilities]
                    [hides]
                        id=always-hidden
                        name=_"hidden"
                        description=_"Hidden:

Due to Wyssauba's magic, Gertburt cannot be seen by enemies, except if they have units next to him."
                        affect_self=yes
                        [filter_self]
                        [/filter_self]
                    [/hides]
                [/abilities]
            [/modify_unit]
            {REDRAW 1}

            # The following avoid tag is a temporary patch to work around a
            # bug in the AI dealing with the [hides] ability -- to be removed later
            {MODIFY_AI_ADD_ASPECT 4 avoid (
                [facet]
                    id="avoid_Gertburt"
                    [value]
                        [filter]
                            id=Gertburt
                        [/filter]
                        radius=1
                    [/value]
                [/facet]
            )}

            {MESSAGE Wyssauba "" "" _"You are now invisible to all enemies, unless they are right next to you."}
            {MESSAGE Gertburt "" "" _"That's very convenient."}
            {MESSAGE Grnk "" "" _"If you can do that, why don't you turn all of us invisible and we sneak away?"}
            {MESSAGE Wyssauba "" "" _"Naturally, the naive question of a novice. This is no simple spell. It takes all my concentration just to maintain it for one person. In fact, if either he or I fight, he will become visible wherever he is at the time."}
            {MESSAGE Gertburt "" "" _"I'll try to remember that."}

            # Need to set the objectives separately for the two sides, otherwise
            # the [show_if] conditions don't get updated correctly.  I don't
            # know if that's because of a bug, or because I am doing something wrong.
            [objectives]
                side=1
                summary=_"<span color='#A050A0'>Thwart The Master's Grand Plan</span>"
                [objective]
                    description=_"Defeat all enemy units"
                    condition=win
                [/objective]
                [objective]
                    [show_if]
                        [have_unit]
                            id=Gertburt
                            side=1
                        [/have_unit]
                    [/show_if]
                    description=_"Get Rutburt to join Grnk's side by moving Gertburt next to him"
                    condition=win
                [/objective]
                [objective]
                    description=_"Death of Grossauba"
                    condition=lose
                [/objective]
                [objective]
                    description=_"Death of Grnk"
                    condition=lose
                [/objective]
                [objective]
                    description=_"Death of Wyssauba"
                    condition=lose
                [/objective]
                [objective]
                    description=_"Death of Gertburt"
                    condition=lose
                [/objective]
                [objective]
                    description=_"Death of Vanak"
                    condition=lose
                [/objective]
                [objective]
                    description=_"Death of Rutburt"
                    condition=lose
                [/objective]
                [note]
                    [show_if]
                        [have_unit]
                            id=Gertburt
                            ability=always-hidden
                        [/have_unit]
                    [/show_if]
                    description=_"Gertburt will turn visible to enemies when either he or Wyssauba get into a fight."
                [/note]
                {IS_LAST_SCENARIO}
            [/objectives]

            [objectives]
                side=4
                summary=_"<span color='#A050A0'>Thwart The Master's Grand Plan</span>"
                [objective]
                    description=_"Defeat all enemy units"
                    condition=win
                [/objective]
                [objective]
                    description=_"Death of Grossauba"
                    condition=lose
                [/objective]
                [objective]
                    description=_"Death of Grnk"
                    condition=lose
                [/objective]
                [objective]
                    description=_"Death of Wyssauba"
                    condition=lose
                [/objective]
                [objective]
                    description=_"Death of Gertburt"
                    condition=lose
                [/objective]
                [objective]
                    description=_"Death of Vanak"
                    condition=lose
                [/objective]
                [objective]
                    description=_"Death of Rutburt"
                    condition=lose
                [/objective]
                [note]
                    [show_if]
                        [have_unit]
                            id=Gertburt
                            ability=always-hidden
                        [/have_unit]
                    [/show_if]
                    description=_"Gertburt will turn visible to enemies when either he or Wyssauba get into a fight."
                [/note]
                [note]
                    description=_"Rutburt can recruit one Level-2 unit per turn."
                [/note]
                {IS_LAST_SCENARIO}
            [/objectives]
        [/event]

        # Gertburt's hidden ability disappears when either Gertburt or Wyssauba have to fight
        [event]
            name=attack end

            [filter]
                id=Gertburt,Wyssauba
            [/filter]

            [fire_event]
                name=unhide_Gertburt
            [/fire_event]
        [/event]

        [event]
            name=attack end

            [filter_second]
                id=Gertburt,Wyssauba
            [/filter_second]

            [fire_event]
                name=unhide_Gertburt
            [/fire_event]
        [/event]

        [event]
            name=unhide_Gertburt

            {MESSAGE Gertburt "" "" _"Rats! There goes my cover."}

            [store_unit]
                [filter]
                    id=Gertburt
                [/filter]

                variable=tmp_Gertburt
            [/store_unit]

            # Again, need this to be done differently based on unit type
            {IF_VAR tmp_Gertburt.type equals Outlaw (
                [then]
                    {CLEAR_VARIABLE tmp_Gertburt.abilities}
                [/then]

                [else]
                    {CLEAR_VARIABLE tmp_Gertburt.abilities.hides[1]}
                [/else]
            )}
            {REDRAW 1}
            [unstore_unit]
                variable=tmp_Gertburt
                find_vacant=no
            [/unstore_unit]
            {CLEAR_VARIABLE tmp_Gertburt}

            # Also: the temporary avoid tag for Side 4 needs to be cleared
            # To be deleted later
            {MODIFY_AI_TRY_DELETE_ASPECT 4 avoid avoid_Gertburt}

            [show_objectives]
                side=1,4
            [/show_objectives]
        [/event]

        # When Gertburt moves next to Rutburt (or vice versa),
        # Rutburt jumps sides and Gertburt joins his side
        [event]
            name=moveto

            [filter]
                id=Gertburt,Rutburt
                [filter_adjacent]
                    id=Gertburt,Rutburt
                [/filter_adjacent]
            [/filter]

            {MESSAGE Gertburt "" "" _"Rutburt, what the hell are you doing?"}
            {MESSAGE Rutburt "" "" _"Gertburt, go away. I don't want to hurt you, but I ..."}

            {SLAP_UNIT Gertburt Rutburt}
            {DELAY 800}

            {MESSAGE Rutburt "" "" _"What the ...?! You hit me! I'll get you, you little ..."}
            {MESSAGE Rutburt "" "" _"Gertburt, what the hell am I doing?"}
            {MESSAGE Gertburt "" "" _"That's what I just asked you."}
            {MESSAGE Rutburt "" "" _"I ... I don't know. It's those damned undead. They messed with my head somehow."}
            {MESSAGE Gertburt "" "" _"Well, now that I unmessed it for you, how about you join the rest of us in getting rid of them skeletons?"}

            {IF_VAR S13.stonehand_id equals Rutburt (
                [then]
                    {MESSAGE Rutburt "" "" _"I don't know. That goblin turned my hand to stone after all."}
                    {MESSAGE Gertburt "" "" _"From what I heard, that's your own fault. You should be glad that it's only your hand."}
                [/then]
            )}

            {MESSAGE Rutburt "" "" _"If you put it that way ... Let's bash in some skulls. The chaps were never happy with this anyway."}

            [if]
                [have_unit]
                    id=Koorzhar
                [/have_unit]

                [then]
                    {MESSAGE Gertburt "" "" _"How about Koorzhar? Can we get him on our side too?"}
                    {MESSAGE Rutburt "" "" _"Koorzhar's a lost cause. Even if we could manage to turn him against the undead, he'll continue to fight us simply out of 'principle.'"}
                [/then]
            [/if]

            [modify_side]
                side=4
                controller=human
                hidden=no
                team_name=wizards
                user_team_name=_"Hynderwlt Mages"
            [/modify_side]
            {MODIFY_UNIT id=Gertburt side 4}
            # Now side 4 is not an enemy any more
            {VARIABLE S13.ally_sides "1,3,4,7"}

            [show_objectives]
                side=1,4
            [/show_objectives]

            # Just in the (unlikely) case that Rutburt is the last enemy standing ...
            [fire_event]
                name=are_we_done
            [/fire_event]

            {NARRATOR_GRAY _"Gertburt joins Rutburt" _"After the end of this turn, control of Rutburt, Gertburt and their chaps will be turned over to the player, on a side separate from Grnk and his friends."}
        [/event]

        # Two turns later, lots of peasants show up
        [event]
            name=side 6 turn end

            [event]
                name=side 6 turn end

                [modify_side]
                    side=7
                    controller=ai
                [/modify_side]

                {REPEAT 27 (
                    {SCROLL_TO 41 1}
                    {CLOSE_EMPTY_HEX 41 1 () 0}
                    [move_unit_fake]
                        type=Peasant
                        side=7
                        x=41,$hex_x
                        y=1,$hex_y
                    [/move_unit_fake]
                    {GENERIC_UNIT 7 Peasant $hex_x $hex_y}
                )}

                {GET_RANDOM_UNIT_ID side=7}
                {MESSAGE $random_unit_id "" "" _"There they are. Let's get them!"}
                {MESSAGE Grossauba "" "" _"Now whom do you think they are after?"}
                {GET_RANDOM_UNIT_ID side=7}
                {MESSAGE $random_unit_id "" "" _"That little goblin is the only one who's ever stood up for us peasants. And now they are hunting him down for that."}
                {MESSAGE Grnk "" "" _"Don't do this. You're going to get slaughtered!"}
                {MESSAGE Koorzhar "" "" _"We cannot tolerate a peasant revolt. You have permission to kill them without mercy."}
                {MESSAGE Grnk "" "" _"No, don't! They are your own people."}
                {CLEAR_VARIABLE random_unit_id,hex_x,hex_y}

                # And some more next turn
                [event]
                    name=side 6 turn end

                    # Don't do this for now; I like the one-wave approach better
                    {REPEAT 0 (
                        {SCROLL_TO 41 1}
                        {CLOSE_EMPTY_HEX 41 1 () 0}
                        [move_unit_fake]
                            type=Peasant
                            side=7
                            x=41,$hex_x
                            y=1,$hex_y
                        [/move_unit_fake]
                        {GENERIC_UNIT 7 Peasant $hex_x $hex_y}
                    )}
                    {CLEAR_VARIABLE hex_x,hex_y}

                    # And some more on the 3rd turn
                    [event]
                        name=side 6 turn end

                        # Don't do this for now; like one-wave better
                        {REPEAT 0 (
                            {SCROLL_TO 41 1}
                            {CLOSE_EMPTY_HEX 41 1 () 0}
                            [move_unit_fake]
                                type=Peasant
                                side=7
                                x=47,$hex_x
                                y=1,$hex_y
                            [/move_unit_fake]
                            {GENERIC_UNIT 7 Peasant $hex_x $hex_y}
                        )}
                        {SCROLL_TO 41 1}
                        {MESSAGE_NOSCROLL Grnk _"This is madness! You will all be killed."}
                        {GET_RANDOM_UNIT_ID side=7}
                        {MESSAGE $random_unit_id "" "" _"We might all die here, but it has to start somewhere if we want our children to lead a better life."}
                        {CLEAR_VARIABLE random_unit_id,hex_x,hex_y}
                    [/event]
                [/event]
            [/event]
        [/event]
    [/event]

    # Karcyn's skeleton guardians move back to their spot if they have been drawn out,
    # and do not have an enemy within attack range
    [event]
        name=side 6 turn
        first_time_only=no

        # First guard
        {STORE_UNIT_VAR id=skeleton_guard1 x sk_x}
        {STORE_UNIT_VAR id=skeleton_guard1 y sk_y}
        [if]
            {VARIABLE_CONDITIONAL sk_x not_equals 59}
            [or]
                {VARIABLE_CONDITIONAL sk_y not_equals 12}
            [/or]

            [then]
                #{DEBUG "Guard 1 has moved"}
                [store_reachable_locations]
                    [filter]
                        id=skeleton_guard1
                    [/filter]
                    [filter_location]
                        [filter]
                            side=$S13.ally_sides
                        [/filter]
                    [/filter_location]
                    moves=max
                    range=attack

                    variable=tmp_locs
                [/store_reachable_locations]
                #{DEBUG "Enemies within attack range: $tmp_locs.length"}

                {IF_VAR tmp_locs.length equals 0 (
                    [then]
                        #{DEBUG "Sending Guard 1 back"}
                        {MODIFY_UNIT id=skeleton_guard1 goto_x 59}
                        {MODIFY_UNIT id=skeleton_guard1 goto_y 12}
                    [/then]

                    [else] # This is necessary as a goto_x,goto_y might still be set from previous turn
                        {MODIFY_UNIT id=skeleton_guard1 goto_x 0}
                        {MODIFY_UNIT id=skeleton_guard1 goto_y 0}
                    [/else]
                )}
            [/then]
        [/if]

        # Second guard
        {STORE_UNIT_VAR id=skeleton_guard2 x sk_x}
        {STORE_UNIT_VAR id=skeleton_guard2 y sk_y}
        [if]
            {VARIABLE_CONDITIONAL sk_x not_equals 59}
            [or]
                {VARIABLE_CONDITIONAL sk_y not_equals 14}
            [/or]

            [then]
                #{DEBUG "Guard 2 has moved"}
                [store_reachable_locations]
                    [filter]
                        id=skeleton_guard2
                    [/filter]
                    [filter_location]
                        [filter]
                            side=$S13.ally_sides
                        [/filter]
                    [/filter_location]
                    moves=max
                    range=attack

                    variable=tmp_locs
                [/store_reachable_locations]
                #{DEBUG "Enemies within attack range: $tmp_locs.length"}

                {IF_VAR tmp_locs.length equals 0 (
                    [then]
                        #{DEBUG "Sending Guard 2 back"}
                        {MODIFY_UNIT id=skeleton_guard2 goto_x 59}
                        {MODIFY_UNIT id=skeleton_guard2 goto_y 14}
                    [/then]

                    [else] # This is necessary as a goto_x,goto_y might still be set from previous turn
                        {MODIFY_UNIT id=skeleton_guard2 goto_x 0}
                        {MODIFY_UNIT id=skeleton_guard2 goto_y 0}
                    [/else]
                )}
            [/then]
        [/if]

        {CLEAR_VARIABLE tmp_locs,sk_x,sk_y}
    [/event]

    # Also, Karcyn never moves or attacks at all
    [event]
        name=side 6 turn refresh
        first_time_only=no

        {MODIFY_UNIT id=Karcyn moves 0}
        {MODIFY_UNIT id=Karcyn attacks_left 0}
    [/event]

    # Stonehand's death (except if it's Rutburt)
    [event]
        name=last breath

        [filter]
            id=$S13.stonehand_id
            [not]
                id=Rutburt
            [/not]
        [/filter]

        {MESSAGE $S13.stonehand_id "" "" _"Now I will never get my revenge! Tell them to display my stone hand on the market square in Shmaltupp, as a warning to others."}

        {CLEAR_VARIABLE S13.stonehand_id}
    [/event]

    # When the last peasant dies
    [event]
        name=last_breath]

        [filter]
            side=7
        [/filter]
        [filter_condition]
            [not]
                [have_unit]
                    side=7
                [/have_unit]
            [/not]
        [/filter_condition]

        {MESSAGE $unit.id "" "" _"We might have all died here, but they won't be able to stop what we started."}
        [modify_side]
            side=7
            controller=null
            hidden=yes
        [/modify_side]
    [/event]

    # Mal An, Karcyn (and his guards) and Koorzhar run if
    # 1a. Mal An & Koorzhar: they are killed
    # 1b. Karcyn: he's attacked
    # 2. They are down to 1 other unit (3 for Karcyn, because of the guardians)

    # Mal An runs
    [event]
        name=Mal_An_runs

        {MESSAGE (Mal An) "" "" _"That goblin's even more trouble than the Master expected. I better report this to him. The Grand Plan must continue."}

        {STORE_UNIT_VAR (id=Mal An) type Mal_An_type}
        {STORE_UNIT_VAR (id=Mal An) x Mal_An_x}
        {STORE_UNIT_VAR (id=Mal An) y Mal_An_y}
        [kill]
            id=Mal An
        [/kill]
        [move_unit_fake]
            type=$Mal_An_type
            side=2
            x=$Mal_An_x,1
            y=$Mal_An_y,30
        [/move_unit_fake]

        {CLEAR_VARIABLE Mal_An_type,Mal_An_x,Mal_An_y}
    [/event]

    # Koorzhar runs
    [event]
        name=Koorzhar_runs

        {MESSAGE Koorzhar "" "" _"I'm not going to die for that so-called Master. I'm out of here."}

        [store_unit]
            [filter]
                id=Koorzhar
            [/filter]

            variable=tmp_Koorzhar
            kill=yes
        [/store_unit]

        [move_unit_fake]
            type=$tmp_Koorzhar.type
            side=5
            x=$tmp_Koorzhar.x,64
            y=$tmp_Koorzhar.y,15
        [/move_unit_fake]

        {CLEAR_VARIABLE tmp_Koorzhar}

        {MESSAGE Grnk "" "" _"He sacrifices his people, but he's a coward himself."}
    [/event]

    # Karcyn runs
    [event]
        name=Karcyn_runs

        {MESSAGE Karcyn "" "" _"The Master will not be happy with this."}

        {STORE_UNIT_VAR id=Karcyn type Karcyn_type}
        {STORE_UNIT_VAR id=Karcyn x Karcyn_x}
        {STORE_UNIT_VAR id=Karcyn y Karcyn_y}
        [kill]
            id=Karcyn
        [/kill]
        [move_unit_fake]
            type=$Karcyn_type
            side=6
            x=$Karcyn_x,64
            y=$Karcyn_y,15
        [/move_unit_fake]

        # His two guards leave too
        [if]
            [have_unit]
                id=skeleton_guard1
            [/have_unit]

            [then]
                {STORE_UNIT_VAR id=skeleton_guard1 type sk1_type}
                {STORE_UNIT_VAR id=skeleton_guard1 x sk1_x}
                {STORE_UNIT_VAR id=skeleton_guard1 y sk1_y}
                [kill]
                    id=skeleton_guard1
                [/kill]
                [move_unit_fake]
                    type=$sk1_type
                    side=6
                    x=$sk1_x,64
                    y=$sk1_y,15
                [/move_unit_fake]
            [/then]
        [/if]

        [if]
            [have_unit]
                id=skeleton_guard2
            [/have_unit]

            [then]
                {STORE_UNIT_VAR id=skeleton_guard2 type sk2_type}
                {STORE_UNIT_VAR id=skeleton_guard2 x sk2_x}
                {STORE_UNIT_VAR id=skeleton_guard2 y sk2_y}
                [kill]
                    id=skeleton_guard2
                [/kill]
                [move_unit_fake]
                    type=$sk2_type
                    side=6
                    x=$sk2_x,64
                    y=$sk2_y,15
                [/move_unit_fake]
            [/then]
        [/if]

        {CLEAR_VARIABLE Karcyn_type,Karcyn_x,Karcyn_y,sk1_type,sk1_x,sk1_y,sk2_type,sk2_x,sk2_y}

        {MESSAGE Grnk "" "" _"Why am I not surprised?"}
    [/event]

    # 1a. When Mal An or Koorzhar die (before they have no units left), they flee
    [event]
        name=last_breath

        [filter]
            id=Mal An
        [/filter]

        [fire_event]
            name=Mal_An_runs
        [/fire_event]
    [/event]

    [event]
        name=last_breath

        [filter]
            id=Koorzhar
        [/filter]

        [fire_event]
            name=Koorzhar_runs
        [/fire_event]
    [/event]

    # 1b. If Karcyn is attacked directly, he also leaves
    [event]
        name=attack

        [filter_second]
            id=Karcyn
        [/filter_second]

        [fire_event]
            name=Karcyn_runs
        [/fire_event]
    [/event]

    # 2: When an enemy unit dies:
    #  - if only 1 of a side (or 3 for Karcyn) left, leader runs
    #  - if no enemy units left, Grnk wins (this can only happen after the leader ran)
    [event]
        name=die
        first_time_only=no

        [filter]
            side=2,5,6
        [/filter]

        # Get unit off the map
        [kill]
            id=$unit.id
        [/kill]

        # This could trigger one of the enemy leaders to leave ...
        [fire_event]
            name=enemy_leader_leaves
        [/fire_event]
        # ... or the end of the scenario
        [fire_event]
            name=are_we_done
        [/fire_event]
    [/event]

    # The event for one of the enemy leaders to leave
    # This can be triggered by the above die event, or by the prunes events
    [event]
        name=enemy_leader_leaves
        first_time_only=no

        [if]
            [have_unit]
                id=Mal An
            [/have_unit]
            [not]
                [have_unit]
                    side=2
                    x=1-999  # don't include recall list
                    [not]
                        [filter_wml]  # and only non-petrified units
                            [status]
                                petrified=yes
                            [/status]
                        [/filter_wml]
                    [/not]
                    count=3-999
                [/have_unit]
            [/not]

            [then]
                [fire_event]
                    name=Mal_An_runs
                [/fire_event]
            [/then]
        [/if]

        # Koorzhar's side
        [if]
            [have_unit]
                id=Koorzhar
            [/have_unit]
            [not]
                [have_unit]
                    side=5
                    x=1-999  # don't include recall list
                    [not]
                        [filter_wml]  # and only non-petrified units
                            [status]
                                petrified=yes
                            [/status]
                        [/filter_wml]
                    [/not]
                    count=3-999
                [/have_unit]
            [/not]

            [then]
                [fire_event]
                    name=Koorzhar_runs
                [/fire_event]
            [/then]
        [/if]

        # Karcyn's side
        [if]
            [have_unit]
                id=Karcyn
            [/have_unit]
            [not]
                [have_unit]
                    side=6
                    x=1-999  # don't include recall list
                    [not]
                        [filter_wml]  # and only non-petrified units
                            [status]
                                petrified=yes
                            [/status]
                        [/filter_wml]
                    [/not]
                    count=5-999
                [/have_unit]
            [/not]

            [then]
                [fire_event]
                    name=Karcyn_runs
                [/fire_event]
            [/then]
        [/if]
    [/event]

    # If the last enemy unit is gone, we're done
    # This can be triggered from the above kill event, or the prunes events ...
    # or if Rutburt just got converted (and was the last unit)
    # Petrified units don't count
    [event]
        name=are_we_done
        first_time_only=no

        # If Rutburt's joined Grnk, Gertburt has been change to side 4
        {STORE_UNIT_VAR id=Gertburt side Gertburt_side}

        [if]
            [not]
                [have_unit]
                    side=2,5,6  # Don't need to check Rutburt's side
                    [not]
                        [filter_wml]  # and only non-petrified units
                            [status]
                                petrified=yes
                            [/status]
                        [/filter_wml]
                    [/not]
                [/have_unit]
            [/not]
            # Following condition: so that we cannot end the game before Rutburt is converted
            {VARIABLE_CONDITIONAL Gertburt_side equals 4}

            [then]
                {MESSAGE Grnk "" "" _"Wow, we really did it!"}
                {MESSAGE Grossauba "" "" _"We did indeed. You're an amazing little fellow, Grnk. I am astonished by what I have seen."}
                {MESSAGE Wyssauba "" "" _"That's high praise coming from Grossauba. In fact, it's the greatest compliment I have ever heard him make to anybody. Except to me, naturally."}
                {MESSAGE Grnk "" "" _"Naturally."}
                {MESSAGE Grnk "" "" _"Thank you, Grossauba. I am honored."}
                {MESSAGE Grossauba "" "" _"We're heading back to Hynderwlt then. I will leave you in Wyssauba's capable hands. I am certain that, in his greatness, he will have no trouble figuring out what to do to put you on the right path."}

                # Move all of Grossauba's units off, except for Wyssauba and Grnk
                [store_unit]
                    [filter]
                        side=1
                        type=Mage,Red Mage,White Mage,Arch Mage,Silver Mage,Mage of Light,Great Mage
                        [not]
                            id=Wyssauba
                        [/not]
                    [/filter]

                    variable=tmp_units
                [/store_unit]

                {FOREACH tmp_units i_u}
                    {MOVE_UNIT id=$tmp_units[$i_u].id 25 1}
                    [kill]
                        id=$tmp_units[$i_u].id
                    [/kill]
                {NEXT i_u}
                {CLEAR_VARIABLE tmp_units}

                {MESSAGE Vanak "" "" _"Little goblin Vanak friend. Vanak go."}
                {MOVE_UNIT id=Vanak 52 36}
                [kill]
                    id=Vanak
                [/kill]
                {MESSAGE Wyssauba "" "" _"An orc of few words. I like him."}
                {MESSAGE Grnk "" "" _"And you can always take him at face value. That's something my experience with humans has taught me to appreciate about orcs."}

                # Gryphons move away
                [store_unit]
                    [filter]
                        side=1
                        type=Gryphon
                    [/filter]

                    variable=tmp_units
                [/store_unit]

                {IF_VAR tmp_units.length not_equals 0 (
                    [then]
                        {MESSAGE $tmp_units[0].id "" "" _"Kraahhh!!!!"}
                        {FOREACH tmp_units i_u}
                            {MOVE_UNIT id=$tmp_units[$i_u].id $tmp_units[$i_u].x 36}
                            [kill]
                                id=$tmp_units[$i_u].id
                            [/kill]
                        {NEXT i_u}
                        {CLEAR_VARIABLE tmp_units}
                    [/then]
                )}

                # And the ghosts
                [store_unit]
                    [filter]
                        side=1
                        race=undead
                    [/filter]

                    variable=tmp_units
                [/store_unit]

                {IF_VAR tmp_units.length not_equals 0 (
                    [then]
                        {MESSAGE $tmp_units[0].id "" "" _"Farewell, Grnk. You're not as bad a goblin, or a sorcerer, as we thought at first."}
                        {FOREACH tmp_units i_u}
                            {MOVE_UNIT id=$tmp_units[$i_u].id 1 1}
                            [kill]
                                id=$tmp_units[$i_u].id
                            [/kill]
                        {NEXT i_u}
                        {CLEAR_VARIABLE tmp_units}
                    [/then]
                )}

                {MESSAGE Gertburt "" "" _"We must be off too. There are lots of things to be sorted out in Shmaltupp. Good luck, little fella."}
                {MESSAGE Rutburt "" "" _"No hard feelings, Grnk. Maybe we can continue on better terms sometime."}

                # Move any other ally left off with Gertburt and Rutburt
                # This includes the cart driver, if he's still alive
                [store_unit]
                    [filter]
                        side=1,4,7
                        [not]
                            id=Wyssauba,Grnk
                        [/not]
                    [/filter]

                    variable=tmp_units
                [/store_unit]

                {FOREACH tmp_units i_u}
                    {MOVE_UNIT id=$tmp_units[$i_u].id 64 15}
                    [kill]
                        id=$tmp_units[$i_u].id
                    [/kill]
                {NEXT i_u}
                {CLEAR_VARIABLE tmp_units}

                {MESSAGE Grnk "" "" _"What do I do now, Wyssauba? I went to Shmaltupp to start a better life. Look at the mess that created. The humans are constantly scheming and double-crossing everybody, including their own people. I do not know whom to trust any more."}
                {MESSAGE Grnk "" "" _"With the orcs, it's easy. It's as simple as ""Little goblin help Vanak. Vanak help little goblin.""  Or ""They there! We them get!""  At least you know what you're up against. Maybe I should join Vanak."}
                {MESSAGE Wyssauba "" "" _"Don't be discouraged, Grnk. Most humans are pretty decent people. Unfortunately, those that rise to the top often do so because they are more ... ambitious than the rest."}
                {MESSAGE Grnk "" "" _"So what do I do?"}
                {MESSAGE Wyssauba "" "" _"Why don't you join me and we will work together on getting your magic under control. I believe that you have only scratched the surface of your powers. It would be a shame to waste it and ..."}
                {MESSAGE narrator "portraits/humans/transparent/mage-arch.png~O(25%)" "Grossauba" _"... and that's high praise coming from Wyssauba."}
                {MESSAGE Wyssauba "" "" _"... and we need to make sure that it does not fall into the wrong hands. Besides, I am one of the best teachers you will be able to find, maybe <i>the</i> best."}
                {MESSAGE Grnk "" "" _"Naturally?"}
                {MESSAGE Wyssauba "" "" _"Naturally."}

                {MOVE_UNIT id=Wyssauba 25 1}
                [kill]
                    id=Wyssauba
                [/kill]
                {MOVE_UNIT id=Grnk 25 1}
                [kill]
                    id=Grnk
                [/kill]

                # House cleaning
                {CLEAR_VARIABLE S13}

                [endlevel]
                    result=victory
                    carryover_report=no
                    linger_mode=no
                    end_text=_"Maybe there is hope for me yet.

To be continued ...

Thank you for playing Grnk the Mighty!
If you have suggestions or encountered problems,
please visit our thread on the Wesnoth forums: http://tinyurl.com/BfW-Grnk"
                    end_text_duration=10000
                [/endlevel]
            [/then]
        [/if]

        {CLEAR_VARIABLE Gertburt_side}
    [/event]

    ######################
    # Finally, the standard events for all or most scenarios
    {STORY_IMAGE id=Grnk}
    {KOORZHAR_MAKES_GENERAL}
    {GRNK_DEATH}
    {GERTBURT_DEATH}
    {RUTBURT_DEATH}
    {KOORZHAR_DEATH}
    {VANAK_DEATH}
    {WYSSAUBA_DEATH}
    {GROSSAUBA_DEATH}
[/scenario]
