#textdomain wesnoth-Grnk

[scenario]
    id=09_Chaos
    name=_"Chaos"
    next_scenario=10_Captured

    # Same map as S10
    map_data="{~add-ons/Grnk/part1/maps/10_Captured.map}"

    {DEFAULT_SCHEDULE}
    turns=-1
    victory_when_enemies_defeated=no

    {GRNK_STORY_09}

    [side]
        side=1
        controller=human
        id=Grnk

        team_name=Grnk
        user_team_name=_"Grnk"

        village_gold=0
        gold=0
        income=-2  # No income whatsoever
    [/side]

    [side]
        side=2
        controller=ai
        id=Clerezzasz
        name=Clerezzasz
        type=Saurian Soothsayer

        team_name=saurians2
        user_team_name=_"Western Saurians"

        recruit=Saurian Augur,Saurian Skirmisher

        {GOLD 102 127 152}

        [ai]
            aggression=1.0
            caution=0.0
            leader_aggression=1.0
            leader_caution=0.0
            village_value=0.0
            scout_village_targeting=0.0
            villages_per_scout=0.0
            # Make them preferentially target the other saurians
            [goal]
                [criteria]
                    side=1
                [/criteria]
                value=1.
            [/goal]
            [goal]
                [criteria]
                    side=3
                [/criteria]
                value=100.
            [/goal]
            [goal]
                [criteria]
                    side=4
                [/criteria]
                value=5.
            [/goal]
        [/ai]
    [/side]

    [side]
        side=3
        controller=ai
        id=Xaz
        name=Xaz
        type=Saurian Oracle

        team_name=saurians3
        user_team_name=_"Eastern Saurians"

        recruit=Saurian Augur,Saurian Skirmisher

        {GOLD 102 127 152}

        [ai]
            aggression=1.0
            caution=0.0
            leader_aggression=1.0
            leader_caution=0.0
            village_value=0.0
            scout_village_targeting=0.0
\            villages_per_scout=0.0
            # Make them preferentially target the other saurians
            [goal]
                [criteria]
                    side=1
                [/criteria]
                value=1.
            [/goal]
            [goal]
                [criteria]
                    side=2
                [/criteria]
                value=100.
            [/goal]
            [goal]
                [criteria]
                     side=4
                [/criteria]
                value=5.
            [/goal]
        [/ai]
    [/side]

    # Pursuers
    [side]
        side=4
        controller=null
        no_leader=yes
        hidden=yes

        team_name=humans
        user_team_name=_"Human Army"

        gold=0

        [ai]
            aggression=1.0
            caution=0.0
            # Make them preferentially target Grnk
            [goal]
                [criteria]
                    side=2,3
                [/criteria]
                value=1.
            [/goal]
            [goal]
                [criteria]
                    side=1
                [/criteria]
                value=100.
            [/goal]
        [/ai]
    [/side]

    # Need this side only to get Karcyn out
    [side]
        side=5
        controller=null
        hidden=yes

        persistent=yes
        save_id=Karcyn

        gold=0
    [/side]

    # Need this side only to get Koorzhar out
    [side]
        side=6
        controller=null
        hidden=yes

        persistent=yes
        save_id=Koorzhar
        color=4

        gold=0
    [/side]

    # Need this side only to get Rutburt out
    [side]
        side=7
        controller=null
        hidden=yes
        color=4

        persistent=yes
        save_id=Rutburt

        gold=0
    [/side]

    # Need this side only to get Vanak out
    [side]
        side=8
        controller=null
        hidden=yes
        color=6

        persistent=yes
        save_id=Vanak

        gold=0
    [/side]

    [event]
        name=prestart

        # Set Side 1 gold to value of Grnks_gold
        {SET_GOLD 1 $Grnks_gold}

        # Set up strange time areas
        {REPEAT 50 (
            [set_variable]
                name=S9.rand_radius
                rand="1..3"
            [/set_variable]
            [set_variable]
                name=S9.rand_x
                rand="1..40"
            [/set_variable]
            [set_variable]
                name=S9.rand_y
                rand="1..45"
            [/set_variable]
            [set_variable]
                name=S9.rand_time
                rand="1..6"
            [/set_variable]

            [switch]
                variable=S9.rand_time
                [case]
                    value=1
                    [time_area]
                        x,y=$S9.rand_x,$S9.rand_y
                        radius=$S9.rand_radius
                        {MORNING}
                    [/time_area]
                [/case]
                [case]
                    value=2
                    [time_area]
                        x,y=$S9.rand_x,$S9.rand_y
                        radius=$S9.rand_radius
                        {AFTERNOON}
                    [/time_area]
                [/case]
                [case]
                    value=3
                    [time_area]
                        x,y=$S9.rand_x,$S9.rand_y
                        radius=$S9.rand_radius
                        {DUSK}
                    [/time_area]
                [/case]
                [case]
                    value=4
                    [time_area]
                        x,y=$S9.rand_x,$S9.rand_y
                        radius=$S9.rand_radius
                        {FIRST_WATCH}
                    [/time_area]
                [/case]
                [case]
                    value=5
                    [time_area]
                        x,y=$S9.rand_x,$S9.rand_y
                        radius=$S9.rand_radius
                        {SECOND_WATCH}
                    [/time_area]
                [/case]
                [case]
                    value=6
                    [time_area]
                        x,y=$S9.rand_x,$S9.rand_y
                        radius=$S9.rand_radius
                        {MORNING}
                    [/time_area]
                [/case]
            [/switch]
        )}
        {CLEAR_VARIABLE S9.rand_radius,S9.rand_x,S9.rand_y,S9.rand_time}

        # Store Grnk and saurian leaders for later revival
        [store_unit]
            [filter]
                id=Grnk
            [/filter]
            variable=S9.stored_Grnk_start
        [/store_unit]
        [store_unit]
            [filter]
                id=Clerezzasz
            [/filter]
            variable=S9.stored_Clerezzasz
        [/store_unit]
        [store_unit]
            [filter]
                id=Xaz
            [/filter]
            variable=S9.stored_Xaz
        [/store_unit]

        # Two saurian guardians
        {UNIT 2 (Saurian Ambusher) 13 14 (ai_special=guardian)}
        {UNIT 3 (Saurian Ambusher) 44 30 (ai_special=guardian)}

        # Store gold for the saurians, to reset at restart
        # Grnk's gold is already stored in Grnks_gold
        [store_gold]
            side=2
            variable=S9.gold_side2
        [/store_gold]
        [store_gold]
            side=3
            variable=S9.gold_side3
        [/store_gold]

        # Set up the array with the random event names
        [set_variables]
            name=S9.events
            [split]
                list= "Vanak_appears,lurker_attack,PekszJE_appear,Mal_An_appears,Grnk_staggers,wolf_event,wolf_event,Koorzhar_appears,Koorzhar_appears,Koorzhar_appears"
                # Not included (triggered separately)
                # Wyssauba_talks_nodespair, stonehand_appears, transform_saurians (now a 'turn 10 event)
                # gryphons_pass_by (now side 4 turn 5) and village capture (*3)
                separator=","
                key=name
            [/split]
        [/set_variables]
    [/event]

    [event]
        name=start

        {S9_START_SEQUENCE}

        {MESSAGE_RIGHT Grnk _"Gertburt! You better stay away from me. I'm dangerous, especially to my friends."}
        {MESSAGE_RIGHT Gertburt _"Yeah, I heard what happened."}
        {MESSAGE_RIGHT Grnk _"So you have come to kill me?"}
        {MESSAGE_RIGHT Gertburt _"Kill you? On the contrary, the chaps and I are here to help you. It's rare to see a fella stand up for what he believes in any more these days. So what's your plan?"}
        {MESSAGE_RIGHT Grnk _"I wish I had one. Getting as far away from Shmaltupp as possible is all I can think of. I think I'll wait until those saurians have fought it out and sneak across the swamp when they're done."}
        {MESSAGE_RIGHT Gertburt _"You don't have time for that. Koorzhar's people will be here any moment. I suggest you head past the mountains in the northwest and make your escape along the coast. You might be able to get away from them there."}

        {HIGHLIGHT_IMAGE_SHORT 1 7 scenery/signpost.png ()}

        {MESSAGE_RIGHT Gertburt _"One more thing, little fella. I promised the chaps that this wouldn't turn into a massacre."}
        {MESSAGE_RIGHT Grnk _"Fair enough."}

        [objectives]
            side=1
            summary=_"Objectives for Grnk and Gertburt"
            [objective]
                description=_"Move Grnk to the signpost"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Gertburt"
                condition=lose
            [/objective]
            [objective]
                description=_"More than one of Gertburt's chaps dies"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=no
                carryover_percentage=100
            [/gold_carryover]
        [/objectives]
    [/event]

    # Common events for S9 restarts and/or S10
    {PURSUERS_APPEAR}
    {GERTBURT_CHAPS_DIE}
    {S9_PEASANTS_FIRST_TIME}

    # This is here to allow the second peasant event to happen even if
    # the previous was delayed until after the next restart
    [event]
        name=new_turn
        first_time_only=no

        {CLEAR_VARIABLE S9.peasant_event_this_turn}
    [/event]

    # When Grnk gets close to the signposts, he is killed
    # At 1,7
    [event]
        name=moveto
        [filter]
            id=Grnk
            [filter_location]
                x,y=1,7
                radius=6
            [/filter_location]
        [/filter]

        {UNIT 4 Sergeant 1 7 (id=sergeant2)}
        {MESSAGE sergeant2 "" "" _"Well done, men. We got him!"}

        {SURROUND_UNIT id=Grnk (Spearman,Bowman) soldier 1 7}
        {MESSAGE sergeant2 "" "" _"Kill him!"}
        {MESSAGE Grnk "" "" _"Where is that help I was promised?"}
        {ATTACK_UNTIL_DEATH id=Grnk soldier melee 5}

        [dialog_defeat]
            message=_"You have been defeated!"
        [/dialog_defeat]

        {S9_RESET_MAP}
        {S9_START_SEQUENCE}
        # Saurian variables not needed any more after this
        {CLEAR_VARIABLE S9.stored_Clerezzasz,S9.stored_Xaz,S9.gold_side2,S9.gold_side3}

        {MESSAGE_RIGHT Grnk _"Gertburt! You better stay away from me. I'm dangerous, especially to my friends."}
        {MESSAGE_RIGHT Gertburt _"Yeah, I heard what happened."}
        {MESSAGE_RIGHT Grnk _"So you have come to kill me?"}

        {MESSAGE_RIGHT Gertburt _"Kill you? On the contrary ..."}
        {MESSAGE_RIGHT Grnk _"""... the chaps and I are here to help you. It's rare to see a fella stand up for what he believes in any more these days."""}
        {MESSAGE_RIGHT Gertburt _"How did you know I was going to say that?!?"}
        {MESSAGE_RIGHT Grnk _"Because this has all happened before. You're also going to tell me that Koorzhar's people are right behind me and that we need to head past the mountains in the northwest, right?"}
        {MESSAGE_RIGHT Gertburt _"Uh, right."}
        {MESSAGE_RIGHT Grnk _"We cannot do that. Koorzhar's troops are waiting there for me."}
        {MESSAGE_RIGHT Gertburt _"How do you know that?"}
        {MESSAGE_RIGHT Grnk _"The same way how I knew what you were going to say, because I've seen it happen."}
        {MESSAGE_RIGHT Gertburt _"You know how crazy this sounds, don't you?"}
        {MESSAGE_RIGHT Grnk _"I do. But it's true."}
        {MESSAGE_RIGHT Gertburt _"You're an odd little fella, Grnk, but fine, let's take the abandoned road through the swamps in the east instead."}

        {REMOVE_IMAGE 1 7}
        {HIGHLIGHT_IMAGE_SHORT 56 32 scenery/signpost.png ()}

        {MESSAGE_RIGHT Gertburt _"One more thing, little fella."}
        {MESSAGE_RIGHT Grnk _"Let me guess, your chaps don't want to be massacred."}
        {MESSAGE_RIGHT Gertburt _"Right ..."}

        {S9_PEASANTS_SECOND_TIME}

        [show_objectives]
        [/show_objectives]

        # Second signpost, at 56,32
        [event]
            name=moveto
            [filter]
                id=Grnk
                [filter_location]
                    x,y=56,32
                    radius=6
                [/filter_location]
            [/filter]

            {UNIT 4 Sergeant 56 32 (id=sergeant2)}
            {MESSAGE sergeant2 "" "" _"Well done, men. We got him!"}

            {SURROUND_UNIT id=Grnk (Spearman,Bowman) soldier 56 32}
            {MESSAGE Grnk "" "" _"Not again!"}
            {MESSAGE sergeant2 "" "" _"Kill him and that damned bandit bastard!"}
            {ATTACK_UNTIL_DEATH id=Grnk soldier melee 5}
            {SURROUND_UNIT id=Gertburt (Spearman,Bowman) soldier2 56 32}
            {ATTACK_UNTIL_DEATH id=Gertburt soldier2 melee 5}

            [dialog_defeat]
                message=_"You have been defeated!"
            [/dialog_defeat]
            [dialog_message]
                message=_"Or have you?"
            [/dialog_message]

            # Sound and flash white
            {SOUND dragonstick.ogg}
            {COLOR_ADJUST 255 255 255}

            # Kill everybody on the field
            [kill]
                x=1-999
            [/kill]

            # Reset Grnk to what he was at the beginning of the scenario
            # and put on recall list
            [unstore_unit]
                variable=S9.stored_Grnk_start
            [/unstore_unit]
            {PUT_TO_RECALL_LIST id=Grnk}

            # Back to normal color
            {COLOR_ADJUST 0 0 0}

            {MESSAGE narrator "portraits/humans/transparent/mage-arch.png~O(25%)" "Grossauba" _"I am astonished by what I have seen. I have never met anybody who could do that kind of magic without years of instruction. You do exhibit a certain lack of control though."}

            # This ends the scenario
            # House cleaning
            {CLEAR_VARIABLE S9}

            [endlevel]
                result=victory
                carryover_report=no
                bonus=no
                carryover_add=yes
                carryover_percentage=100
                linger_mode=no
            [/endlevel]
        [/event]
    [/event]

    # Event handler for all the random stuff
    # This triggers at each new turn, then spawns different events
    [event]
        name=new turn
        first_time_only=no

        # First determine what event should be triggered, and by what trigger
        [switch]
            variable=turn_number
            [case]
                value=1,2
                {VARIABLE S9.trigger nothing_turn1_2}
                {VARIABLE S9.event ""}
            [/case]
            [case]
                value=3
                {VARIABLE S9.event stonehand_appears}
                {VARIABLE S9.trigger side1_turn}
            [/case]
            [case]
                value=6
                {VARIABLE S9.event Wyssauba_talks_nodespair}
                {VARIABLE S9.trigger side1_turn}
            [/case]
            # This can be used to force triggering any of the events
            # Set 'value=1,2'  (or similar)
            [case]
                value=1111
                {VARIABLE S9.trigger moveto}
                #{VARIABLE S9.event Wyssauba_talks_nodespair}
                #{VARIABLE S9.event stonehand_appears}
                #{VARIABLE S9.event Vanak_appears}
                #{VARIABLE S9.event lurker_attack}
                #{VARIABLE S9.event PekszJE_appear}
                #{VARIABLE S9.event Mal_An_appears}
                #{VARIABLE S9.event Grnk_staggers}
                #{VARIABLE S9.event wolf_event}  # 2x
                #{VARIABLE S9.event Koorzhar_appears}  # 3x
            [/case]
            # Comment out for now, but leave for possible reinclusion
            #[case]
            #    value=$S9.no_event_this_turn
            #    # This will override everything that happened previously
            #    # It will also prevent the [else] case from happening
            #    {VARIABLE S9.trigger nothing_forced}
            #    {VARIABLE S9.event ""}
            #    {CLEAR_VARIABLE S9.no_event_this_turn}
            #[/case]
            [else]
                # Random number drawing contains one more number than events available
                # -> chance of a "nothing" event (increasing throughout scenario)
                # -> automatically nothing happens when all events are used
                {RANDOM "0..$S9.events.length"}
                #{DEBUG "0 .. $S9.events.length : $random"}
                {IF_VAR random equals $S9.events.length (
                    [then]
                        {VARIABLE S9.trigger nothing_random}
                        {VARIABLE S9.event ""}
                    [/then]
                    [else]
                        {VARIABLE S9.event $S9.events[$random].name}
                        {CLEAR_VARIABLE S9.events[$random]}
                        [switch]
                            variable=S9.event
                            [case] # Some events require a specific trigger
                                value=Grnk_staggers
                                {VARIABLE S9.trigger select}
                                #{DEBUG "Random event $S9.event: force trigger to $S9.trigger"}
                            [/case]
                            [else]  # Otherwise choose a random trigger
                                [set_variable]
                                    name=S9.trigger
                                    rand=side1_turn,side1_turn_end,moveto
                                [/set_variable]
                                #{DEBUG "Random event $S9.event: choose random trigger: $S9.trigger"}
                            [/else]
                        [/switch]
                    [/else]
                )}
                {CLEAR_VARIABLE random}
            [/else]
        [/switch]
        #{DEBUG "$turn_number: $S9.trigger $S9.event  $S9.no_event_this_turn"}

        # This will trigger the events at the correct instances
        [switch]
            variable=S9.trigger
            [case]
                value=side1_turn
                [event]
                    name=side 1 turn

                    [scroll_to_unit]
                        id=Grnk
                    [/scroll_to_unit]
                    [fire_event]
                        name=$S9.event
                    [/fire_event]
                [/event]
            [/case]
            [case]
                value=side1_turn_end
                [event]
                    name=side 1 turn end

                    [scroll_to_unit]
                        id=Grnk
                    [/scroll_to_unit]
                    [fire_event]
                        name=$S9.event
                    [/fire_event]
                [/event]
            [/case]
            [case]
                value=moveto
                [event]
                    name=moveto
                    [filter]
                        id=Grnk
                    [/filter]

                    [scroll_to_unit]
                        id=Grnk
                    [/scroll_to_unit]
                    [fire_event]
                        name=$S9.event
                    [/fire_event]
                [/event]
            [/case]
            [case]
                value=select
                [event]
                    name=select
                    [filter]
                        id=Grnk
                    [/filter]

                    [scroll_to_unit]
                        id=Grnk
                    [/scroll_to_unit]
                    [fire_event]
                        name=$S9.event
                    [/fire_event]
                [/event]
            [/case]
        [/switch]
    [/event]

    # Just in case Grnk did not move or was not selected this turn, we
    # force fire those events at the end of the turn
    # This can be done indiscriminately, as the actual events only fire once
    [event]
        name=side 1 turn end
        first_time_only=no

        [fire_event]
            name=moveto
            [primary_unit]
                id=Grnk
            [/primary_unit]
        [/fire_event]

        # Event Grnk_staggers needs 4 select events, but
        # they cannot just be put into a repeat (BfW feature or bug?)
        # spread them out over the next side turns instead (which actually increases the chaos!)
        [fire_event]
            name=select
            [primary_unit]
                id=Grnk
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=side 2 turn
        first_time_only=no

        [fire_event]
            name=select
            [primary_unit]
                id=Grnk
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=side 3 turn
        first_time_only=no

        [fire_event]
            name=select
            [primary_unit]
                id=Grnk
            [/primary_unit]
        [/fire_event]
    [/event]
    [event]
        name=side 3 turn end
        first_time_only=no

        [fire_event]
            name=select
            [primary_unit]
                id=Grnk
            [/primary_unit]
        [/fire_event]
    [/event]

    # Now come all the different events that can be called by this
    # Fixed event: Stonehand appears
    [event]
        name=stonehand_appears

        {SWITCH_TO_FOG}
        {MESSAGE Grnk "" "" _"What the ..."}

        # Stonehand appears
        {VARIABLE stored_stonehand.side 4}
        [unstore_unit]
            variable=stored_stonehand
            x,y=$S9.hex1_x,$S9.hex1_y
        [/unstore_unit]
        {FULL_HEAL_AND_CURE id=$stored_stonehand.id}
        {MOVE_UNIT id=$stored_stonehand.id $S9.hex2_x $S9.hex2_y}

        {MESSAGE $stored_stonehand.id "" "" _"That goblin turned my hand to stone. I will make him pay for that!"}

        # Karcyn appears
        {CLOSE_EMPTY_HEX $S9.hex2_x $S9.hex2_y (*^X*,W*) 1}
        {IF_VAR hex_x greater_than $S9.hex2_x (
            [then]
                {VARIABLE S9.facing sw}
            [/then]
            [else]
                {VARIABLE S9.facing se}
            [/else]
        )}
        {FIREBALL $hex_x $hex_y "~GS()"}
        [recall]
            id=Karcyn
            x,y=$hex_x,$hex_y
            show=no
        [/recall]
        {MODIFY_UNIT id=Karcyn facing $S9.facing}
        {CLEAR_VARIABLE S9.facing}

        {MESSAGE Karcyn "" "" _"Oh no, you won't. The Master wants that goblin alive."}
        {FIREBALL $hex_x $hex_y "~GS()"}
        {PUT_TO_RECALL_LIST id=Karcyn}
        {CLEAR_VARIABLE hex_x,hex_y}
        {MESSAGE $stored_stonehand.id "" "" {GASP _"grumbles"}}
        {MOVE_UNIT id=$stored_stonehand.id $S9.hex1_x $S9.hex1_y}

        # Dialog with Gertburt in "dream"
        {DELAY 500}
        [unstore_unit]
            variable=S9.stored_Gertburt
            x,y=$S9.hex1_x,$S9.hex1_y
        [/unstore_unit]
        {MOVE_UNIT id=Gertburt $S9.hex2_x $S9.hex2_y}

        {MESSAGE Gertburt "" "" _"What's up, little fella? You look like you've seen a ghost."}
        {MESSAGE Grnk "" "" _"Uh ..."}
        {MESSAGE Gertburt "" "" _"Hello? Hello-oh!!"}

        # Back to reality
        {RESET_FROM_FOG}

        # Dialog with Gertburt in reality
        {DELAY 800}
        {MESSAGE Gertburt "" "" _"What's up, little fella? You look like you've seen a ghost."}
        {MESSAGE Grnk "" "" _"Uh ..."}
        {MESSAGE Gertburt "" "" _"Hello? Hello-oh!!"}
        {MESSAGE Grnk "" "" _"What?"}
        {MESSAGE Gertburt "" "" _"I said, you look like you've seen a ghost. Are you feeling alright?"}
        {MESSAGE Grnk "" "" _"No, I am definitely not feeling alright. Very strange things are going on here. I think ... I must ... I think I am seeing the future."}
        {MESSAGE Gertburt "" "" _"You what?"}
        {MESSAGE Grnk "" "" _"I just saw you say that ... And then there was a flash of light and there you were saying it again ... But I had already seen you say it ... I ... I think I am going crazy."}
    [/event]

    # Fixed event: Wyssauba message: don't despair
    [event]
        name=Wyssauba_talks_nodespair

        {MESSAGE narrator "portraits/humans/transparent/mage-light.png~O(25%)" _"A Voice from the Distance" _"Grnk, do not despair. Help is on the way."}
        {MESSAGE Grnk "" "" _"What was that? Who said that?"}
        {MESSAGE Gertburt "" "" _"Said what?"}
    [/event]

    # Fixed event: Gryphons pass by
    [event]
        name=side 4 turn 5

        {UNIT 6 Gryphon 1 22 (upkeep,id,name=0,gryphon1,Kraa)}
        {UNIT 6 Gryphon 1 23 (upkeep,id=0,gryphon2)}
        {UNIT 6 Gryphon 1 25 (upkeep,id=0,gryphon3)}

        {MESSAGE_RIGHT gryphon1 _"Kraahhh!!!!"}
        {MESSAGE narrator "portraits/humans/transparent/mage-arch.png~O(25%)" "Grossauba" _"Gryphons of the High Planes, join us in our fight against the undead."}
        {MESSAGE_RIGHT gryphon1 _"We do not like the undead, but you are allied with that mad goblin. We cannot help you."}

        [kill]
            id=gryphon2
        [/kill]
        [move_unit_fake]
            type=Gryphon
            side=4
            x=1,3,1
            y=23,21,18
        [/move_unit_fake]

        [kill]
            id=gryphon3
        [/kill]
        [move_unit_fake]
            type=Gryphon
            side=4
            x=1,4,1
            y=25,22,19
        [/move_unit_fake]

        [kill]
            id=gryphon1
        [/kill]
        [move_unit_fake]
            type=Gryphon
            side=4
            x=1,2,1
            y=22,19,18
        [/move_unit_fake]

        {MESSAGE Grnk "" "" _"Did you see that at least?"}
        {MESSAGE Gertburt "" "" _"See what?"}
    [/event]

    # Fixed event: Transform all saurians to drakes
    # This happens on the move of the 2nd Side 1 unit other than Grnk and Gertburt on turn 10
    [event]
        name=turn 10

        [event]
            name=moveto
            [filter]
                side=1
                [not]
                    id=Grnk,Gertburt
                [/not]
            [/filter]

            [event]
                name=moveto
                [filter]
                    side=1
                    [not]
                        id=Grnk,Gertburt
                    [/not]
                [/filter]

                [store_unit]
                    [filter]
                        side=2,3
                    [/filter]
                    variable=S9.stored_saurians
                [/store_unit]

                {FOREACH S9.stored_saurians S9.i}
                    {SCROLL_TO $S9.stored_saurians[$S9.i].x $S9.stored_saurians[$S9.i].y}
                    {WHITE_MISSILE $S9.stored_saurians[$S9.i].id "~GS()~CS(0,-50,0)"}
                    [switch]
                        variable=S9.stored_saurians[$S9.i].type
                        [case]
                            value=Saurian Augur
                            [transform_unit]
                                id=$S9.stored_saurians[$S9.i].id
                                transform_to=Drake Burner
                            [/transform_unit]
                        [/case]
                        [case]
                            value=Saurian Skirmisher
                            [transform_unit]
                                id=$S9.stored_saurians[$S9.i].id
                                transform_to=Drake Fighter
                            [/transform_unit]
                        [/case]
                        [case]
                            value=Saurian Oracle
                            [transform_unit]
                                id=$S9.stored_saurians[$S9.i].id
                                transform_to=Drake Flare
                            [/transform_unit]
                        [/case]
                        [case]
                            value=Saurian Soothsayer
                            [transform_unit]
                                id=$S9.stored_saurians[$S9.i].id
                                transform_to=Fire Drake
                            [/transform_unit]
                        [/case]
                        [case]
                            value=Saurian Ambusher
                            [transform_unit]
                                id=$S9.stored_saurians[$S9.i].id
                                transform_to=Drake Warrior
                            [/transform_unit]
                        [/case]
                        [case]
                            value=Saurian Flanker
                            [transform_unit]
                                id=$S9.stored_saurians[$S9.i].id
                                transform_to=Drake Blademaster
                            [/transform_unit]
                        [/case]
                    [/switch]
                {NEXT S9.i}

                [modify_side]
                    side=2
                    recruit=Drake Burner,Drake Fighter
                [/modify_side]
                [modify_side]
                    side=3
                    recruit=Drake Burner,Drake Fighter
                [/modify_side]

                {SCROLL_TO 13 13}
                {SOUND drake-die.ogg}
                {DELAY 1200}
                {SCROLL_TO 44 29}
                {SOUND drake-die.ogg}
                {DELAY 1200}

                {MESSAGE Gertburt "" "" _"How the hell did you do that?"}
                {MESSAGE Grnk "" "" _"I have no idea. I swear! I don't even know if it was I who did this."}
                {MESSAGE narrator "portraits/humans/transparent/mage-light.png~O(25%)" _"A Voice from the Distance" _"Grnk, why don't you join me and we will work together on getting your magic under control."}
                {MESSAGE Grnk "" "" _"But who are you? Where do I find you?"}
                {MESSAGE Gertburt "" "" _"Umm, I'm Gertburt and I'm right here. We've met before ... Are you alright?"}
            [/event]
        [/event]
    [/event]

    # Random event: Vanak appears
    [event]
        name=Vanak_appears

        {SWITCH_TO_FOG}

        # Vanak appears
        [recall]
            id=Vanak
            x,y=$S9.hex1_x,$S9.hex1_y
        [/recall]
        {MOVE_UNIT id=Vanak $S9.hex2_x $S9.hex2_y}

        {MESSAGE Vanak "" "" _"They there! We them help!"}
        {MESSAGE Grnk "" "" _"Vanak! You're back. You're still alive! And you're here to help me???"}
        {MESSAGE Vanak "" "" _"Little goblin help Vanak. Vanak help little gob ..."}

        # Karcyn appears
        {CLOSE_EMPTY_HEX $S9.hex2_x $S9.hex2_y (*^X*,W*) 1}
        {IF_VAR hex_x greater_than $S9.hex2_x (
            [then]
                {VARIABLE S9.facing sw}
            [/then]
            [else]
                {VARIABLE S9.facing se}
            [/else]
        )}
        {FIREBALL $hex_x $hex_y "~GS()"}
        [recall]
            id=Karcyn
            x,y=$hex_x,$hex_y
            show=no
        [/recall]
        {MODIFY_UNIT id=Karcyn facing $S9.facing}
        {CLEAR_VARIABLE S9.facing}

        {MESSAGE Karcyn "" "" _"Oh no, you won't."}
        {FIREBALL $S9.hex2_x $S9.hex2_y "~GS()"}
        {PUT_TO_RECALL_LIST id=Vanak}
        {FIREBALL $hex_x $hex_y "~GS()"}
        {PUT_TO_RECALL_LIST id=Karcyn}

        {CLEAR_VARIABLE hex_x,hex_y}

        # Back to reality
        {RESET_FROM_FOG}

        {MESSAGE Grnk "" "" _"Vanak! No!!"}
        {MESSAGE Gertburt "" "" _"What's a vanak?"}
        {MESSAGE Grnk "" "" _"Oh, just ... somebody you wouldn't like very much."}
    [/event]

    # Random event: Lurker attack
    [event]
        name=lurker_attack

        {SWITCH_TO_FOG_TELEPORT 36 36 37 36}

        {UNIT 4 "Swamp Lurker" 37 37 id=lurker0}
        {UNIT 4 "Swamp Lurker" 35 36 id=lurker1}
        {UNIT 4 "Swamp Lurker" 35 37 id=lurker2}
        {UNIT 4 "Swamp Lurker" 36 35 id=lurker3}

        # Make them very colorful
        [object]
            silent=yes
            [filter]
                id=lurker0
            [/filter]
            [effect]
                apply_to=image_mod
                replace=CS(-84,-125,0)
            [/effect]
        [/object]
        [object]
            silent=yes
            [filter]
                id=lurker1
            [/filter]
            [effect]
                apply_to=image_mod
                replace=CS(0,-128,-128)
            [/effect]
        [/object]
        [object]
            silent=yes
            [filter]
                id=lurker2
            [/filter]
            [effect]
                apply_to=image_mod
                replace=CS(0,0,-255)
            [/effect]
        [/object]
        [object]
            silent=yes
            [filter]
                id=lurker3
            [/filter]
            [effect]
                apply_to=image_mod
                replace=CS(-255,0,-127)
            [/effect]
        [/object]

        {MESSAGE Grnk "" "" _"Those lurker thingers again!"}
        {VARIABLE SU_n_locs 4}
        {ATTACK_UNTIL_DEATH id=Grnk lurker melee 4}

        {RESET_FROM_FOG_TELEPORT}

        {MESSAGE Grnk "" "" _"Ouch, that hurt!"}
        {MESSAGE Gertburt "" "" _"Did you step on something?"}
    [/event]

    # Random event: Pekzs and Jen emaris appear, attack Grnk
    [event]
        name=PekszJE_appear

        {SWITCH_TO_FOG_TELEPORT 30 5 25 7}
        # Only one of them is alive -> recreate both
        {UNIT 4 (Mermaid Priestess) 17 1 (id,name,canrecruit="Jen emaris","Jen emaris",yes)}
        {UNIT 4 (Saurian Soothsayer) 31 12 (id,name,canrecruit=Pekzs,Pekzs,yes)}

        {MOVE_UNIT id=Pekzs 30 6}
        {MESSAGE Pekzs "" "" _"Zzere he isss!"}
        {MOVE_UNIT (id=Jen emaris) 29 5}
        {MESSAGE (Jen emaris) "" "" _"You turned us against each other!"}
        {MESSAGE Grnk "" "" _"That's not true! You were already fighting and forced me to choose sides."}
        {MESSAGE (Jen emaris) "" "" _"Lies! As punishment, we will hand you over to the humans."}

        {UNIT 4 (Transport Galleon) 20 12 id=galleon}
        {SOUND ambient/ship.ogg}
        {MOVE_UNIT (id=galleon) 29 6}
        {MESSAGE Pekzs "" "" _"Get onto zze damned boat!"}

        # Move Grnk onto the boat
        [kill]
            id=Grnk
        [/kill]
        [move_unit_fake]
            type=$S9.tmp_Grnk.type
            side=1
            x=30,29
            y=5,6
        [/move_unit_fake]
        {SOUND ambient/ship.ogg}
        {MOVE_UNIT (id=galleon) 22 4}
        {MESSAGE narrator "portraits/humans/transparent/thug.png~FL()~RIGHT()" "Galleon Captain" _"Get out!"}

        # Move Grnk off the boat
        [move_unit_fake]
            type=$S9.tmp_Grnk.type
            side=1
            x=22,20
            y=4,6
        [/move_unit_fake]
        [unstore_unit]
            variable=S9.tmp_Grnk
            x,y=20,6
        [/unstore_unit]

        {MESSAGE narrator "portraits/humans/transparent/lieutenant.png" _"Prison Island Leader" _"I wish they had executed him. I bet he's going to be nothing but trouble."}

        {RESET_FROM_FOG_TELEPORT}

        {MESSAGE Gertburt "" "" _"Are you okay? You look a bit woozy."}
        {MESSAGE Grnk "" "" _"I think boats don't agree with me."}
    [/event]

    # Random event: Mal An appears, skeletons kill Grnk
    [event]
        name=Mal_An_appears

        {SWITCH_TO_FOG_TELEPORT 13 9 12 4}
        {UNIT 4 (Water Lich) 7 3 (id,name,canrecruit="Mal An","Mal An",yes)}
        {UNIT 5 Revenant 8 2 (id=skeleton0)}
        {UNIT 5 (Bone Shooter) 8 3 (id=skeleton1)}
        {UNIT 5 Deathblade 7 4 (id=skeleton2)}

        {MESSAGE_RIGHT (Mal An) _"Remember, the Master wants that goblin alive!"}
        {MOVE_UNIT id=skeleton0 13 6}
        {MOVE_UNIT id=skeleton1 12 6}
        {MOVE_UNIT id=skeleton2 8 8}
        {MOVE_UNIT (id=Mal An) 9 7}
        {DELAY 700}
        {MOVE_UNIT id=skeleton0 14 6}
        {MOVE_UNIT id=skeleton1 13 7}
        {MOVE_UNIT id=skeleton2 9 9}
        {MOVE_UNIT (id=Mal An) 10 7}

        # The recruited skeletons animations, using some trickery
        # as I cannot get it to work without adjacent units
        # 2 hidden units, to recruiting_animate against
        {UNIT 4 Skeleton 11 7 (animate=yes)}
        {UNIT 4 Skeleton 9 7 (animate=yes)}
        # 3 pseudo-recruited skeletons
        {RECRUITING_ANIMATION (id=Mal An) (x,y=9,7)}
        {UNIT 4 Skeleton 9 8 (animate=yes)}
        {RECRUITING_ANIMATION (id=Mal An) (x,y=11,7)}
        {UNIT 4 Skeleton 11 8 (animate=yes)}
        {RECRUITING_ANIMATION (id=Mal An) (x,y=11,7)}
        {UNIT 4 (Skeleton Archer) 10 8 (animate=yes)}

        {MESSAGE Grnk "" "" _"How the hell does he do that?!"}
        {MESSAGE narrator "portraits/humans/transparent/bandit.png" _"Mounry" _"I don't know. Black magic?"}

        {MOVE_UNIT id=skeleton0 14 8}
        {MOVE_UNIT id=skeleton1 13 8}
        {MOVE_UNIT id=skeleton2 13 10}

        {VARIABLE SU_n_locs 3}
        {ATTACK_UNTIL_DEATH id=Grnk skeleton melee 7}

        {MESSAGE (Mal An) "" "" _"Idiots! How often have I told you that the Master wants that goblin alive! His wrath will be terrible."}
        {RESET_FROM_FOG_TELEPORT}

        {MESSAGE Grnk "" "" _"What do those skeletons want from me?!"}
    [/event]

    # Random event: Grnk moves around randomly
    [event]
        name=Grnk_staggers

        {STORE_UNIT_VAR id=Grnk x S9.Grnk_org_x}
        {STORE_UNIT_VAR id=Grnk y S9.Grnk_org_y}

        {MESSAGE Grnk "" "" _"I feel kind of dizzy!"}
        {EARTHQUAKE_OWN {GRNK_MOVES_AWAY}}

        # 3 more select events, on each of which Grnk staggers some more
        [event]
            name=select
            [filter]
                id=Grnk
            [/filter]

            {EARTHQUAKE_OWN {GRNK_MOVES_AWAY}}

            [event]
                name=select
                [filter]
                    id=Grnk
                [/filter]

                {EARTHQUAKE_OWN {GRNK_MOVES_AWAY}}

                [event]
                    name=select
                    [filter]
                        id=Grnk
                    [/filter]

                    {EARTHQUAKE_OWN {MOVE_UNIT id=Grnk $S9.Grnk_org_x $S9.Grnk_org_y}}
                    {CLEAR_VARIABLE S9.Grnk_org_x,S9.Grnk_org_y}
                    {MESSAGE Grnk "" "" _"Whoa, this brings back memories of Shmaltupp Lager."}
                [/event]
            [/event]
        [/event]
    [/event]

    # Random event: Grnk and his wolf (2 events in one)
    [event]
        name=wolf_event

        # Store current Grnk
        [store_unit]
            [filter]
                id=Grnk
            [/filter]
            variable=S9.tmp_Grnk
        [/store_unit]

        {SWITCH_TO_FOG}

        # Place the bait and cage out there, as halo
        {PLACE_IMAGE "units/monsters/giant-rat-die-3.png" $S9.hex2_x $S9.hex2_y}
        [item]
            x,y=$S9.hex2_x,$S9.hex2_y
            halo=items/cage.png
        [/item]
        # And the wolf
        {UNIT 4 Wolf $S9.hex1_x $S9.hex1_y id=wolf}

        {MESSAGE Grnk "" "" _"Here, wolfie, wolfie, wolfie ..."}
        {MOVE_UNIT id=wolf $S9.hex2_x $S9.hex2_y}

        # Remove the rat and place the cage again
        {REMOVE_IMAGE $S9.hex2_x $S9.hex2_y}
        [item]
            x,y=$S9.hex2_x,$S9.hex2_y
            halo=items/cage.png
        [/item]

        {MESSAGE Grnk "" "" _"I did it! I caught a wolf!! Now how do I get onto it without being eaten?"}
        {MESSAGE Grnk "" "" _"Here, little puppy."}
        {SOUND wolf-growl-1.ogg}
        {MESSAGE wolf "" "" _"Grrrrrrwwwllll !!!"}
        {MESSAGE Grnk "" "" _"Nice little wolfie."}
        {SOUND wolf-growl-1.ogg}
        {MESSAGE wolf "" "" _"Grrrrrrwwwllll !!!"}
        {BOOMING_VOICE_EFFECT_GRNK Grnk _"Quiet, you ..." $S9.hex2_x $S9.hex2_y 0.35}
        {MESSAGE Grnk "" "" _"... or I will turn you into a ghast!"}
        {SOUND wolf-die.wav}
        {MESSAGE wolf "" "" _"Yelp !"}

        [kill]
            id=Grnk
        [/kill]

        # Turn Grnk into Wolf Rider
        [move_unit_fake]
            type=$S9.tmp_Grnk.type
            side=1
            x=$S9.tmp_Grnk.x,$S9.hex2_x
            y=$S9.tmp_Grnk.y,$S9.hex2_y
        [/move_unit_fake]
        [kill]
            id=wolf
        [/kill]
        {UNIT 1 "Grnk the Rider" $S9.hex2_x $S9.hex2_y (id,name,canrecruit=Grnk,Grnk,yes)}

        {DELAY 600}
        {MOVE_UNIT id=Grnk $S9.tmp_Grnk.x $S9.tmp_Grnk.y}
        {MESSAGE Grnk "" "" _"Look at me, I am riding a wolf !!!"}

        {REMOVE_IMAGE $S9.hex2_x $S9.hex2_y}
        [unstore_unit]
            variable=S9.tmp_Grnk
        [/unstore_unit]
        {RESET_FROM_FOG}

        {MESSAGE Grnk "" "" _"What was that? Now I am seeing the past?"}

        # The second wolf event
        [event]
            name=wolf_event

            # Store current Grnk
            [store_unit]
                [filter]
                    id=Grnk
                [/filter]
                variable=S9.tmp_Grnk
            [/store_unit]

            {SWITCH_TO_FOG}

            # Wolf is already in the cage this time
            [item]
                x,y=$S9.hex2_x,$S9.hex2_y
                halo=items/cage.png
            [/item]
            # And the wolf
            {UNIT 4 Wolf $S9.hex2_x $S9.hex2_y id=wolf}

            {MESSAGE Grnk "" "" _"... or I will turn you into a ghast!"}
            {SOUND wolf-growl-1.ogg}
            {MESSAGE wolf "" "" _"Grrrrrrwwwllll !!!"}

            # Transform wolf into ghast
            {LIGHT_BEAM wolf}
            [transform_unit]
                id=wolf
                transform_to=Ghast
            [/transform_unit]
            {FULL_HEAL id=wolf}
            # Need to replace the cage
            [item]
                x,y=$S9.hex2_x,$S9.hex2_y
                halo=items/cage.png
            [/item]

            {MESSAGE Grnk "" "" _"I warned you."}
            {SOUND wolf-growl-1.ogg}
            {MESSAGE wolf "" "" _"Arr !!!"}
            {MESSAGE Grnk "" "" _"Ooo, you're really scaring me."}
            {SOUND wolf-growl-2.ogg}
            {MESSAGE wolf "" "" _"Aaarrrrrrrr !!!"}

            # Break the cage
            {SOUND flail.ogg}
            {REMOVE_IMAGE $S9.hex2_x $S9.hex2_y}
            {PLACE_IMAGE items/cage_broken.png $S9.hex2_x $S9.hex2_y}
            {PLACE_IMAGE items/cage_broken_top.png $S9.hex2_x "$($S9.hex2_y-1)"}

            {FAR_EMPTY_HEX $S9.tmp_Grnk.x $S9.tmp_Grnk.y (*^X*,W*) 2}
            {MOVE_UNIT id=wolf $hex_x $hex_y}
            {MESSAGE Grnk "" "" _"Ok, now I <i>am</i> scared. Unbreakable cage my ass!"}

            # Ghast and Grnk fight it out (ghast will usually win)
            {CLOSE_EMPTY_HEX $S9.tmp_Grnk.x $S9.tmp_Grnk.y (*^X*,W*) 1}
            {MOVE_UNIT id=wolf $hex_x $hex_y}
            {CLEAR_VARIABLE hex_x,hex_y}
            {FIGHT_TO_DEATH wolf Grnk no}

            # The victor will say this:
            {DELAY 600}
            {SOUND wolf-growl-2.ogg}
            {MESSAGE wolf "" "" _"Aaarrrrrrrr !!!"}
            {MESSAGE Grnk "" "" _"Aaarrrrrrrr !!!"}

            # In case the ghast is killed, Grnk needs to be removed:
            [kill]
                x=1-999  # This works on everybody
            [/kill]

            # Then reset
            {REMOVE_IMAGE $S9.hex2_x $S9.hex2_y}
            {REMOVE_IMAGE $S9.hex2_x "$($S9.hex2_y-1)"}
            [unstore_unit]
                variable=S9.tmp_Grnk
            [/unstore_unit]
            {RESET_FROM_FOG}

            {MESSAGE Grnk "" "" _"No!!! That's not how it happened."}
            {MESSAGE Gertburt "" "" _"What are you talking about?"}
            {MESSAGE Grnk "" "" _"I just saw me capture my wolf, again, but it was all different and messed up."}
            {MESSAGE Gertburt "" "" _"So what you're saying is that the past you're seeing is all wrong? Then why should the future be any realer?"}
            {MESSAGE Grnk "" "" _"I don't know. I don't even know if anything is real any more."}
            {MESSAGE Gertburt "" "" _"I'm real. At least I think so."}
        [/event]
    [/event]

    # Random event: Koorzhar and Rutburt (3 events in one)
    [event]
        name=Koorzhar_appears

        {SWITCH_TO_FOG}

        # Get Koorzhar out, store, put back on recall list, then put 2nd copy onto map
        [recall]
            id=Koorzhar
            x,y=$S9.hex1_x,$S9.hex1_y
        [/recall]
        [store_unit]
            [filter]
                id=Koorzhar
            [/filter]
            variable=S9.tmp_Koorzhar
        [/store_unit]
        {PUT_TO_RECALL_LIST id=Koorzhar}
        [unstore_unit]
            variable=S9.tmp_Koorzhar
        [/unstore_unit]

        # Transform to the correct unit for the attack vs. attack animation
        # This requires the special [defend] animation that really is an attack (special units)
        {IF_VAR S9.tmp_Koorzhar.type equals Lieutenant (
            [then]
                [transform_unit]
                    id=Koorzhar
                    transform_to=Lieutenant_attack_only
                [/transform_unit]
            [/then]
            [else]
                [transform_unit]
                    id=Koorzhar
                    transform_to=General_attack_only
                [/transform_unit]
            [/else]
        )}
        {FULL_HEAL id=Koorzhar}

        {MOVE_UNIT id=Koorzhar $S9.hex2_x $S9.hex2_y}
        {MESSAGE Koorzhar "" "" _"There he is!"}

        # Get Rutburt out, store, put back on recall list, then put 2nd copy onto map
        [recall]
            id=Rutburt
            x,y=$S9.hex1_x,$S9.hex1_y
        [/recall]
        [store_unit]
            [filter]
                id=Rutburt
            [/filter]
            variable=S9.tmp_Rutburt
        [/store_unit]
        {PUT_TO_RECALL_LIST id=Rutburt}
        [unstore_unit]
            variable=S9.tmp_Rutburt
        [/unstore_unit]

        # Transform to the correct unit for the attack vs. attack animation
        # This requires the special [defend] animation that really is an attack (special units)
        {IF_VAR S9.tmp_Koorzhar.type equals Outlaw (
            [then]
                [transform_unit]
                    id=Rutburt
                    transform_to=Outlaw_attack_only
                [/transform_unit]
            [/then]
            [else]
                [transform_unit]
                    id=Rutburt
                    transform_to=Fugitive_attack_only
                [/transform_unit]
            [/else]
        )}
        {FULL_HEAL id=Rutburt}

        # Move Rutburt next to Grnk
        {CLOSE_EMPTY_HEX $S9.Grnk_x $S9.Grnk_y (*^X*,W*) 1}
        {MOVE_UNIT id=Rutburt $hex_x $hex_y}
        {CLEAR_VARIABLE hex_x,hex_y,S9.tmp_Koorzhar,S9.tmp_Rutburt}

        {MESSAGE Rutburt "" "" _"I'll get him!"}
        {MESSAGE Koorzhar "" "" _"Oh no, you won't. That goblin is for me personally."}
        {MESSAGE Rutburt "" "" _"You lying self-serving bastard! You promised me that ..."}
        {MESSAGE Koorzhar "" "" _"I promised you nothing. All I said was ..."}
        {MESSAGE Rutburt "" "" _"You're really getting on my nerves. It's time we end this once and for all."}

        {CLOSE_EMPTY_HEX $S9.hex2_x $S9.hex2_y (*^X*,W*) 1}
        {MOVE_UNIT id=Rutburt $hex_x $hex_y}
        {CLEAR_VARIABLE hex_x,hex_y}

        # dhp: 1/5 of total hitpoints; to be taken off per attack round
        {STORE_UNIT_VAR id=Koorzhar hitpoints S9.Koorzhar_hp}
        {STORE_UNIT_VAR id=Rutburt hitpoints S9.Rutburt_hp}
        {VARIABLE S9.Koorzhar_dhp "$($S9.Koorzhar_hp/5+1)"}
        {VARIABLE S9.Rutburt_dhp "$($S9.Rutburt_hp/5+1)"}

        # 5 rounds of attack vs. attack (special animation) ...
        {REPEAT 5 (
            {ATTACK_ATTACK_ANIMATION id=Koorzhar id=Rutburt melee yes $S9.Koorzhar_dhp yes $S9.Rutburt_dhp}
            {VARIABLE_OP S9.Koorzhar_hp sub $S9.Koorzhar_dhp}
            {MODIFY_UNIT id=Koorzhar hitpoints $S9.Koorzhar_hp}
            {VARIABLE_OP S9.Rutburt_hp sub $S9.Rutburt_dhp}
            {MODIFY_UNIT id=Rutburt hitpoints $S9.Rutburt_hp}
        )}
        # ... which leaves both of them dead
        {MESSAGE Koorzhar "" "" _"Idiot!"}
        {MESSAGE Rutburt "" "" _"Moron!"}
        [kill]
            id=Rutburt,Koorzhar
            x=1-999
            animate=yes
        [/kill]

        {CLEAR_VARIABLE S9.Koorzhar_hp,S9.Rutburt_hp,S9.Koorzhar_dhp,S9.Rutburt_dhp}
        {RESET_FROM_FOG}

        {MESSAGE Grnk "" "" _"Wow. That was weird."}

        #############################################
        # Second appearance of Koorzhar and Rutburt #
        [event]
            name=Koorzhar_appears

            {SWITCH_TO_FOG}

            # Get Koorzhar out, store, put back on recall list, then put 2nd copy onto map
            [recall]
                id=Koorzhar
                x,y=$S9.hex1_x,$S9.hex1_y
            [/recall]
            [store_unit]
                [filter]
                    id=Koorzhar
                [/filter]
                variable=S9.tmp_Koorzhar
            [/store_unit]
            {PUT_TO_RECALL_LIST id=Koorzhar}
            [unstore_unit]
                variable=S9.tmp_Koorzhar
            [/unstore_unit]

            {MOVE_UNIT id=Koorzhar $S9.hex2_x $S9.hex2_y}
            {MESSAGE Koorzhar "" "" _"There he is!"}

            # Get Rutburt out, store, put back on recall list, then put 2nd copy onto map
            [recall]
                id=Rutburt
                x,y=$S9.hex1_x,$S9.hex1_y
            [/recall]
            [store_unit]
                [filter]
                    id=Rutburt
                [/filter]
                variable=S9.tmp_Rutburt
            [/store_unit]
            {PUT_TO_RECALL_LIST id=Rutburt}
            [unstore_unit]
                variable=S9.tmp_Rutburt
            [/unstore_unit]
            {CLEAR_VARIABLE S9.tmp_Koorzhar,S9.tmp_Rutburt}

            # Move Rutburt next to Grnk
            {CLOSE_EMPTY_HEX $S9.Grnk_x $S9.Grnk_y (*^X*,W*) 1}
            {MOVE_UNIT id=Rutburt $hex_x $hex_y}
            {VARIABLE S9.Rutburt_x $hex_x}
            {VARIABLE S9.Rutburt_y $hex_y}

            {MESSAGE Rutburt "" "" _"I'll get him!"}
            {MESSAGE Koorzhar "" "" _"Oh no, you won't. We agreed that we would do this together."}
            {MESSAGE Rutburt "" "" _"Alright, fine. Let's ..."}

            # Now bring Gertburt in
            {FAR_EMPTY_HEX $S9.Grnk_x $S9.Grnk_y (*^X*,Wo) 8}
            [unstore_unit]
                variable=S9.stored_Gertburt
                x,y=$hex_x,$hex_y
            [/unstore_unit]
            {CLOSE_EMPTY_HEX $S9.Rutburt_x $S9.Rutburt_y (*^X*,W*) 1}
            {MOVE_UNIT id=Gertburt $hex_x $hex_y}
            {CLEAR_VARIABLE hex_x,hex_y,S9.Rutburt_x,S9.Rutburt_y}
            {MESSAGE Gertburt "" "" _"Rutburt, what the hell are you doing?"}
            {MESSAGE Rutburt "" "" _"Gertburt, go away. I don't want to hurt you, but I ..."}
            {SOUND fist.ogg}
            {DELAY 800}
            {MESSAGE Rutburt "" "" _"What the ...?! You hit me! I'll get you, you little ..."}

            {MESSAGE narrator "portraits/humans/transparent/mage-arch.png~O(25%)" "Grossauba" _"If I may interrupt this brotherly squabble ... Mages of Hynderwlt, smite these idiots. Apparently they are too stupid to notice that they are playing right into the hands of the undead."}
            {SURROUND_UNIT id=Koorzhar Mage mage $S9.hex1_x $S9.hex1_y}
            {ATTACK_UNTIL_DEATH id=Koorzhar mage ranged 9}
            {SURROUND_UNIT id=Rutburt Mage mage2 $S9.hex1_x $S9.hex1_y}
            {ATTACK_UNTIL_DEATH id=Rutburt mage2 ranged 9}

            {DELAY 500}

            # Need to kill everybody here, so that Grnk can move back before RESET_FROM_FOG,
            # which might have otherwise put a unit on top of him (if we don't move him first)
            [kill]
                x=1-999  # not units on recall lists
                [not]
                    id=Grnk
                [/not]
            [/kill]
            {MOVE_UNIT id=Grnk $S9.Grnk_x $S9.Grnk_y}
            {RESET_FROM_FOG}

            {MESSAGE Grnk "" "" _"I ..."}

            ############################################
            # Third appearance of Koorzhar and Rutburt #
            [event]
                name=Koorzhar_appears

                {SWITCH_TO_FOG}

                # Get Koorzhar out
                [recall]
                    id=Koorzhar
                    x,y=$S9.hex1_x,$S9.hex1_y
                [/recall]
                {MOVE_UNIT id=Koorzhar $S9.hex2_x $S9.hex2_y}
                {MESSAGE Koorzhar "" "" _"There he is!"}

                # Get Rutburt out
                [recall]
                    id=Rutburt
                    x,y=$S9.hex1_x,$S9.hex1_y
                [/recall]

                # Move Rutburt next to Grnk
                {CLOSE_EMPTY_HEX $S9.Grnk_x $S9.Grnk_y (*^X*,W*) 1}
                {MOVE_UNIT id=Rutburt $hex_x $hex_y}

                {MESSAGE Rutburt "" "" _"I'll get him!"}
                {MESSAGE Koorzhar "" "" _"Oh no, you won't. We agreed that we'd let the men have the fun."}
                {MESSAGE Rutburt "" "" _"Alright, fine."}
                {CLOSE_EMPTY_HEX $S9.hex2_x $S9.hex2_y (*^X*,W*) 1}
                {MOVE_UNIT id=Rutburt $hex_x $hex_y}
                {CLEAR_VARIABLE hex_x,hex_y}

                {SURROUND_UNIT id=Grnk (Spearman,Thug) soldier $S9.hex1_x $S9.hex1_y}

                {MESSAGE Grnk "" "" _"Uh oh!"}
                {MESSAGE narrator "portraits/humans/transparent/mage-light.png~O(25%)" _"A Voice from the Distance" _"Use the prunes, Grnk."}
                {MESSAGE Grnk "" "" _"Use the what?"}
                {MESSAGE narrator "portraits/humans/transparent/mage-light.png~O(25%)" _"A Voice from the Distance" _"Prunes. Prunes are fruits that grow on trees. They can be eaten either fresh or dried. They are rather tasty, I may add."}
                {MESSAGE Grnk "" "" _"I know what the hell prunes are!!! But what is 'use the prunes' supposed to mean?"}
                {MESSAGE Grnk "" "" _"Hello?"}
                {MESSAGE Rutburt "" "" _"Do you always talk to yourself?"}
                {MESSAGE Grnk "" "" _"Umm, no, but if you don't mind, I'll just pick up a couple of rocks right here. And then, umm, I am going to ... pretend that they are prunes and, uh, use them. Somehow."}
                {MESSAGE Rutburt "" "" _"O ... kay ..."}
                {MESSAGE Grnk "" "" _"Maybe if I throw them up into the air?"}
                {MESSAGE Koorzhar "" "" _"Don't let him do that!! It's some sort of magical tri..."}

                # Prunes leading animation
                {LEADING_HALO_PRUNES Grnk}
                # Units surrounding Grnk will fight each other, until only one is left
                {REPEAT "$($SU_n_locs-1)" (
                    # Unit that can attack (we simply take the first of those):
                    [store_unit]
                        [filter]
                            side=4
                            [filter_location]
                                x,y=$S9.Grnk_x,$S9.Grnk_y
                                radius=1
                            [/filter_location]
                        [/filter]
                        variable=S9.tmp_units
                    [/store_unit]
                    # Unit to be attacked:
                    {FIND_CLOSEST_HEX $S9.tmp_units.x $S9.tmp_units.y (
                        [filter]
                            side=4
                            [not]
                                id=$S9.tmp_units[0].id
                            [/not]
                        [/filter]
                    )}
                    [store_unit]
                        [filter]
                            x,y=$hex_x,$hex_y
                        [/filter]
                        variable=S9.unit2
                    [/store_unit]

                    # Leading halo over the attacking unit
                    {LEADING_HALO_PRUNES $S9.tmp_units[0].id}

                    # If they are not already adjacent, move the first unit
                    [if]
                        [not]
                            [have_unit]
                                id=$S9.unit2.id
                                [filter_adjacent]
                                    id=$S9.tmp_units[0].id
                                [/filter_adjacent]
                            [/have_unit]
                        [/not]
                        [then]
                            {CLOSE_EMPTY_HEX $S9.unit2.x $S9.unit2.y (*^X*,W*) 1}
                            {MOVE_UNIT id=$S9.tmp_units[0].id $hex_x $hex_y}
                        [/then]
                    [/if]

                    {FIGHT_TO_DEATH $S9.tmp_units[0].id $S9.unit2.id yes}
                )}
                {CLEAR_VARIABLE SU_n_locs,hex_x,hex_y,S9.tmp_units,S9.unit2}

                {MESSAGE Rutburt "" "" _"What just happened?"}
                {MESSAGE Koorzhar "" "" _"I have no idea, but I'm out of here."}
                {MOVE_UNIT id=Koorzhar $S9.hex1_x $S9.hex1_y}
                {PUT_TO_RECALL_LIST id=Koorzhar}
                {MOVE_UNIT id=Rutburt $S9.hex1_x $S9.hex1_y}
                {PUT_TO_RECALL_LIST id=Rutburt}
                {MOVE_UNIT side=4 $S9.hex1_x $S9.hex1_y}

                {RESET_FROM_FOG}
                {MESSAGE Grnk "" "" _"This is just getting stranger and stranger."}
            [/event]
        [/event]
    [/event]

    ######################
    # Finally, the standard events for all or most scenarios
    {STORY_IMAGE id=Grnk}
    {GRNK_DEATH}
    {GERTBURT_DEATH}
[/scenario]
