#textdomain wesnoth-Grnk

[scenario]
    id=06_Hunting
    name=_"Hunting"
    next_scenario=02_Shmaltupp_04

    map_data="{~add-ons/Grnk/part1/maps/06_Hunting.map}"

    {DEFAULT_SCHEDULE}
    {TURNS 15 18 22}
    victory_when_enemies_defeated=no

    {GRNK_STORY_06}

    [side]
        side=1
        controller=human
        id=Grnk
        type=null # just to make wmllint happy

        team_name=Grnk
        user_team_name=_"Grnk"
        defeat_condition=never

        village_gold=0
        gold=0
        income=-2  # No income whatsoever
    [/side]

    [side]
        side=2
        controller=ai
        id=Jen emaris
        name=Jen emaris
        type=Mermaid Priestess
        unrenamable=yes

        facing=se

        team_name=merfolk
        user_team_name=_"Merfolk"
        persistent=yes
        save_id=Jen emaris

        recruit=Mermaid Initiate,Merman Fighter,Merman Hunter

        {GOLD 212 262 362}
    [/side]

    [side]
        side=3
        controller=ai
        id=Pekzs
        name=Pekzs
        unrenamable=yes
        type=Saurian Soothsayer

        facing=sw

        team_name=saurian  # !!! Omission of 's' at end is intentional and must not be changed !!!
        user_team_name=_"Saurians"
        save_id=Pekzs
        persistent=yes

        recruit=Saurian Augur,Saurian Skirmisher

        {GOLD 211 261 361}
    [/side]

    # Fishermen
    [side]
        side=4
        controller=ai
        no_leader=yes
        hidden=yes

        # They just go about their own business
        team_name=animals,saurian,menfolk,driver

        gold=0
    [/side]

    # Monsters, wolves
    [side]
        side=5
        controller=ai
        no_leader=yes

        team_name=animals
        user_team_name=_"Animals"

        gold=0
        income=-2
    [/side]

    # Driver - for when he goes home
    [side]
        side=6
        controller=null
        no_leader=yes
        hidden=yes

        team_name=driver

        gold=0
        income=-2
    [/side]

    # Prestart
    [event]
        name=prestart

        {MODIFY_UNIT id=Grnk facing sw}

        # Restore Grnk's health status as it was at the end of S2_03
        {MODIFY_UNIT id=Grnk hitpoints $Grnk_hitpoints_for_hunt}
        {MODIFY_UNIT id=Grnk status.poisoned $Grnk_poisoned_for_hunt}
        {CLEAR_VARIABLE Grnk_hitpoints_for_hunt,Grnk_poisoned_for_hunt}

        {LOYAL_UNIT 1 "Ox Cart" 36 1}
        [+unit]
            id=driver
            overlays=misc/hero-icon.png
            facing=sw
        [/unit]

        # Hide Jen emaris and Pekzs for the beginning
        [hide_unit]
            side=2,3
        [/hide_unit]

        # Store the locations where the wolves wander
        [store_locations]
            terrain=*^F*
            x=22-99
            y=31-99
            variable=S6.wolf_coords
        [/store_locations]
        #{DEBUG "$S6.wolf_coords.length"}

        # Place some sea monsters
        # Originally, put 1 Cuttle Fish or Water Serpent on each side of the map
        {RANDOM "Water Serpent,Cuttle Fish"}
        {GENERIC_UNIT 5 $random 1 30}
        {RANDOM "Water Serpent,Cuttle Fish"}
        {GENERIC_UNIT 5 $random 63 31}
        # Place 5 wolves in the forest
        {REPEAT 5 (
            {RANDOM "1..$S6.wolf_coords.length"}
            {VARIABLE_OP random sub 1}
            #{DEBUG "$random $S6.wolf_coords[$random].x $S6.wolf_coords[$random].y"}
            {GENERIC_UNIT 5 Wolf $S6.wolf_coords[$random].x $S6.wolf_coords[$random].y}
        )}
        {CLEAR_VARIABLE random}
    [/event]

    [event]
        name=start

        {MESSAGE Grnk "" "" _"I still think that this is a mistake."}
        {MESSAGE driver "" _"Cart Driver" _"You cannot hire me as a guide and then not let me guide."}
        {MESSAGE Grnk "" "" _"I did not hire you as a guide. Quank blackmailed me into hiring you as a cart driver."}
        {MESSAGE driver "" _"Cart Driver" _"You are welcome to go wherever you want. By yourself. Quank told me to guide you to a place with wild wolves and not to risk the cart or the oxen."}
        {MESSAGE Grnk "" "" _"There are plenty of wolves in the mountains west of Shmaltupp."}
        {MESSAGE driver "" _"Cart Driver" _"There are also plenty of orcs in those mountains and recently the undead, I've been told. No way I am going into orc country if Quank's too cheap to send an armed escort with us."}
        {MESSAGE Grnk "" "" _"I've fought against the undead and I know how to deal with orcs."}
        {MESSAGE driver "" _"Cart Driver" _"As do I. I stay out of their way. In any case, I have my instructions and that's what we're going to do."}
        {MESSAGE Grnk "" "" {GASP_BEGINNING _"grumbles"}+_"And you are sure that there are wolves on that island?"}
        {MESSAGE driver "" _"Cart Driver" _"Peninsula, not island. Hulbensal Peninsula, to be precise. There are more than enough wolves in the forest down there for you to commit suicide, belie..."}

        {SCROLL_TO 24 16}
        {DELAY 500}
        [unhide_unit]
            side=2,3
        [/unhide_unit]

        {MESSAGE_RIGHT "Jen emaris" _"There they are! Let's get them!"}
        {MESSAGE Grnk "" "" _"Now what?"}
        {MESSAGE_RIGHT "Jen emaris" _"What? Who are you? Oh, just a little goblin. You stay out of our way while we take care of those lizards over there."}
        {MESSAGE Pekzs "" "" _"Who you're calling a lizzzard, fisssh scum?! You will pay for what you have done!"}
        {MESSAGE Grnk "" "" _"I don't know what your dispute is about and I want no part in it. I'm just trying to get down to that island, Hulbensal, or whatever it's called."}
        {MESSAGE Pekzs "" "" _"Peninsssula, not island."}
        {MESSAGE Grnk "" "" _"Whatever."}
        {MESSAGE_RIGHT "Jen emaris" _"No trespassing on our land!"}
        {MESSAGE Pekzs "" "" _"Your land?! Zzizz iss our land!"}
        {MESSAGE Grnk "" "" _"Listen, I really don't care whose land this is, I just ..."}
        {MESSAGE_RIGHT "Jen emaris" _"Silence! You can either join us fight those lizards or go back to where you came from."}
        {MESSAGE Pekzs "" "" _"Join uss, not zzem fishesss! Zzey will only betray you!"}
        {MESSAGE Grnk "" "" _"Sigh. It can't ever be easy, can it?"}
        {MESSAGE driver "" _"Cart Driver" _"I say we go back to ..."}
        {MESSAGE Grnk "" "" _"Oh, shut up!"}
        {MESSAGE driver "" _"Cart Driver" {GASP_BEGINNING _"grumbles"}+{WHISPER _"You just see. Quank is only paying me for so much time. Once that is up, I'll dump your cage and go back to Shmaltupp."}}

        [objectives]
            side=1
            victory_string=_"<span color='#A050A0'>First Turn Objective</span>"
            [objective]
                description=_"Decide which side to join at the end of the turn"
                condition=win
            [/objective]
        [/objectives]
    [/event]

    # Choose side for Grnk
    [event]
        name=side 1 turn 1 end

        [message]
            message=_"I guess it's time to make a decision"
            speaker=Grnk

            [option]
                message=_"I will join the merfolk"
                [command]
                    {MESSAGE_RIGHT "Jen emaris" _"Good choice."}
                    {VARIABLE S6.ally_side 2}
                    {VARIABLE S6.enemy_side 3}
                    {VARIABLE S6.ally merfolk}
                    {VARIABLE S6.enemy saurian}
                    {VARIABLE S6.ally_leader_id "Jen emaris"}
                    {VARIABLE S6.enemy_leader_id Pekzs}

                    [event]
                        name=side 2 turn 3

                        {MESSAGE "Jen emaris" "" "" _"So, tell me, little goblin, what mission of yours is so urgent that you join a fight in which you have no stakes whatsoever?"}
                        {MESSAGE Grnk "" "" _"I need to catch and tame myself a wolf."}
                        {MESSAGE driver "" _"Cart Driver" _"He is insane, I tell you. We should go back to ..."}
                        {MESSAGE "Jen emaris" "" "" _"And what do you know about that?! This is not so crazy."}
                        {MESSAGE driver "" _"Cart Driver" _"It is not?!?"}
                        {MESSAGE Grnk "" "" _"It is not?!?"}
                        {MESSAGE "Jen emaris" "" "" _"All kinds of folks come to Hulbensal's Forest for this quest. Some do it searching for glory, some out of desperation. Most of them fail miserably and are torn to shreds. Don't ask me what happens in there, neither we nor those lizards have ever entered the forest, but a few of them strangers do come back out, occasionally even with all their limbs, and every once in a while with a wolf."}
                        {MESSAGE driver "" _"Cart Driver" _"But he's just a puny little ..."}
                        {MESSAGE "Jen emaris" "" "" _"Size doesn't seem to matter for this. I do not know exactly what makes the difference, but it seems that nobody has ever succeeded without strong leadership qualities."+{NOTE _"This means that Grnk needs to have his level 2 leadership AMLA advancement by the time a wolf enters the cage."}}
                        {MESSAGE Grnk "" "" _"Well, good then ..."}
                        {MESSAGE "Jen emaris" "" "" _"Help us defeat that liar Pekzs, and I will wish you good luck for your mission. But be warned, if you abandon the fight and move onto Hulbensal Peninsula before the lizard king is dead, you'll be fighting not only them, but also us."}
                    [/event]
                [/command]
            [/option]

            [option]
                message=_"I will join the saurians"
                [command]
                    {MESSAGE Pekzs "" "" _"Good choisss."}
                    {VARIABLE S6.ally_side 3}
                    {VARIABLE S6.enemy_side 2}
                    {VARIABLE S6.ally saurian}
                    {VARIABLE S6.enemy merfolk}
                    {VARIABLE S6.ally_leader_id Pekzs}
                    {VARIABLE S6.enemy_leader_id "Jen emaris"}

                    [event]
                        name=side 3 turn 3

                        {MESSAGE "Pekzs" "" "" _"Ssso, tell me, little goblin, what misssion of yourss is sso urgent zzat you join a fight in which you have no stakess whatsoever?"}
                        {MESSAGE Grnk "" "" _"I need to catch and tame myself a wolf."}
                        {MESSAGE driver "" _"Cart Driver" _"He is insane, I tell you. We should go back to ..."}
                        {MESSAGE "Pekzs" "" "" _"And what do you know about zatt?! Zizz iss not so crazy."}
                        {MESSAGE driver "" _"Cart Driver" _"It is not?!?"}
                        {MESSAGE Grnk "" "" _"It is not?!?"}
                        {MESSAGE "Pekzs" "" "" _"All kindsss of folkss come to Hulbensal's Foressst for zziss quest. Ssome do it searching for glory, sssome out of desperation. Mosst of zzem fail miserably and are torn to shredzz. Don't asssk me what happenss in zzere, neizzer we nor zzosse fishesss have ever entered zze forest, but a few of zzem strangerss do come back out, occasssionally even wizz all zzeir limbszs, and every once in a while wizz a wolf."}
                        {MESSAGE driver "" _"Cart Driver" _"But he's just a puny little ..."}
                        {MESSAGE "Pekzs" "" "" _"Ssize doesss not ssseem to matter for zziss. I do not know exactly what makesss zze difference, but it seemsss zzat nobody hasss ever sucsseeded wizzout strong leadersship qualitiesss."+{NOTE _"This means that Grnk needs to have his level 2 leadership AMLA advancement by the time a wolf enters the cage."}}
                        {MESSAGE Grnk "" "" _"Well, good then ..."}
                        {MESSAGE "Pekzs" "" "" _"Help usss defeat zzat liar Jen emarisss, and I will wissh you good luck for your misssion. But be warned, if you abandon zze fight and move onto Hulbensal Peninsssula before zze fisssh queen isss dead, you'll be fighting not only zzem, but also usss."}
                    [/event]
                [/command]
            [/option]
        [/message]

        # Also change the objectives then. This can be done on the Side 2 turn
        # independent of which side is the chosen as ally
        [event]
            name=side 2 turn 3

            [objectives]
                side=$S6.ally_side
                summary=_"<span color='#A050A0'>Catch A Wolf</span>"
                [objective]
                    description=_"Defeat the $S6.enemy leader"
                    condition=win
                [/objective]
                [objective]
                    description=_"Then deploy the cage before the cart driver calls it quits"
                    condition=win
                [/objective]
                [objective]
                    description=_"Death of Grnk"
                    condition=lose
                [/objective]
                [objective]
                    description=_"Death of Ox Cart"
                    condition=lose
                [/objective]
                [objective]
                    description=_"Death of $S6.ally_leader_id"
                    condition=lose
                [/objective]
                [objective]
                    description=_"Grnk or Ox Cart move onto Hulbensal Peninsula before $S6.enemy_leader_id is defeated"
                    condition=lose
                [/objective]
                [objective]
                    description=_"Grnk catches a wolf before he has level 2 leadership abilities (as a level-1 unit)"
                    condition=lose
                [/objective]
                {TURNS_RUN_OUT}
                [gold_carryover]
                    bonus=no
                    carryover_percentage=0
                [/gold_carryover]
            [/objectives]
        [/event]

        # Move Grnk to new side and change controller to human, make loyal
        {GET_GRNK_FROM_DUMMY_SIDE 1 $S6.ally_side}  # Just a shortcut
        {MAKE_GRNK_LOYAL ()}
        {MODIFY_UNIT side=1 side $S6.ally_side}
        [modify_side]
            side=$S6.ally_side
            controller=human
        [/modify_side]

        # Make the enemy side attack ruthlessly
        # This way it's a somewhat harder fight, even with equal gold
        # Also have them avoid the sea monsters and only come for Grnk's side
        [modify_side]
            side=$S6.enemy_side

            [ai]
                aggression=1.0
                caution=0.0
                leader_aggression=1.0
                leader_caution=0.0
                village_value=0.0
                scout_village_targeting=0.0
                villages_per_scout=0.0

                [avoid]
                    [filter]
                        side=5
                    [/filter]
                    radius=1
                [/avoid]
            [/ai]
        [/modify_side]

        # In turn, we need to have the sea monsters avoid the enemy leader
        # or they'll just kill him off with no defense
        # Do this by having them avoid a radius of 2 around the leader
        [modify_side]
            side=5

            [ai]
                [avoid]
                    [filter]
                        id=$S6.enemy_leader_id
                    [/filter]
                    radius=2
                [/avoid]

                [goal]
                    [criteria]
                        side=$S6.ally_side
                    [/criteria]
                    value=10.
                [/goal]
                [goal]
                    [criteria]
                        side=$S6.enemy_side
                    [/criteria]
                    value=1.
                [/goal]

                aggression=1.0
                caution=0.0
                leader_value=0.01
            [/ai]
        [/modify_side]

        [micro_ai]
            side=5
            ai_type=lurkers
            action=add

            [filter]
                type=Swamp Lurker
            [/filter]
            [filter_location]
                terrain=S*
            [/filter_location]
        [/micro_ai]

        [objectives]
            side=$S6.ally_side
            summary=_"<span color='#A050A0'>Catch A Wolf</span>"
            [objective]
                description=_"Defeat the $S6.enemy leader"
                condition=win
            [/objective]
            [objective]
                description=_"Then deploy the cage before the cart driver calls it quits"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Ox Cart"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of $S6.ally_leader_id"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=no
                carryover_percentage=0
            [/gold_carryover]
        [/objectives]
    [/event]

    # Each turn, put some more sea monsters out there
    [event]
        name=side 5 turn
        first_time_only=no

        # Swamp Lurker - 90% chance of 1 per turn, anywhere in the swamps
        {RANDOM_FOE 5 90 (Swamp Lurker) 1 (terrain=S*) ()}

        # Eel - chance of 1 on each side of map
        # Deep water only (there are equal amounts of deep water in
        # left and right halves of map in given ranges)
        # but only if there are no more than 4 on the map already
        [if]
            [have_unit]
                type=Eel
                count=0-4
            [/have_unit]

            [then]
                {RANDOM_FOE 5 33 Eel 1 (
                    terrain=Wo*
                    x=1-34
                    y=15-42
                ) ()}
                {RANDOM_FOE 5 33 Eel 1 (
                    terrain=Wo*
                    x=35-99
                    y=24-42
                ) ()}
            [/then]
        [/if]

        # Squid - chance of swarm of 1-3 on either side of the map
        # but only if there are no more than 6 on the map already
        [if]
            [have_unit]
                type=Squid
                count=0-6
            [/have_unit]

            [then]
                [set_variable]
                    name=random_reps
                    rand=1..3
                [/set_variable]
                {RANDOM_FOE 5 30 Squid $random_reps (
                    terrain=Wo*
                    x=1-34
                    y=15-42
                ) ()}
                [set_variable]
                    name=random_reps
                    rand=1..3
                [/set_variable]
                {RANDOM_FOE 5 30 Squid $random_reps (
                    terrain=Wo*
                    x=35-99
                    y=24-42
                ) ()}
                {CLEAR_VARIABLE random_reps}
            [/then]
        [/if]
    [/event]

    # Grnk exclaims first time there is an attack involving a lurker (attack or defense)
    [event]
        name=lurker message

        {MESSAGE_NOSCROLL Grnk _"What the hell is that?!"}
        {IF_VAR S6.ally_side equals 2 (
            [then]
                {MESSAGE_NOSCROLL $S6.ally_leader_id _"Never seen a Swamp Lurker, have you? Lucky you."}
            [/then]

            [else]
                {MESSAGE_NOSCROLL $S6.ally_leader_id _"Never ssseen a Ssswamp Lurker, have you? Lucky you."}
            [/else]
        )}

        # 3 turns later
        [event]
            name=new turn

            [event]
                name=new turn

                [event]
                    name=new turn

                    {MESSAGE driver "" _"Cart Driver" _"Why would anyone want this land anyway? It's wet, it stinks and there are slimy critters everywhere."}
                [/event]
            [/event]
        [/event]
    [/event]

    [event]
        name=attack end

        [filter]
            type=Swamp Lurker
        [/filter]

        [fire_event]
            name=lurker message
        [/fire_event]
    [/event]

    [event]
        name=attack end

        [filter_second]
            type=Swamp Lurker
        [/filter_second]

        [fire_event]
            name=lurker message
        [/fire_event]
    [/event]

    # Saurians and merfolk cannot enter the forest
    # Nor can the sea monsters
    # 2 events: one at start, one at each recruit
    #  (Could be combined into one, but computationally inefficient)
    [event]
        name=start

        {MODIFY_UNIT (
            side=2,3,5
            [not]
                type=Wolf
            [/not]
        ) movement_costs.forest 99}
    [/event]

    [event]
        name=recruit
        first_time_only=no

        {MODIFY_UNIT id=$unit.id movement_costs.forest 99}
    [/event]

    # Wolf moves
    # Reset goal at the beginning of each turn
    # First a random move gets set
    # If Grnk is within reach, a wolf will go for him instead
    # Finally, if the cage (with bait) is in reach, the wolf goes there
    [event]
        name=side 5 turn
        first_time_only=no

        {GET_ALL_UNITS (side,type=5,Wolf)}
        {FOREACH filtered_units i_u}
            {RANDOM "1..$S6.wolf_coords.length"}
            #{DEBUG "$random $S6.wolf_coords[$random].x $S6.wolf_coords[$random].y"}
            {MODIFY_UNIT id=$filtered_units[$i_u].id goto_x $S6.wolf_coords[$random].x}
            {MODIFY_UNIT id=$filtered_units[$i_u].id goto_y $S6.wolf_coords[$random].y}

            # Now, instead, if the wolf can reach Grnk ...
            [store_reachable_locations]
                [filter]
                    id=$filtered_units[$i_u].id
                [/filter]
                [filter_location]
                    [filter_adjacent_location]
                        [filter]
                            id=Grnk
                        [/filter]
                    [/filter_adjacent_location]
                [/filter_location]
                moves=max

                variable=Grnk_locs
            [/store_reachable_locations]
            #{DEBUG "$i_u $Grnk_locs.length"}

            # ... clear its goal and let him go for Grnk
            {IF_VAR Grnk_locs.length greater_than 0 (
                [then]
                    #{DEBUG "Clearing Wolf $i_u goalÉ"}
                    {MODIFY_UNIT id=$filtered_units[$i_u].id goto_x ""}
                    {MODIFY_UNIT id=$filtered_units[$i_u].id goto_y ""}
                    {IF_VAR S6.here_wolfie not_equals yes (
                        [then]
                            {SOUND  wolf-growl-1.ogg}
                            {MESSAGE $filtered_units[$i_u].id "" "" _"Grrrrrrwwwllll !!!"}
                            {MESSAGE Grnk "" "" _"Here, wolfie, wolfie, wolfie ..."}
                            {VARIABLE S6.here_wolfie yes}
                        [/then]
                    )}
                [/then]
            )}

            # Finally, if a wolf can reach the cage (and it has been baited)
            # Make him go for that instead
            [store_reachable_locations]
                [filter]
                    id=$filtered_units[$i_u].id
                [/filter]
                [filter_location]
                    x,y=34,25
                [/filter_location]
                moves=max

                variable=cage_locs
            [/store_reachable_locations]

            [if]
                {VARIABLE_CONDITIONAL cage_locs.length greater_than 0}
                {VARIABLE_CONDITIONAL S6.cage_baited equals yes}

                [then]
                    #{DEBUG "Wolf $i_u going for cageÉ"}
                    {MODIFY_UNIT id=$filtered_units[$i_u].id goto_x 34}
                    {MODIFY_UNIT id=$filtered_units[$i_u].id goto_y 25}
                [/then]
            [/if]
        {NEXT i_u}

        {CLEAR_VARIABLE filtered_units,random,Grnk_locs,cage_locs}
    [/event]

    # Defeat event when Grnk or cart go too far south
    [event]
        name=moveto

        [filter]
            id=Grnk,driver
            y=23-99
        [/filter]

        {IF_VAR S6.enemies_defeated not_equals yes (
            [then]
                {IF_VAR S6.ally_side equals 2 (
                    [then]
                        {MESSAGE $S6.ally_leader_id "" "" _"The little goblin is trying to sneak away without honoring his commitment. Kill him!"}
                    [/then]

                    [else]
                        {MESSAGE $S6.ally_leader_id "" "" _"Zze little goblin isss trying to sssneak away wizzout honoring hiss commitment. Kill him!"}
                    [/else]
                )}

                [endlevel]
                    result=defeat
                [/endlevel]
            [/then]
        )}
        # Clear the variable first time we go south
        {CLEAR_VARIABLE S6.enemies_defeated}
    [/event]

    # When the ally leader is killed -> defeat
    [event]
        name=last_breath

        [filter]
            id=$S6.ally_leader_id
        [/filter]

        {MESSAGE $S6.ally_leader_id "" "" _"Arghh! Our land ..."}

        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    # When the enemy leader is defeated
    # Set variable so that Grnk and cart can move onto peninsula
    [event]
        name=last_breath

        [filter]
            id=$S6.enemy_leader_id
        [/filter]

        {MESSAGE $S6.enemy_leader_id "" "" _"Arghh!"}

        [kill]
            id=$S6.enemy_leader_id
            animate=yes
        [/kill]

        {IF_VAR S6.ally_side equals 2 (
            [then]
                {MESSAGE $S6.ally_leader_id "" "" _"Thank you for your help, little goblin. Maybe our paths will cross again in the future."}
            [/then]

            [else]
                {MESSAGE $S6.ally_leader_id "" "" _"Zzank you for your help, little goblin. Maybe our pazzss will crosss again in zze future."}
            [/else]
        )}

        {VARIABLE S6.enemies_defeated yes}

        # Set up sign and (below) the event for unloading the cage
        {MESSAGE Grnk "" "" _"I hope so as well. Now let's set up the cage down there in the forest."}
        {MESSAGE driver "" _"Cart Driver" _"You know that this cart cannot enter the forest, right?"}
        {MESSAGE Grnk "" "" _"Go figure. Is there anything you are actually going to be helpful with?"}
        {MESSAGE driver "" _"Cart Driver" _"I have brought your cage this far, haven't I? I will drive it down there to the edge of the forest, but that's as far as I will go."}

        {SET_LABEL 33 25 "Move cart here"}
        {HIGHLIGHT_IMAGE_SHORT 33 25 items/gohere.png ()}
        {MESSAGE Grnk "" "" _"Better than nothing, I guess. Barely."}

        [objectives]
            side=$S6.ally_side
            summary=_"<span color='#A050A0'>Catch A Wolf</span>"
            [objective]
                description=_"Deploy the cage before the cart driver calls it quits"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Ox Cart"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of $S6.ally_leader_id"
                condition=lose
            [/objective]
            [objective]
                description=_"Grnk catches a wolf before he has level 2 leadership abilities (as a level-1 unit)"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=no
                carryover_percentage=0
            [/gold_carryover]
        [/objectives]

        # The unloading event
        [event]
            name=moveto

            [filter]
                id=driver
                x,y=33,25
            [/filter]

            {REMOVE_LABEL 33 25}
            {REMOVE_IMAGE 33 25}

            {MESSAGE driver "" _"Cart Driver" _"Here we are. Let's get this damn cage off my cart and then I'm out of here."}
            {PLACE_IMAGE items/cage.png 34 25}
            {MESSAGE Grnk "" "" _"What do you mean you're out of here? You are going to help me catch that wolf."}
            {MESSAGE driver "" _"Cart Driver" _"The hell I am! Quank is paying me to transport the cage, and not very much, if I may add. You're on your own now."}
            {MESSAGE Grnk "" "" _"I am going to have a word with Quank when I am back."}
            {MESSAGE driver "" _"Cart Driver" _"You do that. I am sure he is trembling already ..."}

            {MESSAGE driver "" _"Cart Driver" _"I'm off. Don't forget to bait the cage. Although, if I were a wolf, I'd take a fresh little goblin any time over a stinking rat that has been dead forever."+{NOTE _"Baiting the cage can be done by moving Grnk onto it."}}
            {MESSAGE Grnk "" "" _"I hate to admit it, but he is right. That rat is starting to smell. I bet I don't have much time before no wolf is going to touch it any more."}

            # The turn limit is changed to when the rat goes bad (8 turns from now)
            [modify_turns]
                value="$($turn_number+8)"
            [/modify_turns]

            [objectives]
                side=$S6.ally_side
                summary=_"<span color='#A050A0'>Catch A Wolf</span>"
                [objective]
                    description=_"Bait the cage and catch a wolf before the rat goes bad"
                    condition=win
                [/objective]
                [objective]
                    description=_"Death of Grnk"
                    condition=lose
                [/objective]
                [objective]
                    description=_"Death of $S6.ally_leader_id"
                    condition=lose
                [/objective]
                [objective]
                    description=_"Grnk catches a wolf before he has level 2 leadership abilities (as a level-1 unit)"
                    condition=lose
                [/objective]
                {TURNS_RUN_OUT}
                [gold_carryover]
                    bonus=no
                    carryover_percentage=0
                [/gold_carryover]
            [/objectives]

            {VARIABLE S6.cage_placed yes}

            # Set up the baiting event
            [event]
                name=moveto

                [filter]
                    id=Grnk
                    x,y=34,25
                [/filter]

                # Check if there is a rat (this shouldn't be necessary - for debug only)
                {LOOKUP_INDEX inventory short rat item_index}
                {IF_VAR item_index less_than $inventory.length (
                    [then]  # if Grnk has a rat
                        {REMOVE_INVENTORY_ITEM rat}
                        {REMOVE_IMAGE 34 25}
                        {PLACE_IMAGE "units/monsters/giant-rat-die-3.png" 34 25}
                        {PLACE_IMAGE items/cage.png 34 25}
                        {VARIABLE S6.cage_baited yes}
                        {MESSAGE Grnk "" "" _"There goes the bait. Now I only need to get one of them wolves to come out here."}
                        {IF_VAR S6.ally_side equals 2 (
                            [then]
                                {MESSAGE $S6.ally_leader_id "" "" _"I have been told that the wolves will come for you if you're within their striking distance. You should be able to use that to lure one out of the forest. And once they are within reach of the bait, they'll go for that."}
                            [/then]

                            [else]
                                {MESSAGE $S6.ally_leader_id "" "" _"I have been told zzat zze wolvess will come for you if you're wizzin zzeir striking distansss. You should be able to usse zzat to lure one out of zze forest. And onccce zzey are wizzin reach of the bait, zzey'll go for zzat."}
                            [/else]
                        )}
                    [/then]

                    [else]  # if Grnk has no rat
                        {NARRATOR_GRAY "Problem !!!" _"Grnk does not have a rat !!!!
<i> </i>
This message should never appear in normal game play. It is for debug purposes only. If you see this without having taken any shortcuts, please let me know so that I can fix it. It is not possible to finish this scenario from here (without cheating)."}
                    [/else]
                )}
                {CLEAR_VARIABLE item_index}

                # Catching a wolf - this may only happen after cage was baited,
                # therefore make this a nested event
                [event]
                    name=moveto

                    [filter]
                        side=5  # shouldn't be necessary, but just in case
                        type=Wolf
                        x,y=34,25
                    [/filter]

                    [fire_event]
                        name=wolf caught
                        [primary_unit]
                            id=$unit.id
                        [/primary_unit]
                    [/fire_event]
                [/event]
            [/event]

            # The rest just sends the driver home
            {MODIFY_UNIT id=driver side 6}
            {MODIFY_UNIT id=driver goto_x 36}
            {MODIFY_UNIT id=driver goto_y 15}

            [modify_side]
                side=6
                team_name=$S6.ally
                controller=ai
                hidden=yes
            [/modify_side]

            [event]
                name=moveto

                [filter]
                    id=driver
                    x,y=36,15
                [/filter]

                {MODIFY_UNIT id=driver goto_x 37}
                {MODIFY_UNIT id=driver goto_y 1}
            [/event]

            [event]
                name=moveto

                [filter]
                    id=driver
                    x,y=37,1
                [/filter]

                {MESSAGE driver "" _"Cart Driver" _"Back home, finally. If I never have to guide a maniac goblin again, so much the better."}

                [kill]
                    id=driver
                [/kill]
            [/event]
        [/event]
    [/event]

    # If Grnk kills a wolf
    [event]
        name=die

        [filter]
            type=Wolf
        [/filter]

        {MESSAGE Grnk "" "" _"Grnk, you idiot! You are supposed to lure a wolf into the cage, not kill it. (And why am I talking to myself ?!)"}
    [/event]

    # If the cart is killed ...
    [event]
        name=die

        [filter]
            id=driver
        [/filter]

        {IF_VAR S6.cage_placed not_equals yes (
            # If it happens before the cage is placed, Grnk loses
            [then]
                {MESSAGE Grnk "" "" _"Now I will never be able to catch a wolf!"}
                [endlevel]
                    result=defeat
                [/endlevel]
            [/then]

            # If it happens after the cage is placed, Grnk just comments
            [else]
                {MESSAGE Grnk "" "" _"Serves him right! He should have stayed with me."}
            [/else]
        )}
    [/event]

    # Defeat if running out of time:
    [event]
        name=time over

        # Depends on whether it happens before or after the cage was placed
        {IF_VAR S6.cage_placed equals yes (
            [then]
                {MESSAGE Grnk "" "" _"I got so close! All I needed was a little more time."}
            [/then]

            [else]
                {MESSAGE driver "" _"Cart Driver" _"That's it, I am going to leave this madness."}
                {MESSAGE Grnk "" "" _"Oh, come one. Please. Just a little longer. I know we can make it."}
                {MESSAGE driver "" _"Cart Driver" _"And get ourselves killed in the process."}
                {MESSAGE Grnk "" "" _"I will pay you twice what Quank would pay you for the same time."}
                {MESSAGE driver "" _"Cart Driver" _"Forget it! I am going to go back to driving tourists to the Eldryanic River. Anything is better than working for a mad goblin on a maniac mission."}
            [/else]
        )}
    [/event]

    # Victory, when wolf moves into cage
    # Can only happen after cage has been baited, thus called from a nested event
    [event]
        name=wolf caught

        # Remove the rat
        {REMOVE_IMAGE 34 25}
        # Place the cage image in front of wolf, not behind
        [item]
            x,y=34,25
            halo=items/cage.png
        [/item]

        {MESSAGE Grnk "" "" _"I did it! I caught a wolf!! Now, how do I get onto it without being eaten?"}
        {MOVE_UNIT id=Grnk 35 25}
        {MESSAGE_FACING Grnk $unit.id "" _"Here, little puppy."}
        {SOUND wolf-growl-1.ogg}
        {MESSAGE $unit.id "" "" _"Grrrrrrwwwllll !!!"}

        # Taming the wolf can only happen if Grnk has L2 leadership
        [if]
            [have_unit]
                id=Grnk
                ability=L2-leadership
            [/have_unit]

            [then]
                {MESSAGE Grnk "" "" _"Nice little wolfie."}
                {SOUND  wolf-growl-1.ogg}
                {MESSAGE $unit.id "" "" _"Grrrrrrwwwllll !!!"}
                {MESSAGE Grnk "" "" _"Yes, yes, you said that already. How about you let me come in there without biting my head off?"}
                {SOUND  wolf-growl-1.ogg}
                {MESSAGE $unit.id "" "" _"Grrrrrrwwwllll !!!"}
                {MESSAGE Grnk "" "" _"Now, listen, I ..."}
                {SOUND  wolf-growl-1.ogg}
                {MESSAGE $unit.id "" "" _"Grrrrrrwwwllll !!!"}
                {BOOMING_VOICE_EFFECT_GRNK Grnk _"Quiet, you !!!" 35 25 0.35 ()}
                {SOUND wolf-die-1.ogg}
                {MESSAGE $unit.id "" "" _"Yelp !"}
                {MESSAGE Grnk "" "" _"That's better. I am going to come in there now and climb on your back, and you're not going to do anything stupid, is that understood?!"}
                {SOUND wolf-die-1.ogg}
                {MESSAGE $unit.id "" "" _"Yelp."}

                # Store Grnk for Shmaltupp visits
                [store_unit]
                    [filter]
                        id=Grnk
                    [/filter]

                    variable=stored_Grnk
                    kill=yes
                [/store_unit]
                # And change his name
                {VARIABLE stored_Grnk.name "Grnk the Rider"}

                # Also store his wolf, and make it loyal first
                [modify_unit]
                    [filter]
                        id=$unit.id
                    [/filter]

                    [modifications]
                        # Leave first two traits unmodified
                        [trait]
                        [/trait]
                        [trait]
                        [/trait]
                        {TRAIT_LOYAL}
                    [/modifications]

                    overlays=misc/loyal-icon.png
                [/modify_unit]

                [store_unit]
                    [filter]
                        id=$unit.id
                    [/filter]

                    variable=stored_Grnks_wolf
                [/store_unit]
                {VARIABLE stored_Grnks_wolf.id Grnks_wolf}

                # Turn Grnk into Wolf Rider
                [move_unit_fake]
                    type=$stored_Grnk.type
                    side=$S6.ally_side
                    x=$stored_Grnk.x,34
                    y=$stored_Grnk.y,25
                [/move_unit_fake]
                [kill]
                    id=$unit.id
                [/kill]
                {NOTRAIT_UNIT $S6.ally_side "Grnk the Rider" 34 25}
                [+unit]
                    id=Grnk
                    name=Grnk the Rider
                    gender=male
                    unrenamable=yes
                    facing=$stored_Grnks_wolf.facing
                    [modifications]
                        {TRAIT_QUICK}
                    [/modifications]
                [/unit]

                # Clear pickpocketing menu
                {CLEAR_MENU_PICKPOCKET}

                {DELAY 500}
                {MOVE_UNIT id=Grnk 35 25}
                {MESSAGE Grnk "" "" _"Look at me, I am riding a wolf !!!
<i> </i>
(But I still don't know how I do that voice thing.)"}

                # House cleaning
                {CLEAR_VARIABLE S6}
                {MOVE_GRNK_TO_DUMMY_SIDE 1}
                {UNDO_GRNK_IS_LOYAL ()}

                [endlevel]
                    result=victory
                    bonus=no
                    carryover_add=no
                    carryover_percentage=0
                    carryover_report=no
                [/endlevel]
            [/then]

            [else]
                {MESSAGE Grnk "" "" _"Oh no! I forgot that I need to have improved my leadership abilities to tame these wolves."}
                [endlevel]
                    result=defeat
                [/endlevel]
            [/else]
        [/if]
    [/event]

    ##### The fishermen events - "story" only #####
    {BOATS_DONT_MOVE}
    {BOATS_REAPPEAR 4 3}
    {BOATS_LAND 4 4}
    {BOATS_LAUNCH 4 7}
    {BOATS_DISAPPEAR 4 8}
    {BOATS_REAPPEAR 4 15}
    {BOATS_LAND 4 16}
    {BOATS_LAUNCH 4 19}
    {BOATS_DISAPPEAR 4 20}
    {BOATS_REAPPEAR 4 27}
    {BOATS_LAND 4 28}
    {BOATS_LAUNCH 4 31}
    {BOATS_DISAPPEAR 4 32}

    ######################
    # Finally, the standard events for all or most scenarios
    {STORY_IMAGE id=Grnk}
    {PICKPOCKET_EVENTS (type=Grnk the Spearman,Grnk the Rouser)}
    {POISON_ATTACK_EVENTS}
    {HEALING_POTION_MESSAGE}
    {GRNK_DEATH}
[/scenario]
