#textdomain wesnoth-Grnk

[scenario]
    id=11_Escape
    name=_"Escape"
    next_scenario=12_Prunes

    map_data="{~add-ons/Grnk/part1/maps/11_Escape.map}"

    {DEFAULT_SCHEDULE}
    turns=-1
    victory_when_enemies_defeated=no

    {GRNK_STORY_11}

    [side]
        side=1
        controller=human
        id=Grnk
        type=null # just to make wmllint happy

        team_name=Grnk
        user_team_name=_"Grnk"
        defeat_condition=never

        village_gold=0
        gold=0
        income=-2  # No income whatsoever
    [/side]

    [side]
        side=2
        controller=null
        id=Jen emaris
        type=null # just to make wmllint happy
        hidden=yes

        save_id=Jen emaris
        persistent=yes
        defeat_condition=never

        team_name=Grnk
        user_team_name=_"Grnk"
        color=1

        {GOLD 307 262 217}
    [/side]

    [side]
        side=3
        controller=null
        id=Pekzs
        type=null # just to make wmllint happy
        hidden=yes

        save_id=Pekzs
        persistent=yes
        defeat_condition=never

        team_name=Grnk
        user_team_name=_"Grnk"
        color=1

        {GOLD 307 262 217}
    [/side]

    [side]
        side=4
        controller=ai
        no_leader=yes

        team_name=humans,undead
        user_team_name=_"Dinvarn"
        color=2
        save_id="Dinvarn"

        gold=0
        income=-2

        [ai]
            aggression=1.0
            caution=-10.0
            village_value=0.0
            grouping=no
        [/ai]
    [/side]

    [side]
        side=5
        controller=ai
        id=Mal An
        type=Water Lich
        name=_"Mal An"

        gender=male
        unrenamable=yes

        facing=se

        team_name=undead
        user_team_name=_"Undead"
        hidden=yes
        persistent=yes
        save_id=Mal An
        defeat_condition=never
        color=3

        recruit=Skeleton,Skeleton Archer

        {GOLD 1724 1725 1726}

        [ai]
            aggression=1.0
            caution=-10.0
            village_value=0.0
            grouping=no

            # Target Grnk et al. much more than sea creatures
            [goal]
                [criteria]
                    side=1,2,3
                [/criteria]
                value=10.0
            [/goal]
            [goal]
                [criteria]
                    side=8
                [/criteria]
                value=1.0
            [/goal]
        [/ai]
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 5 "Skeleton Archer" 5}

    # The prison guards
    [side]
        side=6
        controller=ai
        no_leader=yes

        team_name=humans,Grnk
        user_team_name=_"Shmaltupp Army"
        save_id="Prison Island Guards"
        color=4

        gold=0

        [ai]
            aggression=1.0
            caution=-10.0
        [/ai]
    [/side]

    # The army outpost on the mainland
    [side]
        side=7
        controller=ai
        id=outpost_leader
        type=Shmaltupp Lieutenant

        facing=sw

        team_name=humans,undead  # These also fight with the undead
        user_team_name=_"Shmaltupp Army"
        persistent=yes
        save_id="Shmaltupp Army Outpost"
        color=5

        {GOLD 103 153 183} # He'll also have quite a bit of village income by the time he becomes active

        [ai]
            aggression=1.0
            caution=-10.0
            village_value=0.0
            grouping=no
            leader_aggression=1.0
            leader_caution=-10.0
        [/ai]
    [/side]
    # Want them to have only 3 H.I. in the entire scenario
    {LIMIT_RECRUITS 7 "Heavy Infantryman" 3}

    # Swamp Lurkers, sea monsters, ...
    [side]
        side=8
        controller=ai
        no_leader=yes

        team_name=animals
        user_team_name=_"Animals"
        save_id=Creatures
        color=6

        gold=0
        income=-2

        # Avoid the galleons and areas around Mal An's keeps
        [ai]
            [avoid]
                x,y=14-18,19-23
            [/avoid]
            [avoid]
                x,y=23-17,6-10
            [/avoid]
            [avoid]
                x,y=48-52,29-33
            [/avoid]
        [/ai]
    [/side]

    # Need this side only to get Karcyn out for a couple events, he won't take part in the fighting
    [side]
        side=9
        controller=null
        id=Karcyn
        type=null # just to make wmllint happy
        hidden=yes

        persistent=yes
        save_id=Karcyn
        defeat_condition=never

        color=3

        gold=0
    [/side]

    # Need a separate side for the float, so that the controller change works as desired
    [side]
        side=10
        controller=ai
        no_leader=yes
        hidden=yes

        team_name=Grnk,humans,undead,lurkers  # so that it doesn't get attacked
        color=7

        gold=0
    [/side]

    [event]
        name=prestart

        # Find which leader Grnk allied with in S6, set variables
        [if]
            [have_unit]
                id=Jen emaris
                search_recall_list=yes
            [/have_unit]

            [then]
                {VARIABLE S11.ally (Jen emaris)}
                {VARIABLE S11.ally_side 2}
                {VARIABLE S11.ally_x 45}
                {VARIABLE S11.ally_y 39}
                {VARIABLE S11.ally_new_units (Mermaid Initiate,Merman Fighter,Merman Hunter)}
            [/then]

            [else]
                {VARIABLE S11.ally Pekzs}
                {VARIABLE S11.ally_side 3}
                {VARIABLE S11.ally_x 30}
                {VARIABLE S11.ally_y 16}
                {VARIABLE S11.ally_new_units (Saurian Augur,Saurian Skirmisher)}
            [/else]
        [/if]

        # Grnk loses his spear for a fist attack, but keeps his fireball attack
        [transform_unit]
            id=Grnk
            transform_to=Confused Grnk Prisoner
        [/transform_unit]

        # Prisoners
        [unit]
            side=4
            type=Highwayman Prisoner
            id=Mounry
            name=_"Mounry"
            unrenamable=yes

            x,y=34,25
            facing=se

            upkeep=loyal
            overlays=misc/hero-icon.png

            role=Grnk_ally
        [/unit]

        [unit]
            side=4
            type=Assassin Prisoner
            id=Dinvarn
            name=_"Dinvarn"
            unrenamable=yes

            x,y=26,35
            facing=ne

            upkeep=loyal
            overlays=misc/hero-icon.png

            role=Grnk_enemy
        [/unit]

        [unit]
            side=4
            type=Bandit Prisoner
            id=prisoner1

            x,y=33,27
            facing=se

            upkeep=loyal

            role=Grnk_ally
        [/unit]

        # Put random prisoners out there all over the island
        # With Grnk (northern part of island); 2 should always be Fencers
        {REPEAT 2 (
            {RANDOM_FOE 4 100 "Fencer Prisoner" 1 (
                x=25-35
                y=23-29
                [not]
                    terrain=W*,C*
                [/not]
            ) (role,upkeep,facing=Grnk_ally,loyal,se)}
        )}

        {REPEAT 3 (
            {RANDOM_FOE 4 100 "Bandit Prisoner,Outlaw Prisoner,Trapper Prisoner,Footpad Prisoner,Thug Prisoner,Thug Prisoner" 1 (
                x=25-35
                y=23-29
                [not]
                    terrain=W*,C*
                [/not]
            ) (role,upkeep,facing=Grnk_ally,loyal,se)}
        )}

        # Against Grnk (southern part of island)
        {REPEAT 7 (
            {RANDOM_FOE 4 100 "Bandit Prisoner,Outlaw Prisoner,Trapper Prisoner,Footpad Prisoner,Thug Prisoner,Thug Prisoner,Fencer Prisoner" 1 (
                x=21-32
                y=32-38
                [not]
                    terrain=W*,C*
                [/not]
            ) (role,upkeep,facing=Grnk_enemy,loyal,se)}
        )}

        # Mal An's skeletons
        {UNIT 5 Revenant 3 13 (id,facing=skeleton1,se)}
        [+unit]
            [modifications]
                {TRAIT_QUICK}
            [/modifications]
        [/unit]
        {UNIT 5 (Bone Shooter) 2 13 (id,facing=skeleton2,se)}
        [+unit]
            [modifications]
                {TRAIT_QUICK}
            [/modifications]
        [/unit]
        {UNIT 5 Deathblade 1 13 (id,facing=skeleton3,se)}
        [+unit]
            [modifications]
                {TRAIT_QUICK}
            [/modifications]
        [/unit]

        # Prison guards
        {UNIT 6 (Shmaltupp Lieutenant) 38 22 (id,overlays,facing=prison_leader,misc/hero-icon.png,sw)}
        {UNIT 6 Swordsman 39 27 (facing=sw)}
        {UNIT 6 Pikeman 38 23 (facing=sw)}
        {UNIT 6 Spearman 39 40 (facing=nw)}
        {UNIT 6 Spearman 24 38 (facing=ne)}
        {UNIT 6 Bowman 18 32 (facing=se)}
        {UNIT 6 (Heavy Infantryman) 24 18 (facing=se)}

        # Boats
        {UNIT 7 (Transport Galleon) 54 16 (id,facing=galleon,sw)}
        {GENERIC_UNIT 7 (Boat) 54 17}

        # Lurkers
        [micro_ai]
            side=8
            ai_type=lurkers
            action=add

            [filter]
                type=Swamp Lurker
            [/filter]
            [filter_location]
                terrain=S*
            [/filter_location]
        [/micro_ai]

        # Capture some of the villages for army outpost
        [capture_village]
            side=7
            x=32-99
        [/capture_village]

        # Grnk has all his gold taken from him
        # Keep the variable, as he might get it back later (bonus)
        # -> do not use SET_GOLD macro
        [store_gold]
            side=1
            variable=S11.Grnks_gold
        [/store_gold]
        [gold]
            side=1
            amount=-$S11.Grnks_gold
        [/gold]

        # Finally, we hide away Grnk for a moment
        {MODIFY_UNIT id=Grnk facing sw}
        [hide_unit]
            id=Grnk
        [/hide_unit]
    [/event]

    [event]
        name=start

        {MESSAGE_RIGHT (Mal An) _"Remember, the Master wants that goblin alive!"}
        {MOVE_UNIT id=skeleton1 7 15}
        {MOVE_UNIT id=skeleton2 7 16}
        {MOVE_UNIT id=skeleton3 6 16}
        {MOVE_UNIT (id=Mal An) 6 15}

        {SCROLL_TO 54 16}
        {SOUND ambient/ship.ogg}
        {MOVE_UNIT (id=galleon) 40 23}

        {MESSAGE narrator "portraits/humans/transparent/thug.png~FL()~RIGHT()" "Galleon Captain" _"Get out!"}

        [move_unit_fake]
            type=Confused Grnk Prisoner
            side=1
            x=40,37
            y=23,25
        [/move_unit_fake]
        [unhide_unit]
            id=Grnk
        [/unhide_unit]

        {MESSAGE_RIGHT outpost_leader _"I wish they had executed him. I bet he's going to be nothing but trouble."}
        {SOUND ambient/ship.ogg}
        {MOVE_UNIT (id=galleon) 54 16}

        {MESSAGE_FACING Dinvarn Grnk "" _"Well, well, look who's here. That little sorcerer goblin."}
        {MESSAGE Grnk "" "" _"Hi there. I don't want any ..."}
        {MESSAGE Dinvarn "" "" _"Silence! We've heard about your voice."}
        {MESSAGE Grnk "" "" _"But I don't even know how I ..."}
        {MESSAGE Dinvarn "" "" _"Silence, I said! We don't want your kind here. I say we kill him right away. Why didn't they execute him in Shmaltupp in the first place?"}
        {MESSAGE_FACING Mounry Dinvarn "" _"Now, now, Dinvarn, why don't we ..."}
        {MESSAGE Dinvarn "" "" _"You shut up too, Mounry! We've listened to you too many times already. Let's get him, boys."}
        {MESSAGE Mounry "" "" {GASP_BEGINNING _"sigh"}+_"I guess it's your boys against mine. Again."}

        # Some of the prisoners now turn over to Grnk's side
        {MODIFY_UNIT role=Grnk_ally side 1}

        {MESSAGE_FACING Grnk Mounry "" _"You're really going to fight for me? Why?"}
        {MESSAGE Mounry "" "" _"This isn't about you. Dinvarn over there's an idiot. He does this sort of thing all the time. His 'boys' are getting tired of it too, I bet they will turn over to our side if we just get rid of him."}
        {MESSAGE Grnk "" "" _"But won't the guards intervene?"}
        {MESSAGE Mounry "" "" _"The guards don't care. The fewer of us there are, the less work for them. Dinvarn does have a point though. Why didn't they execute you? I'd've expected Koorzhar to do that simply to set an example."}
        {MESSAGE Grnk "" "" _"It's funny, really. Apparently, I've become some sort of folk hero in Shmaltupp. I'm told the people there were threatening a city-wide rebellion — led by Quank of all people, if you can believe it!"}

        [objectives]
            side=1
            summary=_"<span color='#A050A0'>Plot Grnk's Escape From The Prison Island</span>"
            [objective]
                description=_"Figure out a way off the island"
                condition=win
            [/objective]
            [objective]
                [show_if]
                    [have_unit]
                        id=Dinvarn
                    [/have_unit]
                [/show_if]
                description=_"Defeat Dinvarn with minimum loss of life on either side"
                condition=win
            [/objective]
            [objective]
                [show_if]
                    [have_unit]
                        side=5
                        [filter_vision]
                            side=1
                        [/filter_vision]
                    [/have_unit]
                [/show_if]
                description=_"Hold off Mal An's skeletons for as long as possible"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [gold_carryover]
                bonus=no
                carryover_percentage=100
            [/gold_carryover]
        [/objectives]

        #{NARRATOR_GRAY _"Note" "The prisoners on the island have been disarmed and fight with their fists only."}
    [/event]

    # When Dinvarn dies, rest of his units turns over to Grnk's side
    [event]
        name=last_breath

        [filter]
            id=Dinvarn
        [/filter]

        {MESSAGE Dinvarn "" "" _"Lousy goblin!"}
        [kill]
            id=Dinvarn
        [/kill]

        {GET_RANDOM_UNIT_ID side=4}
        {MESSAGE_FACING $random_unit_id Mounry "" _"Listen, Mounry, Dinvarn threatened to ..."}
        {MESSAGE Mounry "" "" _"No need for explanations. Join us now and I promise nobody will ask questions later."}
        {CLEAR_VARIABLE random_unit_id}
        {MODIFY_UNIT side=4 side 1}

        [modify_side]
            side=4
            controller=null
            hidden=yes
        [/modify_side]

        [show_objectives]
        [/show_objectives]
    [/event]

    # Mal An's units are kept in place for two turns
    [event]
        name=side 5 turn 1 refresh,side 5 turn 2 refresh
        first_time_only=no

        {MODIFY_UNIT side=5 moves 0}
    [/event]

    # And Mal An himself never moves
    [event]
        name=side 5 turn refresh
        first_time_only=no

        [modify_unit]
            [filter]
                id=Mal An
            [/filter]

            moves=0
        [/modify_unit]
    [/event]

    # The prison guards are also kept in place until Mal An appears
    [event]
        name=side 6 turn 1 refresh
        first_time_only=no

        {MODIFY_UNIT side=6 moves 0}
    [/event]

    # The galleons are kept in place indefinitely
    [event]
        name=side 7 turn refresh
        first_time_only=no

        {MODIFY_UNIT (side,race=7,mechanical) moves 0}
    [/event]

    # Turn 2: bring Mal An out
    [event]
        name=side 5 turn 2

        {MOVE_UNIT (id=skeleton1) 16 21}
        {MOVE_UNIT (id=skeleton2) 15 23}
        {MOVE_UNIT (id=skeleton3) 14 23}
        {MOVE_UNIT (id=Mal An) 14 21}

        [modify_side]
            side=5
            hidden=no
        [/modify_side]

        {MESSAGE_RIGHT (Mal An) _"There he is! Let's get him! Kill everybody else."}

        [event]
            name=side 6 turn

            {MESSAGE Grnk "" "" _"How the hell does he do that?!"}
            {MESSAGE_FACING Mounry Grnk "" _"I don't know. Black magic?"}
            {MESSAGE prison_leader "" "" _"Guards! Sound the alarm and defend the island until help from the mainland arrives."}
            {SOUND fanfare-short.wav}
        [/event]

        # The outpost leader wants to help, but may not
        [event]
            name=side 7 turn

            {MESSAGE outpost_leader "" "" _"The island is under attack. Men, to the ..."}

            [store_unit]
                [filter]
                    id=Karcyn
                [/filter]

                variable=tmp_Karcyn
                kill=yes
            [/store_unit]

            {FIREBALL_IN 9 62 16 $tmp_Karcyn.image sw "~GS()"}

            {VARIABLE tmp_Karcyn.facing sw}

            [unstore_unit]
                variable=tmp_Karcyn
                x,y=62,16
                find_vacant=no
            [/unstore_unit]
            {CLEAR_VARIABLE tmp_Karcyn}

            {MESSAGE_FACING Karcyn outpost_leader "" _"Oh no, you won't."}
            {MESSAGE outpost_leader "" "" _"But you said that the goblin must not ..."}
            {MESSAGE Karcyn "" "" _"This is none of your concern. Stay in place until I tell you otherwise."}

            {FIREBALL_OUT_HIDE Karcyn "~GS()"}
            {PUT_TO_RECALL_LIST id=Karcyn}

            {MESSAGE outpost_leader "" "" {GASP _"grumbles"}}

            # Now show in the stats that these are working with the undead
            [modify_side]
                side=7
                team_name=humans,undead  # These also fight with the undead
                user_team_name=_"Undead"
            [/modify_side]
        [/event]

        # On this and all following turns, set the water terrain for recruiting, but only during Mal An's turn
        # All 3 of Mal An's keeps
        [event]
            name=side 5 turn refresh
            first_time_only=no

            {MODIFY_TERRAIN Ww^Kw 14 21}
            [terrain]
                x=13,14,15,15
                y=22,22,21,22
                terrain=Ww^Cw
            [/terrain]
            {MODIFY_TERRAIN Ww^Kw 25 8}
            [terrain]
                x=25,26,26
                y=7,7,8
                terrain=Ww^Cw
            [/terrain]
            {MODIFY_TERRAIN Ww^Kw 50 31}
            [terrain]
                x=50,51,51
                y=32,31,32
                terrain=Ww^Cw
            [/terrain]
        [/event]

        [event]
            name=side 5 turn end
            first_time_only=no

            [terrain]
                x=14,13,14,15,15
                y=21,22,22,21,22
                terrain=Ww
            [/terrain]
            [terrain]
                x=25,25,26,26
                y=8,7,7,8
                terrain=Ww
            [/terrain]
            [terrain]
                x=50,50,51,51,
                y=31,32,31,32
                terrain=Ww
            [/terrain]
        [/event]

        # Prison guards want help
        [event]
            name=side 1 turn

            [if]
                [have_unit]
                    id=Mounry
                [/have_unit]

                [then]
                    {VARIABLE S11.speaker Mounry}
                [/then]

                [else]
                    {VARIABLE S11.speaker Grnk}
                [/else]
            [/if]

            [if]
                [have_unit]
                    id=Dinvarn
                [/have_unit]

                [then]
                    {MESSAGE Dinvarn "" "" _"Boys, let's take advantage of this chaos and get rid of that goblin."}
                    {MESSAGE_FACING $S11.speaker Dinvarn "" _"Dinvarn, you idiot! Let's work together or those undead will kill us all."}
                    {MESSAGE Dinvarn "" "" _"I am sick and tired of being told what to do. Get that damned goblin!"}
                    {MESSAGE_FACING prison_leader $S11.speaker "" {GASP_BEGINNING _"sigh"}+_"Dinvarn's being his usual braniac self. How about the rest of you help us fight those skeletons? They don't care which side of the law you're on."}
                [/then]

                [else]
                    {MESSAGE_FACING prison_leader Mounry "" _"How about you prisoners help us fight those skeletons? They don't care which side of the law you're on."}
                [/else]
            [/if]

            {MESSAGE $S11.speaker "" "" _"How about you give us our weapons back first?"}
            {MESSAGE prison_leader "" "" _"Do you really think that we are keeping a stack of weapons on an island full of dangerous criminals just in case we are suddenly attacked by an army of undead?"}
            {MESSAGE $S11.speaker "" "" _"Ah, well, if you put it that way ..."}

            {CLEAR_VARIABLE S11.speaker}

            [show_objectives]
            [/show_objectives]
        [/event]
    [/event]

    # Turn 5: Grnk gets a warning
    [event]
        name=side 1 turn 5

        {IF_VAR S11.ally equals Pekzs (
            [then]
                {VARIABLE S11.str "northern-most"}
                {SCROLL_TO 35 1}
            [/then]

            [else]
                {VARIABLE S11.str "south-eastern-most"}
                {SCROLL_TO 62 49}
            [/else]
        )}

        {MESSAGE narrator "portraits/humans/transparent/mage-light.png~O(30%)" _"A Voice from the Distance" _"Grnk, help is on the way. Keep the skeletons away from the $S11.str point of the island and be there yourself two sunrises from now."}
        {MESSAGE Grnk "" "" _"What was that? Who said that?"}
        # If Mounry's dead and doesn't say the following, that's fine
        {MESSAGE Mounry "" "" _"Said what?"}

        {CLEAR_VARIABLE S11.str}
    [/event]

    # Turn 10: put the float out there so that it makes it to the island on Turn 13
    [event]
        name=side 10 turn 10,mobilize_float

        {IF_VAR S11.ally equals Pekzs (
            [then]
                {UNIT 10 Float_spear 35 1 (
                    id=float
                    goto_x,goto_y=30,16
                )}
            [/then]

            [else]
                {UNIT 10 Float_spear 62 49 (
                    id=float
                    goto_x,goto_y=45,39
                )}
            [/else]
        )}
    [/event]

    # Turn 9: Mal An disappears into the water
    [event]
        name=side 5 turn 9 end,mal_an_leaves

        {MESSAGE (Mal An) "" "" _"That should do. Now to take care of that other problem."}
        {FIREBALL_OUT_HIDE (Mal An) "~GS()"}
        {FULL_HEAL_AND_CURE (id=Mal An)}
        {PUT_TO_RECALL_LIST (id=Mal An)}
    [/event]

    # Turn 13: Mal An comes back out of the water
    [event]
        name=side 5 turn 13,mal_an_back

        {IF_VAR S11.ally equals Pekzs (
            [then]
                [recall]
                    id=Mal An
                    x,y=23,11
                [/recall]
                {MOVE_UNIT (id=Mal An) 25 8}
                {MESSAGE (Mal An) "" "" _"Those pesky little saurians were faster than I expected."}
            [/then]

            [else]
                [recall]
                    id=Mal An
                    x,y=49,30
                [/recall]
                {MOVE_UNIT (id=Mal An) 50 31}
                {MESSAGE (Mal An) "" "" _"Those pesky little mermen were faster than I expected."}
            [/else]
        )}
    [/event]

    # When float gets to destination, Pekzs or Jen emaris come out on next
    # Side 1 turn (this is why float is on last side)
    # The moveto event has a radius=2 in it, in case somebody is at the target location
    [event]
        name=moveto,mobilize_ally

        [filter]
            id=float
            [filter_location]
                x,y=$S11.ally_x,$S11.ally_y
                radius=2
            [/filter_location]
        [/filter]

        [modify_unit]
            [filter]
                id=float
            [/filter]

            facing=se
        [/modify_unit]

        {VARIABLE S11.float_x $x1}
        {VARIABLE S11.float_y $y1}

        # Activate ally side
        [modify_side]
            side=$S11.ally_side
            controller=human
            hidden=no
        [/modify_side]

        # Everybody on Side 1 gets moved to new side; deactivate Side 1
        {MODIFY_UNIT side=1 side $S11.ally_side}
        [modify_side]
            side=1
            controller=null
            hidden=yes
        [/modify_side]

        # New event so that it happens at Turn 13 (in the morning)
        [event]
            name=side 2 turn refresh,side 3 turn refresh

            {SCROLL_TO $S11.float_x $S11.float_y}

            {IF_VAR S11.ally equals Pekzs (
                [then]
                    {RANDOM_UNIT $S11.ally_side $S11.ally_new_units "$($S11.float_x+1)" $S11.float_y (id,animate,facing=float_pusher,yes,sw)}
                    [kill]  # In this order, so that pusher is not on float if some hexes are occupied
                        id=float
                    [/kill]
                    {PLACE_IMAGE "units/float.png~BLIT(items/spear-float.png,20,42)" $S11.float_x $S11.float_y}

                    [recall]
                        id=$S11.ally
                        x="$($S11.ally_x+6)"
                        y="$($S11.ally_y-4)"
                        check_passability=no
                    [/recall]

                    [modify_unit]
                        [filter]
                            id=$S11.ally
                        [/filter]

                        facing=sw
                    [/modify_unit]

                    {REPEAT 2 (
                        {RECALL_BEST_UNIT $S11.ally_side () "$($S11.ally_x+6)" "$($S11.ally_y-4)" () $S11.ally_new_units (facing=sw)}
                    )}
                    {REDRAW 1}
                    {CLEAR_VARIABLE new_unit_id}

                    {MESSAGE_FACING $S11.ally Grnk "" _"Hello, Grnk."}
                    {MESSAGE Grnk "" "" _"$S11.ally! How did you ...?"}
                    {MESSAGE $S11.ally "" "" _"We have our wayss ... But zzere'ss no time to explain. It is esssential zzat we must protect you from zze undead. Apparently, you have become very important."}
                    {MESSAGE Grnk "" "" _"What do you mean? Why me?"}
                    {MESSAGE $S11.ally "" "" _"Don't asssk me, I don't know. A great wizzzard spoke to uss. We have dealt wizz him before and we trust him. We need to get you acroszs zze passs by zze army outpost asss quickly asss poszsible. Step on zze float and come wizz ussss. We left you a spear wizz it too."}

                    {MOVE_UNIT id=float_pusher "$($S11.ally_x+3)" "$($S11.ally_y-2)"}
                    {MODIFY_UNIT id=float_pusher moves 0}
                [/then]

                [else]
                    {RANDOM_UNIT $S11.ally_side $S11.ally_new_units "$($S11.float_x+1)" $S11.float_y (id,animate,facing=float_pusher,yes,sw)}
                    [kill]  # In this order, so that pusher is not on float if some hexes are occupied
                        id=float
                    [/kill]
                    {PLACE_IMAGE "units/float.png~BLIT(items/spear-float.png,20,42)" $S11.float_x $S11.float_y}

                    [recall]
                        id=$S11.ally
                        x="$($S11.ally_x+9)"
                        y="$($S11.ally_y)"
                        check_passability=no
                    [/recall]

                    [modify_unit]
                        [filter]
                            id=$S11.ally
                        [/filter]

                        facing=sw
                    [/modify_unit]

                    {REPEAT 2 (
                        {RECALL_BEST_UNIT $S11.ally_side () "$($S11.ally_x+9)" $S11.ally_y () $S11.ally_new_units (facing=sw)}
                    )}

                    {REDRAW 1}
                    {CLEAR_VARIABLE new_unit_id}

                    {MESSAGE_FACING $S11.ally Grnk "" _"Hello, Grnk."}
                    {MESSAGE Grnk "" "" _"$S11.ally! How did you ...?"}
                    {MESSAGE $S11.ally "" "" _"We have our ways ... But there's no time to explain. It is essential that we must protect you from the undead. Apparently, you have become very important."}
                    {MESSAGE Grnk "" "" _"What do you mean? Why me?"}
                    {MESSAGE $S11.ally "" "" _"Don't ask me, I don't know. A great wizard spoke to us. We have dealt with him before and we trust him. We need to get you across the pass by the army outpost as quickly as possible. Step on the float and come with us. We left you a spear with it too."}

                    {MOVE_UNIT id=float_pusher "$($S11.ally_x+4)" $S11.ally_y}
                    {MODIFY_UNIT id=float_pusher moves 0}
                [/else]
            )}

            {HIGHLIGHT_IMAGE_SHORT 67 11 scenery/signpost.png ()}

            [objectives]
                side=$S11.ally_side
                summary=_"<span color='#A050A0'>Escape From The Prison Island</span>"
                [objective]
                    description=_"Get Grnk to the signpost across the pass before the undead catch up with him"
                    condition=win
                [/objective]
                [objective]
                    description= _"Bonus: Defeat the army outpost leader"
                    condition=win
                [/objective]
                [objective]
                    description=_"Death of Grnk"
                    condition=lose
                [/objective]
                [gold_carryover]
                    bonus=no
                    carryover_percentage=100
                [/gold_carryover]
            [/objectives]

            # On the next Side 7 turn, the army gets activates (by Karcyn)
            [event]
                name=side 7 turn

                [store_unit]
                    [filter]
                        id=Karcyn
                    [/filter]

                    variable=tmp_Karcyn
                    kill=yes
                [/store_unit]

                {FIREBALL_IN 9 62 16 $tmp_Karcyn.image sw "~GS()"}

                {VARIABLE tmp_Karcyn.facing sw}

                [unstore_unit]
                    variable=tmp_Karcyn
                    x,y=62,16
                    find_vacant=no
                [/unstore_unit]
                {CLEAR_VARIABLE tmp_Karcyn}

                {MESSAGE_FACING Karcyn outpost_leader "" _"The Master was afraid something like this would happen. <i>Now</i> it's your turn. That goblin must be captured and his allies destroyed."}
                {MESSAGE outpost_leader "" "" _"We're not a very strong outpost, HQ never ..."}
                {MESSAGE Karcyn "" "" _"Stop whining. Mal An's over there already. All you need to do is delay them for long enough to let his skeletons take care of the rest."}

                {FIREBALL_OUT_HIDE Karcyn "~GS()"}
                {PUT_TO_RECALL_LIST id=Karcyn}

                {MESSAGE outpost_leader "" "" {GASP _"grumbles"}}

                [modify_side]
                    side=7
                    recruit=Spearman,Bowman,Heavy Infantryman
                [/modify_side]
            [/event]

            [event]
                name=side 7 turn end

                {MESSAGE outpost_leader "" "" _"The goblin is trying to escape. After him!"}
            [/event]

            # Bonus objective: Grnk gets his gold when army leader is defeated
            [event]
                name=last_breath

                [filter]
                    id=outpost_leader
                [/filter]

                {MESSAGE outpost_leader "" "" _"I knew that goblin would be nothing but trouble!"}
                [kill]
                    id=outpost_leader
                [/kill]

                {SOUND gold.ogg}
                {MESSAGE Grnk "" "" _"He had my gold!"}
                {MESSAGE Grnk "" "" _"Wait! There's only half of it. Bugger!!"+{NOTE _"Grnk will start the next scenario with $($S11.Grnks_gold/2) gold."}}
                {SET_GOLD 1 "$($S11.Grnks_gold/2)"}
                {CLEAR_VARIABLE S11.Grnks_gold}
            [/event]
        [/event]

        # Afterward: Grnk steps on float
        [event]
            name=moveto

            [filter]
                id=Grnk
                x,y=$S11.float_x,$S11.float_y
            [/filter]

            {REMOVE_IMAGE $x1 $y1}
            {CLEAR_VARIABLE S11.float_x,S11.float_y}

            # Grnk becomes floating Grnk
            [transform_unit]
                id=Grnk
                transform_to=Floating Grnk
            [/transform_unit]

            # Ask about other prisoners, depending on how many are left
            {COUNT_UNITS (
                role=Grnk_ally
                [or]
                    role=Grnk_enemy
                [/or]
            )}
            {GET_RANDOM_UNIT_ID (
                role=Grnk_ally
                [or]
                    role=Grnk_enemy
                [/or]
            )}

            [switch]
                variable=unit_count

                [case]  # if none left
                    value=0
                [/case]

                [case]  # if one left
                    value=1

                    {MESSAGE Grnk "" "" _"What about my friend over there?"}
                    {IF_VAR S11.ally equals Pekzs (
                        [then]
                            {MESSAGE_FACING $S11.ally Grnk yes _"I'm afraid zzat we have no way of getting him acrozz zze water."}
                        [/then]

                        [else]
                            {MESSAGE_FACING $S11.ally Grnk yes _"I'm afraid that we have no way of getting him across the water."}
                        [/else]
                    )}
                    {MESSAGE_FACING $random_unit_id Grnk yes _"Don't worry about me. I will hold off these undead for as long as I can."}
                [/case]

                [else]  # if more than one left
                    {MESSAGE Grnk "" "" _"What about my friends over there?"}
                    {IF_VAR S11.ally equals Pekzs (
                        [then]
                            {MESSAGE_FACING $S11.ally Grnk yes _"I'm afraid zzat we have no way of getting zzem acrozz zze water."}
                        [/then]

                        [else]
                            {MESSAGE_FACING $S11.ally Grnk yes _"I'm afraid that we have no way of getting them across the water."}
                        [/else]
                    )}
                    {MESSAGE_FACING $random_unit_id Grnk yes _"Don't worry about us. We will hold off these undead for as long as we can."}
                [/else]
            [/switch]
            {CLEAR_VARIABLE unit_count,random_unit_id}

            {NARRATOR_GRAY _"Getting off the Float" "Grnk will step off the float when he moves next to an unoccupied solid-ground hex (anything other than water or swamp) connected to the mainland."}

            # Grnk gets off the float when he moves next to a tile other than water
            [event]
                name=moveto

                [filter]
                    id=Grnk
                    [filter_location]
                        [not]
                            x=1-41
                            y=15-40
                        [/not]
                        [filter_adjacent_location]
                            [not]
                                terrain=W*,S*
                            [/not]
                            [not]
                                [filter]
                                [/filter]
                            [/not]
                        [/filter_adjacent_location]
                    [/filter_location]
                [/filter]

                # First, store him away for a moment
                [store_unit]
                    [filter]
                        id=Grnk
                    [/filter]
                    variable=S11.tmp_Grnk
                [/store_unit]

                # Modify the id of the original Grnk (floating)
                {MODIFY_UNIT id=Grnk id tmp_Grnk}

                # Then unstore him at x,y=1,1, in order to transform him
                [unstore_unit]
                    variable=S11.tmp_Grnk
                    x,y=1,1
                [/unstore_unit]
                [hide_unit]
                    id=Grnk
                [/hide_unit]

                # Now Grnk becomes Confused Grnk again
                [transform_unit]
                    id=Grnk
                    transform_to=Confused Grnk
                [/transform_unit]
                # ... is stored again
                [store_unit]
                    [filter]
                        id=Grnk
                    [/filter]
                    variable=S11.tmp_Grnk
                [/store_unit]
                # ... and the unit at 1,1 is killed
                [kill]
                    id=Grnk
                [/kill]

                # Now replace Floating Grnk, by float, and move Confused Grnk out
                {CLOSE_EMPTY_HEX $x1 $y1 (W*,S*) 1}
                [kill]
                    id=tmp_Grnk
                [/kill]
                {UNIT 5 Float $x1 $y1 id=float}
                [move_unit_fake]
                    type=Confused Grnk
                    side=$S11.ally_side
                    x=$x1,$hex_x
                    y=$y1,$hex_y
                [/move_unit_fake]
                [unstore_unit]
                    variable=S11.tmp_Grnk
                    x,y=$hex_x,$hex_y
                [/unstore_unit]
                # If Grnk lands on a village:
                [capture_village]
                    side=$S11.ally_side
                    x,y=$hex_x,$hex_y
                [/capture_village]

                # Finally, blow up the float
                [adjust_facing]
                    id=Grnk
                    second_id=float
                    speaker_only=yes
                [/adjust_facing]

                {DELAY 500}
                {FIREBALL_KILL float}
                {MESSAGE_FACING $S11.ally Grnk "" _"Why did you ...?"}
                {MESSAGE Grnk "" "" _"Just making sure no enemy can use the float."}
                {CLEAR_VARIABLE S11.tmp_Grnk,hex_x,hex_y}

                # A turn after landing, Grnk exclaims about skeletons
                # Jen emaris/Pekzs hints that they'll all die
                [event]
                    name=side 2 turn,side 3 turn

                    {MESSAGE Grnk "" "" _"There are way too many of those damned skeletons! We will never defeat them."}

                    {IF_VAR S11.ally equals Pekzs (
                        [then]
                            {MESSAGE_FACING $S11.ally Grnk "" _"Don't worry about zzat. You just make ssure you get acrozz zze passs. We will delay zze undead for asss long asss we can."}
                            {MESSAGE Grnk "" "" _"But you will all die!"}
                            {MESSAGE $S11.ally "" "" _"We're told zzat ssome zzingss are worzz dying for."}
                            {MESSAGE Grnk "" "" _"By that great wizard of yours? He cannot ask you to sacrifice yourselves!"}
                            {MESSAGE $S11.ally "" "" _"He can. And he hasss. As I ssaid, we trust him. And we owe him. Now stop complaining and get on wizz zze busineszs at hand!"}
                        [/then]

                        [else]
                            {MESSAGE_FACING $S11.ally Grnk "" _"Don't worry about that. You just make sure you get across the pass. We will delay the undead for as long as we can."}
                            {MESSAGE Grnk "" "" _"But you will all die!"}
                            {MESSAGE $S11.ally "" "" _"We're told that some things are worth dying for."}
                            {MESSAGE Grnk "" "" _"By that great wizard of yours? He cannot ask you to sacrifice yourself!"}
                            {MESSAGE $S11.ally "" "" _"He can. And he has. As I said, we trust him. And we owe him. Now stop complaining and get on with the business at hand!"}
                        [/else]
                    )}
                [/event]
            [/event]
        [/event]

        # After rescue, start the lurkers
        [event]
            name=side 8 turn
            first_time_only=no

            {RANDOM_FOE 8 75 (Swamp Lurker) 1 (terrain=S*) ()}
        [/event]
    [/event]

    # Grnk exclaims, again, first time there is an attack involving a lurker (attack or defense)
    [event]
        name=lurker message

        {MESSAGE_NOSCROLL Grnk _"Those lurker thingers again!"}
    [/event]

    [event]
        name=attack end

        [filter]
            type=Swamp Lurker
        [/filter]

        [fire_event]
            name=lurker message
        [/fire_event]
    [/event]

    [event]
        name=attack end

        [filter_second]
            type=Swamp Lurker
        [/filter_second]

        [fire_event]
            name=lurker message
        [/fire_event]
    [/event]

    # Throughout the scenario, there's a small chance of some sea creatures
    [event]
        name=side 8 turn
        first_time_only=no

        # Eel - small chance of 1 in SW corner of map
        {RANDOM_FOE 8 15 (Eel) 1 (
            terrain=Wo*
            x=1-6
            y=44-99
        ) ()}
        # Squid - chance of swarm of 1-3 in SW corner of the map
        [set_variable]
            name=S11.random_reps
            rand=1..3
        [/set_variable]
        {RANDOM_FOE 8 10 (Squid) $S11.random_reps (
            terrain=Wo*
            x=1-6
            y=44-99
        ) ()}
        {CLEAR_VARIABLE S11.random_reps}
    [/event]

    # Event: Finish by getting Grnk to the signpost
    [event]
        name=moveto

        [filter]
            id=Grnk
            x,y=67,11
        [/filter]

        # Don't need to save anyone, everybody except Grnk dies here (really!)
        {MESSAGE Grnk "" "" _"I made it, but at what cost?!"}

        # Get Gertburt out there
        {FOREACH stored_Gertburt_troops S11.i}
            {IF_VAR stored_Gertburt_troops[$S11.i].name equals Gertburt (
                [then]
                    [unstore_unit]
                        variable=stored_Gertburt_troops[$S11.i]
                        x,y=68,10
                    [/unstore_unit]
                    # We put him on Grnk's orignial side, that way he will be carried over automatically
                    # can be deleted from variable
                    {CLEAR_VARIABLE stored_Gertburt_troops[$S11.i]}
                [/then]
            )}
        {NEXT S11.i}

        {MESSAGE_FACING Gertburt Grnk "" _"What took you so long, little fella?"}
        {MESSAGE Grnk "" "" _"Gertburt!!!"}

        # Move Grnk back to his own side
        {MOVE_GRNK_TO_DUMMY_SIDE 1}

        # Want the carry-over message to be for Grnk, not Pekzs or Jen emaris
        [modify_side]
            side=$S11.ally_side
            controller=null
        [/modify_side]
        [modify_side]
            side=1
            controller=human
        [/modify_side]

        # Save all units that are in the area of the next map
        [store_unit]
            [filter]
                side=2,3,5,7,8
                x,y=63-99,1-16
                [not]
                    id=Mal An,outpost_leader
                [/not]
            [/filter]

            kill=no # not killing them, because I want them to stay out there, deleted of recall list next scenario
            variable=stored_enemies_onmap12
        [/store_unit]

        # Save all the skeletons for the next scenario; only skeletons follow, everybody else goes back
        [store_unit]
            [filter]
                side=5
                [not]
                    x,y=63-99,1-16
                [/not]
                [not]
                    id=Mal An,outpost_leader
                [/not]
            [/filter]

            kill=no # not killing them, because I want them to stay out there, deleted of recall list next scenario
            variable=stored_enemies_offmap12
        [/store_unit]

        # Also store Grnk, as he should not have time to recover his health
        [store_unit]
            [filter]
                id=Grnk
            [/filter]

            kill=no # not killing him, because I want them to stay out there, deleted of recall list next scenario
            variable=stored_Grnk_formap12
        [/store_unit]

        # House cleaning
        {CLEAR_VARIABLE S11,side_7_limited_recruits,side_7_limited_recruits_length}

        # Start S12 at same time of day
        [store_time_of_day]
        [/store_time_of_day]

        [endlevel]
            result=victory
            bonus=no
            carryover_add=yes
            carryover_percentage=100
        [/endlevel]
    [/event]

    # If Mal An dies, he needs to be put back onto his recall list, needed later
    [event]
        name=last_breath
        first_time_only=no

        [filter]
            id=Mal An
        [/filter]

        {MESSAGE (Mal An) "" "" _"Oh no, you won't. I will be back."}
        {FIREBALL_OUT_HIDE (Mal An) "~GS()"}
        {FULL_HEAL_AND_CURE (id=Mal An)}
        {PUT_TO_RECALL_LIST (id=Mal An)}
    [/event]

    # A few more last breath speeches
    [event]
        name=last_breath

        [filter]
            id=Pekzs,Jen emaris
        [/filter]

        {MESSAGE $unit.id "" "" _"Good luck, Grnk."}
    [/event]

    [event]
        name=last_breath

        [filter]
            id=Mounry
        [/filter]

        {MESSAGE $unit.id "" "" _"I hope the little goblin will make it."}
    [/event]

    ######################
    # Finally, the standard events for all or most scenarios
    {STORY_IMAGE id=Grnk}
    {GRNK_DEATH}
[/scenario]
