#textdomain wesnoth-Grnk

[scenario]
    id=07_Disillusion
    name=_"Disillusion"
    next_scenario=02_Shmaltupp_05

    map_data="{~add-ons/Grnk/part1/maps/07_Disillusion_initial.map}"

    {DEFAULT_SCHEDULE}
    {TURNS 15 17 20}
    victory_when_enemies_defeated=no

    {GRNK_STORY_07}

    [side]
        side=1
        controller=human
        id=Vanak
        name=Vanak
        type=Orcish Ruler

        gender=male
        unrenamable=yes

        team_name=Karcyn # Orcs don't fight each other or the undead (until later)
        user_team_name=_"Orcs"

        recruit=Orcish Grunt,Orcish Archer,Orcish Assassin

        {GOLD 288 244 197}

        # For the part when this side is played by the AI:
        [ai]
            aggression=1.0
            caution=0.0
            leader_aggression=1.0
            leader_caution=0.0
            village_value=0.0
            scout_village_targeting=0.0
            villages_per_scout=0.0
        [/ai]
    [/side]

    # Teehf River Fort
    [side]
        side=2
        controller=ai
        id=outpost_leader
        type=Shmaltupp Lieutenant

        team_name=Koorzhar
        user_team_name=_"Human Army"

        recruit=Heavy Infantryman,Bowman,Spearman

        {GOLD 197 247 287}

        # Make them target mostly Side 1 orcs, leave villages alone
        [ai]
            [goal]
                [criteria]
                    side=1
                [/criteria]
                value=100.0
            [/goal]
            [goal]
                [criteria]
                    side=3,4,5,6,7,8,9
                [/criteria]
                value=1.0
            [/goal]

            village_value=0.00
            scout_village_targeting=0.0
            villages_per_scout=0.0
        [/ai]
    [/side]

    [side]
        side=3
        controller=human
        id=Koorzhar

        team_name=Koorzhar
        user_team_name=_"Human Army"

        {GOLD 303 253 203}
        income=0
    [/side]

    [side]
        side=4
        controller=ai
        id=Borck
        name=Borck
        type=Orcish Ruler

        team_name=Karcyn
        user_team_name=_"Orcs"

        recruit=Orcish Grunt,Orcish Archer,Wolf Rider,Orcish Assassin

        {GOLD 411 511 611}

        [ai]
            aggression=1.0
            caution=0.0
            leader_aggression=1.0
            leader_caution=0.0
            village_value=0.0
            scout_village_targeting=0.0
            number_of_possible_recruits_to_force_recruit=0.0
            villages_per_scout=0.0
        [/ai]
    [/side]
    {LIMIT_CONTEMPORANEOUS_RECRUITS 4 "Orcish Assassin" 2}

    # Army reinforcements
    [side]
        side=5
        controller=null
        no_leader=yes
        hidden=yes

        team_name=Koorzhar
        user_team_name=_"Human Army"

        recruit=Heavy Infantryman,Bowman,Spearman,Shmaltupp Sergeant

        {GOLD 192 142 106}
    [/side]

    [side]
        side=6
        controller=null
        no_leader=yes
        hidden=yes

        team_name=Karcyn
        user_team_name=_"Orcs"
        persistent=yes
        save_id=Karcyn
        defeat_condition=never

        recruit=Orcish Grunt,Orcish Archer,Wolf Rider,Orcish Assassin,Orcish Warrior,Orcish Crossbowman

        {GOLD 532 632 732}

        [ai]
            aggression=1.0
            caution=0.0
            village_value=0.0
            scout_village_targeting=0.0
            villages_per_scout=0.0
        [/ai]
    [/side]
    # Karcyn can recruit 1 Level 2 orc per turn
    {ONE_RECRUIT_PER_TURN 6 (Orcish Warrior,Orcish Crossbowman)}

    [side]
        side=7
        controller=null
        no_leader=yes
        hidden=yes

        team_name=saurians
        user_team_name=_"Saurians"

        recruit=Saurian Augur,Saurian Skirmisher

        {GOLD 261 261 361}

        [ai]
            aggression=1.0
            caution=0.0
            leader_aggression=1.0
            leader_caution=0.0
            village_value=0.0
            scout_village_targeting=0.0
            number_of_possible_recruits_to_force_recruit=0.0
            villages_per_scout=0.0
        [/ai]
    [/side]
    # Saurians can recruit 1 Level 2 unit per turn
    {ONE_RECRUIT_PER_TURN 7 (Saurian Oracle,Saurian Soothsayer,Saurian Ambusher)}

    {GRNK_DUMMY_SIDE 8}

    [event]
        name=prestart

        # Kill Koorzhar's city guards on recall list
        [kill]
            side=3
            role=city guard
            [not]
                x=1-999
            [/not]
        [/kill]

        # Hide the orc and outpost leaders, only Grnk and Koorzhar visible at first
        [hide_unit]
            side=1,2,4
        [/hide_unit]
        {GET_GRNK_FROM_DUMMY_SIDE 8 1}

        [modify_unit]
            [filter]
                id=Grnk
            [/filter]

            facing=se
        [/modify_unit]

        [modify_unit]
            [filter]
                id=Koorzhar
            [/filter]

            side=1
            facing=sw
        [/modify_unit]

        # Need the outpost leader name later
        {STORE_UNIT_VAR id=outpost_leader name S7.outpost_leader_name}

        # Variable for gold for Grnk
        {VARIABLE S7.gold_for_Grnk 0}
    [/event]

    [event]
        name=start

        {MESSAGE Grnk "" "" _"I cannot do that! I will not do that!!!"}
        {MESSAGE Koorzhar "" "" _"You said that you want to make a difference and become a better person. Here's a chance to use your unique position to do so."}
        {MESSAGE Grnk "" "" _"You are sacrificing your own people. How does helping with that make me a better person?"}
        {MESSAGE Koorzhar "" "" _"Look, kid, I don't like this any better than you. Lieutenant $S7.outpost_leader_name is a friend of mine. If there were another way, I'd jump on it in a heartbeat. But we need to stop this orc uprising before it is too late. Yes, the men at Teehf River Fort will lose their lives, but it will save thousands in return."}
        {MESSAGE Grnk "" "" {GASP _"grumbles"}}
        {MESSAGE Koorzhar "" "" _"The correct answer is 'Yes, sir.'
<i> </i>
And, kid, make no mistake. My men don't trust you. One wrong move on your part and you'll become very familiar with the inside of Shmaltupp Jail. If you're lucky.
<i> </i>
If, on the other hand, you do well, you will get the same pay as everybody else and I'll be happy to take you along on future missions."}
        {MESSAGE Grnk "" "" _"Yes ... Sir ..."}
        {MOVE_UNIT id=Grnk 8 1}
        {MOVE_UNIT_OFF_MAP_HIDE Grnk n}

        # Blacks out the screen to change maps
        [modify_side]
            side=1
            shroud=yes
        [/modify_side]
        {REDRAW 8} # no typo

        [replace_map]
            map="{~add-ons/Grnk/part1/maps/07_Disillusion.map}"
            expand=yes
        [/replace_map]

        # Put units in right place, on right sides
        [modify_unit]
            [filter]
                id=Koorzhar
            [/filter]

            side=3
            x,y=33,43
            facing=nw
        [/modify_unit]

        [modify_unit]
            [filter]
                id=Grnk
            [/filter]

            x,y=2,5
            facing=se
        [/modify_unit]

        [modify_unit]
            [filter]
                id=Vanak
            [/filter]

            x,y=2,4
            facing=se
        [/modify_unit]

        [modify_unit]
            [filter]
                id=Borck
            [/filter]

            x,y=11,46
            facing=ne
        [/modify_unit]

        [modify_unit]
            [filter]
                id=outpost_leader
            [/filter]

            x,y=19,17
            facing=sw
        [/modify_unit]

        [unhide_unit]
        [/unhide_unit]

        # Set up the extra units, villages Side 2 (Outpost)
        {UNIT 2 Halberdier 18 16 ai_special,facing=guardian,sw}
        {UNIT 2 Longbowman 15 15 ai_special,facing=guardian,se}
        {UNIT 2 Longbowman 15 12 ai_special,facing=guardian,se}
        {UNIT 2 Swordsman 18 13 ai_special,facing=guardian,sw}
        {CAPTURE_VILLAGES 2 16 14 8}

        # Koorzhar also has some starting troops (don't care about their facings)
        {GENERIC_UNIT 3 Bowman 33 43}
        {GENERIC_UNIT 3 Longbowman 33 43}
        {GENERIC_UNIT 3 Spearman 33 43}
        {GENERIC_UNIT 3 Swordsman 33 43}

        # Set up the extra units, villages Side 3 (Koorzhar)
        {CAPTURE_VILLAGES 3 33 35 5}
        {CAPTURE_VILLAGES 3 33 43 3}

        {SCROLL_TO 2 5}

        [dialog_message]
            message=_"Some time later"
        [/dialog_message]

        # Bring screen back on new map
        [modify_side]
            side=1
            shroud=no
        [/modify_side]
        {REDRAW 8} # no typo

        {SET_LABEL 16 30 _"Knick Point"}
        {SET_LABEL 19 17 _"Teehf River Fort"}
        {SET_LABEL 27 18 _"Lake Teehf"}

        {MESSAGE_RIGHT Vanak _"Little goblin smart. Help Vanak get big gold."}
        {MESSAGE_RIGHT Grnk _"Right ... Fighting with the orcs again. Great.
<i> </i>
Anyway, the soldiers at the outpost will be defending that chest with their lives. They might even try to throw it into the river when all is lost. We need to hit them hard and swiftly."}
        {MESSAGE_RIGHT Vanak _"Uh, little goblin say what?"}
        {MESSAGE_RIGHT Grnk {GASP_BEGINNING _"sigh"}+_"They there. We them get."}

        [objectives]
            side=1
            summary=_"<span color='#A050A0'>Carry out Koorzhaar's Double-Crossing Scheme</span>"
            [objective]
                description=_"Defeat all Teehf River Fort units"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Vanak"
                condition=lose
            [/objective]
            [objective]
                description=_"Grnk attacks one of Koorzhar's units"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
            [note]
                description=_"Throughout this scenario, Grnk gets 1 gold per turn per experience level, to be paid in full at the end of the scenario."
            [/note]
        [/objectives]

        [objectives]
            side=3
            summary=_"<span color='#A050A0'>Carry out Koorzhaar's Double-Crossing Scheme</span>"
            [objective]
                description=_"Prevent Borck's horde from getting to Teehf River Fort"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Koorzhar"
                condition=lose
            [/objective]
            [objective]
                description=_"Any of Koorzhar's or Borck's units moves into sight of Teehf River Fort
    (right-click on the map and choose 'View no-go area' to see which area needs to be avoided)"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
            [note]
                description=_"This scenario features changing objectives throughout a series of battles. Koorzhar needs to deploy his troops very carefully."
            [/note]
        [/objectives]
    [/event]

    # Gold for Grnk each turn
    [event]
        name=new turn
        first_time_only=no

        {STORE_UNIT_VAR id=Grnk level S7.turn_gold}
        {VARIABLE_OP S7.gold_for_Grnk add $S7.turn_gold}
        {CLEAR_VARIABLE S7.turn_gold}
    [/event]

    [event]
        name=side 2 turn 1

        {SCROLL_TO 19 17}
        {MESSAGE outpost_leader "" "" _"Alarm! Orcs approaching!"}

        {UNIT 2 Bowman 19 20 (
            id=outpost_messenger
            goto_x=15
            goto_y=29
            facing=sw
            [modifications]
                {TRAIT_QUICK}
            [/modifications]
        )}

        {STORE_UNIT_VAR id=outpost_messenger name S7.messenger_name}
        {MESSAGE outpost_leader "" "" _"$S7.messenger_name, hurry to Shmaltupp and tell them that we are under attack by orcs."}
        {MESSAGE outpost_messenger "" "" _"Yes, sir."}
        {MESSAGE outpost_leader "" "" _"Everybody else, we need to defend this chest with all we have. HQ orders are that under no circumstance may it fall into orcs' hands. Lieutenant Koorzhar is on his way with reinforcements, we need to hold out until he gets here."}
        {CLEAR_VARIABLE S7.messenger_name}

        # Set the path for the messenger
        [event]
            name=moveto

            [filter]
                id=outpost_messenger
                x,y=15,29
            [/filter]

            {MODIFY_UNIT id=outpost_messenger goto_x 34}
            {MODIFY_UNIT id=outpost_messenger goto_y 35}

            [event]
                name=moveto
                first_time_only=no

                [filter]
                    id=outpost_messenger
                    side=2
                [/filter]

                # If the messenger is within reach of Koorzhar, change to K's side
                # If not, make him go for Koorzhar (separate moveto event after this)
                [store_reachable_locations]
                    [filter]
                        id=outpost_messenger
                    [/filter]
                    [filter_location]
                        [filter_adjacent_location]
                            [filter]
                                id=Koorzhar
                            [/filter]
                        [/filter_adjacent_location]
                    [/filter_location]
                    moves=max

                    variable=S7.messenger_locs
                [/store_reachable_locations]

                {IF_VAR S7.messenger_locs.length not_equals 0 (
                    [then]
                        {MESSAGE_FACING outpost_messenger Koorzhar "" _"Help! Teehf River Fort is under attack by the orcs."}
                        {MESSAGE Koorzhar "" "" _"We are already on our way, soldier."}
                        {STORE_UNIT_VAR id=Koorzhar language_name S7.Koorzhar_type}
                        {MESSAGE outpost_messenger "" "" _"$S7.Koorzhar_type Koorzhar! Am I glad to see you. We must immediately send reinforcements to Teehf River Fort. Orcs are ..."}
                        {MESSAGE Koorzhar "" "" _"We must, must we? Are Bowmen now giving orders to $S7.Koorzhar_type|s?"}
                        {CLEAR_VARIABLE S7.Koorzhar_type}
                        {MESSAGE outpost_messenger "" "" _"I apologize, sir, but Lieutenant $S7.outpost_leader_name says ..."}
                        {MESSAGE Koorzhar "" "" _"Quiet, soldier! I am quite aware of the situation at the fort. In case you have not noticed, there is a huge horde of orcs approaching in the south. We cannot spare anyone until they have been beaten."}
                        {MESSAGE outpost_messenger "" "" _"But ..."}
                        {MESSAGE Koorzhar "" "" _"One more word and I'll have you on latrine duty for insubordination for the rest of the year. Now join my men and help us fight off these orcs. The quicker we are done here, the sooner we can help $S7.outpost_leader_name."}
                        {MESSAGE outpost_messenger "" "" _"Yes, sir."}

                        {MODIFY_UNIT id=outpost_messenger goto_x ""}
                        {MODIFY_UNIT id=outpost_messenger goto_y ""}
                        {MODIFY_UNIT id=outpost_messenger side 3}
                    [/then]
                )}

                {CLEAR_VARIABLE S7.messenger_locs}
            [/event]

            # Here's the event that will make the messenger go for Koorzhar
            # only while he is still on side 2, of course
            [event]
                name=moveto
                first_time_only=no
                [allow_undo]
                [/allow_undo]

                [filter]
                    id=Koorzhar
                [/filter]
                [filter_condition]
                    [have_unit]
                        id=outpost_messenger
                        side=2
                    [/have_unit]
                [/filter_condition]

                {STORE_UNIT_VAR id=Koorzhar x S7.Koorzhar_x}
                {STORE_UNIT_VAR id=Koorzhar y S7.Koorzhar_y}
                {MODIFY_UNIT id=outpost_messenger goto_x $S7.Koorzhar_x}
                {MODIFY_UNIT id=outpost_messenger goto_y $S7.Koorzhar_y}
                {CLEAR_VARIABLE S7.Koorzhar_x,S7.Koorzhar_y}
            [/event]
        [/event]
    [/event]

#define NOGO_AREA
    # The area that Koorzhar's troops need to avoid
    x=0-43,0-16,0-11,0-7, 9,0-7,0-5,0-3,0-3,0-1,21,23,26-27,29-30,31-43,33-43,35,37-39,39,41,43
    y=0-28,0-39,  40, 41,41, 42, 43, 44, 45, 46,29,29,   29,   29,29-30,   31,32,   32,33,   32,32
#enddef

    [event]
        name=side 3 turn 1

        {MESSAGE Koorzhar "" "" _"Alright, men. Let's hope that goblin kid is getting the job done. In the meantime, we need to stay out of sight of the fort and keep those southern orcs away from there too."}
        {MESSAGE Koorzhar "" "" _"And, men, be very careful out there. Based on the intelligence we have, these orcs are only the tip of the iceberg. We will likely be facing many more before we're headed back to Shmaltupp."}

        [set_menu_item]
            id=m01_menu_nogo
            description=_"View No-Go Area"
            image=misc/nogo.png
            [show_if]
                {VARIABLE_CONDITIONAL side_number equals 3}
            [/show_if]
            [command]
                # Gray out the area
                [time_area]
                    {NOGO_AREA}
                    id=dark_time
                    [time]
                        id=dark_time
                        name=_"Dark Time"
                        red,green,blue=-100,-100,-100
                    [/time]
                [/time_area]

                {NARRATOR_GRAY _"No-Go Area" _"No Side 3 or 4 unit may move into the darkened area before Grnk has returned to Koorzhar. [ You need to have 'Local time of day area lighting' turned on in the advanced preferences in order to see the area. ]
<i> </i>
The view will be restored the next time any unit starts moving."}

                # Remove area by clicking on unit
                [event]
                    name=exit_hex
                    [allow_undo]
                    [/allow_undo]

                    [time_area]
                        id=dark_time
                        remove=yes
                    [/time_area]
                    {REDRAW 1}
                [/event]
            [/command]
        [/set_menu_item]
    [/event]

    # After 6 turns: where is help? (if a side 2 unit is left)
    [event]
        name=side 2 turn 7

        {GET_RANDOM_UNIT_ID (
            side=2
            [not]
                id=outpost_leader
            [/not]
        )}
        {IF_VAR random_unit_id not_equals -1 (
            [then]
                {MESSAGE $random_unit_id "" "" _"Why is nobody coming to help us?"}
                {MESSAGE outpost_leader "" "" _"Patience. I can hear battle noises from beyond the hills south of Lake Teehf. No doubt Koorzhar is doing everything he can to get here as quickly as possible."}
            [/then]
        )}
        {CLEAR_VARIABLE random_unit_id}
    [/event]

    # When outpost leader is killed
    [event]
        name=last breath
        first_time_only=no

        [filter]
            id=outpost_leader
        [/filter]

        {MESSAGE outpost_leader "" "" _"No! The orcs must not get the chest!"}
        {CLEAR_VARIABLE S7.outpost_leader_name}
    [/event]

    # When last Side 2 unit is killed (which could be the leader)
    [event]
        name=die

        [filter]
            side=2
        [/filter]
        [filter_condition]
            [not]
                [have_unit]
                    side=2
                [/have_unit]
            [/not]
        [/filter_condition]

        # Need to get rid of the unit before somebody can go here
        [kill]
            id=$unit.id
        [/kill]
        # Also need to give the unit making the kill the experience
        # as it is stored away for later before this happens automatically
        # (unless it is Grnk, who stays out)
        {IF_VAR second_unit.id not_equals Grnk (
            [then]
                {GIVE_KILL_EXPERIENCE_BEFORE_STORE $second_unit.id $unit.level}
            [/then]
        )}

        # Deactivate Side 2
        [modify_side]
            side=2
            controller=null
            hidden=yes
        [/modify_side]

        {MESSAGE Vanak "" "" _"Vanak win! Vanak get big gold."}

        # If there's a unit on the keep, move it away
        [if]
            [have_unit]
                x,y=19,17
            [/have_unit]

            [then]
                {CLOSE_EMPTY_HEX 19 17 (W*) 1}
                {MOVE_UNIT (x,y=19,17) $hex_x $hex_y}
                {CLEAR_VARIABLE hex_x,hex_y}
            [/then]
        [/if]

        # Then move Vanak there
        {MOVE_UNIT id=Vanak 19 17}
        {SOUND "open-chest.wav"}
        {SOUND "gold.ogg"}
        {MESSAGE Vanak "" "" _"Vanak get big gold! Vanak ... What this? Thing under gold. This ... This ..."}
        {MESSAGE Grnk "" "" _"This is an outrage. An incredible betrayal by the southern orcs.
<i> </i>
"+{WHISPER _"Or by somebody else"}+"
<i> </i>
Hurry back and show this to your tribe leaders. I bet they'll take immediate action."}
        {MESSAGE Vanak "" "" _"Umm?"}
        {MESSAGE Grnk "" "" {GASP_BEGINNING _"sigh"}+_"Vanak go home. Vanak show orc leaders."}
        {MESSAGE Vanak "" "" _"Right. Vanak go now."}
        {MESSAGE Grnk "" "" _"No, wait, you must take all orcs with ..."}

        # Select one orc to come with Vanak
        {SELECT_BEST_UNIT (
            side=1
            [not]
                id=Grnk,Vanak
            [/not]
        )}
        {IF_VAR selected_unit_id equals -1 (
            [then]
                {MESSAGE Vanak "" "" _"Vanak go. Vanak brother Vadak chief now."}
            [/then]

            [else]
                {STORE_UNIT_VAR id=$selected_unit_id name S7.orc_name}
                {MESSAGE Vanak "" "" _"Vanak go. Vanak brother Vadak chief now. $S7.orc_name, come Vanak."}
            [/else]
        )}

        {UNIT 1 "Orcish Ruler" 11 15 (id,name,canrecruit,unrenamable=Vadak,Vadak,yes,yes)}
        {MOVE_UNIT id=Vanak 1 3}
        {FULL_HEAL_AND_CURE id=Vanak}
        [store_unit]
            [filter]
                id=Vanak
            [/filter]

            variable=S7.stored_Vanak
        [/store_unit]
        {MOVE_UNIT_OFF_MAP Vanak nw}

        {IF_VAR selected_unit_id not_equals -1 (
            [then]
                {MESSAGE $selected_unit_id "" "" _"$S7.orc_name come."}
                {MOVE_UNIT id=$selected_unit_id 1 3}
                [store_unit]
                    [filter]
                        id=$selected_unit_id
                    [/filter]

                    variable=S7.stored_Vanak_helper
                [/store_unit]
                {MOVE_UNIT_OFF_MAP $selected_unit_id nw}
            [/then]
        )}
        {CLEAR_VARIABLE selected_unit_id,S7.orc_name}

        {MOVE_UNIT id=Vadak 19 17}
        {MESSAGE Grnk "" "" _"Now where the hell did he come from?"}
        {MESSAGE Vadak "" "" _"Vadak hide mountain. Vadak watch fight. Good fight. Vadak like."}
        {MESSAGE Grnk "" "" _"You watched us fight and did not help?!"}
        {MESSAGE Vadak "" "" _"Little goblin right. Good fight."}
        {MESSAGE Grnk "" "" _"I see. Now, why not Vadak go with Vanak. Back home. All orcs."}
        {MESSAGE Vadak "" "" _"No. Vadak like here. All go in. Eat. Drink."}

        # Move all the units inside
        [store_unit]
            [filter]
                side=1
                [not]
                    id=Grnk,Vadak
                [/not]
            [/filter]

            variable=S7.Vadak_units
            mode=append
            kill=no
        [/store_unit]

        # Heal units, put them on recall list, and do a fake move to the keep
        {FOREACH S7.Vadak_units S7.i}
            {FULL_HEAL_AND_CURE id=$S7.Vadak_units[$S7.i].id}
            {PUT_TO_RECALL_LIST id=$S7.Vadak_units[$S7.i].id}
            [move_unit_fake]
                type=$S7.Vadak_units[$S7.i].type
                side=1
                x=$S7.Vadak_units[$S7.i].x,19
                y=$S7.Vadak_units[$S7.i].y,17
            [/move_unit_fake]
        {NEXT S7.i}
        {CLEAR_VARIABLE S7.Vadak_units}

        {MESSAGE Grnk "" "" {GASP_BEGINNING _"sigh"}+{WHISPER _"I guess we will have to take the fort back the hard way then."}+"
<i> </i>
Umm, Grnk go, scout mountains."}
        {MESSAGE Vadak "" "" _"Little goblin do. Vadak eat. Drink."}

        # Store Vadak, for use in a little while
        [store_unit]
            [filter]
                id=Vadak
            [/filter]

            variable=S7.stored_Vadak
            kill=yes
        [/store_unit]

        # The turn limit is changed
        [modify_turns]
            value="$($turn_number+4)"
        [/modify_turns]

        # And hide Side 1 until reactivation later; can't set controller=null though
        [modify_side]
            side=1
            hidden=yes
        [/modify_side]

        [objectives]
            side=1
            summary=_"<span color='#A050A0'>Carry out Koorzhaar's Double-Crossing Scheme</span>"
            [objective]
                description=_"Move Grnk within one turn's move of Koorzhar's troops"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Grnk attacks one of Koorzhar's units"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]

        # When Grnk moves within reach of one of Koorzhar's units (or vice versa)
        [event]
            name=moveto
            first_time_only=no
            [allow_undo]
            [/allow_undo]

            [filter]
                id=Grnk
                side=1   # Need this because this can also happen when Grnk is back with Vanak later
            [/filter]

            [store_reachable_locations]
                [filter]
                    id=Grnk
                [/filter]
                [filter_location]
                    [filter_adjacent_location]
                        [filter]
                            side=3
                        [/filter]
                    [/filter_adjacent_location]
                [/filter_location]
                moves=max

                variable=S7.Grnk_locs
            [/store_reachable_locations]

            [if]
                {VARIABLE_CONDITIONAL S7.Grnk_locs.length not_equals 0}
                {VARIABLE_CONDITIONAL S7.Grnk_with_Koorzhar not_equals yes}
                [then]
                    {VARIABLE S7.Grnk_with_Koorzhar yes}
                    [fire_event]
                        name=Grnk_backto_Koorzhar
                    [/fire_event]
                [/then]
            [/if]
            {CLEAR_VARIABLE S7.Grnk_locs}
        [/event]
    [/event]

    [event]
        name=Grnk_backto_Koorzhar

        {MESSAGE Grnk "" "" _"I completed my mission as ordered. Teehf River Fort has been taken by the orcs. Unfortunately, I was not able to get them to leave afterward."}
        {MESSAGE Koorzhar "" "" _"I didn't expect that they would. Let's take it back then."}

        {MODIFY_UNIT id=Grnk side 3}
        [modify_side]
            side=1
            controller=null
            hidden=yes
        [/modify_side]

        # Also delete the no-go area menu item
        [set_menu_item]
            id=m01_menu_nogo
            [show_if]
                [not]
                [/not]
            [/show_if]
        [/set_menu_item]

        # The turn limit is changed
        [modify_turns]
            value="$($turn_number+14)"
        [/modify_turns]

        [objectives]
            side=3
            summary=_"<span color='#A050A0'>Carry out Koorzhaar's Double-Crossing Scheme</span>"
            [objective]
                description=_"Take back Teehf River Fort"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Koorzhar"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
            [note]
                description=_"This scenario features changing objectives throughout a series of battles. Koorzhar needs to deploy his troops very carefully."
            [/note]
        [/objectives]

        [end_turn]
        [/end_turn]

        # Mobilize the fort orcs on turn after Grnk gets back to Koorzhar
        # if it has not happened already otherwise
        [event]
            name=new turn

            [fire_event]
                name=mobilize_fort_orcs
            [/fire_event]
        [/event]

        # Next turn, scouts return with warning
        # As the current event can happen on both side 1 and 3, put this inside a side 3 turn end event,
        # and make it happen on the next side 3 turn refresh after that
        [event]
            name=side 3 turn end

            [event]
                name=side 3 turn refresh

                {SCROLL_TO 16 35}
                {UNIT 3 (Shmaltupp Sergeant) 16 35 (
                    id=scout_leader
                    animate=yes
                    [modifications]
                        {TRAIT_QUICK}
                    [/modifications]
                )}
                {UNIT 3 Longbowman 16 36 (
                    animate=yes
                    [modifications]
                        {TRAIT_QUICK}
                    [/modifications]
                )}
                {UNIT 3 Spearman 17 36 (
                    animate=yes
                    [modifications]
                        {TRAIT_QUICK}
                    [/modifications]
                )}

                {STORE_UNIT_VAR id=Koorzhar language_name S7.Koorzhar_type}
                {MESSAGE_FACING scout_leader Koorzhar "" _"$S7.Koorzhar_type Koorzhar, we bring bad news. There is a huge orc army racing this way in the southwest. They will be here any moment."}
                {CLEAR_VARIABLE S7.Koorzhar_type}
                {MESSAGE Grnk "" "" _"Whoa! Where did they come from?"}
                {MESSAGE Koorzhar "" "" _"It may be hard for you to believe this, but our scouts are good at moving unseen through the mountains also."}
                {MESSAGE Koorzhar "" "" _"Thank you, Sergeant. Well done.
<i> </i>
Men, we need to take Teehf River Fort back as quickly as possible. We don't want to be caught between two fronts."}
            [/event]
        [/event]

        # The first battle between Side 1 & 3 after Grnk is back with Koorzhar triggers
        # the reinforcements 2 turns later
        [event]
            name=attack

            [filter]
                side=1,3
            [/filter]
            [filter_second]
                side=1,3
            [/filter_second]

            # Next turn: comment by Koorzhar
            # Turn after that: reinforcements come
            [event]
                name=side 3 turn

                {MESSAGE Grnk "" "" _"There are way too many of them. Why the hell did you leave them that much gold together with the 'evidence'?"}
                {MESSAGE Koorzhar "" "" _"Hey, kid, I didn't like that idea either. HQ thought it wouldn't look real otherwise. As usual, they have no idea how things work in the real world."}
                {MESSAGE Grnk "" "" _"Such as how orcs think. Or rather, don't think."}
                {MESSAGE Koorzhar "" "" _"Exactly. HQ also promised us reinforcements. They better get here soon."}

                [event]
                    name=side 3 turn end

                    #{DEBUG "1 more turn ..."}
                    [event]
                        name=side 3 turn end

                        {MOVE_UNIT_ONTO_MAP 5 (Shmaltupp Sergeant) 21 1 sw (id=tmp)}
                        [kill]
                            id=tmp
                        [/kill]
                        {NEW_LEADER_APPEARS 5 (Shmaltupp Sergeant) 21 1 reinforcement_leader (facing=sw)}

                        {STORE_UNIT_VAR id=Koorzhar language_name S7.Koorzhar_type}
                        {MESSAGE reinforcement_leader "" "" _"$S7.Koorzhar_type Koorzhar, HQ sends us to help you in the fight against the orcs."}
                        {CLEAR_VARIABLE S7.Koorzhar_type}
                        {MESSAGE Koorzhar "" "" _"It's about time!"}

                        {MOVE_UNIT id=reinforcement_leader 21 4}
                        [terrain]
                            x=20,21,22
                            y=4,5,4
                            terrain=Ce
                        [/terrain]
                        [terrain]
                            x,y=21,4
                            terrain=Ke
                        [/terrain]
                        {REDRAW 1}
                    [/event]
                [/event]
            [/event]
        [/event]
    [/event]

    # Defeat: if Grnk attacks one of Koorzhar's units
    # If any of the other Side 1 & 3 units attack each other, that's just stupid
    # and doesn't serve any real purpose, so we don't catch it here
    [event]
        name=attack end

        [filter]
            id=Grnk
        [/filter]
        [filter_second]
            side=3
        [/filter_second]

        {IF_VAR second_unit.id equals Koorzhar (
            [then]
                {MESSAGE Koorzhar "" "" _"Hey, kid, what do you think you're doing?"}
            [/then]

            [else]
                {MESSAGE $second_unit.id "" "" _"What the hell? I thought that goblin was supposed to be on our side!"}
            [/else]
        )}

        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    # If one of Borck's or Koorzhar's unit moves north of Knick Point
    # before Grnk is back with Koorzhar: defeat
    # after: mobilize fort orcs (if it has not happened yet)
    [event]
        name=moveto

        [filter]
            side=3,4
            {NOGO_AREA}
        [/filter]

        {STORE_UNIT_VAR id=Grnk side S7.Grnk_side}
        {IF_VAR S7.Grnk_side not_equals 3 (
            [then]
                {IF_VAR unit.side equals 3 (
                    [then]
                        {IF_VAR unit.id equals Koorzhar (
                            [then]
                                {MESSAGE Koorzhar "" "" _"Oops!"}
                            [/then]

                            [else]
                                {MESSAGE Koorzhar "" "" _"You were not supposed to move there!"}
                            [/else]
                        )}
                    [/then]

                    [else]
                        {MESSAGE Koorzhar "" "" _"Who let that orc slip past?!"}
                    [/else]
                )}

                [endlevel]
                    result=defeat
                [/endlevel]
            [/then]

            [else]
                [fire_event]
                    name=mobilize_fort_orcs
                [/fire_event]
            [/else]
        )}

        {CLEAR_VARIABLE S7.Grnk_side}
    [/event]

    # When only 5 Side 4 orcs are left and Vanak/Grnk have not defeated the outpost yet
    # Put a few more orcs out there (once)
    # This is to keep it interesting in case Koorzhar is faster than Grnk
    [event]
        name=die
        first_time_only=no

        [filter]
            side=4
        [/filter]
        [filter_condition]
            [not]
                [have_unit]
                    side=4
                    count=6-999
                [/have_unit]
            [/not]
            [have_unit]
                id=Vanak
            [/have_unit]
        [/filter_condition]

        # Number of new orcs to put out there: 4-6
        {SCROLL_TO 13 46}
        {DELAY 500}
        {RANDOM "4..6"}
        {VARIABLE S7.repeat $random}
        #{DEBUG "To repeat: $S7.repeat"}
        {REPEAT $S7.repeat (
            {RANDOM "Orcish Grunt,Wolf Rider,Orcish Archer,Orcish Assassin"}
            {CLOSE_EMPTY_HEX 13 46 () 0}
            {MOVE_UNIT_ONTO_MAP 4 $random 8 48 ne (id=new_orc_$REPEAT_i)}
            {MOVE_UNIT (x,y=8,48) $hex_x $hex_y}
            #{DEBUG "Repeat # $REPEAT_i $random"}
        )}

        {STORE_UNIT_VAR id=new_orc_1 name S7.new_orc_name}
        {MESSAGE new_orc_1 "" "" _"$S7.new_orc_name help brother."}

        # The following modification is a dirty trick so that in case this event happens
        # more than once, it's the new orc speaking, not one of the old
        {MODIFY_UNIT id=new_orc_1 id new_orc_10}

        {CLEAR_VARIABLE S7.repeat,random,S7.new_orc_name,hex_x,hex_y}
    [/event]

    # When at most 3 Side 4 orcs are left, they run
    # This could happen both before or after Grnk is back,
    # but the previous event only triggers while Vanak is around,
    # therefore we can only get to this one after Vanak is gone
    [event]
        name=die

        [filter]
            side=4
        [/filter]
        [filter_condition]
            [not]
                [have_unit]
                    side=4
                    count=4-999
                [/have_unit]
            [/not]
        [/filter_condition]

        # Kill off the unit first, so that it does not get moved later (as a fake)
        [kill]
            id=$unit.id
        [/kill]

        # If orc leader is left, he will speak, otherwise random unit
        [if]
            [have_unit]
                side=4
                canrecruit=yes
            [/have_unit]

            [then]
                {VARIABLE S7.speaker_id Borck}
            [/then]

            [else]
                {GET_RANDOM_UNIT_ID side=4}
                {VARIABLE S7.speaker_id $random_unit_id}
                {CLEAR_VARIABLE random_unit_id}
            [/else]
        [/if]
        {STORE_UNIT_VAR id=$S7.speaker_id name S7.orc_name}
        {MESSAGE $S7.speaker_id "" "" _"Human strong. $S7.orc_name go!"}
        {SOUND horn-signals/horn-1.ogg}

        {MOVE_UNIT_TO_EDGE_AND_OFF_MAP Borck 6 48 sw}
        [kill]
            side=4
        [/kill]

        [modify_side]
            side=4
            controller=null
            hidden=yes
        [/modify_side]

        # This will also mobilize the orcs in the fort again
        # If Grnk has already made it back to Koorzhar
        [if]
            [have_unit]
                side=3
                id=Grnk
            [/have_unit]

            [then]
                [fire_event]
                    name=mobilize_fort_orcs
                [/fire_event]
            [/then]
        [/if]
    [/event]

    # Mobilizing the fort orcs - there are several possible triggers
    # 1: Side 3 or 4 unit moves into sight of Fort after Grnk is with Koorzhar
    # 2: Borck's horde retreats and Grnk is back
    # 3: Turn after Grnk is back, if Borck is defeated
    # In all cases, Grnk is back -> objectives and turn limit are changed already
    [event]
        name=mobilize_fort_orcs

        [unstore_unit]
            variable=S7.stored_Vadak
        [/unstore_unit]
        {CLEAR_VARIABLE S7.stored_Vadak}
        [modify_side]
            side=1
            controller=ai
            hidden=no
        [/modify_side]
        {MESSAGE Vadak "" "" _"What this? Thing go on over there. Vadak smart, get ready."}

        # Give Vadak a fixed amount of gold (total, not additionally)
        {SET_GOLD 1 413}

        # Vadak swears at Grnk, if Grnk moves within 10 hexes
        [event]
            name=moveto

            [filter]
                id=Grnk
                side=3
                [filter_location]
                    [filter]
                        id=Vadak
                    [/filter]
                    radius=10
                [/filter_location]
            [/filter]

            {MESSAGE Vadak "" "" _"Little goblin traitor. Vadak angry!"}
            {MESSAGE Grnk "" "" _"I'm not happy about it either, believe me."}
        [/event]

        # Vadak swears at Grnk when he dies
        [event]
            name=last breath

            [filter]
                id=Vadak
            [/filter]

            {MESSAGE Vadak "" "" _"Little goblin all fault!"}
            {MESSAGE Koorzhar "" "" _"Don't listen to him. You know that's not true."}
            {MESSAGE Grnk "" "" {WHISPER _"Yes, it is."}}
        [/event]

        # The undead leader gets triggered when there are only 9 fort orcs left
        # This can happen at the earliest after 3 turns, so that it does not trigger
        # right at the beginning. This does mean that there is a problem if all fort
        # orcs are already killed by then, so that's why we need the additional code
        {TURNS_LATER (side 1 turn end) 3 S7.trigger_undead_turn (
            #{DEBUG "Undead can now be triggered: less than 10 fort orcs"}

            [if]
                [not]
                    [have_unit]
                        side=1
                    [/have_unit]
                [/not]

                [then]
                    [fire_event]
                        name=mobilize_Karcyn
                    [/fire_event]
                [/then]
            [/if]

            [event]
                name=die

                [filter]
                    side=1
                [/filter]
                [filter_condition]
                    [not]
                        [have_unit]
                            side=1
                            count=10-999
                        [/have_unit]
                    [/not]
                [/filter_condition]

                [fire_event]
                    name=mobilize_Karcyn
                [/fire_event]
            [/event]
        )}

        # Vanak comes back the turn after all fort orcs are killed
        [event]
            name=die

            [filter]
                side=1
            [/filter]
            [filter_condition]
                [not]
                    [have_unit]
                        side=1
                    [/have_unit]
                [/not]
            [/filter_condition]

            [event]
                name=new turn

                [fire_event]
                    name=bring_Vanak_back
                [/fire_event]
            [/event]
        [/event]
    [/event]

    # Reinforcement leader dies
    [event]
        name=die

        [filter]
            id=reinforcement_leader
        [/filter]

        {MESSAGE Koorzhar "" "" _"There goes a good soldier. Shall his death not be in vain."}
    [/event]

    # This brings the orcs led by Karcyn out
    [event]
        name=mobilize_Karcyn

        # Move close units out of the way (probably won't happen, but just in case)
        [store_unit]
            [filter]
                side=1,2,3,4,5,7,8
                [filter_location]
                    x,y=1,43
                    radius=6
                [/filter_location]
            [/filter]

            variable=S7.tmp_units
            mode=append
        [/store_unit]

        {FOREACH S7.tmp_units S7.i}
            {MOVE_UNIT id=$S7.tmp_units[$S7.i].id 8 37}
        {NEXT S7.i}
        {CLEAR_VARIABLE S7.tmp_units}

        {SCROLL_TO 1 43}
        {DELAY 500}

        {MOVE_UNIT_ONTO_MAP 6 (Dark Sorcerer) 1 43 se (id=tmp)}
        [kill]
            id=tmp
        [/kill]
        {NEW_LEADER_APPEARS 6 (Dark Sorcerer) 1 43 Karcyn (
            name=Karcyn
            gender=male
            unrenamable=yes
            facing=se
            [modifications]
                {TRAIT_QUICK}
            [/modifications]
        )}

        {MOVE_UNIT_ONTO_MAP 6 Revenant 1 42 ne ()}
        [kill]
            x,y=1,42
        [/kill]
        {UNIT 6 Revenant 1 42 (
            id=skeleton_guard1
            ai_special=guardian
            facing=ne
            [modifications]
                {TRAIT_QUICK}
            [/modifications]
        )}
        {MOVE_UNIT (x,y=1,42) 1 41}

        {MOVE_UNIT_ONTO_MAP 6 (Bone Shooter) 1 42 ne ()}
        [kill]
            x,y=1,42
        [/kill]
        {UNIT 6 (Bone Shooter) 1 42 (
            id=skeleton_guard2
            ai_special=guardian
            facing=ne
            [modifications]
                {TRAIT_QUICK}
            [/modifications]
        )}
        {MOVE_UNIT (x,y=1,42) 3 43}

        {MOVE_UNIT_ONTO_MAP 6 (Orcish Warrior) 1 42 ne (id=orc6_1)}
        {MOVE_UNIT_ALONG_PATH orc6_1 (2,3) (42,42) 4 42 se}
        {MOVE_UNIT_ONTO_MAP 6 (Orcish Crossbowman) 1 42 ne (id=orc6_2)}
        {MOVE_UNIT_ALONG_PATH orc6_2 2 42 4 41 ne}
        {MOVE_UNIT_ONTO_MAP 6 (Orcish Grunt) 1 42 ne (id=orc6_3)}
        {MOVE_UNIT_ALONG_PATH orc6_3 2 42 3 42 ne}
        {MOVE_UNIT_ONTO_MAP 6 (Orcish Grunt) 1 42 ne (id=orc6_4)}
        {MOVE_UNIT (x,y=1,42) 2 41}

        {MESSAGE_RIGHT Karcyn _"Orc minions, it's time to show those humans which way the wind is blowing. The era of the undead is about to begin."}
        {MESSAGE_RIGHT orc6_1 _"Uh, what you say?"}
        {MESSAGE_RIGHT Karcyn {GASP_BEGINNING _"sigh"}+_"They there. We them get."}
        {STORE_UNIT_VAR id=orc6_1 name S7.orc_name}
        #wmlindent: start ignoring
        {MESSAGE_RIGHT orc6_1 _"Right. We them get.
<i> </i>
"+{WHISPER _"And if sorcer no have skeleton guard, $S7.orc_name like get sorcer."}}
        #wmlindent: stop ignoring
        {CLEAR_VARIABLE S7.orc_name}

        [terrain]
            x=1,2,2,1
            y=42,42,43,44
            terrain=Ce
        [/terrain]
        [terrain]
            x,y=1,43
            terrain=Ke
        [/terrain]
        [redraw]
        [/redraw]

        {MESSAGE Grnk "" "" _"Another Dark Sorcerer! Why do they keep popping up everywhere all of a sudden?"}
        {MESSAGE Koorzhar "" "" _"I have no idea, but we better take the fort back quickly or we'll be in real trouble."}

        # This also changes the turn limit again
        [modify_turns]
            value="$($turn_number+22)"
        [/modify_turns]

        [objectives]
            side=3
            summary=_"<span color='#A050A0'>Carry out Koorzhaar's Double-Crossing Scheme</span>"
            [objective]
                description=_"Defeat all enemy units"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Koorzhar"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
            [note]
                description=_"This scenario features changing objectives throughout a series of battles. Koorzhar needs to deploy his troops very carefully."
            [/note]
        [/objectives]

        # The skeleton guards never move or attack in this scenario
        # Nor does Karcyn
        [event]
            name=side 6 turn refresh
            first_time_only=no

            {MODIFY_UNIT race=undead moves 0}
            {MODIFY_UNIT race=undead attacks_left 0}
            {MODIFY_UNIT id=Karcyn moves 0}
            {MODIFY_UNIT id=Karcyn attacks_left 0}
        [/event]

        # When at most 3 orcs are left on Karcyn's side, he leaves
        # This can happen at the earliest after 2 turns, so that it does not trigger
        # right at the beginning. This does mean that this will not trigger if all
        # orcs are already killed by then, but there's no way of this happening
        # Triggering attack on the skeletions/Karcyn is also put in here
        {TURNS_LATER (side 6 turn end) 2 S7.trigger_Karcyn_leaves_turn (
            #{DEBUG "Karcyn departure can now be triggered: less than 6 orcs"}

            [event]
                name=die

                [filter]
                    side=6
                [/filter]
                [filter_condition]
                    [not]
                        [have_unit]
                            side=6
                            [not]
                                race=human
                            [/not]
                            [not]
                                race=undead
                            [/not]
                            count=4-999
                        [/have_unit]
                    [/not]
                [/filter_condition]

                # Kill off the unit first, so that it does not get moved later (as a fake)
                [kill]
                    id=$unit.id
                [/kill]

                [fire_event]
                    name=Karcyn_leaves
                [/fire_event]
            [/event]

            # If Karcyn or one of his skeletons is attacked directly, he also leaves
            [event]
                name=attack

                [filter_second]
                    id=Karcyn
                    [or]
                        side=6
                        race=undead
                    [/or]
                [/filter_second]

                [fire_event]
                    name=Karcyn_leaves
                [/fire_event]
            [/event]
        )}
    [/event]

    # The actual event in which Karcyn leaves
    [event]
        name=Karcyn_leaves

        {MESSAGE_RIGHT Karcyn _"I told the Master not to rely on those damned orcs. We'll have to change our strategy."}

        # Take all of Karcyn's units off map (and put to recall list for next scenario)
        # Karcyn and the skeleton guards go off in fireballs
        {MOVE_UNIT_OFF_MAP_HIDE Karcyn nw}
        {FULL_HEAL_AND_CURE id=Karcyn}
        {PUT_TO_RECALL_LIST id=Karcyn}

        {MOVE_UNIT_OFF_MAP_HIDE skeleton_guard1 sw}
        {FULL_HEAL_AND_CURE id=skeleton_guard1}
        {PUT_TO_RECALL_LIST id=skeleton_guard1}

        {MOVE_UNIT (id=skeleton_guard2) 1 43}
        {MOVE_UNIT_OFF_MAP_HIDE skeleton_guard2 nw}
        {FULL_HEAL_AND_CURE id=skeleton_guard2}
        {PUT_TO_RECALL_LIST id=skeleton_guard2}

        # The other units are just taken off
        [store_unit]
            [filter]
                side=6
                x=1-99
            [/filter]

            variable=S7.Karcyn_units
        [/store_unit]

        {FOREACH S7.Karcyn_units S7.i}
            {FULL_HEAL_AND_CURE id=$S7.Karcyn_units[$S7.i].id}
            {PUT_TO_RECALL_LIST id=$S7.Karcyn_units[$S7.i].id}
        {NEXT S7.i}
        {CLEAR_VARIABLE S7.Karcyn_units}

        {MESSAGE Grnk "" "" _"What do you think he meant by that?"}
        {MESSAGE Koorzhar "" "" _"Beats me, but I sure don't like the sound of it."}

        [fire_event]
            name=S7_done
        [/fire_event]
    [/event]

    # This brings Vanak back
    [event]
        name=bring_Vanak_back

        # Clear his recall list, in case Vadak did not use everybody
        [kill]
            side=1
            [not]
                x=1-999
            [/not]
        [/kill]

        # Move close units out of the way (probably won't happen, but just in case)
        [store_unit]
            [filter]
                side=2,3,4,5,6,7,8
                [filter_location]
                    x,y=1,16
                    radius=3
                [/filter_location]
            [/filter]

            variable=S7.tmp_units
            mode=append
        [/store_unit]

        {FOREACH S7.tmp_units S7.i}
            {MOVE_UNIT id=$S7.tmp_units[$S7.i].id 4 18}
        {NEXT S7.i}
        {CLEAR_VARIABLE S7.tmp_units}

        {VARIABLE S7.stored_Vanak.facing se}
        {VARIABLE S7.stored_Vanak.moves $S7.stored_Vanak.max_moves}
        {VARIABLE S7.stored_Vanak.attacks_left 1}
        {MOVE_UNIT_ONTO_MAP 1 $S7.stored_Vanak.type 1 16 se ()}
        [unstore_unit]
            variable=S7.stored_Vanak
            x,y=1,16
        [/unstore_unit]
        {FULL_HEAL_AND_CURE id=Vanak}

        [if]
            [variable]
                name=S7.stored_Vanak_helper.length
                not_equals=0
            [/variable]

            [then]
                {VARIABLE S7.stored_Vanak_helper.facing se}
                {VARIABLE S7.stored_Vanak_helper.moves $S7.stored_Vanak_helper.max_moves}
                {VARIABLE S7.stored_Vanak_helper.attacks_left 1}
                {MOVE_UNIT_ONTO_MAP 1 $S7.stored_Vanak_helper.type 1 17 se ()}
                [unstore_unit]
                    variable=S7.stored_Vanak_helper
                    x,y=1,17
                [/unstore_unit]
                {FULL_HEAL_AND_CURE id=$S7.stored_Vanak_helper.id}
            [/then]
        [/if]

        {CLEAR_VARIABLE S7.stored_Vanak,S7.stored_Vanak_helper}

        {MESSAGE_RIGHT Vanak _"Vanak back. Kill sorcer, traitor orc."}
        {MESSAGE_RIGHT Koorzhar _"Hey, kid, it looks like our plan worked and his grudge is with the other orcs. He doesn't appear to have noticed you switching sides yet. We should take advantage of that."}
        {MESSAGE_RIGHT Grnk _"I <i>really</i> don't want to fight with the orcs again."}
        {MESSAGE_RIGHT Koorzhar _"Kid, you don't seem to understand how the military works. This was not a suggestion!"}
        #wmlindent: start ignoring
        {MESSAGE_RIGHT Grnk "Yes. Sir.
<i> </i>
If I may say one thing though, it would be wise to make sure Vanak survives this battle. This way he will continue to spread unrest among the orcs."}
        #wmlindent: stop ignoring
        {MESSAGE_RIGHT Koorzhar _"You're a devious little kid. I like that."}
        {MESSAGE_RIGHT Grnk {WHISPER _"I know you do. I don't."}}

        {MODIFY_UNIT id=Grnk side 1}
        {MOVE_UNIT id=Grnk 2 15}

        {MESSAGE_FACING_RIGHT Vanak Grnk "" _"Little goblin back. Help Vanak fight sorcer, traitor orc."}
        {MESSAGE_RIGHT Grnk _"Grnk help Vanak. Grnk suggest Vanak fight with humans. Sorcerer is enemy of Vanak and humans."}
        {MESSAGE_RIGHT Vanak _"Vanak fight with human? Vanak no like, but Vanak must kill sorcer, traitor orc."}
        {MESSAGE_RIGHT Grnk _"Grnk no like either, but Grnk no choice."}
        {MESSAGE_RIGHT Vanak _"Right. We them get."}
        {MESSAGE_RIGHT Grnk {GASP _"sigh"}}

        [modify_side]
            side=1
            controller=human
            team_name=Koorzhar
            user_team_name=_"Human Army"
        [/modify_side]

        # Give him the right gold
        {SET_GOLD 1 207}

        [terrain]
            x=2,2,1
            y=15,16,17
            terrain=Ce
        [/terrain]
        [terrain]
            x,y=1,16
            terrain=Ke
        [/terrain]
        [redraw]
        [/redraw]

        [objectives]
            side=1,3
            summary=_"<span color='#A050A0'>Carry out Koorzhaar's Double-Crossing Scheme</span>"
            [objective]
                description=_"Defeat Karcyn"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Vanak"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Koorzhar"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}
            [gold_carryover]
                bonus=no
                carryover_percentage=40
            [/gold_carryover]
        [/objectives]

        # When human soldier first moves next to a Side 1 orc
        [event]
            name=moveto

            [filter]
                side=3
                [not]
                    id=Koorzhar
                [/not]
                [filter_adjacent]
                    side=1
                    [not]
                        id=Grnk
                    [/not]
                [/filter_adjacent]
            [/filter]

            {MESSAGE $unit.id "" "" _"As if having a goblin in our ranks weren't bad enough, now we're fighting alongside the orcs!"}
            {MESSAGE Koorzhar "" "" _"Silence, soldier! One more word and you'll report for latrine duty as soon as we're back in Shmaltupp."}
        [/event]

        # When a Side 1 orc first moves next to a human soldier
        [event]
            name=moveto

            [filter]
                side=1
                [not]
                    id=Vanak,Grnk
                [/not]
                [filter_adjacent]
                    side=3
                [/filter_adjacent]
            [/filter]

            {MESSAGE $unit.id "" "" _"$unit.name no like fight with human. $unit.name kill human."}
            {MESSAGE Vanak "" "" _"$unit.name shut! Or Vanak kill $unit.name."}
        [/event]

        # Two turns after Vanak is back, bring out the saurians
        [event]
            name=side 3 turn end

            [event]
                name=side 3 turn end

                [modify_side]
                    side=7
                    controller=ai
                    hidden=no
                [/modify_side]

                [event]
                    name=side 7 turn

                    {NEW_LEADER_APPEARS 7 (Saurian Soothsayer) 39 11 saurian_leader (facing=sw)}

                    {SCROLL_TO 39 11}
                    {MESSAGE saurian_leader "" "" _"Look at zzat. Orczz and humanzss fighting. Alwaysz somezzing to be gained from zzat."}

                    # Move close units out of the way (probably won't happen, but just in case)
                    [store_unit]
                        [filter]
                            side=1,2,3,4,5,6,8
                            [filter_location]
                                x,y=35,10
                                radius=3
                            [/filter_location]
                        [/filter]

                        variable=S7.tmp_units
                        mode=append
                    [/store_unit]

                    {FOREACH S7.tmp_units S7.i}
                        {MOVE_UNIT id=$S7.tmp_units[$S7.i].id 32 12}
                    {NEXT S7.i}
                    {CLEAR_VARIABLE S7.tmp_units}

                    {MOVE_UNIT id=saurian_leader 35 10}

                    [terrain]
                        x=33,34,34
                        y=10,9,10
                        terrain=Ce
                    [/terrain]
                    [terrain]
                        x,y=35,10
                        terrain=Ke
                    [/terrain]
                    [redraw]
                    [/redraw]

                    {MESSAGE Grnk "" "" _"What the hell is going on here? How about we get some trolls out here too?"}
                    {MESSAGE Koorzhar "" "" _"Be careful what you wish for! These saurians on the other hand shouldn't be too hard to deal with. They pop out of the swamps all the time and they always behave the same. Once we kill enough of them, the rest will retreat. No need to go after them and into the swamps."}
                    {MESSAGE Grnk "" "" _"Just like Borck?"}
                    {MESSAGE Koorzhar "" "" _"Hmm, yes, good point. Just like Borck. And, in fact, I'd expect that Sorcerer down there to do the same thing. Look at him standing there smugly with his skeleton guards, watching the fight without getting his hands dirty. I bet he won't even let us get close to him."}

                    # When at most 5 saurians are left, they run also
                    # This can happen at the earliest after 3 turns, so that it does not trigger
                    # right at the beginning.
                    {TURNS_LATER (side 7 turn end) 3 S7.trigger_saurians_leave_turn (
                        #{DEBUG "Saurian departure can now be triggered: less than 6 saurians"}

                        [event]
                            name=die

                            [filter]
                                side=7
                            [/filter]
                            [filter_condition]
                                [not]
                                    [have_unit]
                                        side=7
                                        count=6-999
                                    [/have_unit]
                                [/not]
                            [/filter_condition]

                            # Kill off the unit first, so that it does not get moved later (as a fake)
                            [kill]
                                id=$unit.id
                            [/kill]

                            [fire_event]
                                name=saurians_leave
                            [/fire_event]
                        [/event]
                    )}
                [/event]
            [/event]
        [/event]
    [/event]

    [event]
        name=saurians_leave

        [if]
            [have_unit]
                id=saurian_leader
            [/have_unit]

            [then]
                {MESSAGE saurian_leader "" "" _"Maybe zzizz wazz not ssuch a good idea."}
                {VARIABLE random_unit_id saurian_leader}
            [/then]

            [else]
                {GET_RANDOM_UNIT_ID side=7}
                {MESSAGE $random_unit_id "" "" _"Maybe zzizz wazz not ssuch a good idea."}
            [/else]
        [/if]

        {MOVE_UNIT_TO_EDGE_AND_OFF_MAP $random_unit_id 42 11 se}
        [kill]
            side=7
        [/kill]

        {CLEAR_VARIABLE random_unit_id}

        [modify_side]
            side=7
            controller=null
            hidden=yes
        [/modify_side]
    [/event]

    [event]
        name=S7_done

        {MESSAGE Vanak "" "" _"Vanak glad sorcer gone, but Vanak no like fight with humans. Vanak go."}
        {MESSAGE Grnk "" "" _"No, wait. We can still work toge..."}

        # Move all of Vanak's orcs off map (and hide)
        [store_unit]
            [filter]
                id=Vanak
            [/filter]

            variable=tmp_Vanak
        [/store_unit]

        {MOVE_UNIT id=Vanak 1 $tmp_Vanak.y}
        {MOVE_UNIT_OFF_MAP_HIDE Vanak nw}

        {CLEAR_VARIABLE tmp_Vanak}

        [hide_unit]
            side=1
            [not]
                id=Grnk
            [/not]
        [/hide_unit]

        [modify_side]
            side=1
            hidden=yes
        [/modify_side]

        {MESSAGE Koorzhar "" "" _"Well done, everybody. Especially you, kid."}
        {MESSAGE Grnk "" "" _"Yeah, right. Use the goblin to betray everybody, since he's such an expert at it."}
        {MESSAGE Koorzhar "" "" _"Beat yourself up over it, if you want, sometimes we all have to do things we don't like."}
        {MESSAGE Grnk "" "" _"Right. Sometimes ..."}
        {MESSAGE Koorzhar "" "" _"Either way, you did well. Here's your pay: $S7.gold_for_Grnk gold."}
        {VARIABLE_OP Grnks_gold add $S7.gold_for_Grnk}
        {SET_MENU_INVENTORY}

        {MOVE_GRNK_TO_DUMMY_SIDE 8}

        # House cleaning
        {CLEAR_VARIABLE S7}

        [endlevel]
            result=victory
            bonus=no
            carryover_add=yes
            carryover_percentage=40
        [/endlevel]
    [/event]

    # Defeat if running out of time:
    [event]
        name=time over

        {NARRATOR_GRAY "" _"You have run out of time."}
    [/event]

    ######################
    # Finally, the standard events for all or most scenarios
    {STORY_IMAGE id=Grnk}
    {HEALING_POTION_MESSAGE}
    {KOORZHAR_MAKES_GENERAL}
    {GRNK_DEATH}
    {KOORZHAR_DEATH}
    {VANAK_DEATH}
[/scenario]
