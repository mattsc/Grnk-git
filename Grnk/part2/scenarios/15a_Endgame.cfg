#textdomain wesnoth-Grnk

[scenario]
    id=15a_Endgame
    name=_"Endgame"
    next_scenario=15s_Epilogue

    map_data="{~add-ons/Grnk/part2/maps/14d_Submission.map}"

    {DEFAULT_SCHEDULE_FIRST_WATCH}
    turns=-1

    {GRNK2_STORY_15}

    #wmllint: recognize Langzight
    #wmllint: recognize Grnd
    #wmllint: recognize Grnk
    #wmllint: recognize Vanak
    #wmllint: recognize Mal An
    #wmllint: recognize Grossauba
    #wmllint: recognize Master

    [side]
        side=1
        controller=human
        no_leader=yes

        persistent=yes
        save_id="Grnk and Vanak"

        team_name=Grnk
        user_team_name=_"Grnk"

        recruit=Orcish Grunt,Orcish Archer,Orcish Assassin,Wolf Rider,Goblin Spearman

        gold=0
    [/side]

    [side]
        side=2
        controller=ai
        no_leader=yes

        team_name=master
        user_team_name=_"The Master's Minions"

        recruit=Ghoul,Skeleton,Skeleton Archer,Bone Shooter,Deathblade,Revenant,Draug,Banebow,Ghost,Wraith,Shadow

        {GOLD 750 1000 1250}

        [ai]
            aggression=1
            caution=-10
            grouping=no
            village_value=0

            # Recruit up to two L3s per turn
            [aspect]
                id=recruitment_instructions
                [facet]
                    [value]
                        [recruit]
                            type=1,2,3
                            number=2
                            importance=1
                        [/recruit]
                        [recruit]
                            type=1,2
                            importance=0
                        [/recruit]
                    [/value]
                [/facet]
            [/aspect]
        [/ai]
    [/side]

    [side]
        side=3
        controller=ai
        no_leader=yes

        team_name=master
        user_team_name=_"The Master's Minions"

        recruit=Skeleton,Skeleton Archer,Bone Shooter,Deathblade,Revenant

        {GOLD 200 -300 400}

        [ai]
            aggression=1
            caution=-10
            grouping=no
            village_value=0

            # Recruit up to two L2s per turn
            [aspect]
                id=recruitment_instructions
                [facet]
                    [value]
                        [recruit]
                            type=1,2
                            number=2
                            importance=1
                        [/recruit]
                        [recruit]
                            type=1
                            importance=0
                        [/recruit]
                    [/value]
                [/facet]
            [/aspect]
        [/ai]
    [/side]

    [side]
        side=4
        controller=ai
        no_leader=yes

        team_name=master
        user_team_name=_"The Master's Minions"

        recruit=Ghost,Wraith,Shadow


        {GOLD 200 -300 400}
        [ai]
            aggression=1
            caution=-10
            grouping=no
            village_value=0

            # Recruit up to two L2s per turn
            [aspect]
                id=recruitment_instructions
                [facet]
                    [value]
                        [recruit]
                            type=1,2
                            number=2
                            importance=1
                        [/recruit]
                        [recruit]
                            type=1
                            importance=0
                        [/recruit]
                    [/value]
                [/facet]
            [/aspect]
        [/ai]
    [/side]

    [side]
        side=5
        controller=ai
        no_leader=yes

        team_name=master
        user_team_name=_"More Swamp Squatters"
        recruit=Saurian Skirmisher,Saurian Augur,Saurian Ambusher,Saurian Oracle

        {GOLD 100 150 200}
        {INCOME 20 30 40}

        [ai]
            aggression=1
            caution=-10
            grouping=no
            village_value=0

            # Recruit one L2 unit per turn
            [aspect]
                id=recruitment_instructions
                [facet]
                    [value]
                        [recruit]
                            type=1,2
                            number=1
                            importance=1
                        [/recruit]
                        [recruit]
                            type=1
                            importance=0
                        [/recruit]
                    [/value]
                [/facet]
            [/aspect]

            # Strongly target Quank
            [goal]
                [criteria]
                    id=Quank
                [/criteria]

                value=100
            [/goal]
        [/ai]
    [/side]

    [side]
        side=6
        controller=null
        no_leader=yes
        hidden=yes

        save_id="the Hynderwlt Mages"
        persistent=yes
        team_name=Grnk
        user_team_name=_"Grnk"

        {GOLD 500 400 300}
    [/side]

    [side] # Bats
        side=7
        controller=ai
        no_leader=yes
        hidden=yes

        team_name=bats
    [/side]

    [side]
        side=8
        controller=null
        no_leader=yes
        hidden=yes

        persistent=yes
        save_id="Langzight"

        team_name=Grnk
        user_team_name=_"Grnk"

        {GOLD 400 300 200}
    [/side]

    {CAMPFIRE 27 23}

    [event]
        name=prestart

        [gold]
            side=1
            amount=$S15_gold
        [/gold]
        {CLEAR_VARIABLE S15_gold}

        {SETUP_MAP_S15 0 32 21 se}

        {CLEAR_VARIABLE stored_Grnk_S14,stored_Vanak_S14,stored_Quank_S14,stored_peasant_leader_S14,stored_other_units_S14}

        [recall]
            id=Grashnak
            x,y=31,20
        [/recall]
        [recall]
            id=Gort
            x,y=29,20
        [/recall]

        [modify_unit]
            [filter]
                side=1
            [/filter]

            goto_x=""
            goto_y=""
        [/modify_unit]

        # Also put the saurian leader back out, or a different one in case he was killed
        [if]
            [variable]
                name=stored_saurian_leader_S14.length
                not_equals=0
            [/variable]

            [then]
                {VARIABLE stored_saurian_leader_S14.side 5}
                [unstore_unit]
                    variable=stored_saurian_leader_S14
                    x,y=49,38
                [/unstore_unit]

                {FULL_HEAL_AND_CURE (id=saurian_leader)}
            [/then]

            [else]
                {UNIT 5 (Saurian Oracle) 49 38 (id,canrecruit=saurian_leader,yes)}
            [/else]
        [/if]

        {FOREACH stored_saurian_villages_S14 i_v}
            [capture_village]
                side=5
                x,y=$stored_saurian_villages_S14[$i_v].x,$stored_saurian_villages_S14[$i_v].y
            [/capture_village]
        {NEXT i_v}
        {CLEAR_VARIABLE stored_saurian_leader_S14,stored_saurian_villages_S14}

        # Disable the keep in the south, so that Quank/Vanak cannot use it
        [terrain]
            x,y=40,50
            terrain=Ce
        [/terrain]

        {SET_LABEL 44 50 _"Move Quank here"}
        {PLACE_IMAGE (scenery/signpost.png) 44 50}

        {PRUNES_SETUP 1 Grnk 7 2 "*^X*,Wo,Q*"}

        # Side 2 units should preferentially attack Grnk
        [micro_ai]
            side=2
            ai_type=simple_attack
            action=add

            [filter]
                [not]
                    race=goblin
                [/not]
            [/filter]
            [filter_second]
                id=Grnk
            [/filter_second]
        [/micro_ai]

        # Zone guardian micro AIs for the chocobones of sides 3 and 4
        [micro_ai]
            side=3
            ai_type=zone_guardian
            action=add

            ca_score=170000

            [filter]
                type=Chocobone
            [/filter]
            [filter_location]
                x,y=6-18,7-14
                terrain=G*,R*,*^V*,H*,Wwf
            [/filter_location]
            [filter_location_enemy]
                x,y=1-21,1-16
            [/filter_location_enemy]
        [/micro_ai]

        [micro_ai]
            side=4
            ai_type=zone_guardian
            action=add

            ca_score=170000

            [filter]
                type=Chocobone
            [/filter]
            [filter_location]
                x,y=6-18,23-37
                terrain=G*,R*,*^V*,H*,Wwf
            [/filter_location]
            [filter_location_enemy]
                x,y=6-23,23-99
            [/filter_location_enemy]
        [/micro_ai]

        [objectives]
            summary=_"<span color='#A050A0'>Thwart The Master's Grand Plan Yet Again</span>"
            [objective]
                description=_"Defeat Grnd"
                condition=win
            [/objective]
            [objective]
                [show_if]
                    [have_unit]
                        id=Quank
                    [/have_unit]
                    [not]
                        [have_unit]
                            id=Langzight
                        [/have_unit]
                    [/not]
                [/show_if]
                caption=_"Also useful, but not necessary for victory:"
                description=_"Move Quank to the signpost in the south to get reinforcements"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Vanak"
                condition=lose
            [/objective]
            [objective]
                [show_if]
                    [have_unit]
                        id=Quank
                    [/have_unit]
                [/show_if]
                description=_"Death of Quank"
                condition=lose
            [/objective]
            [objective]
                [show_if]
                    [have_unit]
                        id=Langzight
                    [/have_unit]
                [/show_if]
                description=_"Death of Langzight"
                condition=lose
            [/objective]
            [note]
                description=_"Peasants can still round up their brothers by capturing unowned villages."
            [/note]
            [note]
                description=_"Any goblin who ends up next to Grnk permanently converts to Grnk's side."
            [/note]
            [note]
                description=_"The bridges built by the orcs will be swept away at the end of turn 5."
            [/note]
            [note]
                description=_"Grnk and Vanak will refuse to go south across the bridges, no matter how hard you try."
            [/note]
            {IS_LAST_SCENARIO}
        [/objectives]
    [/event]

    [event]
        name=start

        {MESSAGE_FACING Vanak Grnk "" _"Where wizard go?"}
        {MESSAGE Grnk "" "" _"He said that he was off to get reinforcements."}
        {MESSAGE_FACING Quank Grnk "" _"And you believe that? What if he is the Master after all and is rounding up more undead?"}
        {MESSAGE Grnk "" "" _"Honestly, I don't know what to believe any more. But if he is the Master, there isn't really much we can do anyway. So we might as well go by the assumumption that ..."}

        {GRND_S15 2 53 8}

        {MESSAGE_FACING Grnk Grnd "" _"Grnd, you little impostor! I'm going to get you!"}
        {MESSAGE Grnd "" "" _"Hahahahaha! I want to see you try. Look whom I brought to fight you."}

        # Put the goblins out there individually, rather than using REPEAT,
        # because I want to make sure the hexes where the undead coming through
        # the portals remain open
        {GENERIC_UNIT 2 (Goblin Spearman) 50 8}
        {GENERIC_UNIT 2 (Goblin Spearman) 50 9}
        {GENERIC_UNIT 2 (Goblin Rouser) 50 10}
        {GENERIC_UNIT 2 (Goblin Impaler) 51 8}
        {GENERIC_UNIT 2 (Goblin Spearman) 51 9}
        {GENERIC_UNIT 2 (Goblin Rouser) 51 10}
        {GENERIC_UNIT 2 (Goblin Spearman) 51 11}
        {GENERIC_UNIT 2 (Goblin Spearman) 52 8}
        {GENERIC_UNIT 2 (Goblin Impaler) 52 9}
        {GENERIC_UNIT 2 (Goblin Impaler) 52 10}
        {GENERIC_UNIT 2 (Goblin Spearman) 53 9}
        {GENERIC_UNIT 2 (Goblin Spearman) 53 10}

        {MESSAGE Grnk "" "" _"Don't do that! Those are our brothers."}
        {MESSAGE Grnd "" "" _"Hah! Speak for yourself. I have no brothers!"}
        {MESSAGE Grnk "" "" _"You're a monster! I will convince them to join me. One by one, if I have to."}
        {MESSAGE Grnd "" "" _"You do that, I don't care. You wouldn't think that I rely on these idiots anyway, would you? I just brought them because I knew that it would piss you off. Instead, here's who's really going to kill you."}

        {WHITE_MISSILE_HEX 49 9 ()}
        {GENERIC_UNIT 2 Chocobone 49 9}
        {WHITE_MISSILE_HEX 53 11 ()}
        {GENERIC_UNIT 2 Chocobone 53 11}
        {WHITE_MISSILE_HEX 48 9 ()}
        {GENERIC_UNIT 2 Deathblade 48 9}
        {WHITE_MISSILE_HEX 53 12 ()}
        {GENERIC_UNIT 2 (Bone Shooter) 53 12}
        {WHITE_MISSILE_HEX 49 10 ()}
        {GENERIC_UNIT 2 Banebow 49 10}
        {WHITE_MISSILE_HEX 52 11 ()}
        {GENERIC_UNIT 2 Draug 52 11}

        {SOUND magic-dark-big.ogg}
        {DELAY 100}
        {OPEN_PORTAL (52,53,54) (8,7,8)}

        {PORTAL_FALL 52 8}
        {MESSAGE Grnd "" "" _"Hahahahaha! Stupid goblin!"}

        {UNDEAD_THRU_PORTAL 53 7 2 sw 54 7}
        {UNDEAD_THRU_PORTAL 54 8 2 sw 53 9}
        {UNDEAD_THRU_PORTAL 52 8 2 sw 52 7}

        {MESSAGE Grnd "" "" _"And you won't be able to shut down the portals this time, the Master showed me how to prevent that. Oh, and just in case you're thinking of running, have a look behind you."}

        {FIREBALL_IN 3 8 8 "units/undead-skeletal/deathknight.png" se "~GS()"}

        [unit]
            side=3
            type=Death Knight
            id=undead_leader3
            canrecruit=yes

            x,y=8,8
            facing=se
        [/unit]

        {REPEAT 10 (
            [set_variable]
                name=rand_x
                rand=6-18
            [/set_variable]
            [set_variable]
                name=rand_y
                rand=9-13
            [/set_variable]
            {CLOSE_EMPTY_HEX $rand_x $rand_y (M*,*^X*,C*,K*,W*,S*,D*) 0}
            {SOUND thunderstick.ogg}
            {GENERIC_UNIT 3 Chocobone $hex_x $hex_y}
        )}

        {FIREBALL_IN 4 8 35 "units/undead-skeletal/deathknight.png" se "~GS()"}

        [unit]
            side=4
            type=Death Knight
            id=undead_leader4
            canrecruit=yes

            x,y=8,35
            facing=ne
        [/unit]

        {REPEAT 10 (
            [set_variable]
                name=rand_x
                rand=7-17
            [/set_variable]
            [set_variable]
                name=rand_y
                rand=23-36
            [/set_variable]
            {CLOSE_EMPTY_HEX $rand_x $rand_y (M*,*^X*,C*,K*,W*,S*,D*) 0}
            {SOUND thunderstick.ogg}
            {GENERIC_UNIT 4 Chocobone $hex_x $hex_y}
        )}

        {CLEAR_VARIABLE rand_x,rand_y,hex_x,hex_y}

        {MESSAGE Grnk "" "" _"Rats!"}
        {MESSAGE Grnd "" "" _"Oh, don't worry, those chocos will stay where they are. More or less, they're a twitchy bunch. I just want to make sure that you'll be coming this way. Hahahahaha!"}
        {MESSAGE_FACING Quank Grnk "" _"Looks like odds are stacked against us just a bit. Let's hope that Grossauba will indeed be back, and soon. But either way, I think we should not rely on that and be proactive instead."}
        {MESSAGE Grnk "" "" _"What are you suggesting?"}
        {MESSAGE Quank "" "" _"My negotiations with Lieutenant Langzight back at Lake Teefh were very successful, but Shmaltupp HQ still was not quite ready to send him to our aid. That can probably be changed now, given this new situation here. Send me back to Lake Teefh and I'll come back with the lieutenant, if at all possible."}
        {MESSAGE Grnk "" "" _"That would be most welcome help, but I'd have to send some troops with you to get past them saurians that I then won't have to hold off the undead."}
        {MESSAGE Quank "" "" _"Well, your choice, but you better make up your mind quickly. I'm quite certain that those makeshift bridges the orcs built won't last much longer. If you want us to go, you need to send us off right away."+{NOTE _"The bridges built by the orcs will be swept away at the end of turn 5. After that, nobody else will be able to reach whomever you decide to send south."}}

        {NARRATOR_GRAY _"Goblin Recalling and Recruiting" _"Recalling and recruiting goblins works the same as in the previous two scenarios. You can only recruit one level-1 goblin per turn, but recalling goblins costs only 13 gold. However, it is not possible in Wesnoth 1.12 to set the recall cost to 13 gold for one race (goblins) and to 20 gold for another (orcs). Recalling goblins is therefore handled by first charging 20 gold and then refunding 7. This does mean that you cannot recall a goblin unless there is at least 20 gold left."}
    [/event]

    # Grnd doesn't move until Master appears; Master never moves
    [event]
        name=side 2 turn refresh
        first_time_only=no

        [if]
            [not]
                [have_unit]
                    id=Master
                [/have_unit]
            [/not]

            [then]
                [modify_unit]
                    [filter]
                        id=Grnd
                    [/filter]

                    moves=0
                [/modify_unit]
            [/then]
        [/if]

        [modify_unit]
            [filter]
                id=Master
            [/filter]

            moves=0
        [/modify_unit]
    [/event]

    # One L1 goblin recruit per turn
    [event]
        name=side 1 turn
        first_time_only=no

        [allow_recruit]
            side=1
            type=Goblin Rouser,Goblin Impaler
        [/allow_recruit]
    [/event]

    [event]
        name=recruit
        first_time_only=no

        [filter]
            side=1
            type=Goblin Rouser,Goblin Impaler
        [/filter]

        [disallow_recruit]
            side=1
            type=Goblin Rouser,Goblin Impaler
        [/disallow_recruit]
    [/event]

    [event]
        name=recall
        first_time_only=no

        [filter]
            side=1
            race=goblin
        [/filter]

        [gold]
            side=1
            amount=7
        [/gold]
    [/event]

    {SET_PORTAL_ANIM 52 8}
    {SET_PORTAL_ANIM 53 7}
    {SET_PORTAL_ANIM 54 8}

    # Undead appear at the portals
    [event]
        name=side 2 turn end
        first_time_only=no

        # Only happens before the Grossauba appears
        [if]
            [not]
                [have_unit]
                    id=Grossauba
                [/have_unit]
            [/not]

            [then]
                {UNDEAD_THRU_PORTAL 52 8 2 sw 51 9}
                {UNDEAD_THRU_PORTAL 53 7 2 sw 52 7}
                {UNDEAD_THRU_PORTAL 54 8 2 sw 53 9}
            [/then]
        [/if]
    [/event]

    # Convert Grnd's goblins to Grnk's side, and give them surefire
    [event]
        name=convert_goblin_message

        {MESSAGE Grnk "" "" _"Join me. Grnd is just using you and considers you expendable. You might still die if you're with me, but at least you will get a fighting chance."}
        {MESSAGE $unit.id "" "" _"$unit.name no like little goblin. $unit.name like little goblin. $unit.name join little goblin."}
        {MESSAGE Grnk "" "" _"Right. It almost scares me that that made sense to me."}
    [/event]

    [event]
        name=convert_goblin
        first_time_only=no

        [fire_event]
            name=convert_goblin_message
            [primary_unit]
                id=$unit.id
            [/primary_unit]
        [/fire_event]

        [modify_unit]
            [filter]
                id=$unit.id
            [/filter]

            side=1
            attacks_left=1
            moves=$unit.max_moves
        [/modify_unit]
        {SUREFIRE (id=$unit.id)}
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            side=2
            race=goblin
            [not]
                id=Grnd
            [/not]
            [filter_adjacent]
                id=Grnk
            [/filter_adjacent]
        [/filter]

        [fire_event]
            name=convert_goblin
            [primary_unit]
                id=$unit.id
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            id=Grnk
            [filter_adjacent]
                side=2
                race=goblin
                [not]
                    id=Grnd
                [/not]
            [/filter_adjacent]
        [/filter]

        [store_unit]
            [filter]
                side=2
                race=goblin
                [not]
                    id=Grnd
                [/not]
                [filter_adjacent]
                    id=Grnk
                [/filter_adjacent]
            [/filter]

            variable=tmp_goblins
        [/store_unit]

        {FOREACH tmp_goblins i_g}
            [fire_event]
                name=convert_goblin
                [primary_unit]
                    id=$tmp_goblins[$i_g].id
                [/primary_unit]
            [/fire_event]
        {NEXT i_g}

        {CLEAR_VARIABLE tmp_goblins}
    [/event]

    # The bridges the orcs built in S14 disappear after a while
    [event]
        name=turn 5 end,remove_bridges

        [scroll_to]
            x,y=32,34
        [/scroll_to]

        {MESSAGE_NOSCROLL Quank _"There go the bridges."}

        [terrain]
            x,y=25-99,27-99
            [and]
                terrain=Wo^B*
            [/and]

            terrain=Wo
        [/terrain]

        [redraw]
        [/redraw]

        {MESSAGE_NOSCROLL Quank _"Too bad, they were a brilliant feat of orcish engineering."}

        [objectives]
            summary=_"<span color='#A050A0'>Thwart The Master's Grand Plan Yet Again</span>"
            [objective]
                description=_"Defeat Grnd"
                condition=win
            [/objective]
            [objective]
                [show_if]
                    [have_unit]
                        id=Quank
                    [/have_unit]
                    [not]
                        [have_unit]
                            id=Langzight
                        [/have_unit]
                    [/not]
                [/show_if]
                caption=_"Also useful, but not necessary for victory:"
                description=_"Move Quank to the signpost in the south to get reinforcements"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Vanak"
                condition=lose
            [/objective]
            [objective]
                [show_if]
                    [have_unit]
                        id=Quank
                    [/have_unit]
                [/show_if]
                description=_"Death of Quank"
                condition=lose
            [/objective]
            [objective]
                [show_if]
                    [have_unit]
                        id=Langzight
                    [/have_unit]
                [/show_if]
                description=_"Death of Langzight"
                condition=lose
            [/objective]
            [note]
                description=_"Peasants can still round up their brothers by capturing unowned villages."
            [/note]
            [note]
                description=_"Any goblin who ends up next to Grnk permanently converts to Grnk's side."
            [/note]
            {IS_LAST_SCENARIO}
        [/objectives]
    [/event]

    # Grnk and Vanak will not go south across the bridges
    [event]
        name=enter_hex
        first_time_only=no

        [filter]
            id=Grnk,Vanak

            [filter_location]
                x,y=25-99,27-99
                terrain=Wo^B*
            [/filter_location]
        [/filter]

        [if]
            [variable]
                name=unit.id
                equals=Grnk
            [/variable]

            [then]
                {MESSAGE Grnk "" "" _"No, I will not run away from the fight!"}
            [/then]

            [else]
                {MESSAGE Vanak "" "" _"Vanak no leave little goblin."}
            [/else]
        [/if]

        {MOVE_UNIT (id=$unit.id) $unit.x "$($unit.y-1)"}
    [/event]

    # When Quank gets to the signpost, he leaves and will reappear later with support
    [event]
        name=moveto

        [filter]
            id=Quank
            x,y=44,50
        [/filter]

        [store_unit]
            [filter]
                id=Quank
            [/filter]

            variable=S.stored_Quank
        [/store_unit]

        {MESSAGE Quank "" "" _"We'll be back as soon as we can. With support, if possible. Wish us luck."}
        {MOVE_UNIT_OFF_MAP Quank se}

        # Quank also takes all units that have made it across the bridges with him
        [store_unit]
            [filter]
                side=1
                y=33-99
            [/filter]

            variable=tmp_units
        [/store_unit]

        {FOREACH tmp_units i_u}
            [find_path]
                [traveler]
                    id=$tmp_units[$i_u].id
                [/traveler]

                [destination]
                    x,y=44,50
                [/destination]

                variable=tmp_path
                allow_multiple_turns=yes
                check_zoc=no
            [/find_path]

            [if]
                [variable]
                    name=tmp_path.hexes
                    not_equals=0
                [/variable]

                [then]
                    [store_unit]
                        [filter]
                            id=$tmp_units[$i_u].id
                        [/filter]

                        variable=S.stored_Quanks_units
                        mode=append
                        kill=yes
                    [/store_unit]

                    [move_unit_fake]
                        type=$tmp_units[$i_u].type
                        side=1
                        x=$tmp_units[$i_u].x,44
                        y=$tmp_units[$i_u].y,50
                    [/move_unit_fake]
                [/then]
            [/if]
        {NEXT i_u}

        {CLEAR_VARIABLE tmp_units,tmp_path}

        {MESSAGE Vanak "" "" _"Vanak say luck."}

        [remove_item]
            x,y=44,50
        [/remove_item]
        {SET_LABEL 44 50 ""}

        # Set a turn number for Quank's return
        {VARIABLE S.Quank_returns_turn "$($turn_number+5)"}
#ifdef NORMAL
        {VARIABLE S.Quank_returns_turn "$($turn_number+6)"}
#endif
#ifdef HARD
        {VARIABLE S.Quank_returns_turn "$($turn_number+7)"}
#endif

        [show_objectives]
        [/show_objectives]

        [event]
            name=side 7 turn end,Quank_returns
            first_time_only=no

            [if]
                [variable]
                    name=S.Quank_returns_turn
                    equals=$turn_number
                [/variable]

                [then]
                    # Just in case there are units here, move them out of the way
                    [move_unit]
                        x,y=55-60,23-28
                        [filter_side]
                            [enemy_of]
                                side=1
                            [/enemy_of]
                        [/filter_side]

                        to_x,to_y=53,24
                    [/move_unit]

                    # And in case an allied unit is left at the keep to be built here
                    [move_unit]
                        x=56,57   ,58
                        y=26,26-27,26

                        to_x,to_y=56,24
                    [/move_unit]

                    {VARIABLE S.stored_Quank.side 8}
                    {VARIABLE S.stored_Quank.facing nw}
                    {MOVE_UNIT_ONTO_MAP 8 "$S.stored_Quank.type" 60 25 nw ()}
                    [unstore_unit]
                        variable=S.stored_Quank
                        x,y=60,25
                    [/unstore_unit]
                    {CLEAR_VARIABLE S.stored_Quank}
                    {FULL_HEAL_AND_CURE id=Quank}

                    {MESSAGE Quank "" "" _"Grnk, I am back. And look whom I brought."}
                    {MOVE_UNIT id=Quank 59 26}

                    # Get Langzight from the recall list
                    [store_unit]
                        [filter]
                            id=Langzight
                        [/filter]

                        variable=tmp_Langzight
                        kill=yes
                    [/store_unit]

                    {VARIABLE tmp_Langzight.facing nw}
                    {MOVE_UNIT_ONTO_MAP 8 "$tmp_Langzight.type" 60 25 nw ()}
                    [unstore_unit]
                        variable=tmp_Langzight
                        x,y=60,25
                    [/unstore_unit]

                    {MESSAGE Langzight "" "" _"Hello, Grnk. After General Koorzhar's removal and due in no small part to Quank's negotiation skills, HQ agreed that it would be in Shmaltupp's best interest to support you."}
                    {MESSAGE Grnk "" "" _"That's very, uh, pragmatic of them. Nevertheless, we extend our thanks to you personally, $tmp_Langzight.language_name Langzight."}
                    {MESSAGE Langzight "" "" _"Don't mention it. It's long overdue that we play our role in this fight."}
                    {CLEAR_VARIABLE tmp_Langzight}

                    {MOVE_UNIT id=Langzight 58 26}

                    [terrain]
                        x=56,57
                        y=26,26-27
                        terrain=Ce
                    [/terrain]
                    [terrain]
                        x,y=58,26
                        terrain=Ke
                    [/terrain]
                    [redraw]
                    [/redraw]

                    {FOREACH S.stored_Quanks_units i_u}
                        {VARIABLE S.stored_Quanks_units[$i_u].side 8}
                        {VARIABLE S.stored_Quanks_units[$i_u].facing nw}
                        [unstore_unit]
                            variable=S.stored_Quanks_units[$i_u]
                            x,y=59,26
                            find_vacant=yes
                        [/unstore_unit]
                        {FULL_HEAL_AND_CURE id=$S.stored_Quanks_units[$i_u].id}
                    {NEXT i_u}
                    {CLEAR_VARIABLE S.stored_Quanks_units,S.Quank_returns_turn}

                    [modify_side]
                        side=8
                        controller=human
                        hidden=no
                    [/modify_side]

                    [show_objectives]
                    [/show_objectives]
                [/then]
            [/if]
        [/event]
    [/event]

    # Master appears
    [event]
        name=side 5 turn 6 end,master_appears

        [if]
            [have_unit]
                x,y=56,6
            [/have_unit]

            [then]
                {CLOSE_EMPTY_HEX 56 6 "Q*,W*,M*,*^X*,*^V*" 1}
                {MOVE_UNIT (x,y=56,6) $hex_x $hex_y}
                {CLEAR_VARIABLE hex_x,hex_y}
            [/then]
        [/if]

        {MASTER_S15 2 56 6}

        {MESSAGE_FACING Master Grnd "" _"Grnd, stop fooling around! It's time to put an end to this."}
        {MESSAGE Grnd "" "" _"But I was having fun."}

        # If this was fired from the Grnd last_breath event
        [if]
            [not]
                [have_unit]
                    id=Grnd
                [/have_unit]
            [/not]

            [then]
                {MESSAGE Master "" "" _"Yes, exactly. And see where it's gotten you. I am sending you back to the lair, you wait there for me."}
                {MESSAGE Grnd "" "" _"But ..."}
                {MESSAGE Master "" "" _"No buts!"}

                {FIREBALL_OUT Grnd "~GS()"}
            [/then]

            [else]
                {MESSAGE Master "" "" _"Yes, exactly."}
            [/else]
        [/if]

        {MESSAGE Master "" "" _"Grnk, we have yet another little surprise for you."}

        {BRING_OUT_MAL_AN}

        # Grossauba returns at that point
        {SCROLL_TO 39 1}

        # Just in case there are units here, move them out of the way
        [move_unit]
            x,y=37-45,1-5
            [filter_side]
                [enemy_of]
                    side=1
                [/enemy_of]
            [/filter_side]

            to_x,to_y=46,6
        [/move_unit]

        # And in case an allied unit is left at the keep to be built here
        [move_unit]
            x=39,40, 41
            y=3, 1-3,2-3

            to_x,to_y=40,4
        [/move_unit]

        # Need to kill Wyssauba,Grossauba off the Hynderwlt recall list
        [kill]
            id=Wyssauba,Grossauba
        [/kill]

        {VARIABLE stored_Grossauba_S9.side 6}
        {VARIABLE stored_Grossauba_S9.facing se}
        {VARIABLE stored_Grossauba_S9.goto_x ""}
        {VARIABLE stored_Grossauba_S9.goto_y ""}
        {MOVE_UNIT_ONTO_MAP 6 "$stored_Grossauba_S9.type" 39 1 se ()}
        [unstore_unit]
            variable=stored_Grossauba_S9
            x,y=39,1
        [/unstore_unit]
        {CLEAR_VARIABLE stored_Grossauba_S9}

        {MESSAGE_FACING Grossauba Grnk "" _"Grnk, now!"}
        {MESSAGE Grnk "" "" _"Grossauba, you really did come back. And you really are not the Master!"}
        {MESSAGE Grossauba "" "" _"Indeed. Now stop wasting time and do as I explained to you, before the Master realizes what is going on! I cannot weaken his powers for long."}
        {MESSAGE Grnk "" "" _"Right. Let's see ..."}

        [store_unit]
            [filter]
                role=undead_guard
            [/filter]

            variable=tmp_guards
        [/store_unit]

        {FOREACH tmp_guards i_g}
            [adjust_facing]
                id=Grnk
                second_id=$tmp_guards[$i_g].id
            [/adjust_facing]

            {WHITE_MISSILE_KILL $tmp_guards[$i_g].id "~GS()~CS(0,-50,0)"}
        {NEXT i_g}
        {CLEAR_VARIABLE tmp_guards}

        {MESSAGE_FACING Grnk (Mal An) "" _"And this one's for you, Mal An."}

        {WHITE_MISSILE (Mal An) "~GS()~CS(0,-50,0)"}

        [modify_unit]
            [filter]
                id=Mal An
            [/filter]

            hitpoints=0
        [/modify_unit]

        {MESSAGE (Mal An) "" "" _"Nooooo! Can this really be the end of Mal An?"}
        {MESSAGE Grnk "" "" _"It can. And it is. And no secret revival and attaching to my shadow this time! Grossauba showed me what to do about that."}

        {WHITE_MISSILE (Mal An) "~GS()~CS(0,-50,0)"}
        [kill]
            id=Mal An
            animate=yes
        [/kill]

        {MASTER_EXPLANATION_S15 2 56 6}

        {MESSAGE_FACING Wyssauba Grnk "" _"Now let's get on with this, shall we? It would have been preferable if you had joined me voluntarily, Grnk, but we'll just have to do it the hard way. Let's make it a little less tedious though."}

        {WHITE_MISSILE_HEX 50 6 ()}
        {WHITE_MISSILE_HEX 50 7 ()}
        {WHITE_MISSILE_HEX 49 8 ()}
        {WHITE_MISSILE_HEX 48 7 ()}
        {WHITE_MISSILE_HEX 47 8 ()}
        {WHITE_MISSILE_HEX 47 9 ()}
        {WHITE_MISSILE_HEX 46 9 ()}

        [terrain]
            x=50,50,49,48,47,47,46
            y=6, 7, 8, 7, 8, 9, 9
            terrain=Hhd
        [/terrain]
        [redraw]
        [/redraw]

        {FIREBALL_UNDEAD_IN 2 tmp_Master 56 6 sw}
        {CLEAR_VARIABLE tmp_Master}

        {MESSAGE Master "" "" _"Harharharharhar!"}

        [terrain]
            x,y=56,6
            terrain=Khr
        [/terrain]
        [redraw]
        [/redraw]

        {MESSAGE Grossauba "" "" {GASP _"sigh"}}

        {MOVE_UNIT (id=Grossauba) 40 2}

        [terrain]
            x=39,40,40,41
            y=3 ,1 ,3 ,2-3
            terrain=Ce
        [/terrain]
        [terrain]
            x,y=40,2
            terrain=Ke
        [/terrain]
        [redraw]
        [/redraw]

        {VARIABLE stored_Teussauba_S9.side 6}
        [unstore_unit]
            variable=stored_Teussauba_S9
            x,y=41,3
        [/unstore_unit]
        {CLEAR_VARIABLE stored_Teussauba_S9}

        [modify_unit]
            [filter]
                id=Teussauba
            [/filter]

            canrecruit=no
            overlays=misc/hero-icon.png
            [modifications]
                {TRAIT_LOYAL}
            [/modifications]
        [/modify_unit]

        {MESSAGE_FACING Teussauba Grnk "" _"Hello, Grnk."}
        {MESSAGE Grnk "" "" _"Teussauba!"}

        [if]
            [variable]
                name=stored_animals_S4s.length
                greater_than=0
            [/variable]

            [then]
                {MESSAGE Teussauba "" "" _"Long time no see. And look whom else I brought."}

                {FOREACH stored_animals_S4s i_a}
                    {CLOSE_EMPTY_HEX 42 3 "C*,K*" 0}
                    {VARIABLE stored_animals_S4s[$i_a].moves $stored_animals_S4s[$i_a].max_moves}
                    {VARIABLE stored_animals_S4s[$i_a].side 6}
                    [unstore_unit]
                        variable=stored_animals_S4s[$i_a]
                        x,y=$hex_x,$hex_y
                    [/unstore_unit]
                {NEXT i_a}
                {FULL_HEAL_AND_CURE (side=6)}

                [if]
                    [variable]
                        name=stored_animals_S4s.length
                        greater_than=1
                    [/variable]

                    [then]
                        {MESSAGE Grnk "" "" _"My animals! I didn't think that I would ever see you again."}
                    [/then]

                    [else]
                        {MESSAGE Grnk "" "" _"I didn't think that I would ever see <i>you</i> again!"}
                    [/else]
                [/if]
            [/then]

            [else]
                {MESSAGE Teussauba "" "" _"Long time no see."}
            [/else]
        [/if]

        # Clear animals variable; also can get rid of the trolls (not needed here)
        {CLEAR_VARIABLE stored_animals_S4s,stored_trolls_S4,hex_x,hex_y}

        [modify_unit]
            [filter]
                id=Grnd
            [/filter]

            [modifications]
                {TRAIT_LOYAL}
            [/modifications]

            overlays=misc/hero-icon.png
            canrecruit=no
        [/modify_unit]

        [modify_side]
            side=6

            controller=human
            hidden=no
        [/modify_side]

        # Also close the portals
        [event]
            name=new turn

            {MESSAGE Grossauba "" "" _"Grnk, let's close those portals. It takes a lot of energy and concentration to keep them open, even the Master won't be able to do so against the two of us together."}

            {FIREBALL 52 8 "~GS()~CS(0,-50,0)"}
            {FIREBALL 53 7 "~GS()~CS(0,-50,0)"}
            {FIREBALL 54 8 "~GS()~CS(0,-50,0)"}
            [terrain]
                x=52,53,54
                y=8,7,8
                terrain=Ql
            [/terrain]
            [redraw]
            [/redraw]
        [/event]

        [objectives]
            summary=_"<span color='#A050A0'>Thwart The Master's Grand Plan Yet Again</span>"
            [objective]
                description=_"Defeat the Master"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Vanak"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Grossauba"
                condition=lose
            [/objective]
            [objective]
                [show_if]
                    [have_unit]
                        id=Quank
                    [/have_unit]
                [/show_if]
                description=_"Death of Quank"
                condition=lose
            [/objective]
            [objective]
                [show_if]
                    [have_unit]
                        id=Langzight
                    [/have_unit]
                [/show_if]
                description=_"Death of Langzight"
                condition=lose
            [/objective]
            [note]
                description=_"The Master has a powerful effect on enemies attacking him:"
            [/note]
            [note]
                bullet="  - "
                description=_"Any animal attacking him joins his side."
            [/note]
            [note]
                bullet="  - "
                description=_"Any non-animal enemy attacking him with non-magical weapons experiences an unpleasant (and fatal) surprise."
            [/note]
            {IS_LAST_SCENARIO}
        [/objectives]

        [event]
            name=side 2 turn

            [event]
                name=side 2 turn

                {MESSAGE Master "" "" _"So, Grossauba, since we are finally going head to head, you might as well tell me who you were as an undead."}
                {MESSAGE Grossauba "" "" _"You really haven't figured it out yet, have you?"}

                [store_unit]
                    [filter]
                        id=Grossauba
                    [/filter]

                    variable=tmp_Grossauba
                [/store_unit]

                [unit]
                    type=Ghast
                    id=Sklaf
                    name=_"Sklaf"
                    side=6
                    to_variable=tmp_Sklaf

                    facing=$tmp_Grossauba.facing
                [/unit]

                {FIREBALL_UNDEAD_IN 6 tmp_Sklaf $tmp_Grossauba.x $tmp_Grossauba.y $tmp_Grossauba.facing}

                {MESSAGE Sklaf "" "" _"You truly are evil, Master. Here's your brandy."}
                {MESSAGE Master "" "" _"Sklaf!"}

                [modify_unit]
                    [filter]
                        id=Sklaf
                    [/filter]

                    profile={GROSSAUBA_SKLAF_PORTRAIT}
                    name=_"Grossauba Sklaf"
                [/modify_unit]

                {MESSAGE Sklaf "" "" _"You're so full of yourself that it would never even occur to you that I might lower myself to being a simple servant. It's the perfect disguise."}

                {FIREBALL_UNDEAD_IN 6 tmp_Grossauba $tmp_Grossauba.x $tmp_Grossauba.y $tmp_Grossauba.facing}

                {CLEAR_VARIABLE tmp_Sklaf,tmp_Grossauba}
            [/event]
        [/event]
    [/event]

    # Animals attacking the Master get converted to his side before they can attack
    [event]
        name=attack
        first_time_only=no

        [filter]
            race=monster
            [or]
                race=bats
            [/or]
            [or]
                type=Wolf,Great Wolf,Direwolf
            [/or]
        [/filter]
        [filter_second]
            id=Master
        [/filter_second]

        {MESSAGE Master "" "" _"Join my minions, weak mind."}

        [modify_unit]
            [filter]
                id=$unit.id
            [/filter]

            side=$second_unit.side
        [/modify_unit]
    [/event]

    # Units attacking Master with non-magical weapon go insane after the attack.
    # Animals turn over to his side.
    [event]
        name=first_time_burn_message

        {MESSAGE Master "" "" _"Harharharharhar!"}
    [/event]

    [event]
        name=attack end
        first_time_only=no

        [filter]
            [not]
                race=monster
                [or]
                    race=bats
                [/or]
                [or]
                    type=Wolf,Great Wolf,Direwolf
                [/or]
            [/not]
        [/filter]
        [filter_second]
            id=Master
        [/filter_second]
        [filter_attack]
            [not]
                special=magical
            [/not]
        [/filter_attack]

        [if]
            [variable]
                name=unit.race
                equals=orc
            [/variable]
            [or]
                [variable]
                    name=unit.race
                    equals=goblin
                [/variable]
            [/or]
            [or]
                [variable]
                    name=unit.race
                    equals=wolf
                [/variable]
            [/or]

            [then]
                {MESSAGE unit "" "" _"Aaah! $unit.name burn!!!"}
            [/then]

            [else]
                {MESSAGE unit "" "" _"Aaah! It burns!!!"}
            [/else]
        [/if]

        # Runs around like crazy
        {REPEAT 5 (
            {CLOSE_EMPTY_HEX $unit.x $unit.y (M*,M*^*,W*,Q*) 2}
            {MOVE_UNIT id=$unit.id $hex_x $hex_y}
        )}

        {FIREBALL_KILL $unit.id}
        {PLACE_IMAGE "items/bones.png~BLEND(0,0,0,0.4)" $hex_x $hex_y}
        {CLEAR_VARIABLE hex_x,hex_y}

        [fire_event]
            name=first_time_burn_message
        [/fire_event]
    [/event]

    [event]
        name=die

        [filter]
            id=Teussauba
        [/filter]

        {MESSAGE Grossauba "" "" _"Good-bye, old friend."}
    [/event]

    [event]
        name=last breath

        [filter]
            id=Grnd
        [/filter]

        # If the Master is not there yet, this triggers him
        # This should generally not happen, as it should not be possible to
        # kill Grnd before the Master appears, but it is here as a backup
        [if]
            [not]
                [have_unit]
                    id=Master
                [/have_unit]
            [/not]

            [then]
                [fire_event]
                    name=master_appears
                [/fire_event]
            [/then]

            [else]
                {MESSAGE_FACING Master Grnd "" {GASP_BEGINNING _"sigh"}+_"Sometimes I wonder whether that goblin is worth all the trouble he's causing."}
                {MESSAGE_FACING Grnk Master "" _"Uh, which goblin?"}
                {MESSAGE Master "" "" _"<i>Both</i> of you!
<i> </i>
Grnd, I am sending you back to the lair, you wait there for me."}
                {MESSAGE Grnd "" "" _"But ..."}
                {MESSAGE Master "" "" _"No buts!"}

                {FIREBALL_OUT Grnd "~GS()"}
            [/else]
        [/if]
    [/event]

    # The scenario ends when the Master is defeated
    [event]
        name=last breath

        [filter]
            id=Master
        [/filter]

        {MESSAGE_FACING Master Grnk "" _"Grnk, you're a fool! Just imagine what we could have done together."}
        {MESSAGE Grnk "" "" _"I am imagining it and there is no way you will ever get me to join you! Take this!"}

        {WHITE_MISSILE_KILL Master "~GS()~CS(0,-50,0)"}

        {DELAY 2000}
        {MESSAGE narrator "portraits/undead/transparent/ancient-lich.png~O(50%)" "" _"Harharharharhar!"}
        {MESSAGE narrator "portraits/undead/transparent/ancient-lich.png~O(50%)" "" _"You may have defeated me today, but I will be back."}

        [if]
            [have_unit]
                id=Grnd
            [/have_unit]

            [then]
                {MESSAGE narrator "portraits/undead/transparent/ancient-lich.png~O(50%)" "" _"Grnd, you're with me!"}
                {FIREBALL_OUT Grnd "~GS()"}
            [/then]
        [/if]

        {MESSAGE Grnk "" "" _"Umm."}
        {MESSAGE Grnk "" "" _"We did it."}
        {MESSAGE Grnk "" "" _"Right?"}
        {MESSAGE_FACING Grossauba Grnk "" _"Indeed we did. And it is all thanks to you and your friends. Now, with the Master gone, there is only one thing left to do."}

        [store_unit]
            [filter]
                side=2,3,4
            [/filter]

            variable=tmp_minions
        [/store_unit]
        {FOREACH tmp_minions i_g}
            {WHITE_MISSILE_KILL $tmp_minions[$i_g].id ""}
        {NEXT i_g}
        {CLEAR_VARIABLE tmp_minions}

        {MESSAGE Vanak "" "" _"Vanak no like skeleton."}

        # Set variables to get the right messages in the epilogue
        {VARIABLE joined_Grossauba yes}

        [if]
            [have_unit]
                id=Grashnak
            [/have_unit]

            [then]
                {VARIABLE Grashnak_alive yes}
            [/then]
        [/if]

        {DELAY 1000}

        [endlevel]
            result=victory
            carryover_report=no
            replay_save=yes
            linger_mode=yes
        [/endlevel]
    [/event]

    {SUREFIRE_EVENT 1}
    {PEASANT_EVENTS_P2S14 1 999} # Boats are already on Grnk's side
    {BAT_EVENTS_P2S14 7}
    {MAL_AN_SHADOW}

    # Finally, the standard events for all or most scenarios
    {GRNK_DEATH}
    {VANAK_DEATH}
    {QUANK_DEATH}
    {LANGZIGHT_DEATH}
    {GROSSAUBA_DEATH}
    {GRASHNAK_DEATH}
[/scenario]
