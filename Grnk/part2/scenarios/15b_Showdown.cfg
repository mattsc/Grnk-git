#textdomain wesnoth-Grnk

[scenario]
    id=15b_Showdown
    name=_"Showdown"
    next_scenario=15s_Epilogue

    map_data="{~add-ons/Grnk/part2/maps/15b_Showdown.map}"

    {DEFAULT_SCHEDULE_FIRST_WATCH}
    turns=-1

    {GRNK2_STORY_15}

    #wmllint: recognize Grnk
    #wmllint: recognize Grossauba
    #wmllint: recognize Rok
    #wmllint: recognize Quank

    [side]
        side=1
        controller=human
        no_leader=yes

        persistent=yes
        save_id="Grnk and Vanak"

        team_name=Grnk
        user_team_name=_"Grnk"

        recruit=Orcish Grunt,Orcish Archer,Orcish Assassin,Wolf Rider,Goblin Spearman

        gold=0
    [/side]

    [side]
        side=2
        controller=ai
        no_leader=yes

        team_name=Grossauba
        user_team_name=_"The Master Grossauba"
        save_id="the Hynderwlt Mages"
        persistent=yes

        {GOLD 400 500 600}

        # The mages strongly go for Side 1 & 3 leaders. This is so that it is not
        # possible for the player to sit back and let the Hynderwlt and dark
        # mage AIs fight it out between them.
        [ai]
            aggression=1
            caution=-10
            grouping=no
            village_value=0

            # Recruit up to two L2s per turn
            [aspect]
                id=recruitment_instructions
                [facet]
                    [value]
                        [recruit]
                            type=1,2
                            number=2
                            importance=1
                        [/recruit]
                        [recruit]
                            type=1
                            importance=0
                        [/recruit]
                    [/value]
                [/facet]
            [/aspect]

            [goal]
                [criteria]
                    id=Grnk,Vanak,Quank,Rok
                [/criteria]

                value=10
            [/goal]
        [/ai]
    [/side]

    [side]
        side=3
        controller=human
        no_leader=yes

        persistent=yes
        save_id="Quank and Rok"

        team_name=Grnk
        user_team_name=_"Grnk"

        recruit=Troll Whelp,Troll

        {GOLD 400 300 200}
    [/side]

    [side]
        side=4
        controller=ai
        no_leader=yes
        hidden=yes

        team_name=mages
        user_team_name=_"Northern Dark Mages"

        recruit=Dark Adept

        {GOLD 200 300 400}

        # The dark adepts originally do not attack Grossauba's side
        # They also strongly target Grnk
        [ai]
            aggression=1
            caution=-10
            grouping=no
            village_value=0

            [aspect]
                id=attacks
                [facet]
                    invalidate_on_gamestate_change=yes
                    [filter_enemy]
                        [not]
                            side=2
                        [/not]
                    [/filter_enemy]
                [/facet]
            [/aspect]

            [goal]
                [criteria]
                    id=Grnk,Vanak
                [/criteria]

                value=10
            [/goal]
        [/ai]
    [/side]

    [side] # Bats
        side=5
        controller=ai
        no_leader=yes
        hidden=yes

        team_name=bats
    [/side]

    [side] # Master & Grnd
        side=6
        controller=null
        no_leader=yes
        hidden=yes
    [/side]

    {CAMPFIRE 27 33}

    [event]
        name=prestart

        [gold]
            side=1
            amount=$S15_gold
        [/gold]
        {CLEAR_VARIABLE S15_gold}

        {SETUP_MAP_S15 10 30 27 nw}

        # Clear the unit variables from S14, but still need Grnk variable in the start event
        {CLEAR_VARIABLE stored_Vanak_S14,stored_Quank_S14,stored_peasant_leader_S14,stored_other_units_S14,stored_saurian_leader_S14}

        [recall]
            id=Grashnak
            x,y=31,30
        [/recall]
        [recall]
            id=Gort
            x,y=29,30
        [/recall]

        # Need to kill Wyssauba,Grossauba off the Hynderwlt recall list
        [kill]
            id=Wyssauba,Grossauba
        [/kill]

        {VARIABLE stored_Grossauba_S9.side 2}
        {VARIABLE stored_Grossauba_S9.facing se}
        {VARIABLE stored_Grossauba_S9.moves $stored_Grossauba_S9.max_moves}
        {VARIABLE stored_Grossauba_S9.goto_x ""}
        {VARIABLE stored_Grossauba_S9.goto_y ""}
        [unstore_unit]
            variable=stored_Grossauba_S9
            x,y=13,20
        [/unstore_unit]
        {CLEAR_VARIABLE stored_Grossauba_S9}

        # Also can clear Teussauba variable
        {CLEAR_VARIABLE stored_Teussauba_S9}

        {FOREACH stored_trolls_S4 i_t}
            {VARIABLE stored_trolls_S4[$i_t].side 3}
            [unstore_unit]
                variable=stored_trolls_S4[$i_t]
                x,y=recall,recall
            [/unstore_unit]
        {NEXT i_t}
        # Clear troll variable; also can get rid of the animals (not needed here)
        {CLEAR_VARIABLE stored_trolls_S4,stored_animals_S4s}

        {PRUNES_SETUP 1 Grnk 9 34 "*^X*,Wo,Q*"}

        [modify_unit]
            [filter]
                side=1,2
            [/filter]

            goto_x=""
            goto_y=""
        [/modify_unit]

        [objectives]
            side=1,3
            summary=_"<span color='#A050A0'>Thwart The Master's Grand Plan Yet Again</span>"
            [objective]
                description=_"Defeat the Master Grossauba"
                condition=win
            [/objective]
            [objective]
                description=_"Death of Grnk"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Vanak"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Quank"
                condition=lose
            [/objective]
            [objective]
                description=_"Death of Rok"
                condition=lose
            [/objective]
            [note]
                description=_"Peasants can still round up their brothers by capturing unowned villages."
            [/note]
            [note]
                description=_"Peasants can rebuild burned villages by moving onto them."
            [/note]
            {IS_LAST_SCENARIO}
        [/objectives]
    [/event]

    [event]
        name=start

        {MESSAGE_FACING_RIGHT Grossauba Grnk "" _"Grnk, I am not going to fight you."}

        {MOVE_UNIT_ALONG_PATH Grossauba 11 19 11 16 ne}

        {MESSAGE Quank "" "" _"This might be a good time for Plan C."}
        {MESSAGE Grnk "" "" _"I told you that I do not know how to teleport you reliably. I'm okay doing that to enemies, who cares if they end up inside a volcano, but I cannot take that risk with you."}
        {MESSAGE Quank "" "" _"Do you have a better idea?"}
        {MESSAGE Grnk "" "" _"Umm, no."}
        {MESSAGE Quank "" "" _"Well, then, get on with it. We must not let Grossauba escape."}
        {MESSAGE Grnk "" "" _"I guess so ... Let's see ..."}

        {LEADING_HALO_PRUNES Grnk}
        {TELEPORT_AWAY id=Quank 7 11 () "~CS(0,-50,0)"}

        {MESSAGE_FACING_RIGHT Quank Grnk "" _"Slightly off, but close enough. Now where are those trolls?"}

        {MOVE_UNIT (id=Quank) 9 8}

        {MESSAGE_RIGHT Quank _"Yo, Rok, where are you?"}

        {FULL_HEAL_AND_CURE (side=3)}

        [modify_unit]
            [filter]
                id=Rok
            [/filter]

            facing=sw
        [/modify_unit]

        [recall]
            id=Rok
            x,y=20,1
        [/recall]

        {MOVE_UNIT (id=Rok) 19 3}

        {MESSAGE Rok "" "" _"Rok hide mountain like little dwarf say."}
        {MESSAGE_RIGHT Quank _"Great! Let's stop these wizards then. They must not escape to the north."}

        {MOVE_UNIT (id=Rok) 18 4}

        [terrain]
            x=17, 18,19
            y=5-6,5, 5
            terrain=Ce
        [/terrain]
        [terrain]
            x,y=18,4
            terrain=Ke
        [/terrain]
        [redraw]
        [/redraw]

        [modify_unit]
            [filter]
                id=Quank
            [/filter]

            side=3
        [/modify_unit]

        [scroll_to_unit]
            id=Quank
        [/scroll_to_unit]

        {MESSAGE narrator "$stored_Grnk_S14.profile~O(30%)" _"Grnk's Voice from the Distance" _"I still can't believe that you managed to get the trolls to work for you.
<i> </i>
Ooo, look, I figured out how to do this distant‑voice thing!"}
        {MESSAGE_RIGHT Quank _"It's simply a mutually beneficial business arrangement. They do some of the heavy lifting for me, often quite literally in fact, and in turn I make sure that they are not hunted down and have plenty of skeletons to smash. They also get to keep all the bones."}
        {MESSAGE Rok "" "" _"Rok like smash skeleton."}
        {MESSAGE narrator "$stored_Grnk_S14.profile~O(30%)" _"Grnk's Voice from the Distance" _"And the people in Grentstutt are going along with this?"}
        {MESSAGE_RIGHT Quank _"It's funny really. When I first employed trolls to pull my carts — they last even longer than oxen, you know — people were complaining. So I started charging them extra for the 'experience', and suddenly everybody loves it. They even ..."}


        {MESSAGE Grossauba "" "" _"Ahem. That's all very nice and interesting, but if you don't mind, I will be leaving by my other means of transportation now."}

        [store_unit]
            [filter]
                id=Grossauba
            [/filter]

            variable=tmp_Grossauba
        [/store_unit]

        {FIREBALL_OUT Grossauba "~GS()"}

        {MESSAGE Grnk "" "" _"Oh no, you won't."}

        {FIREBALL_IN 2 $tmp_Grossauba.x $tmp_Grossauba.y $tmp_Grossauba.image $tmp_Grossauba.facing "~GS()~CS(0,-50,0)"}

        [unstore_unit]
            variable=tmp_Grossauba
        [/unstore_unit]
        {CLEAR_VARIABLE tmp_Grossauba}

        {MESSAGE_FACING Grossauba Grnk "" _"Ouch! I'm really getting too old for this.
<i> </i>
Grnk, this is madness. I beg you, don't do this!"}
        {MESSAGE Grnk  "" "" _"The words of a coward. Everybody, attack!"}
        {MESSAGE Grossauba  "" "" {GASP _"sigh"}}

        {MOVE_UNIT_ALONG_PATH Grossauba 11 17 8 18 se}

        {NARRATOR_GRAY _"Goblin Recalling and Recruiting" _"Recalling and recruiting goblins works the same as in the previous two scenarios. You can only recruit one level-1 goblin per turn, but recalling goblins costs only 13 gold. However, it is not possible in Wesnoth 1.12 to set the recall cost to 13 gold for one race (goblins) and to 20 gold for another race (orcs). Recalling goblins is therefore handled by first charging 20 gold and then refunding 7. This does mean that you cannot recall a goblin unless there is at least 20 gold left."}
    [/event]

    # One L1 goblin recruit per turn
    [event]
        name=side 1 turn
        first_time_only=no

        [allow_recruit]
            side=1
            type=Goblin Rouser,Goblin Impaler
        [/allow_recruit]
    [/event]

    [event]
        name=recruit
        first_time_only=no

        [filter]
            side=1
            type=Goblin Rouser,Goblin Impaler
        [/filter]

        [disallow_recruit]
            side=1
            type=Goblin Rouser,Goblin Impaler
        [/disallow_recruit]
    [/event]

    [event]
        name=recall
        first_time_only=no

        [filter]
            side=1
            race=goblin
        [/filter]

        [gold]
            side=1
            amount=7
        [/gold]
    [/event]

    [event]
        name=side 4 turn

        [unit]
            side=4
            type=Necromancer
            id=Addyn
            name=_"Addyn"
            canrecruit=yes

            x,y=45,13
            facing=sw
        [/unit]

        {MESSAGE Addyn "" "" _"There he is. Let's get him for the Master."}

        {MOVE_UNIT (id=Addyn) 42 16}

        [terrain]
            x=41,   42-43
            y=16-17,17
            terrain=Ce
        [/terrain]
        [terrain]
            x,y=42,16
            terrain=Ke
        [/terrain]
        [redraw]
        [/redraw]

        {MESSAGE_FACING_RIGHT Grossauba Addyn "" _"More of those idiots? There must be a nest somewhere. Mages of Hynderwlt, fight them too."}

        [scroll_to_unit]
            id=Quank
        [/scroll_to_unit]

        {MESSAGE narrator "$stored_Grnk_S14.profile~O(30%)" _"Grnk's Voice from the Distance" _"I thought you had said that all the dark mages had disappeared."}
        {MESSAGE Quank "" "" _"They had. They must have been gathering somewhere in hiding. Make sure you collect their robes after killing them!"}

        {CLEAR_VARIABLE stored_Grnk_S14}


        [modify_side]
            side=4
            hidden=no
        [/modify_side]
    [/event]

    # Message after the first attack between sides 1 and 2
    [event]
        name=attack end
        [filter]
            side=1,2
        [/filter]
        [filter_second]
            side=1,2
        [/filter_second]

        {MESSAGE Grossauba "" "" _"Mages of Hynderwlt, remember not to kill Grnk. He must be weakened, I'm afraid, but do not deal the final blow."}
        {MESSAGE_FACING Grnk Grossauba "" _"Yes, yes, we all know it. The Master wants me alive."}
        {MESSAGE Grossauba "" "" _"No, Grnk, that is not at all what I ..."}
        {MESSAGE Grnk "" "" _"Silence!"}
    [/event]

    # Side 4 units continue to destroy all villages they move onto, same as in S14
    [event]
        name=first_village_burn_after

        {MESSAGE_FACING Grnk Addyn "" _"Stop doing that!"}
        {MESSAGE Addyn "" "" _"Hah, you wish!"}
    [/event]

    {DARK_MAGES_BURN_VILLAGES 4}

    # The dark mages start attacking Grossauba's side once they are attacked first
    [event]
        name=attack end

        [filter]
            side=2
        [/filter]
        [filter_second]
            side=4
        [/filter_second]

        {MESSAGE_FACING Addyn Grossauba "" _"What the hell?!? We are here to help you!"}
        {MESSAGE Grossauba "" "" _"And who do you think you are? Do you in all seriousness believe that the Master would want your help?"}
        {MESSAGE_FACING Grnk Grossauba "" _"Aha, I knew it! You <i>are</i> the Master!"}
        {MESSAGE Grossauba "" "" _"No, no, no! I just meant that, hypothetically speaking, the Master, whoever he is, would neither need nor want the help of these ..."}
        {MESSAGE Grnk "" "" _"Oh, just stop your lies."}
        {MESSAGE Grossauba  "" "" {GASP _"sigh"}}
        {MESSAGE_FACING Addyn Grossauba "" _"If that's the gratitude we are getting, you just see. We are not afraid of taking on the self-proclaimed Master of the Undead as well."}
        {MESSAGE Grossauba  "" "" _"Idiots!"}

        {MODIFY_AI_TRY_DELETE_ASPECT 4 attacks *}
    [/event]

    # If a bat attacks a dark mage, all bats will then avoid the mages
    [event]
        name=attack end

        [filter]
            side=5
        [/filter]
        [filter_second]
            side=4
        [/filter_second]

        {MESSAGE $second_unit.id "" "" _"Take this, vermin!"}

        {WHITE_MISSILE_KILL $unit.id ()}

        [modify_side]
            side=5

            [ai]
                [avoid]
                    [filter]
                        side=4
                    [/filter]
                    radius=2
                [/avoid]
            [/ai]
        [/modify_side]
    [/event]

    # Message when dark mage leader dies
    [event]
        name=last breath

        [filter]
            side=4
            canrecruit=yes
        [/filter]

        [if]
            [variable]
                name=second_unit.side
                equals=1
            [/variable]

            [then]
                {MESSAGE $unit.id "" "" _"I hate goblins."}
            [/then]

            [else]
                {MESSAGE $unit.id "" "" _"Maybe we're in a bit over our heads here."}
            [/else]
        [/if]
    [/event]

    # Scenario is done when Grossauba dies
    [event]
        name=last breath

        [filter]
            id=Grossauba
        [/filter]

        # The Master and Grnd appear
        {MESSAGE_FACING Grossauba Grnk "" _"Grnk, what have you done!"}

        # First, just in case there are units here, move them out of the way
        [move_unit]
            x,y=47-49,22-25

            to_x,to_y=44,25
        [/move_unit]

        {MASTER_S15 6 48 23}

        {MESSAGE_FACING Master Grnk "" _"Harharharharhar!"}

        {GRND_S15 6 49 24}

        {MESSAGE Master "" "" _"Well done, Grnk. You got rid of my only adversary who had even the slightest bit of a chance to stop me."}
        {MESSAGE_FACING Grnk Grossauba "" _"Grossauba ... what ... I thought ..."}
        {MESSAGE Grossauba "" "" _"I <i>told</i> you that I am not the Master!"}
        {MESSAGE_FACING Grnk Master "" _"But then ... that must mean ..."}

        {MASTER_EXPLANATION_S15 6 48 23}

        {MESSAGE_FACING Wyssauba Grnk "" _"Now let's get on with this, shall we? It would have been preferable if you had joined me voluntarily, Grnk, but we'll just have to do it the hard way."}

        {FIREBALL_UNDEAD_IN 6 tmp_Master 48 23 sw}
        {CLEAR_VARIABLE tmp_Master}

        {MESSAGE Master "" "" _"Mal An, come out and suppress his magic, just as I showed you."}

        {BRING_OUT_MAL_AN}

        {MESSAGE Master "" "" _"On the contrary. This is just the beginning. You have become quite skilled at magic, Grnk, in particular also at deflecting others' magic. But with Mal An hanging out in your shadow and probing your weaknesses for so long after we allowed you to ""kill"" him, you are no match for the two of us combined."}

        {MESSAGE_FACING Master Grossauba "" _"So, Grossauba, since this is the end of you, of the 'good Grnk' and of the world as you know it, you might as well tell me who you were as an undead when you were spying on me."}
        {MESSAGE Grossauba "" "" _"You still have not figured that out? Well, too bad for you! You will just have to (un)live with that, I am not going to give you the satisfaction of telling you."}

        [kill]
            id=Grossauba
            animate=yes
        [/kill]

        {MESSAGE Master "" "" _"Oh my, this is really going to give me sleepless nights."}
        {MESSAGE Master "" "" _"Harharharharhar!"}
        {MESSAGE_FACING Master Grnk "" _"Come on now, Grnk. I have much to teach you."}

        {FIREBALL_UNDEAD_OUT Grnk}
        {FIREBALL_UNDEAD_OUT Master}

        {MESSAGE Grnd "" "" _"Hey! What about me!"}

        {MESSAGE narrator "portraits/undead/transparent/ancient-lich.png~O(50%)" "" _"Ah, yes, I almost forgot."}

        {WHITE_MISSILE_KILL Grnd "~GS()"}

        {MESSAGE narrator "portraits/undead/transparent/ancient-lich.png~O(50%)" "" _"Good-bye, Grnd. No need to keep the copy, now that I have the original."}
         {MESSAGE narrator "portraits/undead/transparent/ancient-lich.png~O(50%)" "" _"Harharharharhar!"}
        {MESSAGE Vanak "" "" _"Vanak no like skeleton."}

        # Set variables to get the right messages in the epilogue
        {VARIABLE joined_Grossauba no}

        [if]
            [have_unit]
                id=Grashnak
            [/have_unit]

            [then]
                {VARIABLE Grashnak_alive yes}
            [/then]
        [/if]

        {DELAY 1000}

        [dialog_message]
            message=_"You have won."
        [/dialog_message]
        [dialog_message]
            message=_"After a fashion."
        [/dialog_message]

        {CLEAR_VARIABLE MA_shadow_message}

        [endlevel]
            result=victory
            carryover_report=no
            replay_save=yes
            linger_mode=yes
        [/endlevel]
    [/event]

    [event]
        name=last breath

        [filter]
            id=Rok
        [/filter]

        {MESSAGE Rok "" "" _"Rok ... defeated."}

        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    # Death event for Grnk is different here than in other scenarios
    [event]
        name=last breath
        [filter]
            id=Grnk
        [/filter]

        {MESSAGE Grnk "" "" _"Farewell, cruel world."}
        {MESSAGE_FACING Grossauba Grnk "" _"Hold on, Grnk. I can heal you."}

        [if]
            [variable]
                name=second_unit.id
                equals=Grossauba
            [/variable]

            [then]
                {MESSAGE Grnk "" "" _"First you bring me to the verge of death and then you want to save me? No thanks!"}
            [/then]

            [else]
                {MESSAGE Grnk "" "" _"First you order your mages to kill me and then you want to save me? No thanks!"}
            [/else]
        [/if]

        {MESSAGE Grossauba "" "" _"You didn't give me a choice. Let me heal you and we will start over by ..."}
        {MESSAGE Grnk "" "" _"... by you making me your evil second-in-command. I will not let that happen. This must come to an end!"}
        {MESSAGE Grossauba "" "" _"Grnk, no, wait! I am not ..."}

        {WHITE_MISSILE_KILL Grnk "~GS()~CS(0,-50,0)"}

        {MESSAGE Quank "" "" _"He killed himself rather than letting himself be captured. I must say, I'm impressed."}
        {MESSAGE Vanak "" "" _"Vanak miss little goblin."}

        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    {SUREFIRE_EVENT 1}
    {PEASANT_EVENTS_P2S14 1 999} # Boats are already on Grnk's side
    {BAT_EVENTS_P2S14 5}
    {PEASANTS_REBUILD_VILLAGES}
    {MAL_AN_SHADOW}

    # Finally, the standard events for all or most scenarios
    {VANAK_DEATH}
    {QUANK_DEATH}
    {GRASHNAK_DEATH}
[/scenario]
