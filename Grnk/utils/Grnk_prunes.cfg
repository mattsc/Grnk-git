#textdomain wesnoth-Grnk

#ifdef CAMPAIGN_GRNK_PART_2
#define PRUNES_ADVANCE PRUNES_UNIT_ID
    # Advancement system for prunes (Part 2 only)
    [message]
        speaker=narrator
        image=wesnoth-icon.png
        image="items/ball-blue.png~CROP(26,16,20,40)~SCALE(20,20)~CS(-50,-100,-100)"
        # wmllint: display on
        message=_"Grnk's continuing practice with the prunes is paying off.
Choose one of the following improvements to his mastery of the tasty fruits' magic:"
        # wmllint: display off

        [option]
            {OPTION_LABEL _"New prunes effect: convert enemy unit to Grnk's side for one turn"}
            [show_if]
                [not]
                    [variable]
                        name=prunes_cfg.events
                        contains=join
                    [/variable]
                [/not]
            [/show_if]
            [command]
                {VARIABLE prunes_cfg.events $prunes_cfg.events+",join"}
            [/command]
        [/option]

        [option]
            {OPTION_LABEL _"New prunes effect: demote enemy unit to lowest level in its advancement line"}
            [show_if]
                [not]
                    [variable]
                        name=prunes_cfg.events
                        contains=demote
                    [/variable]
                [/not]
            [/show_if]
            [command]
                {VARIABLE prunes_cfg.events $prunes_cfg.events+",demote"}
            [/command]
        [/option]

        [option]
            {OPTION_LABEL _"New prunes effect: damage all close enemy units by small random amount (0-8 hitpoints)"}
            [show_if]
                [not]
                    [variable]
                        name=prunes_cfg.events
                        contains=damage_all
                    [/variable]
                [/not]
            [/show_if]
            [command]
                {VARIABLE prunes_cfg.events $prunes_cfg.events+",damage_all"}
            [/command]
        [/option]

        [option]
            # wmllint: display on
            {OPTION_LABEL _"Increase success rate and amount for damaging all close units
to 85% success rate and maximum damage of 12 HP (currently: 67% and 8 HP)"}
            # wmllint: display off

            [show_if]
                [variable]
                    name=prunes_cfg.events
                    contains=damage_all
                [/variable]
                [variable]
                    name=prunes_cfg.damage_all_random
                    equals="-3..8"
                [/variable]
            [/show_if]
            [command]
                {VARIABLE prunes_cfg.damage_all_random "-1..12"}
            [/command]
        [/option]

        [option]
            # wmllint: display on
            {OPTION_LABEL _"Lengthen enemy petrification to 2‑4 turns (currently: 1‑2 turns)"}
            # wmllint: display off

            [show_if]
                [variable]
                    name=prunes_cfg.petrify_turns
                    equals="1..2"
                [/variable]
                [variable]
                    name=prunes_cfg.advancement_counter
                    greater_than=1
                [/variable]
            [/show_if]
            [command]
                {VARIABLE prunes_cfg.petrify_turns "2..4"}
            [/command]
        [/option]

        [option]
            # wmllint: display on
            {OPTION_LABEL _"Make enemy petrification indefinite (currently: 2‑4 turns)"}
            # wmllint: display off

            [show_if]
                [variable]
                    name=prunes_cfg.petrify_turns
                    equals="2..4"
                [/variable]
                [variable]
                    name=prunes_cfg.advancement_counter
                    greater_than=3
                [/variable]
            [/show_if]
            [command]
                {VARIABLE prunes_cfg.petrify_turns "999"}
            [/command]
        [/option]

        [option]
            # wmllint: display on
            {OPTION_LABEL _"Increase strike number of enemies attacking each other to 3‑6 (currently: 2‑3)"}
            # wmllint: display off

            [show_if]
                [variable]
                    name=prunes_cfg.strike_number
                    equals="2..3"
                [/variable]
                [variable]
                    name=prunes_cfg.advancement_counter
                    greater_than=1
                [/variable]
            [/show_if]
            [command]
                {VARIABLE prunes_cfg.strike_number "3..6"}
            [/command]
        [/option]

        [option]
            # wmllint: display on
            {OPTION_LABEL _"Make enemies attacking each other fight to death (currently: 3‑6 strikes)"}
            # wmllint: display off

            [show_if]
                [variable]
                    name=prunes_cfg.strike_number
                    equals="3..6"
                [/variable]
                [variable]
                    name=prunes_cfg.advancement_counter
                    greater_than=3
                [/variable]
            [/show_if]
            [command]
                {VARIABLE prunes_cfg.strike_number "999"}
            [/command]
        [/option]

        # Disable this option. It is too powerful.
        #[option]
        #    {OPTION_LABEL _"Add ability to choose which effects prunes should have (50% chance of successful choice)"}
        #    [show_if]
        #        [variable]
        #            name=prunes_cfg.select_chance
        #            equals=0
        #        [/variable]
        #    [/show_if]
        #    [command]
        #        {VARIABLE prunes_cfg.select_chance 50}
        #    [/command]
        #[/option]

        [option]
            # wmllint: display on
            {OPTION_LABEL _"Improve ability to choose which effect prunes should have
to 75% chance of successful choice (currently: 50%)"}
            # wmllint: display off

            [show_if]
                [variable]
                    name=prunes_cfg.select_chance
                    equals=50
                [/variable]
            [/show_if]
            [command]
                {VARIABLE prunes_cfg.select_chance 75}
            [/command]
        [/option]

        [option]
            # wmllint: display on
            {OPTION_LABEL _"Improve ability to choose which effect prunes should have
to 90% chance of successful choice (currently: 75%)"}
            # wmllint: display off

            [show_if]
                [variable]
                    name=prunes_cfg.select_chance
                    equals=75
                [/variable]
            [/show_if]
            [command]
                {VARIABLE prunes_cfg.select_chance 90}
            [/command]
        [/option]

        [option]
            {OPTION_LABEL _"Reduce chance of prunes failing to 20% (currently: 33%)"}
            [show_if]
                [variable]
                    name=prunes_cfg.puff_chance
                    equals=33
                [/variable]
            [/show_if]
            [command]
                {VARIABLE prunes_cfg.puff_chance 20}
            [/command]
        [/option]

        [option]
            {OPTION_LABEL _"Reduce chance of prunes failing to 10% (currently: 20%)"}
            [show_if]
                [variable]
                    name=prunes_cfg.puff_chance
                    equals=20
                [/variable]
            [/show_if]
            [command]
                {VARIABLE prunes_cfg.puff_chance 10}
            [/command]
        [/option]

        [option]
            {OPTION_LABEL _"Increase prunes' range by 1 hex (currently: $prunes_cfg.radius hexes)"}
            [command]
                {VARIABLE_OP prunes_cfg.radius add 1}
            [/command]
        [/option]
    [/message]

    {VARIABLE_OP prunes_cfg.advancement_counter add 1}
#enddef
#endif

#define PRUNES_NO_SUCCESS PRUNES_UNIT_ID SECOND_UNIT_ID
    {PUFF_PRUNES {SECOND_UNIT_ID}}

    # Display a message the first time the puff happens
    [if]
        [variable]
            name=prunes_cfg.comments.puff
            not_equals=yes
        [/variable]

        [then]
            {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" _"I guess them prunes don't work every time."}
            {VARIABLE prunes_cfg.comments.puff yes}
        [/then]
    [/if]
#enddef

#define PRUNES_SUCCESS PRUNES_UNIT_ID PRUNES_EVENT PRUNES_MESSAGE
#ifdef CAMPAIGN_GRNK_PART_1
    # Display a message the first time any prune event is successful (Part 1 only)
    [if]
        [variable]
            name=prunes_cfg.comments.first_time_success
            not_equals=yes
        [/variable]

        [then]
            {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" _"Whoa, that's cool!"}
            {VARIABLE prunes_cfg.comments.first_time_success yes}
        [/then]
    [/if]
#endif

    # Display a message the first time a specific prunes event is successful
    [if]
        [variable]
            name=prunes_cfg.comments.{PRUNES_EVENT}
            not_equals=yes
        [/variable]

        [then]
            {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" {PRUNES_MESSAGE}}
            {VARIABLE prunes_cfg.comments.{PRUNES_EVENT} yes}
        [/then]
    [/if]

    # Also fire an event that can be used for scenario-specific actions
    [fire_event]
        name=scenario_prunes_success_event

        [primary_unit]
            id={PRUNES_UNIT_ID}
        [/primary_unit]
        [secondary_unit]
            id=$prunes.target.id
        [/secondary_unit]
    [/fire_event]

#ifdef CAMPAIGN_GRNK_PART_2
    # Check whether Grnk should get new prunes abilities (Part 2 only)
    {VARIABLE_OP prunes_cfg.success_counter add 1}
    #{DEBUG "Prunes success counter: $prunes_cfg.success_counter/$prunes_cfg.successes_needed"}

    [if]
        [variable]
            name=prunes_cfg.success_counter
            greater_than_equal_to=$prunes_cfg.successes_needed
        [/variable]

        [then]
            {PRUNES_ADVANCE {PRUNES_UNIT_ID}}
            {VARIABLE prunes_cfg.success_counter 0}
            {VARIABLE_OP prunes_cfg.successes_needed add 1}
        [/then]
    [/if]
#endif
#enddef

#define PRUNES_EVENTS SIDE PRUNES_UNIT_ID TELE_TO_X TELE_TO_Y NOT_TERRAIN
    # One event for each of the prunes actions.
    # These rely on certain variables to be set in the other parts of the code, not to be used in isolation.

    # Unsuccessful prune event. Used in Part 1 & 2
    [event]
        name=prunes_puff
        first_time_only=no

        {PRUNES_NO_SUCCESS {PRUNES_UNIT_ID} $prunes.target.id}
    [/event]

    # Petrify enemy unit. Used in Part 1 & 2
    [event]
        name=prunes_petrify
        first_time_only=no

        {FIREBALL $prunes.target.x $prunes.target.y "~GS()~CS(100,50,100)"}
        {SOUND petrified.ogg}

        [set_variable]
            name=unpetrify_turn
            rand=$prunes_cfg.petrify_turns
        [/set_variable]
        [set_variable]
            name=unpetrify_turn
            add=$turn_number
        [/set_variable]
        #{DEBUG "Unpetrify unit on turn: $unpetrify_turn"}

        [if]
            [variable]
                name=unpetrify_turn
                greater_than=100
            [/variable]

            [then]
                {VARIABLE unpetrify_turn "xxx"}
            [/then]
        [/if]

        [label]
            x,y=$prunes.target.x,$prunes.target.y
            text=$unpetrify_turn
            color=200,200,200
        [/label]

        [modify_unit]
            [filter]
                id=$prunes.target.id
            [/filter]

            [variables]
                unpetrify_turn=$unpetrify_turn
            [/variables]
            [status]
                petrified=yes
            [/status]
        [/modify_unit]

        {CLEAR_VARIABLE unpetrify_turn}

        {PRUNES_SUCCESS {PRUNES_UNIT_ID} petrify _"You're not going anywhere!"+{NOTE _"Grnk's petrification spell only lasts a short time. The unit will become unpetrified on the turn shown below it (at the beginning of Grnk's turn). Also note that the magical prunes will have no further effect on petrified units."}}
    [/event]

    # Unpetrify units at beginning of Grnk's turn
    [event]
        name=side {SIDE} turn
        first_time_only=no

        [store_unit]
            [filter]
                [filter_wml]
                    [variables]
                        unpetrify_turn=$turn_number
                    [/variables]
                [/filter_wml]
            [/filter]

            variable=tmp_units
        [/store_unit]

        #{DEBUG "Number of units found to unpetrify: $tmp_units.length"}

        {FOREACH tmp_units i_u}
            [modify_unit]
                [filter]
                    id=$tmp_units[$i_u].id
                [/filter]

                [variables]
                    unpetrify_turn=""  # This doesn't really delete it, but I don't care
                [/variables]
                [status]
                    petrified=no
                [/status]
            [/modify_unit]

            [label]
                x,y=$tmp_units[$i_u].x,$tmp_units[$i_u].y
                text=""
            [/label]
        {NEXT i_u}

        {CLEAR_VARIABLE tmp_units}
    [/event]

    # Teleport enemy unit away. Used in Part 1 & 2
    [event]
        name=prunes_teleport
        first_time_only=no

        {TELEPORT_AWAY id=$prunes.target.id {TELE_TO_X} {TELE_TO_Y} {NOT_TERRAIN} "~CS(0,-50,0)"}

        {PRUNES_SUCCESS {PRUNES_UNIT_ID} teleport _"Away with you!
<i> </i>
"+{WHISPER _"If only I knew how to do this intentionally."}}
    [/event]

    # Have two enemy units fight to the death. Used in Part 1 & 2
    [event]
        name=prunes_berserk
        first_time_only=no

        # Find the closest non-leader enemy unit to the selected enemy unit that is not petrified
        {FIND_CLOSEST_HEX $prunes.target.x $prunes.target.y (
            [filter]
                canrecruit=no
                [filter_side]
                    [enemy_of]
                        [has_unit]
                            id={PRUNES_UNIT_ID}
                        [/has_unit]
                    [/enemy_of]
                [/filter_side]
                [not]
                    id=$prunes.target.id
                [/not]
                [not]
                    id=Grnd
                [/not]
                [filter_wml]
                    [not]
                        [status]
                            petrified=yes
                        [/status]
                    [/not]
                [/filter_wml]
            [/filter]
        )}

        # If there is a unit to attack, fight until one of them is dead
        # otherwise, just a puff again
        [if]
            [variable]
                name=hex_x
                not_equals=-1
            [/variable]

            [then]  # If there is a unit to attack
                {LEADING_HALO_PRUNES $prunes.target.id}

                # Need to store this unit as all kinds of parameters are needed
                [store_unit]
                    [filter]
                        x,y=$hex_x,$hex_y
                    [/filter]
                    variable=prunes.target2
                [/store_unit]

                # If they are not already adjacent, move the first unit
                [if]
                    [not]
                        [have_unit]
                            id=$prunes.target2.id
                            [filter_adjacent]
                                id=$prunes.target.id
                            [/filter_adjacent]
                        [/have_unit]
                    [/not]

                    [then]
                        {CLOSE_EMPTY_HEX $prunes.target2.x $prunes.target2.y {NOT_TERRAIN} 1}
                        {MOVE_UNIT id=$prunes.target.id $hex_x $hex_y}
                        {CLEAR_VARIABLE hex_x,hex_y}
                    [/then]
                [/if]

                [set_variable]
                    name=strike_number
                    rand=$prunes_cfg.strike_number
                [/set_variable]

                {FIGHT_TO_DEATH $prunes.target.id $prunes.target2.id $strike_number yes}

                {CLEAR_VARIABLE strike_number}

                {PRUNES_SUCCESS {PRUNES_UNIT_ID} berserk  _"That's right! Fight each other, not us."}
            [/then]

            [else]  # Otherwise, there's just a puff
                {PRUNES_NO_SUCCESS {PRUNES_UNIT_ID} $prunes.target.id}
            [/else]
        [/if]
    [/event]

    # Have unit join Grnk's side. Used in Part 2 only.
    [event]
        name=prunes_join
        first_time_only=no

        {LEADING_HALO_PRUNES $prunes.target.id}

        {VARIABLE prunes_cfg.joined_unit.id $prunes.target.id}
        {VARIABLE prunes_cfg.joined_unit.side $prunes.target.side}

        {STORE_UNIT_VAR id={PRUNES_UNIT_ID} side prunes_cfg.joined_unit.new_side}
        [modify_unit]
            [filter]
                id=$prunes.target.id
            [/filter]

            side=$prunes_cfg.joined_unit.new_side
            moves=$prunes.target.max_moves
            attacks_left=1
        [/modify_unit]

        {PRUNES_SUCCESS {PRUNES_UNIT_ID} join _"Here, en'my, en'my, en'my... Join me!"+{NOTE _"Remember that this effect only lasts one turn."}}

        [event]
            name="side $prunes_cfg.joined_unit.new_side turn,victory"

            #{DEBUG "Turning $prunes_cfg.joined_unit.id back to side $prunes_cfg.joined_unit.side"}
            [modify_unit]
                [filter]
                    id=$prunes_cfg.joined_unit.id
                [/filter]

                side=$prunes_cfg.joined_unit.side
            [/modify_unit]

            {CLEAR_VARIABLE prunes_cfg.joined_unit}
        [/event]
    [/event]

    # Demote unit to lowest level in its unit type line. Used in Part 2 only.
    [event]
        name=prunes_demote
        first_time_only=no

        [lua]
            code = <<
                local adv = wesnoth.require "~/add-ons/Grnk/lua/advances_from.lua"
                wesnoth.set_variable("prunes.from_type", adv.advances_from(wesnoth.get_variable("prunes.target.type"), -1))
            >>
        [/lua]

        [if]
            [variable]
                name=prunes.from_type
                not_equals=""
            [/variable]

            [then]
                {LEADING_HALO_PRUNES $prunes.target.id}

                # New unit shall have same percentage of max_hitpoints as old one
                {VARIABLE prunes.hp_ratio "$((1.0 * $prunes.target.hitpoints) / (1.0 * $prunes.target.max_hitpoints))"}

                [transform_unit]
                    id=$prunes.target.id
                    transform_to=$prunes.from_type
                [/transform_unit]

                # Store unit again, to get new HP right
                [store_unit]
                    [filter]
                        id=$prunes.target.id
                    [/filter]

                    variable=prunes.target
                [/store_unit]

                {VARIABLE prunes.new_hp "$($prunes.target.max_hitpoints * $prunes.hp_ratio)"}

                # Needs to be 1 HP minimum
                [if]
                    [variable]
                        name=prunes.new_hp
                        less_than=1
                    [/variable]

                    [then]
                        {VARIABLE prunes.new_hp 1}
                    [/then]
                [/if]

                [modify_unit]
                    [filter]
                        id=$prunes.target.id
                    [/filter]

                    hitpoints=$prunes.new_hp
                    experience=0
                [/modify_unit]

                {PRUNES_SUCCESS {PRUNES_UNIT_ID} demote _"Hah! Start over, scumbag!"}
            [/then]

            [else]
                {PRUNES_NO_SUCCESS {PRUNES_UNIT_ID} $prunes.target.id}
            [/else]
        [/if]
    [/event]

    # Damage all units within prunes_cfg.radius. Used in Part 2 only.
    [event]
        name=prunes_damage_all
        first_time_only=no

        {VARIABLE prunes.success no}

        {FOREACH prunes.all_targets i}
            {RANDOM $prunes_cfg.damage_all_random}
            #{DEBUG "damage unit: $i $prunes.all_targets[$i].id $random"}

            [if]
                [variable]
                    name=random
                    greater_than=0
                [/variable]
                [variable]
                    name=prunes.all_targets[$i].canrecruit
                    not_equals=yes
                [/variable]
                [variable]
                    name=prunes.all_targets[$i].id
                    not_equals=Grnd
                [/variable]

                [then]
                    [if]
                        [variable]
                            name=random
                            greater_than=$prunes.all_targets[$i].hitpoints
                        [/variable]

                        [then]
                            {VARIABLE random $prunes.all_targets[$i].hitpoints}
                        [/then]
                    [/if]
                    {VARIABLE_OP prunes.all_targets[$i].hitpoints sub $random}

                    {QUICKBURST_PRUNES $prunes.all_targets[$i].id}
                    [unstore_unit]
                        variable=prunes.all_targets[$i]
                        text=$random
                        red,green,blue=120,60,120
                    [/unstore_unit]

                    [if]
                        [variable]
                            name=prunes.all_targets[$i].hitpoints
                            less_than=1
                        [/variable]

                        [then]
                            [kill]
                                id=$prunes.all_targets[$i].id
                                animate=yes
                            [/kill]
                        [/then]
                    [/if]

                    {VARIABLE prunes.success yes}
                [/then]

                [else]
                    {PRUNES_NO_SUCCESS {PRUNES_UNIT_ID} $prunes.all_targets[$i].id}
                [/else]
            [/if]
        {NEXT i}

        [if]
            [variable]
                name=prunes.success
                equals=yes
            [/variable]

            [then]
                # Store temporary variable to see if this was the first time this effect took place
                [if]
                    [variable]
                        name=prunes_cfg.comments.damage_all
                        not_equals=yes
                    [/variable]

                    [then]
                        {VARIABLE prunes.first_time_damage_all yes}
                    [/then]
                [/if]

                {PRUNES_SUCCESS {PRUNES_UNIT_ID} damage_all _"Ouch, that hurt! I better be careful with this one."}

                # If it was not the first time, there might be some weird side effect
                [if]
                    [variable]
                        name=prunes.first_time_damage_all
                        not_equals=yes
                    [/variable]

                    [then]
                        # 33% chance of something weird happening
                        {RANDOM "1..3"}
                        #{DEBUG "Side effect damage_all random: $random"}
                        [if]
                            [variable]
                                name=random
                                equals=1
                            [/variable]

                            [then]
                                {RANDOM "1..3"}
                                [switch]
                                    variable=random
                                    [case]  # Can't use prunes for two turns
                                        value=1

                                        {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" _"Damn, that hurts! I really need a break from them prunes."+{NOTE _"Grnk will not be able to use the prunes for the next 2 turns of this scenario."}}

                                        [event]
                                            name="side 1 turn"  # prunes menu is set during 'new turn' event
                                            {CLEAR_MENU_PRUNES}
                                            [event]
                                                name="side 1 turn"
                                                {CLEAR_MENU_PRUNES}
                                            [/event]
                                        [/event]
                                    [/case]

                                    [case]  # Grnk acts "drunk"
                                        value=2

                                        # Store non-"drunk" Grnk for restoration when he's "sober" again
                                        [store_unit]
                                            [filter]
                                                id={PRUNES_UNIT_ID}
                                            [/filter]
                                            variable=prunes.tmp_unit
                                        [/store_unit]

                                        # Add blue overlay
                                        [object]
                                            silent=yes
                                            [filter]
                                                id={PRUNES_UNIT_ID}
                                            [/filter]
                                            [effect]
                                                apply_to=image_mod
                                                replace="B(128)"
                                            [/effect]
                                        [/object]

                                        {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" _"Ugh, I don't feel so good ..."}
                                        {REPEAT 4 (
                                            [store_reachable_locations]
                                                [filter]
                                                    id={PRUNES_UNIT_ID}
                                                [/filter]
                                                [filter_location]  # unoccupied by other unit
                                                    [not]
                                                        [filter]
                                                            [not]
                                                                id={PRUNES_UNIT_ID}
                                                            [/not]
                                                        [/filter]
                                                    [/not]
                                                [/filter_location]

                                                variable=prunes.tmp_locs
                                            [/store_reachable_locations]

                                            {RANDOM "1..$prunes.tmp_locs.length"}
                                            {VARIABLE_OP random sub 1}
                                            {MOVE_UNIT_IMAGEMODS id={PRUNES_UNIT_ID} $prunes.tmp_locs[$random].x $prunes.tmp_locs[$random].y "B(128)"}

                                            [switch]
                                                variable=REPEAT_i

                                                [case]
                                                    value=0
                                                    {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" _"When did the ground start moving like that?"}
                                                [/case]
                                                [case]
                                                    value=1
                                                    {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" _"This is Shmaltupp Lager all over again!!"}
                                                [/case]
                                                [case]
                                                    value=2
                                                    {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" _"I'm getting too old for this!"}
                                                [/case]
                                                [else]
                                                    {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" _"Whoa!"}
                                                [/else]
                                            [/switch]
                                        )}
                                        {MOVE_UNIT_IMAGEMODS id={PRUNES_UNIT_ID} $prunes.tmp_unit.x $prunes.tmp_unit.y "B(128)"}

                                        # Restore the non-"drunk" Grnk
                                        [unstore_unit]
                                            variable=prunes.tmp_unit
                                        [/unstore_unit]

                                        {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" _"Ahh, that's better."}
                                    [/case]

                                    [case]  # Turn Grnk into a ghast for one turn
                                        value=3

                                        [modify_unit]
                                            [filter]
                                                id={PRUNES_UNIT_ID}
                                            [/filter]

                                            facing=se
                                        [/modify_unit]

                                        [store_unit]
                                            [filter]
                                                id={PRUNES_UNIT_ID}
                                            [/filter]

                                            variable=prunes_cfg.unit_before_ghast
                                        [/store_unit]

                                        {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" _"What the ..."}

                                        {EXTRA_ANIM_UNIT {PRUNES_UNIT_ID} (
                                            alpha=1~0:800,0~1:800
                                            [frame]
                                                image=$prunes_cfg.unit_before_ghast.image:800,units/undead/ghast.png:800
                                            [/frame]
                                        )}

                                        # Don't transform the unit, as we don't want all the special stuff
                                        [kill]
                                            id={PRUNES_UNIT_ID}
                                        [/kill]
                                        [unit]
                                            side=$prunes_cfg.unit_before_ghast.side
                                            type=Ghast
                                            id={PRUNES_UNIT_ID}
                                            name= _"Ghastly Grnk"

                                            # Set all the current properties of Grnk for the ghast
                                            x,y=$prunes_cfg.unit_before_ghast.x,$prunes_cfg.unit_before_ghast.y
                                            canrecruit=$prunes_cfg.unit_before_ghast.canrecruit
                                            facing=$prunes_cfg.unit_before_ghast.facing
                                            experience=$prunes_cfg.unit_before_ghast.experience
                                            max_experience=999  # ghast may not advance during its turn
                                            hitpoints=$prunes_cfg.unit_before_ghast.hitpoints
                                            max_hitpoints=$prunes_cfg.unit_before_ghast.max_hitpoints
                                            moves=$prunes_cfg.unit_before_ghast.moves
                                            max_moves=$prunes_cfg.unit_before_ghast.max_moves
                                            attacks_left=$prunes_cfg.unit_before_ghast.attacks_left
                                        [/unit]

                                        {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" _"Crap! I turned myself into a ghast."}

                                        [event]
                                            name="side $prunes_cfg.unit_before_ghast.side turn,victory"

                                            [modify_unit]
                                                [filter]
                                                    id={PRUNES_UNIT_ID}
                                                [/filter]

                                                facing=se
                                            [/modify_unit]

                                            [store_unit]
                                                [filter]
                                                    id={PRUNES_UNIT_ID}
                                                [/filter]

                                                variable=prunes.tmp_unit
                                            [/store_unit]

                                            {VARIABLE prunes_cfg.unit_before_ghast.x $prunes.tmp_unit.x}
                                            {VARIABLE prunes_cfg.unit_before_ghast.y $prunes.tmp_unit.y}
                                            {VARIABLE prunes_cfg.unit_before_ghast.experience $prunes.tmp_unit.experience}
                                            {VARIABLE prunes_cfg.unit_before_ghast.hitpoints $prunes.tmp_unit.hitpoints}
                                            {VARIABLE prunes_cfg.unit_before_ghast.facing $prunes.tmp_unit.facing}

                                            {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" _"Argh!"}

                                            {EXTRA_ANIM_UNIT {PRUNES_UNIT_ID} (
                                                alpha=1~0:800,0~1:800
                                                [frame]
                                                    image=units/undead/ghast.png:800,$prunes_cfg.unit_before_ghast.image:800
                                                [/frame]
                                            )}

                                            [unstore_unit]
                                                variable=prunes_cfg.unit_before_ghast
                                                advance=yes
                                                fire_event=yes
                                                find_vacant=no
                                            [/unstore_unit]

                                            {CLEAR_VARIABLE prunes_cfg.unit_before_ghast}
                                            {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" _"Phew. That was ... unpleasant."}
                                        [/event]
                                    [/case]
                                [/switch]
                            [/then]
                        [/if]
                    [/then]
                [/if]
            [/then]
        [/if]

        {CLEAR_VARIABLE random}
    [/event]
#enddef

#define SET_MENU_PRUNES SIDE PRUNES_UNIT_ID TELE_TO_X TELE_TO_Y NOT_TERRAIN
    # @SIDE: set this so that menu item only gets displayed for side that Grnk is on
    [set_menu_item]
        id=m09_menu_prunes
        description=_"Use Magical Prunes"
        image=items/ball-blue.png~CROP(26,16,20,40)~SCALE(20,20)~GS()~CS(-50,-100,-50)
        [show_if]
            [variable]
                name=side_number
                equals={SIDE}
            [/variable]
        [/show_if]
        [default_hotkey]
            key=p
            shift=yes
        [/default_hotkey]
        [command]
            # 'prunes' is the overall container variable storing all the prunes
            # events related information needed. .x,.y is the hex of the main unit.

            [store_unit]
                [filter]
                    id={PRUNES_UNIT_ID}
                [/filter]

                variable=tmp_prunes_unit
            [/store_unit]
            {VARIABLE prunes.x $tmp_prunes_unit.x}
            {VARIABLE prunes.y $tmp_prunes_unit.y}
            {CLEAR_VARIABLE tmp_prunes_unit}

#ifdef CAMPAIGN_GRNK_PART_1
            # First time he tries to use one (Part 1 only)
            [if]
                [variable]
                    name=prunes_cfg.comments.first_time_attempt
                    not_equals=yes
                [/variable]

                [then]
                    {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" _"Maybe if I throw them up into the air?"}
                    {VARIABLE prunes_cfg.comments.first_time_attempt yes}
                [/then]
            [/if]
#endif

            # See if there is an enemy_unit unit within prunes_cfg.radius hexes
            # Non-petrified units only
            [store_unit]
                [filter]
                    [filter_side]
                        [enemy_of]
                            [has_unit]
                                id={PRUNES_UNIT_ID}
                            [/has_unit]
                        [/enemy_of]
                    [/filter_side]
                    [filter_wml]
                        [not]
                            [status]
                                petrified=yes
                            [/status]
                        [/not]
                    [/filter_wml]
                    [filter_location]
                        x,y=$prunes.x,$prunes.y
                        radius=$prunes_cfg.radius
                    [/filter_location]
                [/filter]

                variable=prunes.all_targets
            [/store_unit]
            #{DEBUG "Number of close enough targets: $prunes.all_targets.length"}

            # Now pick one of those units randomly
            # If there is none, make a puff at main unit's location,
            # Otherwise, perform all the prune actions
            [if]
                [variable]
                    name=prunes.all_targets.length
                    equals=0
                [/variable]

                [then]
                    {PUFF_PRUNES {PRUNES_UNIT_ID}}
                    {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" _"Rats! I'm not close enough to an enemy."}
                [/then]

                [else]
                    # Store a randomly selected unit in prunes.target
                    {VARIABLE prunes.i $prunes.all_targets.length}
                    {VARIABLE_OP prunes.i add -1}
                    {RANDOM 0..$prunes.i}

                    [store_unit]
                        [filter]
                            id=$prunes.all_targets[$random].id
                        [/filter]
                        variable=prunes.target
                    [/store_unit]
                    #{DEBUG "Selected unit: $random $prunes.target.id"}

                    # Now select one action at random, or from a menu if
                    # prunes_cfg.select_chance > 0
                    [if]
                        [variable]
                            name=prunes_cfg.select_chance
                            equals=0
                        [/variable]

                        [then]
                            {RANDOM $prunes_cfg.events}
                            {VARIABLE prunes.chosen_event $random}
                        [/then]

                        [else]
                            [message]
                                speaker=narrator
                                image=wesnoth-icon.png
                                image="items/ball-blue.png~CROP(26,16,20,40)~SCALE(20,20)~CS(-50,-100,-100)"
                                message=_"What effect should the prunes have? Chance of successful choice: $prunes_cfg.select_chance%"

                                [option]
                                    {OPTION_LABEL (_"Petrify enemy unit")}
                                    image=items/dragonstatue.png~CROP(12,1,48,48)
                                    [show_if]
                                        [variable]
                                            name=prunes_cfg.events
                                            contains=petrify
                                        [/variable]
                                        [or]
                                            [variable]
                                                name=prunes_cfg.test_prunes
                                                equals=yes
                                            [/variable]
                                        [/or]
                                    [/show_if]
                                    [command]
                                        {VARIABLE prunes.chosen_event petrify}
                                    [/command]
                                [/option]

                                [option]
                                    {OPTION_LABEL (_"Teleport enemy unit away")}
                                    image=halo/teleport-7.png~CROP(5,5,48,48)~GS()~CS(0,-50,0)
                                    [show_if]
                                        [variable]
                                            name=prunes_cfg.events
                                            contains=teleport
                                        [/variable]
                                        [or]
                                            [variable]
                                                name=prunes_cfg.test_prunes
                                                equals=yes
                                            [/variable]
                                        [/or]
                                    [/show_if]
                                    [command]
                                        {VARIABLE prunes.chosen_event teleport}
                                    [/command]
                                [/option]

                                [option]
                                    {OPTION_LABEL (_"Make two enemy units fight each other")}
                                    image=icons/crossed_sword_and_hammer.png~CROP(6,6,48,48)
                                    [show_if]
                                        [variable]
                                            name=prunes_cfg.events
                                            contains=berserk
                                        [/variable]
                                        [or]
                                            [variable]
                                                name=prunes_cfg.test_prunes
                                                equals=yes
                                            [/variable]
                                        [/or]
                                    [/show_if]
                                    [command]
                                        {VARIABLE prunes.chosen_event berserk}
                                    [/command]
                                [/option]

                                [option]
                                    {OPTION_LABEL (_"Convert enemy unit to Grnk's side for one turn")}
                                    image=attacks/sword-holy.png~CROP(6,6,48,48)
                                    [show_if]
                                        [variable]
                                            name=prunes_cfg.events
                                            contains=join
                                        [/variable]
                                        [or]
                                            [variable]
                                                name=prunes_cfg.test_prunes
                                                equals=yes
                                            [/variable]
                                        [/or]
                                    [/show_if]
                                    [command]
                                        {VARIABLE prunes.chosen_event join}
                                    [/command]
                                [/option]

                                [option]
                                    {OPTION_LABEL (_"Demote enemy unit")}
                                    image=units/human-peasants/ruffian.png~CROP(11,15,48,48)
                                    [show_if]
                                        [variable]
                                            name=prunes_cfg.events
                                            contains=demote
                                        [/variable]
                                        [or]
                                            [variable]
                                                name=prunes_cfg.test_prunes
                                                equals=yes
                                            [/variable]
                                        [/or]
                                    [/show_if]
                                    [command]
                                        {VARIABLE prunes.chosen_event demote}
                                    [/command]
                                [/option]

                                [option]
                                    {OPTION_LABEL (_"Damage all close units")}
                                    image=projectiles/fire-burst-small-4.png~CROP(6,8,48,48)~GS()~CS(50,0,50)
                                    [show_if]
                                        [variable]
                                            name=prunes_cfg.events
                                            contains=damage_all
                                        [/variable]
                                        [or]
                                            [variable]
                                                name=prunes_cfg.test_prunes
                                                equals=yes
                                            [/variable]
                                        [/or]
                                    [/show_if]
                                    [command]
                                        {VARIABLE prunes.chosen_event damage_all}
                                    [/command]
                                [/option]
                            [/message]

                            # Now run RNG to see if we go with selected effect, or use random one after all
                            {RANDOM "1..100"}
                            #{DEBUG "RNG for selection: $random"}
                            [if]
                                [variable]
                                    name=random
                                    greater_than=$prunes_cfg.select_chance
                                [/variable]

                                [then]
                                    #{DEBUG "Choosing prune effect randomly after all"}
                                    {RANDOM $prunes_cfg.events}
                                    {VARIABLE prunes.chosen_event $random}
                                [/then]
                            [/if]
                        [/else]
                    [/if]

                    # Prunes do not work on the leaders of the enemy sides
                    [if]
                        [variable]
                            name=prunes.target.canrecruit
                            equals=yes
                        [/variable]
                        [or]
                            [variable]
                                name=prunes.target.id
                                equals=Grnd
                            [/variable]
                        [/or]

                        [then]
                            {VARIABLE prunes.chosen_event "puff"}
                        [/then]
                    [/if]

                    # They also do not work on lurkers
                    [if]
                        [variable]
                            name=prunes.target.type
                            equals=Swamp Lurker
                        [/variable]

                        [then]
                            {VARIABLE prunes.chosen_event "puff"}

                            [modify_unit]
                                [filter]
                                    id=$prunes.target.id
                                [/filter]

                                role=SL_visible
                            [/modify_unit]
                        [/then]
                    [/if]

                    # Finally, there is a certain chance of the prunes failing, no matter what has happened so far
                    {RANDOM "0..99"}
                    #{DEBUG "Puff chance random: $random ($prunes_cfg.puff_chance)"}
                    [if]
                        [variable]
                            name=random
                            less_than=$prunes_cfg.puff_chance
                        [/variable]

                        [then]
                            #{DEBUG "Forcing a puff"}
                            {VARIABLE prunes.chosen_event "puff"}
                        [/then]
                    [/if]

                    [adjust_facing]
                        id={PRUNES_UNIT_ID}
                        second_id=$prunes.target.id
                        speaker_only=yes
                    [/adjust_facing]

                    {LEADING_HALO_PRUNES {PRUNES_UNIT_ID}}
                    {DELAY 600}

                    [fire_event]
                        name=prunes_$prunes.chosen_event
                    [/fire_event]

                    # Prunes do not work on the leaders of the enemy sides
                    [if]
                        [variable]
                            name=prunes.target.canrecruit
                            equals=yes
                        [/variable]
                        [or]
                            [variable]
                                name=prunes.target.id
                                equals=Grnd
                            [/variable]
                        [/or]

                        [then]
                            [if]
                                [variable]
                                    name=prunes.target.race
                                    equals=troll
                                [/variable]
                                [or]
                                    [variable]
                                        name=prunes.target.race
                                        equals=orc
                                    [/variable]
                                [/or]
                                [or]
                                    [variable]
                                        name=prunes.target.race
                                        equals=wolf
                                    [/variable]
                                [/or]

                                [then]
                                    {MESSAGE_GRNK $prunes.target.id "" "" _"Harharharharhar! Little goblin magic no hurt $prunes.target.name."}
                                [/then]

                                [else]
                                    [if]
                                        [variable]
                                            name=prunes.target.race
                                            equals=lizard
                                        [/variable]

                                        [then]
                                            {MESSAGE_GRNK $prunes.target.id "" "" _"Hah, your little magic tricksss don't work on me. The Massster'szzsss powerss protect me."}
                                            [if]
                                                [variable]
                                                    name=prunes_cfg.comments.first_lizard_leader
                                                    not_equals=yes
                                                [/variable]

                                                [then]
                                                    {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" _"Even the saurians are under the Master's spell!"}
                                                    {VARIABLE prunes_cfg.comments.first_lizard_leader yes}
                                                [/then]
                                            [/if]
                                        [/then]

                                        [else]
                                            [if]
                                                [variable]
                                                    name=prunes.target.id
                                                    not_equals=Grossauba
                                                [/variable]

                                                [then]
                                                    {MESSAGE_GRNK $prunes.target.id "" "" _"Hah, your little magic tricks don't work on me. The Master's powers protect me."}

                                                    # Also just in case this is the Master himself
                                                    [if]
                                                        [variable]
                                                            name=prunes.target.id
                                                            equals=Master
                                                        [/variable]

                                                        [then]
                                                            {MESSAGE_GRNK Master "" "" _"That would be me. Harharharharhar!"}
                                                        [/then]
                                                    [/if]
                                                [/then]
                                            [/if]
                                        [/else]
                                    [/if]
                                [/else]
                            [/if]
                        [/then]
                    [/if]

                    # They also do not work on lurkers
                    [if]
                        [variable]
                            name=prunes.target.type
                            equals=Swamp Lurker
                        [/variable]

                        [then]
                            [if]
                                [variable]
                                    name=prunes_cfg.comments.lurkers
                                    not_equals=yes
                                [/variable]

                                [then]
                                    {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" _"Hmm. I guess the prunes magic doesn't work on lurkers. They truly are mysterious creatures!"}
                                    {VARIABLE prunes_cfg.comments.lurkers yes}
                                [/then]
                            [/if]

                            [modify_unit]
                                [filter]
                                    id=$prunes.target.id
                                [/filter]

                                role=""
                            [/modify_unit]

                            {VARIABLE prunes.chosen_event "puff"}
                        [/then]
                    [/if]
                [/else]
            [/if]

            # Also fire an event that can be used for scenario-specific actions
            [fire_event]
                name=scenario_prunes_event

                [primary_unit]
                    id={PRUNES_UNIT_ID}
                [/primary_unit]
                [secondary_unit]
                    id=$prunes.target.id
                [/secondary_unit]
            [/fire_event]

            {CLEAR_VARIABLE prunes,random,hex_x,hex_y}

            # Can only be used once per turn, reset at beginning of next turn
            [if]
                [variable]
                    name=prunes_cfg.test_prunes
                    not_equals=yes
                [/variable]

                [then]
                    {CLEAR_MENU_PRUNES}
                [/then]
            [/if]
        [/command]
    [/set_menu_item]

    [event]
        name=test_prunes
        first_time_only=no

        {MESSAGE_GRNK {PRUNES_UNIT_ID} "" "" _"Debug only: Setting prunes testing mode"}

        {VARIABLE prunes_cfg.test_prunes "yes"}
        {VARIABLE prunes_cfg.puff_chance 0}
        {VARIABLE prunes_cfg.select_chance 100}
    [/event]
#enddef

#define CLEAR_MENU_PRUNES
    # Disable menu item: prunes
    [set_menu_item]
        id=m09_menu_prunes
        [show_if]
            [not]
            [/not]
        [/show_if]
    [/set_menu_item]
#enddef

#define PRUNES_SETUP SIDE PRUNES_UNIT_ID TELE_TO_X TELE_TO_Y NOT_TERRAIN
    # Set up the prunes event, the menu item, and an event that resets the menu item
    # at the beginning of each turn, as it is disabled after each use (can only be used once per turn)
    # PRUNES_UNIT_ID: unit which does the actions
    # TELE_TO_X TELE_TO_Y: Location for teleport; not onto terrain NOT_TERRAIN

    {PRUNES_EVENTS {SIDE} {PRUNES_UNIT_ID} {TELE_TO_X} {TELE_TO_Y} {NOT_TERRAIN}}
    {SET_MENU_PRUNES {SIDE} {PRUNES_UNIT_ID} {TELE_TO_X} {TELE_TO_Y} {NOT_TERRAIN}}
    [event]
        name=new turn
        first_time_only=no

        {SET_MENU_PRUNES {SIDE} {PRUNES_UNIT_ID} {TELE_TO_X} {TELE_TO_Y} {NOT_TERRAIN}}
    [/event]
#enddef

#define PRUNES_INIT
    # Initialize the prunes configuration before they are used for the first time
    # This only gets done once per campaign, not in each scenario

    {VARIABLE prunes_cfg.events "petrify,teleport,berserk"}
    #{VARIABLE prunes_cfg.events "petrify,teleport,berserk,join,demote,damage_all"}
    {VARIABLE prunes_cfg.radius 2}
    {VARIABLE prunes_cfg.select_chance 0}
    {VARIABLE prunes_cfg.puff_chance 33}
    {VARIABLE prunes_cfg.petrify_turns "1..2"}
    {VARIABLE prunes_cfg.strike_number "2..3"}

#ifdef CAMPAIGN_GRNK_PART_2
    {VARIABLE prunes_cfg.damage_all_random "-3..8"}
    {VARIABLE prunes_cfg.success_counter 0}  # Start Grnk with some experience from Part 1 already
    {VARIABLE prunes_cfg.successes_needed 5}
    {VARIABLE prunes_cfg.advancement_counter 0}

    # Need no first_time comments for the effects that were present in Part 1 already
    {VARIABLE prunes_cfg.comments.puff yes}
    {VARIABLE prunes_cfg.comments.petrify no} # Repeat this in Part 2
    {VARIABLE prunes_cfg.comments.teleport yes}
    {VARIABLE prunes_cfg.comments.berserk yes}
#endif
#enddef
